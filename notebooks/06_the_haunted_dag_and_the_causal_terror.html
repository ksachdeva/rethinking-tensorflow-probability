
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chapter 6 - The Haunted DAG and The Causal Terror &#8212; Statistical Rethinking (2nd Edition)</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="canonical" href="https://ksachdeva.github.io/rethinking-tensorflow-probability/notebooks/06_the_haunted_dag_and_the_causal_terror.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Chapter 7 - Ulysses’ Compass" href="07_ulysses_compass.html" />
    <link rel="prev" title="Chapter 5 - The Many Variables &amp; The Spurious Waffles" href="05_the_many_variables_and_the_spurious_waffles.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Statistical Rethinking (2nd Edition)</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../README.html">
   Statistical Rethinking (2nd Edition) with Tensorflow Probability
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="00_preface.html">
   Preface
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="01_the_golem_of_prague.html">
   Chapter 1 The Gloem of Prague
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02_small_worlds_and_large_worlds.html">
   Chapter 2 - Small Worlds and Large Worlds
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03_sampling_the_imaginary.html">
   Chapter 3 - Sampling the Imaginary
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="04_geocentric_models.html">
   Chapter 4 - Geocentric Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="05_the_many_variables_and_the_spurious_waffles.html">
   Chapter 5 - The Many Variables &amp; The Spurious Waffles
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Chapter 6 - The Haunted DAG and The Causal Terror
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="07_ulysses_compass.html">
   Chapter 7 - Ulysses’ Compass
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="08_conditional_manatees.html">
   Chapter 8 - Conditional Manatees
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="09_markov_chain_monte_carlo.html">
   Chapter 9 - Markov Chain Monte Carlo
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="10_big_entropy_and_the_generalized_linear_model.html">
   Chapter 10 - Big Entropy and The Generalized Linear Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="11_god_spiked_the_integers.html">
   Chapter 11 - God Spiked the Integers
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="12_monsters_and_mixtures.html">
   Chapter 12 - Monsters and Mixtures
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="13_models_with_memory.html">
   Chapter 13 - Models with Memory
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="14_adventures_in_covariance.html">
   Chapter 14 - Adventures in Covariance
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="15_missing_data_and_other_opportunities.html">
   Chapter 15 - Missing Data and Other Opportunities
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="16_generalized_linear_madness.html">
   Chapter 16 - Generalized Linear Madness
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="17_horoscopes.html">
   Chapter 17 - Horoscopes
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/notebooks/06_the_haunted_dag_and_the_causal_terror.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/ksachdeva/rethinking-tensorflow-probability"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/ksachdeva/rethinking-tensorflow-probability/issues/new?title=Issue%20on%20page%20%2Fnotebooks/06_the_haunted_dag_and_the_causal_terror.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/ksachdeva/rethinking-tensorflow-probability/master?urlpath=tree/notebooks/06_the_haunted_dag_and_the_causal_terror.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#overthinking-simulated-science-distorion">
   Overthinking : Simulated Science Distorion
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-6-1">
     Code 6.1
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#multicollinearity">
   6.1 Multicollinearity
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#multicollinear-legs">
     6.1.1 Multicollinear legs
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-2">
       Code 6.2
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-3">
       Code 6.3
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-5">
       Code 6.5
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-6">
       Code 6.6
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-7">
       Code 6.7
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#multicollinear-milk">
     6.1.2 Multicollinear milk
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-8">
       Code 6.8
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-9">
       Code 6.9
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-10">
       Code 6.10
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-11">
       Code 6.11
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#overthinking-simulating-collinearity">
     Overthinking : Simulating collinearity
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-12">
       Code 6.12
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#post-treatment-bias">
   6.2 Post-treatment bias
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-6-13">
     Code 6.13
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#a-prior-is-born">
     6.2.1 A prior is born
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-14">
       Code 6.14
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-15">
       Code 6.15
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-16">
       Code 6.16
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#blocked-by-consequence">
     6.2.2 Blocked by consequence
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-17">
       Code 6.17
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fungus-and-d-separation">
     6.2.3 Fungus and d-separation
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-18">
       Code 6.18
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-19">
       Code 6.19
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-20">
       Code 6.20
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#collider-bias">
   6.3 Collider bias
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#collider-of-false-sorrow">
     6.3.1 Collider of false sorrow
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-21">
       Code 6.21
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-22">
       Code 6.22
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-23">
       Code 6.23
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-24">
       Code 6.24
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-hanted-dag">
     6.3.2 The hanted DAG
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-25">
       Code 6.25
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-26">
       Code 6.26
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-27">
       Code 6.27
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-28">
       Code 6.28
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#confronting-confounding">
   6.4 Confronting confounding
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#shutting-the-backdoor">
     6.4.1 Shutting the backdoor
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#two-roads">
     6.4.2 Two roads
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-29">
       Code 6.29
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#backdoor-waffles">
     6.4.3 Backdoor waffles
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-30">
       Code 6.30
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-31">
       Code 6.31
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Chapter 6 - The Haunted DAG and The Causal Terror</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#overthinking-simulated-science-distorion">
   Overthinking : Simulated Science Distorion
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-6-1">
     Code 6.1
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#multicollinearity">
   6.1 Multicollinearity
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#multicollinear-legs">
     6.1.1 Multicollinear legs
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-2">
       Code 6.2
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-3">
       Code 6.3
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-5">
       Code 6.5
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-6">
       Code 6.6
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-7">
       Code 6.7
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#multicollinear-milk">
     6.1.2 Multicollinear milk
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-8">
       Code 6.8
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-9">
       Code 6.9
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-10">
       Code 6.10
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-11">
       Code 6.11
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#overthinking-simulating-collinearity">
     Overthinking : Simulating collinearity
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-12">
       Code 6.12
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#post-treatment-bias">
   6.2 Post-treatment bias
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-6-13">
     Code 6.13
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#a-prior-is-born">
     6.2.1 A prior is born
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-14">
       Code 6.14
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-15">
       Code 6.15
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-16">
       Code 6.16
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#blocked-by-consequence">
     6.2.2 Blocked by consequence
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-17">
       Code 6.17
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fungus-and-d-separation">
     6.2.3 Fungus and d-separation
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-18">
       Code 6.18
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-19">
       Code 6.19
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-20">
       Code 6.20
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#collider-bias">
   6.3 Collider bias
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#collider-of-false-sorrow">
     6.3.1 Collider of false sorrow
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-21">
       Code 6.21
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-22">
       Code 6.22
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-23">
       Code 6.23
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-24">
       Code 6.24
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-hanted-dag">
     6.3.2 The hanted DAG
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-25">
       Code 6.25
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-26">
       Code 6.26
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-27">
       Code 6.27
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-28">
       Code 6.28
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#confronting-confounding">
   6.4 Confronting confounding
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#shutting-the-backdoor">
     6.4.1 Shutting the backdoor
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#two-roads">
     6.4.2 Two roads
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-29">
       Code 6.29
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#backdoor-waffles">
     6.4.3 Backdoor waffles
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-30">
       Code 6.30
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-6-31">
       Code 6.31
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <p><a class="reference external" href="https://colab.research.google.com/github/ksachdeva/rethinking-tensorflow-probability/blob/master/notebooks/06_the_haunted_dag_and_the_causal_terror.ipynb"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg" /></a></p>
<div class="tex2jax_ignore mathjax_ignore section" id="chapter-6-the-haunted-dag-and-the-causal-terror">
<h1>Chapter 6 - The Haunted DAG and The Causal Terror<a class="headerlink" href="#chapter-6-the-haunted-dag-and-the-causal-terror" title="Permalink to this headline">¶</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Install packages that are not installed in colab</span>
<span class="k">try</span><span class="p">:</span>
  <span class="kn">import</span> <span class="nn">google.colab</span>
  <span class="o">!</span>pip install --upgrade -q daft
  <span class="o">!</span>pip install -q causalgraphicalmodels
  <span class="o">!</span>pip install -q watermark
<span class="k">except</span><span class="p">:</span>
  <span class="k">pass</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> watermark
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Core</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">arviz</span> <span class="k">as</span> <span class="nn">az</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">tensorflow_probability</span> <span class="k">as</span> <span class="nn">tfp</span>
<span class="kn">from</span> <span class="nn">statsmodels.regression</span> <span class="kn">import</span> <span class="n">linear_model</span>

<span class="c1"># visualization </span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">import</span> <span class="nn">daft</span>
<span class="kn">from</span> <span class="nn">causalgraphicalmodels</span> <span class="kn">import</span> <span class="n">CausalGraphicalModel</span>

<span class="c1"># aliases</span>
<span class="n">tfd</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">distributions</span>
<span class="n">tfb</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">bijectors</span>
<span class="n">Root</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="o">.</span><span class="n">Root</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-01-17 23:43:14.066915: W tensorflow/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library &#39;libcudart.so.11.0&#39;; dlerror: libcudart.so.11.0: cannot open shared object file: No such file or directory
2022-01-17 23:43:14.066951: I tensorflow/stream_executor/cuda/cudart_stub.cc:29] Ignore above cudart dlerror if you do not have a GPU set up on your machine.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">watermark</span> -p numpy,tensorflow,tensorflow_probability,arviz,scipy,pandas,statsmodels,daft,causalgraphicalmodels
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>numpy                 : 1.21.5
tensorflow            : 2.7.0
tensorflow_probability: 0.15.0
arviz                 : 0.11.4
scipy                 : 1.7.3
pandas                : 1.3.5
statsmodels           : 0.13.1
daft                  : 0.1.2
causalgraphicalmodels : 0.0.4
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># config of various plotting libraries</span>
<span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### Tensorflow MCMC sampling helpers</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">USE_XLA</span> <span class="o">=</span> <span class="kc">False</span>              <span class="c1">#@param</span>
<span class="n">NUMBER_OF_CHAINS</span>  <span class="o">=</span> <span class="mi">2</span>        <span class="c1">#@param </span>
<span class="n">NUMBER_OF_BURNIN</span>  <span class="o">=</span> <span class="mi">500</span>      <span class="c1">#@param</span>
<span class="n">NUMBER_OF_SAMPLES</span> <span class="o">=</span> <span class="mi">500</span>      <span class="c1">#@param</span>
<span class="n">NUMBER_OF_LEAPFROG_STEPS</span> <span class="o">=</span> <span class="mi">4</span> <span class="c1">#@param</span>

<span class="k">def</span> <span class="nf">_trace_to_arviz</span><span class="p">(</span><span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">sample_stats</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">observed_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">prior_predictive</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">posterior_predictive</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">trace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                 <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">trace</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="n">sample_stats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sample_stats</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">sample_stats</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sample_stats</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="n">prior_predictive</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prior_predictive</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">prior_predictive</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">prior_predictive</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="n">posterior_predictive</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">posterior_predictive</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">az</span><span class="o">.</span><span class="n">InferenceData</span><span class="p">)</span> <span class="ow">and</span> <span class="n">inplace</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">trace</span> <span class="o">+</span> <span class="n">az</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">posterior_predictive</span><span class="o">=</span><span class="n">posterior_predictive</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">az</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
        <span class="n">posterior</span><span class="o">=</span><span class="n">trace</span><span class="p">,</span>
        <span class="n">sample_stats</span><span class="o">=</span><span class="n">sample_stats</span><span class="p">,</span>
        <span class="n">prior_predictive</span><span class="o">=</span><span class="n">prior_predictive</span><span class="p">,</span>
        <span class="n">posterior_predictive</span><span class="o">=</span><span class="n">posterior_predictive</span><span class="p">,</span>
        <span class="n">observed_data</span><span class="o">=</span><span class="n">observed_data</span><span class="p">,</span>
    <span class="p">)</span>

<span class="nd">@tf</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="n">autograph</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">experimental_compile</span><span class="o">=</span><span class="n">USE_XLA</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">run_hmc_chain</span><span class="p">(</span><span class="n">init_state</span><span class="p">,</span>
              <span class="n">bijectors</span><span class="p">,</span> 
              <span class="n">step_size</span><span class="p">,</span> 
              <span class="n">target_log_prob_fn</span><span class="p">,</span> 
              <span class="n">num_leapfrog_steps</span><span class="o">=</span><span class="n">NUMBER_OF_LEAPFROG_STEPS</span><span class="p">,</span>
              <span class="n">num_samples</span><span class="o">=</span><span class="n">NUMBER_OF_SAMPLES</span><span class="p">,</span>
              <span class="n">burnin</span><span class="o">=</span><span class="n">NUMBER_OF_BURNIN</span><span class="p">,</span>
              <span class="p">):</span>    

    <span class="k">def</span> <span class="nf">_trace_fn_transitioned</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">pkr</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">pkr</span><span class="o">.</span><span class="n">inner_results</span><span class="o">.</span><span class="n">inner_results</span><span class="o">.</span><span class="n">log_accept_ratio</span>
        <span class="p">)</span>

    <span class="n">hmc_kernel</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">mcmc</span><span class="o">.</span><span class="n">HamiltonianMonteCarlo</span><span class="p">(</span>
                    <span class="n">target_log_prob_fn</span><span class="p">,</span>
                    <span class="n">num_leapfrog_steps</span><span class="o">=</span><span class="n">num_leapfrog_steps</span><span class="p">,</span>
                    <span class="n">step_size</span><span class="o">=</span><span class="n">step_size</span><span class="p">)</span>         

    <span class="n">inner_kernel</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">mcmc</span><span class="o">.</span><span class="n">TransformedTransitionKernel</span><span class="p">(</span>
        <span class="n">inner_kernel</span><span class="o">=</span><span class="n">hmc_kernel</span><span class="p">,</span>
        <span class="n">bijector</span><span class="o">=</span><span class="n">bijectors</span><span class="p">)</span>       

    <span class="n">kernel</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">mcmc</span><span class="o">.</span><span class="n">SimpleStepSizeAdaptation</span><span class="p">(</span>
        <span class="n">inner_kernel</span><span class="o">=</span><span class="n">inner_kernel</span><span class="p">,</span>
        <span class="n">target_accept_prob</span><span class="o">=</span><span class="mf">.8</span><span class="p">,</span>
        <span class="n">num_adaptation_steps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.8</span><span class="o">*</span><span class="n">burnin</span><span class="p">),</span>
        <span class="n">log_accept_prob_getter_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">pkr</span><span class="p">:</span> <span class="n">pkr</span><span class="o">.</span><span class="n">inner_results</span><span class="o">.</span><span class="n">log_accept_ratio</span>
    <span class="p">)</span>    

    <span class="n">results</span><span class="p">,</span> <span class="n">sampler_stat</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">mcmc</span><span class="o">.</span><span class="n">sample_chain</span><span class="p">(</span>
        <span class="n">num_results</span><span class="o">=</span><span class="n">num_samples</span><span class="p">,</span>
        <span class="n">num_burnin_steps</span><span class="o">=</span><span class="n">burnin</span><span class="p">,</span>
        <span class="n">current_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
        <span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span>
        <span class="n">trace_fn</span><span class="o">=</span><span class="n">_trace_fn_transitioned</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="n">sampler_stat</span>    

<span class="k">def</span> <span class="nf">sample_posterior</span><span class="p">(</span><span class="n">jdc</span><span class="p">,</span> 
              <span class="n">observed_data</span><span class="p">,</span> 
              <span class="n">params</span><span class="p">,</span> 
              <span class="n">init_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
              <span class="n">bijectors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
              <span class="n">step_size</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
              <span class="n">num_chains</span><span class="o">=</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">,</span>                  
              <span class="n">num_samples</span><span class="o">=</span><span class="n">NUMBER_OF_SAMPLES</span><span class="p">,</span> 
              <span class="n">burnin</span><span class="o">=</span><span class="n">NUMBER_OF_BURNIN</span><span class="p">):</span>
        
    <span class="k">if</span> <span class="n">init_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">init_state</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">jdc</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">bijectors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span><span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">init_state</span><span class="p">]</span>

    <span class="n">target_log_prob_fn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">x</span><span class="p">:</span> <span class="n">jdc</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">observed_data</span><span class="p">)</span>  

    <span class="n">results</span><span class="p">,</span> <span class="n">sample_stats</span> <span class="o">=</span> <span class="n">run_hmc_chain</span><span class="p">(</span><span class="n">init_state</span><span class="p">,</span>
                                  <span class="n">bijectors</span><span class="p">,</span>
                                  <span class="n">step_size</span><span class="o">=</span><span class="n">step_size</span><span class="p">,</span>
                                  <span class="n">target_log_prob_fn</span><span class="o">=</span><span class="n">target_log_prob_fn</span><span class="p">,</span>                                      
                                  <span class="n">num_samples</span><span class="o">=</span><span class="n">num_samples</span><span class="p">,</span> 
                                  <span class="n">burnin</span><span class="o">=</span><span class="n">burnin</span><span class="p">)</span>

    <span class="n">stat_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mean_tree_accept&#39;</span><span class="p">]</span>
    <span class="n">sampler_stats</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">stat_names</span><span class="p">,</span> <span class="p">[</span><span class="n">sample_stats</span><span class="p">]))</span>      
        
    <span class="n">transposed_results</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">transposed_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">transposed_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">transposed_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> 
        
        <span class="n">transposed_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">transposed_shape</span><span class="p">))</span>

    <span class="n">posterior</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">transposed_results</span><span class="p">))</span>        

    <span class="n">az_trace</span> <span class="o">=</span> <span class="n">_trace_to_arviz</span><span class="p">(</span><span class="n">trace</span><span class="o">=</span><span class="n">posterior</span><span class="p">,</span> 
                           <span class="n">sample_stats</span><span class="o">=</span><span class="n">sampler_stats</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">posterior</span><span class="p">,</span> <span class="n">az_trace</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### DATASET URLS &amp; Utils</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># You could change base url to local dir or a remoate raw github content</span>
<span class="n">_BASE_URL</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/rmcelreath/rethinking/master/data&quot;</span>

<span class="n">WAFFLE_DIVORCE_DATASET_PATH</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_BASE_URL</span><span class="si">}</span><span class="s2">/WaffleDivorce.csv&quot;</span>
<span class="n">MILK_DATASET_PATH</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_BASE_URL</span><span class="si">}</span><span class="s2">/milk.csv&quot;</span>
<span class="n">HOWELL_DATASET_PATH</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_BASE_URL</span><span class="si">}</span><span class="s2">/Howell1.csv&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># A utility method to convert data (columns) from pandas dataframe</span>
<span class="c1"># into tensors with appropriate type</span>
<span class="k">def</span> <span class="nf">df_to_tensors</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">default_type</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; name : Name of the dataset</span>
<span class="sd">        df : pandas dataframe</span>
<span class="sd">        colums : a list of names that have the same type or</span>
<span class="sd">                 a dictionary where keys are the column names and values are the tensorflow type (e.g. tf.float32)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
        <span class="n">column_names</span> <span class="o">=</span> <span class="n">columns</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">columns</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>    
    <span class="k">else</span><span class="p">:</span>
        <span class="n">column_names</span> <span class="o">=</span> <span class="n">columns</span>        
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">default_type</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">]</span>    
        
    <span class="c1"># build the cls</span>
    <span class="n">tuple_cls</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">column_names</span><span class="p">)</span>    
    <span class="c1"># build the obj</span>
    <span class="k">return</span> <span class="n">tuple_cls</span><span class="o">.</span><span class="n">_make</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> 
</pre></div>
</div>
</div>
</div>
<p><strong>Berkson’s paradox</strong> - A <em>false</em> observation of a <em>negative</em> coorelation between 2 positive traits.</p>
<p>Members of a population which have some positive trait tend to lack a second even though -:</p>
<ul class="simple">
<li><p>The traits may be unrelated</p></li>
<li><p>Or, they may be even positively related.</p></li>
</ul>
<p>e.g Resturants at good location have bad food even though location &amp; food have no correlation</p>
<p><strong>Berkon’s paradox</strong> is also called <strong>selection-distortion effect</strong>.</p>
<p>The gist of the idea here is that when a sample is selected on a combination of 2 (or more) variables, the relationship between those 2 variables is different after selection than it was before.</p>
<p>Because of above, we should always be cautious of adding more predictor variables to our regression as it may introduce statistical selection with in the model. The phenomenon has a name and it is called <strong>COLLIDER BIAS</strong>.</p>
<p>There are actually 3 types of hazards when we add more predictor variables -</p>
<ul class="simple">
<li><p>Multicollinearity</p></li>
<li><p>Post treatment bias</p></li>
<li><p>Collider bias</p></li>
</ul>
<p>Collider - a beam in which two particles are made to collide (collision)</p>
<div class="section" id="overthinking-simulated-science-distorion">
<h2>Overthinking : Simulated Science Distorion<a class="headerlink" href="#overthinking-simulated-science-distorion" title="Permalink to this headline">¶</a></h2>
<div class="section" id="code-6-1">
<h3>Code 6.1<a class="headerlink" href="#code-6-1" title="Permalink to this headline">¶</a></h3>
<p>A simulated example to demonstrate selection-distortion effect. It has been observed that newsworthiness and trustworthiness of papers accepted by journal are factors in getting the funding.</p>
<p>Below code shows how they correlated with each other.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># A simulated example to demonstrate selection-disortion </span>
<span class="c1">#</span>
<span class="c1"># Here</span>

<span class="n">_SEED</span> <span class="o">=</span> <span class="mi">1914</span>

<span class="n">N</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">p</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># proportion to select</span>

<span class="c1"># uncorrelated newsworthiness &amp; trustworthiness</span>
<span class="n">seed</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">SeedStream</span><span class="p">(</span><span class="n">_SEED</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">nw</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">())</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">seed</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">SeedStream</span><span class="p">(</span><span class="n">_SEED</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">tw</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">())</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

<span class="c1"># select top 10% of combined scores</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">nw</span> <span class="o">+</span> <span class="n">tw</span>  <span class="c1"># total score</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span>  <span class="c1"># top 10% threshold</span>

<span class="n">selected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">s</span> <span class="o">&gt;=</span> <span class="n">q</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">tw</span><span class="p">[</span><span class="n">selected</span><span class="p">],</span> <span class="n">nw</span><span class="p">[</span><span class="n">selected</span><span class="p">])[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-01-17 23:43:16.288237: W tensorflow/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library &#39;libcuda.so.1&#39;; dlerror: libcuda.so.1: cannot open shared object file: No such file or directory
2022-01-17 23:43:16.288274: W tensorflow/stream_executor/cuda/cuda_driver.cc:269] failed call to cuInit: UNKNOWN ERROR (303)
2022-01-17 23:43:16.288296: I tensorflow/stream_executor/cuda/cuda_diagnostics.cc:156] kernel driver does not appear to be running on this host (fv-az272-145): /proc/driver/nvidia/version does not exist
2022-01-17 23:43:16.288618: I tensorflow/core/platform/cpu_feature_guard.cc:151] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  AVX2 AVX512F FMA
To enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-0.828225254885134
</pre></div>
</div>
</div>
</div>
<p>This shows that nw (newsworthiness) &amp; tw (trustworthiness) are <strong>heavily negivately correlated</strong>.</p>
</div>
</div>
<div class="section" id="multicollinearity">
<h2>6.1 Multicollinearity<a class="headerlink" href="#multicollinearity" title="Permalink to this headline">¶</a></h2>
<p><strong>Multicollinearity</strong> happens when the predictor variables are stronly correlated.</p>
<p>When this happens the posterior distribution will seem to suggest that none of the variables is reliably associated with the outcome.</p>
<p>Model will still infer correct results but it would be difficult to understand it.</p>
<div class="section" id="multicollinear-legs">
<h3>6.1.1 Multicollinear legs<a class="headerlink" href="#multicollinear-legs" title="Permalink to this headline">¶</a></h3>
<p>Here we create an artifical dataset about height &amp; its relation to the length of the legs as predictor variables.</p>
<p>The two legs are more or less of same length so they are correlated with each other. Including both of the legs as the predictors result in multicollinearity</p>
<div class="section" id="code-6-2">
<h4>Code 6.2<a class="headerlink" href="#code-6-2" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_SEED</span> <span class="o">=</span> <span class="mi">909</span>

<span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>

<span class="k">def</span> <span class="nf">generate_height_leg_data</span><span class="p">():</span>
    <span class="n">seed</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">SeedStream</span><span class="p">(</span><span class="n">_SEED</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="s2">&quot;leg_exp&quot;</span><span class="p">)</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">2.</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">())</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">leg_prop</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">())</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

    <span class="c1"># left &amp; right leg as proportion + error</span>
    <span class="n">leg_left</span> <span class="o">=</span> <span class="n">leg_prop</span> <span class="o">*</span> <span class="n">height</span> <span class="o">+</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">())</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

    <span class="n">leg_right</span> <span class="o">=</span> <span class="n">leg_prop</span> <span class="o">*</span> <span class="n">height</span> <span class="o">+</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">())</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

    <span class="c1"># build a dataframe using above</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s2">&quot;height&quot;</span> <span class="p">:</span> <span class="n">height</span><span class="p">,</span>
        <span class="s2">&quot;leg_left&quot;</span> <span class="p">:</span> <span class="n">leg_left</span><span class="p">,</span>
        <span class="s2">&quot;leg_right&quot;</span> <span class="p">:</span> <span class="n">leg_right</span>
    <span class="p">})</span>

    <span class="k">return</span> <span class="n">d</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">generate_height_leg_data</span><span class="p">()</span>

<span class="n">d</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>height</th>
      <th>leg_left</th>
      <th>leg_right</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>100.000000</td>
      <td>100.000000</td>
      <td>100.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>10.244188</td>
      <td>4.586804</td>
      <td>4.589090</td>
    </tr>
    <tr>
      <th>std</th>
      <td>1.971723</td>
      <td>0.856999</td>
      <td>0.857432</td>
    </tr>
    <tr>
      <th>min</th>
      <td>6.569585</td>
      <td>2.711091</td>
      <td>2.734310</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>8.705090</td>
      <td>3.959075</td>
      <td>3.970327</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>10.478082</td>
      <td>4.628943</td>
      <td>4.644671</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>11.372977</td>
      <td>5.143220</td>
      <td>5.147640</td>
    </tr>
    <tr>
      <th>max</th>
      <td>15.219750</td>
      <td>7.189007</td>
      <td>7.178730</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="code-6-3">
<h4>Code 6.3<a class="headerlink" href="#code-6-3" title="Permalink to this headline">¶</a></h4>
<p>Very vague and bad priors are used in the model here so that we can be sure that priors are not responsible for what we are about to observe</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tdf</span> <span class="o">=</span> <span class="n">df_to_tensors</span><span class="p">(</span><span class="s1">&#39;SimulatedHeight&#39;</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;leg_left&#39;</span><span class="p">,</span> <span class="s1">&#39;leg_right&#39;</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">model_6_1</span><span class="p">(</span><span class="n">leg_left_data</span><span class="p">,</span> <span class="n">leg_right_data</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
      <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">100.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;alpha&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">betaL</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">2.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;betaL&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">betaR</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">2.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;betaR&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

      <span class="n">mu</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span>
          <span class="n">alpha</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> \
          <span class="n">betaL</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">leg_left_data</span> <span class="o">+</span> \
          <span class="n">betaR</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">leg_right_data</span>
      <span class="p">)</span>
        
      <span class="n">scale</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        
      <span class="n">height</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span>
                      <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;height&quot;</span><span class="p">),</span> 
                      <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    
    
<span class="n">jdc_6_1</span> <span class="o">=</span> <span class="n">model_6_1</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">leg_left</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">leg_right</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NUM_CHAINS_FOR_6_1</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c1"># Note - </span>
<span class="c1"># I got somewhat ok looking results with this init values</span>
<span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_1</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_1</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_1</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_1</span><span class="p">])</span>    
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">()</span>
<span class="p">]</span>

<span class="n">observed_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="p">)</span>

<span class="n">posterior_6_1</span><span class="p">,</span> <span class="n">trace_6_1</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                                <span class="n">jdc_6_1</span><span class="p">,</span> 
                                <span class="n">observed_data</span><span class="o">=</span><span class="n">observed_data</span><span class="p">,</span> 
                                <span class="n">num_chains</span><span class="o">=</span><span class="n">NUM_CHAINS_FOR_6_1</span><span class="p">,</span>
                                <span class="n">init_state</span> <span class="o">=</span> <span class="n">init_state</span><span class="p">,</span>
                                <span class="n">bijectors</span> <span class="o">=</span> <span class="n">bijectors</span><span class="p">,</span>
                                <span class="n">num_samples</span><span class="o">=</span><span class="mi">4000</span><span class="p">,</span>
                                <span class="n">burnin</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                                <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;betaL&#39;</span><span class="p">,</span> <span class="s1">&#39;betaR&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">])</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_6_1</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha</th>
      <td>0.362</td>
      <td>0.351</td>
      <td>-0.178</td>
      <td>0.936</td>
      <td>0.048</td>
      <td>0.036</td>
      <td>53.0</td>
      <td>80.0</td>
      <td>1.03</td>
    </tr>
    <tr>
      <th>betaL</th>
      <td>-0.564</td>
      <td>0.729</td>
      <td>-1.605</td>
      <td>0.726</td>
      <td>0.177</td>
      <td>0.127</td>
      <td>18.0</td>
      <td>28.0</td>
      <td>1.05</td>
    </tr>
    <tr>
      <th>betaR</th>
      <td>2.717</td>
      <td>0.754</td>
      <td>1.431</td>
      <td>3.862</td>
      <td>0.182</td>
      <td>0.131</td>
      <td>18.0</td>
      <td>28.0</td>
      <td>1.04</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>0.661</td>
      <td>0.048</td>
      <td>0.589</td>
      <td>0.740</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>1144.0</td>
      <td>1311.0</td>
      <td>1.00</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Notice betaL and betaR values. How can they be so different ? Afterall we know that the legs are more or less of same lenght so their effects should be both equal. This is confusing indeed !</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">trace_6_1</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span> <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06_the_haunted_dag_and_the_causal_terror_25_0.png" src="../_images/06_the_haunted_dag_and_the_causal_terror_25_0.png" />
</div>
</div>
</div>
<div class="section" id="code-6-5">
<h4>Code 6.5<a class="headerlink" href="#code-6-5" title="Permalink to this headline">¶</a></h4>
<p>Looking at the bivariate posterior distribution for betaR &amp; betaL.</p>
<p>Since both variables contain identical information, the posterior is a narrow ridge of negatively correlated values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">posterior_6_1</span><span class="p">[</span><span class="s1">&#39;betaR&#39;</span><span class="p">],</span> <span class="n">posterior_6_1</span><span class="p">[</span><span class="s1">&#39;betaL&#39;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;br&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;bl&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06_the_haunted_dag_and_the_causal_terror_27_0.png" src="../_images/06_the_haunted_dag_and_the_causal_terror_27_0.png" />
</div>
</div>
</div>
<div class="section" id="code-6-6">
<h4>Code 6.6<a class="headerlink" href="#code-6-6" title="Permalink to this headline">¶</a></h4>
<p>Below plot shows that the posterior distribution of sum of the two parameters is centered on the proper association of either leg with height</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sum_blbr</span> <span class="o">=</span> <span class="n">posterior_6_1</span><span class="p">[</span><span class="s2">&quot;betaL&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">posterior_6_1</span><span class="p">[</span><span class="s2">&quot;betaR&quot;</span><span class="p">]</span>
<span class="n">az</span><span class="o">.</span><span class="n">plot_kde</span><span class="p">(</span><span class="n">sum_blbr</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;sum of bl and br&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06_the_haunted_dag_and_the_causal_terror_29_0.png" src="../_images/06_the_haunted_dag_and_the_causal_terror_29_0.png" />
</div>
</div>
</div>
<div class="section" id="code-6-7">
<h4>Code 6.7<a class="headerlink" href="#code-6-7" title="Permalink to this headline">¶</a></h4>
<p>We will now do the regression using only one leg and the posterior mean will be approximately the same.</p>
<p>Building the model using only left leg.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_6_2</span><span class="p">(</span><span class="n">leg_left_data</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
      <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">100.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;alpha&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">betaL</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">2.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;betaL&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

      <span class="n">mu</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span>
          <span class="n">alpha</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> \
          <span class="n">betaL</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">leg_left_data</span>
      <span class="p">)</span>
        
      <span class="n">scale</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        
      <span class="n">height</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span>
                      <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;height&quot;</span><span class="p">),</span> 
                      <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    
    
<span class="n">jdc_6_2</span> <span class="o">=</span> <span class="n">model_6_2</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">leg_left</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NUM_CHAINS_FOR_6_2</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c1"># Note - </span>
<span class="c1"># I got somewhat ok looking results with this init values</span>
<span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_2</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_2</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_1</span><span class="p">])</span>    
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">()</span>
<span class="p">]</span>

<span class="n">observed_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="p">)</span>

<span class="n">posterior_6_2</span><span class="p">,</span> <span class="n">trace_6_2</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                                <span class="n">jdc_6_2</span><span class="p">,</span> 
                                <span class="n">observed_data</span><span class="o">=</span><span class="n">observed_data</span><span class="p">,</span> 
                                <span class="n">num_chains</span><span class="o">=</span><span class="n">NUM_CHAINS_FOR_6_2</span><span class="p">,</span>
                                <span class="n">init_state</span> <span class="o">=</span> <span class="n">init_state</span><span class="p">,</span>
                                <span class="n">bijectors</span> <span class="o">=</span> <span class="n">bijectors</span><span class="p">,</span>
                                <span class="n">num_samples</span><span class="o">=</span><span class="mi">4000</span><span class="p">,</span>
                                <span class="n">burnin</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                                <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;betaL&#39;</span><span class="p">,</span><span class="s1">&#39;sigma&#39;</span><span class="p">])</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_6_2</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha</th>
      <td>0.214</td>
      <td>0.346</td>
      <td>-0.382</td>
      <td>0.734</td>
      <td>0.034</td>
      <td>0.024</td>
      <td>103.0</td>
      <td>196.0</td>
      <td>1.03</td>
    </tr>
    <tr>
      <th>betaL</th>
      <td>2.186</td>
      <td>0.074</td>
      <td>2.074</td>
      <td>2.311</td>
      <td>0.007</td>
      <td>0.005</td>
      <td>105.0</td>
      <td>194.0</td>
      <td>1.03</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>0.663</td>
      <td>0.049</td>
      <td>0.587</td>
      <td>0.742</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>1444.0</td>
      <td>729.0</td>
      <td>1.00</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The value of <code class="docutils literal notranslate"><span class="pre">betaL</span></code> is now identical to <code class="docutils literal notranslate"><span class="pre">sum</span> <span class="pre">of</span> <span class="pre">betaL</span> <span class="pre">&amp;</span> <span class="pre">betaL</span></code> (see the chart from Code 6.6) from previous models</p>
</div>
</div>
<div class="section" id="multicollinear-milk">
<h3>6.1.2 Multicollinear milk<a class="headerlink" href="#multicollinear-milk" title="Permalink to this headline">¶</a></h3>
<p>In real datasets, it may be difficult to identify the highly correlated predictors. This has the consequence of coming to a conclusion that none of the predictor is significant.</p>
<p>Here the primate milk dataset is used as another example for multicollinearity challenge.</p>
<div class="section" id="code-6-8">
<h4>Code 6.8<a class="headerlink" href="#code-6-8" title="Permalink to this headline">¶</a></h4>
<p>Loading the dataset and creating new standardized (centered) columns</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">MILK_DATASET_PATH</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>

<span class="n">d</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;kcal.per.g&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
<span class="n">d</span><span class="p">[</span><span class="s2">&quot;F&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;perc.fat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
<span class="n">d</span><span class="p">[</span><span class="s2">&quot;L&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;perc.lactose&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tdf</span> <span class="o">=</span> <span class="n">df_to_tensors</span><span class="p">(</span><span class="s2">&quot;Milk&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-6-9">
<h4>Code 6.9<a class="headerlink" href="#code-6-9" title="Permalink to this headline">¶</a></h4>
<p>We are building 2 models here.</p>
<ul class="simple">
<li><p>KCal regressed on perc.fat</p></li>
<li><p>KCal regressed on perc.lactose</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># KCal is regressed on perc.fat</span>



<span class="k">def</span> <span class="nf">model_6_3</span><span class="p">(</span><span class="n">per_fat</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
      <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;alpha&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">betaF</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;betaF&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>      
      <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>    

      <span class="n">mu</span> <span class="o">=</span>  <span class="n">alpha</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">betaF</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">per_fat</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
      <span class="n">scale</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  
        
      <span class="n">K</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;K&quot;</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    
    
<span class="n">jdc_6_3</span> <span class="o">=</span> <span class="n">model_6_3</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">F</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NUM_CHAINS_FOR_6_3</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_3</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_3</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_3</span><span class="p">]),</span>    
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>    
    <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">()</span>
<span class="p">]</span>

<span class="n">posterior_6_3</span><span class="p">,</span> <span class="n">trace_6_3</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                            <span class="n">jdc_6_3</span><span class="p">,</span> 
                            <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">K</span><span class="p">,),</span>
                            <span class="n">init_state</span> <span class="o">=</span> <span class="n">init_state</span><span class="p">,</span>
                            <span class="n">bijectors</span> <span class="o">=</span> <span class="n">bijectors</span><span class="p">,</span>
                            <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;betaF&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># KCal is regressed on perc.lactose</span>

<span class="k">def</span> <span class="nf">model_6_4</span><span class="p">(</span><span class="n">per_lac</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
      <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;alpha&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">betaL</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;betaL&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>      
      <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    
      <span class="n">mu</span> <span class="o">=</span>  <span class="n">alpha</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">betaL</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">per_lac</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
      <span class="n">scale</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  
        
      <span class="n">K</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;K&quot;</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    
    
<span class="n">jdc_6_4</span> <span class="o">=</span> <span class="n">model_6_4</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">L</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NUM_CHAINS_FOR_6_4</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_4</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_4</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_4</span><span class="p">]),</span>    
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>    
    <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">()</span>
<span class="p">]</span>

<span class="n">posterior_6_4</span><span class="p">,</span> <span class="n">trace_6_4</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                                <span class="n">jdc_6_4</span><span class="p">,</span> 
                                <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">K</span><span class="p">,),</span>
                                <span class="n">init_state</span> <span class="o">=</span> <span class="n">init_state</span><span class="p">,</span>
                                <span class="n">bijectors</span> <span class="o">=</span> <span class="n">bijectors</span><span class="p">,</span>
                                <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;betaL&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_6_3</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha</th>
      <td>0.016</td>
      <td>0.084</td>
      <td>-0.109</td>
      <td>0.149</td>
      <td>0.008</td>
      <td>0.006</td>
      <td>99.0</td>
      <td>110.0</td>
      <td>1.03</td>
    </tr>
    <tr>
      <th>betaF</th>
      <td>0.858</td>
      <td>0.090</td>
      <td>0.704</td>
      <td>0.988</td>
      <td>0.009</td>
      <td>0.007</td>
      <td>81.0</td>
      <td>356.0</td>
      <td>1.04</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>0.486</td>
      <td>0.068</td>
      <td>0.379</td>
      <td>0.585</td>
      <td>0.002</td>
      <td>0.002</td>
      <td>687.0</td>
      <td>148.0</td>
      <td>1.01</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_6_4</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha</th>
      <td>0.004</td>
      <td>0.075</td>
      <td>-0.111</td>
      <td>0.132</td>
      <td>0.006</td>
      <td>0.005</td>
      <td>135.0</td>
      <td>172.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>betaL</th>
      <td>-0.900</td>
      <td>0.081</td>
      <td>-1.021</td>
      <td>-0.774</td>
      <td>0.007</td>
      <td>0.005</td>
      <td>154.0</td>
      <td>202.0</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>0.412</td>
      <td>0.058</td>
      <td>0.337</td>
      <td>0.496</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>541.0</td>
      <td>227.0</td>
      <td>1.03</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Posterior for betaF &amp; betaL are mirror images of each other.</p>
<p>This seems to imply that both predictors have strong association with the outcome. Notice the <code class="docutils literal notranslate"><span class="pre">sd</span></code> of both the predictors; they are quite low.</p>
<p>In next section we will see what happens when we combine both of them in the regression model</p>
</div>
<div class="section" id="code-6-10">
<h4>Code 6.10<a class="headerlink" href="#code-6-10" title="Permalink to this headline">¶</a></h4>
<p>We build a model where we include both of the predictors (per_fat &amp; per_lac)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_6_5</span><span class="p">(</span><span class="n">per_fat</span><span class="p">,</span> <span class="n">per_lac</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
      <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;alpha&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">betaF</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;betaF&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>      
      <span class="n">betaL</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;betaL&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>      
      <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    
      <span class="n">mu</span> <span class="o">=</span>  <span class="n">alpha</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> \
                    <span class="n">betaF</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">per_fat</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span> <span class="o">+</span> \
                    <span class="n">betaL</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">per_lac</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
    
      <span class="n">scale</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  
        
      <span class="n">K</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;K&quot;</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    
    
<span class="n">jdc_6_5</span> <span class="o">=</span> <span class="n">model_6_5</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">F</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">L</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NUM_CHAINS_FOR_6_5</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_5</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_5</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_5</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_5</span><span class="p">])</span>    
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">()</span>
<span class="p">]</span>

<span class="n">posterior_6_5</span><span class="p">,</span> <span class="n">trace_6_5</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                    <span class="n">jdc_6_5</span><span class="p">,</span> 
                    <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">K</span><span class="p">,),</span> 
                    <span class="n">num_chains</span><span class="o">=</span><span class="n">NUM_CHAINS_FOR_6_5</span><span class="p">,</span>
                    <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                    <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;betaF&#39;</span><span class="p">,</span> <span class="s1">&#39;betaL&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">])</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_6_5</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:5 out of the last 5 calls to &lt;function run_hmc_chain at 0x7f1da680fa70&gt; triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has experimental_relax_shapes=True option that relaxes argument shapes that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha</th>
      <td>-0.003</td>
      <td>0.070</td>
      <td>-0.107</td>
      <td>0.113</td>
      <td>0.005</td>
      <td>0.003</td>
      <td>223.0</td>
      <td>345.0</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>betaF</th>
      <td>0.235</td>
      <td>0.194</td>
      <td>-0.071</td>
      <td>0.529</td>
      <td>0.013</td>
      <td>0.009</td>
      <td>182.0</td>
      <td>80.0</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>betaL</th>
      <td>-0.701</td>
      <td>0.186</td>
      <td>-1.020</td>
      <td>-0.420</td>
      <td>0.014</td>
      <td>0.011</td>
      <td>184.0</td>
      <td>62.0</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>0.411</td>
      <td>0.060</td>
      <td>0.325</td>
      <td>0.502</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>369.0</td>
      <td>131.0</td>
      <td>1.01</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Notice how the standard deviations of the posterior for betaF &amp; betaL has jumped up significantly.</p>
<p>per_fat &amp; per_lac both contain much of the same information and can be substitued for each other. Therefore, the model has not choice but to describe a long ridge of combination of betaF &amp; betaL that are equally plaussible.</p>
</div>
<div class="section" id="code-6-11">
<h4>Code 6.11<a class="headerlink" href="#code-6-11" title="Permalink to this headline">¶</a></h4>
<p>We plot again like in the legs example to visualize the relationship</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_pair</span><span class="p">(</span><span class="n">d</span><span class="p">[[</span><span class="s2">&quot;kcal.per.g&quot;</span><span class="p">,</span> <span class="s2">&quot;perc.fat&quot;</span><span class="p">,</span> <span class="s2">&quot;perc.lactose&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s2">&quot;list&quot;</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06_the_haunted_dag_and_the_causal_terror_51_0.png" src="../_images/06_the_haunted_dag_and_the_causal_terror_51_0.png" />
</div>
</div>
<ul class="simple">
<li><p>perc.fat is positively related to outcome</p></li>
<li><p>perc.lac is negatively related to outcome</p></li>
<li><p>perc.fat &amp; perc.lac are negatively coorelated to each other</p></li>
</ul>
<p>Either of them helps in predicting KCal but neither helps much once we already know the other.</p>
</div>
</div>
<div class="section" id="overthinking-simulating-collinearity">
<h3>Overthinking : Simulating collinearity<a class="headerlink" href="#overthinking-simulating-collinearity" title="Permalink to this headline">¶</a></h3>
<p>Simulating collinearity using Milk dataset</p>
<div class="section" id="code-6-12">
<h4>Code 6.12<a class="headerlink" href="#code-6-12" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">MILK_DATASET_PATH</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">simcoll</span><span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">):</span>
    
    <span class="n">mean</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;perc.fat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">r</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;perc.fat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
    
    <span class="n">x</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sd</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
    
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;perc.fat&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">))</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">linear_model</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;kcal.per.g&#39;</span><span class="p">],</span> <span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
    <span class="n">cov</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">cov_params</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cov</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mf">0.5</span>
    
<span class="k">def</span> <span class="nf">repsimcoll</span><span class="p">(</span><span class="n">r</span><span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="mi">100</span><span class="p">):</span>
    <span class="n">stddev</span> <span class="o">=</span> <span class="p">[</span><span class="n">simcoll</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">stddev</span><span class="p">)</span>

<span class="n">lista</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="mf">0.99</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">):</span>   
    <span class="n">lista</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">repsimcoll</span> <span class="p">(</span><span class="n">r</span><span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="mi">100</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="mf">0.99</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">),</span> <span class="n">lista</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;correlation&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;stddev&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">ipykernel_2130</span><span class="o">/</span><span class="mf">2851539633.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">     </span><span class="mi">19</span> <span class="n">lista</span> <span class="o">=</span> <span class="p">[]</span>
<span class="g g-Whitespace">     </span><span class="mi">20</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="mf">0.99</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">):</span>
<span class="ne">---&gt; </span><span class="mi">21</span>     <span class="n">lista</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">repsimcoll</span> <span class="p">(</span><span class="n">r</span><span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="mi">100</span><span class="p">))</span>
<span class="g g-Whitespace">     </span><span class="mi">22</span> 
<span class="g g-Whitespace">     </span><span class="mi">23</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="mf">0.99</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">),</span> <span class="n">lista</span><span class="p">)</span>

<span class="nn">/tmp/ipykernel_2130/2851539633.py</span> in <span class="ni">repsimcoll</span><span class="nt">(r, N)</span>
<span class="g g-Whitespace">     </span><span class="mi">14</span> 
<span class="g g-Whitespace">     </span><span class="mi">15</span> <span class="k">def</span> <span class="nf">repsimcoll</span><span class="p">(</span><span class="n">r</span><span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="mi">100</span><span class="p">):</span>
<span class="ne">---&gt; </span><span class="mi">16</span>     <span class="n">stddev</span> <span class="o">=</span> <span class="p">[</span><span class="n">simcoll</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span>     <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">stddev</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">18</span> 

<span class="nn">/tmp/ipykernel_2130/2851539633.py</span> in <span class="ni">&lt;listcomp&gt;</span><span class="nt">(.0)</span>
<span class="g g-Whitespace">     </span><span class="mi">14</span> 
<span class="g g-Whitespace">     </span><span class="mi">15</span> <span class="k">def</span> <span class="nf">repsimcoll</span><span class="p">(</span><span class="n">r</span><span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="mi">100</span><span class="p">):</span>
<span class="ne">---&gt; </span><span class="mi">16</span>     <span class="n">stddev</span> <span class="o">=</span> <span class="p">[</span><span class="n">simcoll</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span>     <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">stddev</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">18</span> 

<span class="nn">/tmp/ipykernel_2130/2851539633.py</span> in <span class="ni">simcoll</span><span class="nt">(r)</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>     <span class="n">sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">r</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;perc.fat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> 
<span class="ne">----&gt; </span><span class="mi">8</span>     <span class="n">x</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sd</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span> 
<span class="g g-Whitespace">     </span><span class="mi">10</span>     <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;perc.fat&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">))</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow_probability/python/distributions/distribution.py</span> in <span class="ni">sample</span><span class="nt">(self, sample_shape, seed, name, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1232</span>     <span class="s2">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">   </span><span class="mi">1233</span><span class="s2">     with self._name_and_control_scope(name):</span>
<span class="ne">-&gt; </span><span class="mi">1234</span><span class="s2">       return self._call_sample_n(sample_shape, seed, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1235</span><span class="s2"> </span>
<span class="g g-Whitespace">   </span><span class="mi">1236</span><span class="s2">   def _call_sample_and_log_prob(self, sample_shape, seed, **kwargs):</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow_probability/python/distributions/distribution.py</span> in <span class="ni">_call_sample_n</span><span class="nt">(self, sample_shape, seed, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1210</span><span class="s2">         sample_shape, &#39;sample_shape&#39;)</span>
<span class="g g-Whitespace">   </span><span class="mi">1211</span><span class="s2">     samples = self._sample_n(</span>
<span class="ne">-&gt; </span><span class="mi">1212</span><span class="s2">         n, seed=seed() if callable(seed) else seed, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1213</span><span class="s2">     samples = tf.nest.map_structure(</span>
<span class="g g-Whitespace">   </span><span class="mi">1214</span><span class="s2">         lambda x: tf.reshape(x, ps.concat([sample_shape, ps.shape(x)[1:]], 0)),</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow_probability/python/distributions/normal.py</span> in <span class="ni">_sample_n</span><span class="nt">(self, n, seed)</span>
<span class="g g-Whitespace">    </span><span class="mi">178</span><span class="s2">                       axis=0)</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span><span class="s2">     sampled = samplers.normal(</span>
<span class="ne">--&gt; </span><span class="mi">180</span><span class="s2">         shape=shape, mean=0., stddev=1., dtype=self.dtype, seed=seed)</span>
<span class="g g-Whitespace">    </span><span class="mi">181</span><span class="s2">     return sampled * scale + loc</span>
<span class="g g-Whitespace">    </span><span class="mi">182</span><span class="s2"> </span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow_probability/python/internal/samplers.py</span> in <span class="ni">normal</span><span class="nt">(shape, mean, stddev, dtype, seed, name)</span>
<span class="g g-Whitespace">    </span><span class="mi">238</span><span class="s2">     if is_stateful_seed(seed):</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span><span class="s2">       return tf.random.normal(</span>
<span class="ne">--&gt; </span><span class="mi">240</span><span class="s2">           shape=shape, seed=seed, mean=mean, stddev=stddev, dtype=dtype)</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span><span class="s2"> </span>
<span class="g g-Whitespace">    </span><span class="mi">242</span><span class="s2">     seed = sanitize_seed(seed)</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/util/traceback_utils.py</span> in <span class="ni">error_handler</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">148</span><span class="s2">     filtered_tb = None</span>
<span class="g g-Whitespace">    </span><span class="mi">149</span><span class="s2">     try:</span>
<span class="ne">--&gt; </span><span class="mi">150</span><span class="s2">       return fn(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">151</span><span class="s2">     except Exception as e:</span>
<span class="g g-Whitespace">    </span><span class="mi">152</span><span class="s2">       filtered_tb = _process_traceback_frames(e.__traceback__)</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/util/dispatch.py</span> in <span class="ni">op_dispatch_handler</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1094</span><span class="s2">       # Fallback dispatch system (dispatch v1):</span>
<span class="g g-Whitespace">   </span><span class="mi">1095</span><span class="s2">       try:</span>
<span class="ne">-&gt; </span><span class="mi">1096</span><span class="s2">         return dispatch_target(*args, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1097</span><span class="s2">       except (TypeError, ValueError):</span>
<span class="g g-Whitespace">   </span><span class="mi">1098</span><span class="s2">         # Note: convert_to_eager_tensor currently raises a ValueError, not a</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/ops/random_ops.py</span> in <span class="ni">random_normal</span><span class="nt">(shape, mean, stddev, dtype, seed, name)</span>
<span class="g g-Whitespace">     </span><span class="mi">95</span><span class="s2">         shape_tensor, dtype, seed=seed1, seed2=seed2)</span>
<span class="g g-Whitespace">     </span><span class="mi">96</span><span class="s2">     mul = rnd * stddev_tensor</span>
<span class="ne">---&gt; </span><span class="mi">97</span><span class="s2">     value = math_ops.add(mul, mean_tensor, name=name)</span>
<span class="g g-Whitespace">     </span><span class="mi">98</span><span class="s2">     tensor_util.maybe_set_static_shape(value, shape)</span>
<span class="g g-Whitespace">     </span><span class="mi">99</span><span class="s2">     return value</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/util/traceback_utils.py</span> in <span class="ni">error_handler</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">148</span><span class="s2">     filtered_tb = None</span>
<span class="g g-Whitespace">    </span><span class="mi">149</span><span class="s2">     try:</span>
<span class="ne">--&gt; </span><span class="mi">150</span><span class="s2">       return fn(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">151</span><span class="s2">     except Exception as e:</span>
<span class="g g-Whitespace">    </span><span class="mi">152</span><span class="s2">       filtered_tb = _process_traceback_frames(e.__traceback__)</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/util/dispatch.py</span> in <span class="ni">op_dispatch_handler</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1094</span><span class="s2">       # Fallback dispatch system (dispatch v1):</span>
<span class="g g-Whitespace">   </span><span class="mi">1095</span><span class="s2">       try:</span>
<span class="ne">-&gt; </span><span class="mi">1096</span><span class="s2">         return dispatch_target(*args, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1097</span><span class="s2">       except (TypeError, ValueError):</span>
<span class="g g-Whitespace">   </span><span class="mi">1098</span><span class="s2">         # Note: convert_to_eager_tensor currently raises a ValueError, not a</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/ops/math_ops.py</span> in <span class="ni">add</span><span class="nt">(x, y, name)</span>
<span class="g g-Whitespace">   </span><span class="mi">3988</span><span class="s2">       return gen_math_ops.add(x, y, name=name)</span>
<span class="g g-Whitespace">   </span><span class="mi">3989</span><span class="s2">     else:</span>
<span class="ne">-&gt; </span><span class="mi">3990</span><span class="s2">       return gen_math_ops.add_v2(x, y, name=name)</span>
<span class="g g-Whitespace">   </span><span class="mi">3991</span><span class="s2"> </span>
<span class="g g-Whitespace">   </span><span class="mi">3992</span><span class="s2"> </span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/ops/gen_math_ops.py</span> in <span class="ni">add_v2</span><span class="nt">(x, y, name)</span>
<span class="g g-Whitespace">    </span><span class="mi">461</span><span class="s2">     try:</span>
<span class="g g-Whitespace">    </span><span class="mi">462</span><span class="s2">       _result = pywrap_tfe.TFE_Py_FastPathExecute(</span>
<span class="ne">--&gt; </span><span class="mi">463</span><span class="s2">         _ctx, &quot;AddV2&quot;, name, x, y)</span>
<span class="g g-Whitespace">    </span><span class="mi">464</span><span class="s2">       return _result</span>
<span class="g g-Whitespace">    </span><span class="mi">465</span><span class="s2">     except _core._NotOkStatusException as e:</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="post-treatment-bias">
<h2>6.2 Post-treatment bias<a class="headerlink" href="#post-treatment-bias" title="Permalink to this headline">¶</a></h2>
<p><strong>Omitted Variable bias</strong> - Problems that arise because of <strong>not</strong> including predictior variables</p>
<p><strong>Post-treatment bias</strong> - Problems that arise becuase of including <strong>improper</strong> predictor variables</p>
<div class="section" id="code-6-13">
<h3>Code 6.13<a class="headerlink" href="#code-6-13" title="Permalink to this headline">¶</a></h3>
<p>Simulate data to see what goes wrong when we include a <strong>post-treatment</strong> variable</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_SEED</span> <span class="o">=</span> <span class="mi">71</span>

<span class="c1"># Note - even after providing SeedStream and generated seeds</span>
<span class="c1"># it still does not respect it</span>
<span class="k">def</span> <span class="nf">simulate</span><span class="p">():</span>
    <span class="n">seed</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">SeedStream</span><span class="p">(</span><span class="n">_SEED</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="s2">&quot;sim_heights&quot;</span><span class="p">)</span>

    <span class="c1"># number of plants</span>
    <span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>

    <span class="c1"># simulate initial heights</span>
    <span class="n">h0</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">2.</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">())</span>

    <span class="c1"># assign treatments and simulate fungus and growth</span>
    <span class="n">treatment</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="n">repeats</span><span class="o">=</span><span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
    
    <span class="n">fungus</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span><span class="n">total_count</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">treatment</span> <span class="o">*</span> <span class="mf">0.4</span><span class="p">))</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">())</span>
    
    <span class="n">h1</span> <span class="o">=</span> <span class="n">h0</span> <span class="o">+</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">5.</span> <span class="o">-</span> <span class="mf">3.</span> <span class="o">*</span> <span class="n">fungus</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">())</span>

    <span class="c1"># compose a clean data frame</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;h0&quot;</span><span class="p">:</span><span class="n">h0</span><span class="p">,</span> <span class="s2">&quot;h1&quot;</span><span class="p">:</span><span class="n">h1</span><span class="p">,</span> <span class="s2">&quot;treatment&quot;</span><span class="p">:</span><span class="n">treatment</span><span class="p">,</span> <span class="s2">&quot;fungus&quot;</span><span class="p">:</span><span class="n">fungus</span><span class="p">}</span>
    
    <span class="k">return</span> <span class="n">d</span>
    
<span class="n">d_dict</span> <span class="o">=</span> <span class="n">simulate</span><span class="p">()</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">d_dict</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;stats&quot;</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>h0</th>
      <td>9.894</td>
      <td>2.143</td>
      <td>6.421</td>
      <td>12.93</td>
    </tr>
    <tr>
      <th>h1</th>
      <td>13.609</td>
      <td>2.696</td>
      <td>8.782</td>
      <td>17.34</td>
    </tr>
    <tr>
      <th>treatment</th>
      <td>0.500</td>
      <td>0.503</td>
      <td>0.000</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>fungus</th>
      <td>0.350</td>
      <td>0.479</td>
      <td>0.000</td>
      <td>1.00</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d_dict</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tdf</span> <span class="o">=</span> <span class="n">df_to_tensors</span><span class="p">(</span><span class="s1">&#39;SimulatedTreatment&#39;</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;h0&#39;</span><span class="p">,</span> <span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="s1">&#39;treatment&#39;</span><span class="p">,</span> <span class="s1">&#39;fungus&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="a-prior-is-born">
<h3>6.2.1 A prior is born<a class="headerlink" href="#a-prior-is-born" title="Permalink to this headline">¶</a></h3>
<p>We will use a prior (see Code 6.14) that expects anything from 40% shrinkage up to 50% growth</p>
<div class="section" id="code-6-14">
<h4>Code 6.14<a class="headerlink" href="#code-6-14" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sim_p</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">LogNormal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="mf">1e4</span><span class="p">),))</span>
<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">({</span><span class="s2">&quot;sim_p&quot;</span> <span class="p">:</span> <span class="n">sim_p</span><span class="p">},</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;stats&quot;</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>sim_p</th>
      <td>1.028</td>
      <td>0.257</td>
      <td>0.614</td>
      <td>1.403</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="code-6-15">
<h4>Code 6.15<a class="headerlink" href="#code-6-15" title="Permalink to this headline">¶</a></h4>
<p>In this model only height (h0) as the predictor is included</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_6_6</span><span class="p">(</span><span class="n">h0</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
      <span class="n">p</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">LogNormal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;p&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>      
      <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        
      <span class="n">mu</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">h0</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="o">*</span> <span class="n">p</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
      <span class="n">scale</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  
        
      <span class="n">h1</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;h1&quot;</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    
    
<span class="n">jdc_6_6</span> <span class="o">=</span> <span class="n">model_6_6</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">h0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NUM_CHAINS_FOR_6_6</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_6</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_6</span><span class="p">])</span>    
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">()</span>
<span class="p">]</span>

<span class="n">posterior_6_6</span><span class="p">,</span> <span class="n">trace_6_6</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                    <span class="n">jdc_6_6</span><span class="p">,</span> 
                    <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">h1</span><span class="p">,),</span> 
                    <span class="n">num_chains</span><span class="o">=</span><span class="n">NUM_CHAINS_FOR_6_6</span><span class="p">,</span>
                    <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                    <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">,</span>
                    <span class="n">num_samples</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> 
                    <span class="n">burnin</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">])</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_6_6</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:6 out of the last 6 calls to &lt;function run_hmc_chain at 0x14cbd20e0&gt; triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has experimental_relax_shapes=True option that relaxes argument shapes that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>p</th>
      <td>1.357</td>
      <td>0.019</td>
      <td>1.327</td>
      <td>1.387</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>1515.0</td>
      <td>1562.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>1.903</td>
      <td>0.137</td>
      <td>1.681</td>
      <td>2.117</td>
      <td>0.004</td>
      <td>0.003</td>
      <td>1321.0</td>
      <td>1623.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The result shows that with height as the only predictor variable in the model there is about 40% growth on average.</p>
</div>
<div class="section" id="code-6-16">
<h4>Code 6.16<a class="headerlink" href="#code-6-16" title="Permalink to this headline">¶</a></h4>
<p>In this model we include treatment &amp; fungus variables as well</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_6_7</span><span class="p">(</span><span class="n">h0</span><span class="p">,</span> <span class="n">treatment</span><span class="p">,</span> <span class="n">fungus</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
      <span class="n">a</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">LogNormal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>      
      <span class="n">bt</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;bt&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>    
      <span class="n">bf</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;bf&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>    
      <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        
      <span class="n">p</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">bt</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">treatment</span> <span class="o">+</span> <span class="n">bf</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">fungus</span>
        
      <span class="n">mu</span> <span class="o">=</span> <span class="n">h0</span> <span class="o">*</span> <span class="n">p</span>
      <span class="n">scale</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  
        
      <span class="n">h1</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;h1&quot;</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    
    
<span class="n">jdc_6_7</span> <span class="o">=</span> <span class="n">model_6_7</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">h0</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">treatment</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">fungus</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NUM_CHAINS_FOR_6_7</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_7</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_7</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_7</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_7</span><span class="p">])</span>    
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">()</span>
<span class="p">]</span>

<span class="n">posterior_6_7</span><span class="p">,</span> <span class="n">trace_6_7</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                    <span class="n">jdc_6_7</span><span class="p">,</span> 
                    <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">h1</span><span class="p">,),</span> 
                    <span class="n">num_chains</span><span class="o">=</span><span class="n">NUM_CHAINS_FOR_6_7</span><span class="p">,</span>
                    <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                    <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">,</span>
                    <span class="n">num_samples</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> 
                    <span class="n">burnin</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;bt&#39;</span><span class="p">,</span> <span class="s1">&#39;bf&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">])</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_6_7</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <td>1.454</td>
      <td>0.029</td>
      <td>1.416</td>
      <td>1.508</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>1076.0</td>
      <td>1183.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>bt</th>
      <td>-0.011</td>
      <td>0.034</td>
      <td>-0.066</td>
      <td>0.040</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>1163.0</td>
      <td>1033.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>bf</th>
      <td>-0.275</td>
      <td>0.034</td>
      <td>-0.327</td>
      <td>-0.218</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>1309.0</td>
      <td>1630.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>1.385</td>
      <td>0.097</td>
      <td>1.233</td>
      <td>1.537</td>
      <td>0.005</td>
      <td>0.003</td>
      <td>430.0</td>
      <td>809.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Note that <code class="docutils literal notranslate"><span class="pre">a</span></code> is same as <code class="docutils literal notranslate"><span class="pre">p</span></code> in the previous model i.e. about 40% growth on average</p>
<p>Marginal posterior for <code class="docutils literal notranslate"><span class="pre">bt</span></code> (effect of treatment) is about 0 with a tight interval. This implies treatment is not associated with the growth.</p>
<p>Fungus (<code class="docutils literal notranslate"><span class="pre">bf</span></code>) seems to actually hurt the growth.</p>
<p>Clearly this does not makes us happy because we know that the treatment does matter. Next section tries to find the answers.</p>
</div>
</div>
<div class="section" id="blocked-by-consequence">
<h3>6.2.2 Blocked by consequence<a class="headerlink" href="#blocked-by-consequence" title="Permalink to this headline">¶</a></h3>
<p>Fungus is a consequence of treatment i.e. fungus is a <strong>post-treatment</strong> variable.</p>
<p>When we include Fungus variable, the model tries to find whether a plat developed fungus or not. However, what we really want to understand is the impact of treatment on growth.</p>
<p>This can be done by omitting the post-treatment variable <em>fungus</em></p>
<div class="section" id="code-6-17">
<h4>Code 6.17<a class="headerlink" href="#code-6-17" title="Permalink to this headline">¶</a></h4>
<p>In this model, fungus predictor is not included</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_6_8</span><span class="p">(</span><span class="n">h0</span><span class="p">,</span> <span class="n">treatment</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
      <span class="n">a</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">LogNormal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>      
      <span class="n">bt</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;bt&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>    
      <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        
      <span class="n">p</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">bt</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">treatment</span> 
        
      <span class="n">mu</span> <span class="o">=</span> <span class="n">h0</span> <span class="o">*</span> <span class="n">p</span>
      <span class="n">scale</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  
        
      <span class="n">h1</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;h1&quot;</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    
    
<span class="n">jdc_6_8</span> <span class="o">=</span> <span class="n">model_6_8</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">h0</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">treatment</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NUM_CHAINS_FOR_6_8</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_8</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_8</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_8</span><span class="p">])</span>    
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">()</span>
<span class="p">]</span>

<span class="n">posterior_6_8</span><span class="p">,</span> <span class="n">trace_6_8</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                    <span class="n">jdc_6_8</span><span class="p">,</span> 
                    <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">h1</span><span class="p">,),</span> 
                    <span class="n">num_chains</span><span class="o">=</span><span class="n">NUM_CHAINS_FOR_6_8</span><span class="p">,</span>
                    <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                    <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">,</span>
                    <span class="n">num_samples</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> 
                    <span class="n">burnin</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;bt&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">])</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_6_8</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <td>1.288</td>
      <td>0.025</td>
      <td>1.251</td>
      <td>1.330</td>
      <td>0.001</td>
      <td>0.000</td>
      <td>2037.0</td>
      <td>1479.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>bt</th>
      <td>0.133</td>
      <td>0.035</td>
      <td>0.075</td>
      <td>0.186</td>
      <td>0.001</td>
      <td>0.000</td>
      <td>3748.0</td>
      <td>1747.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>1.789</td>
      <td>0.126</td>
      <td>1.599</td>
      <td>1.994</td>
      <td>0.004</td>
      <td>0.003</td>
      <td>928.0</td>
      <td>1665.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can now see that <code class="docutils literal notranslate"><span class="pre">bt</span></code> (effect of treatment) has a positive impact on the model.</p>
</div>
</div>
<div class="section" id="fungus-and-d-separation">
<h3>6.2.3 Fungus and d-separation<a class="headerlink" href="#fungus-and-d-separation" title="Permalink to this headline">¶</a></h3>
<p>Above we built models by including and excluding various potential predictors. However, it helps to represent these relations graphically with the help of DAG.</p>
<div class="section" id="code-6-18">
<h4>Code 6.18<a class="headerlink" href="#code-6-18" title="Permalink to this headline">¶</a></h4>
<p>Here we are using <code class="docutils literal notranslate"><span class="pre">causalgraphicalmodel</span></code> package</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plant_dag</span> <span class="o">=</span> <span class="n">CausalGraphicalModel</span><span class="p">(</span>
    <span class="n">nodes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;H0&quot;</span><span class="p">,</span> <span class="s2">&quot;H1&quot;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">],</span>
    <span class="n">edges</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;H0&quot;</span><span class="p">,</span> <span class="s2">&quot;H1&quot;</span><span class="p">),</span>
           <span class="p">(</span><span class="s2">&quot;F&quot;</span><span class="p">,</span> <span class="s2">&quot;H1&quot;</span><span class="p">),</span>
           <span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">)])</span>
<span class="n">pgm</span> <span class="o">=</span> <span class="n">daft</span><span class="o">.</span><span class="n">PGM</span><span class="p">()</span>
<span class="n">coordinates</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;H0&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;T&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;F&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;H1&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)}</span>
<span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">plant_dag</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
    <span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">coordinates</span><span class="p">[</span><span class="n">node</span><span class="p">])</span>
<span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">plant_dag</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
    <span class="n">pgm</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="o">*</span><span class="n">edge</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06_the_haunted_dag_and_the_causal_terror_79_0.png" src="../_images/06_the_haunted_dag_and_the_causal_terror_79_0.png" />
</div>
</div>
<p>The graph clearly shows how treatment’s (T) impact on height (H1) is <strong>blocked</strong> by fungus (F)</p>
<p>Another way to say above is - If we condition on F it induces <strong>D-SEPARATION</strong>. The “d” stands for <em>directional</em></p>
<p>H1 is conditionally independent of T if we include F (the blocker)</p>
</div>
<div class="section" id="code-6-19">
<h4>Code 6.19<a class="headerlink" href="#code-6-19" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_independencies</span> <span class="o">=</span> <span class="n">plant_dag</span><span class="o">.</span><span class="n">get_all_independence_relationships</span><span class="p">()</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">all_independencies</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
           <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_independencies</span> <span class="k">if</span> <span class="n">t</span> <span class="o">!=</span> <span class="n">s</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;T&#39;, &#39;H1&#39;, {&#39;F&#39;})
(&#39;T&#39;, &#39;H0&#39;, set())
(&#39;F&#39;, &#39;H0&#39;, set())
</pre></div>
</div>
</div>
</div>
<p>Here is how we want to read the above result -</p>
<ul class="simple">
<li><p>H0 is conditionally independent on T  (note the empty set). In other words, original height H0 should not be associated with T</p></li>
<li><p>H0 is conditionally independent on F  (note the empty set). In other words, original height H0 should not be associated with F</p></li>
<li><p>H1 is conditionally independent on T if we include F</p></li>
</ul>
</div>
<div class="section" id="code-6-20">
<h4>Code 6.20<a class="headerlink" href="#code-6-20" title="Permalink to this headline">¶</a></h4>
<p>A synthetic data generation to modifiy the plant growth simulation so that fungus has no influence on growth, but moisture M influences both H1 and F</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_SEED</span> <span class="o">=</span> <span class="mi">71</span>

<span class="c1"># Note - even after providing SeedStream and generated seeds</span>
<span class="c1"># it still does not respect it</span>
<span class="k">def</span> <span class="nf">simulate</span><span class="p">():</span>
    <span class="n">seed</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">SeedStream</span><span class="p">(</span><span class="n">_SEED</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="s2">&quot;sim_heights&quot;</span><span class="p">)</span>

    <span class="c1"># number of plants</span>
    <span class="n">N</span> <span class="o">=</span> <span class="mi">1000</span>

    <span class="c1"># simulate initial heights</span>
    <span class="n">h0</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">2.</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">())</span>

    <span class="c1"># assign treatments and simulate fungus and growth</span>
    <span class="n">treatment</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="n">repeats</span><span class="o">=</span><span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
    
    <span class="n">M</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Bernoulli</span><span class="p">(</span><span class="n">probs</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    
    <span class="n">fungus</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span><span class="n">total_count</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">treatment</span> <span class="o">*</span> <span class="mf">0.4</span> <span class="o">+</span> <span class="n">M</span> <span class="o">*</span> <span class="mf">0.4</span><span class="p">))</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">())</span>
    
    <span class="n">h1</span> <span class="o">=</span> <span class="n">h0</span> <span class="o">+</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">5.</span> <span class="o">+</span> <span class="mf">3.</span> <span class="o">*</span> <span class="n">M</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">())</span>

    <span class="c1"># compose a clean data frame</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;h0&quot;</span><span class="p">:</span><span class="n">h0</span><span class="p">,</span> <span class="s2">&quot;h1&quot;</span><span class="p">:</span><span class="n">h1</span><span class="p">,</span> <span class="s2">&quot;treatment&quot;</span><span class="p">:</span><span class="n">treatment</span><span class="p">,</span> <span class="s2">&quot;fungus&quot;</span><span class="p">:</span><span class="n">fungus</span><span class="p">}</span>
    
    <span class="k">return</span> <span class="n">d</span>
    
<span class="n">d</span> <span class="o">=</span> <span class="n">simulate</span><span class="p">()</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;stats&quot;</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>h0</th>
      <td>9.994</td>
      <td>2.06</td>
      <td>6.494</td>
      <td>12.935</td>
    </tr>
    <tr>
      <th>h1</th>
      <td>16.544</td>
      <td>2.80</td>
      <td>12.268</td>
      <td>20.809</td>
    </tr>
    <tr>
      <th>treatment</th>
      <td>0.500</td>
      <td>0.50</td>
      <td>0.000</td>
      <td>1.000</td>
    </tr>
    <tr>
      <th>fungus</th>
      <td>0.491</td>
      <td>0.50</td>
      <td>0.000</td>
      <td>1.000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
</div>
</div>
<div class="section" id="collider-bias">
<h2>6.3 Collider bias<a class="headerlink" href="#collider-bias" title="Permalink to this headline">¶</a></h2>
<div class="section" id="collider-of-false-sorrow">
<h3>6.3.1 Collider of false sorrow<a class="headerlink" href="#collider-of-false-sorrow" title="Permalink to this headline">¶</a></h3>
<p>Question we consider in this section is how aging influences happiness ?</p>
<p>We also know that happiness (H) &amp; age (A) both cause marriage (M). This makes marriage (M) a <strong>collider</strong></p>
<p>H —-&gt; M &lt;—– A</p>
<div class="section" id="code-6-21">
<h4>Code 6.21<a class="headerlink" href="#code-6-21" title="Permalink to this headline">¶</a></h4>
<p>Simulating (synthetic data generation) happiness and its relationship with age &amp; marriage</p>
<ul class="simple">
<li><p>Each year, 20 people are born with uniformly distributed happiness values</p></li>
<li><p>Each year, each person ages one year. Happiness does not change.</p></li>
<li><p>At age 18, individuals can be married. The odds of marriage each year are proportional to an individual’s happiness</p></li>
<li><p>Once married, an individual remains married</p></li>
<li><p>After age 65, individuals leave the sample. (They move to Spain)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Port of R code from here https://github.com/rmcelreath/rethinking/blob/master/R/sim_happiness.R</span>
<span class="k">def</span> <span class="nf">sim_happiness</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">1977</span><span class="p">,</span> <span class="n">N_years</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="mi">65</span><span class="p">,</span> <span class="n">N_births</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">aom</span><span class="o">=</span><span class="mi">18</span><span class="p">):</span>
    <span class="c1"># age existing individuals &amp; newborns</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N_years</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">N_births</span><span class="p">)</span>
    <span class="c1"># sim happiness trait - never changes</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">N_births</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">N_years</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># not yet married</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N_years</span> <span class="o">*</span> <span class="n">N_births</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_M</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">M</span><span class="p">):</span>
        <span class="c1"># for each person over 17, chance get married</span>
        <span class="n">married</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Bernoulli</span><span class="p">(</span><span class="n">logits</span><span class="o">=</span><span class="p">(</span><span class="n">H</span> <span class="o">-</span> <span class="mf">4.</span><span class="p">))</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">A</span> <span class="o">&gt;=</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">M</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">),</span> <span class="n">married</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fori_loop</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">body_fun</span><span class="p">,</span> <span class="n">init_val</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">init_val</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">body_fun</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">val</span>
    
    <span class="n">M</span> <span class="o">=</span> <span class="n">fori_loop</span><span class="p">(</span><span class="n">aom</span><span class="p">,</span> <span class="n">max_age</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">update_M</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>    

    <span class="c1"># mortality</span>
    <span class="n">deaths</span> <span class="o">=</span> <span class="n">A</span> <span class="o">&gt;</span> <span class="n">max_age</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="o">~</span><span class="n">deaths</span><span class="p">]</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">H</span><span class="p">[</span><span class="o">~</span><span class="n">deaths</span><span class="p">]</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="o">~</span><span class="n">deaths</span><span class="p">]</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="n">A</span><span class="p">,</span> <span class="s2">&quot;married&quot;</span><span class="p">:</span> <span class="n">M</span><span class="p">,</span> <span class="s2">&quot;happiness&quot;</span><span class="p">:</span> <span class="n">H</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">d</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">sim_happiness</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">1977</span><span class="p">,</span> <span class="n">N_years</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>age</th>
      <th>married</th>
      <th>happiness</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>1300.000000</td>
      <td>1300.000000</td>
      <td>1.300000e+03</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>33.000000</td>
      <td>0.292308</td>
      <td>-8.335213e-17</td>
    </tr>
    <tr>
      <th>std</th>
      <td>18.768883</td>
      <td>0.454998</td>
      <td>1.214421e+00</td>
    </tr>
    <tr>
      <th>min</th>
      <td>1.000000</td>
      <td>0.000000</td>
      <td>-2.000000e+00</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>17.000000</td>
      <td>0.000000</td>
      <td>-1.000000e+00</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>33.000000</td>
      <td>0.000000</td>
      <td>-1.110223e-16</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>49.000000</td>
      <td>1.000000</td>
      <td>1.000000e+00</td>
    </tr>
    <tr>
      <th>max</th>
      <td>65.000000</td>
      <td>1.000000</td>
      <td>2.000000e+00</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="code-6-22">
<h4>Code 6.22<a class="headerlink" href="#code-6-22" title="Permalink to this headline">¶</a></h4>
<p>Rescaling age so that the range from 18 to 65 is one unit</p>
<p>We are adding a new column called “A” that ranges from 0 to 1 where 0 is age 18 and 1 is age 65</p>
<p>Happiness is on an arbitary scale from -2 to +2</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d2</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">age</span> <span class="o">&gt;</span> <span class="mi">17</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># only adults</span>
<span class="n">d2</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">d2</span><span class="o">.</span><span class="n">age</span> <span class="o">-</span> <span class="mi">18</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">65</span> <span class="o">-</span> <span class="mi">18</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-6-23">
<h4>Code 6.23<a class="headerlink" href="#code-6-23" title="Permalink to this headline">¶</a></h4>
<p>Here we are doing multiple regression. The linear model is</p>
<p><span class="math notranslate nohighlight">\(\mu_i\)</span> = <span class="math notranslate nohighlight">\(\alpha_{MID[i]}\)</span> + <span class="math notranslate nohighlight">\(\beta_A\)</span> * <span class="math notranslate nohighlight">\(A_i\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d2</span><span class="p">[</span><span class="s2">&quot;mid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d2</span><span class="o">.</span><span class="n">married</span>

<span class="n">tdf</span> <span class="o">=</span> <span class="n">df_to_tensors</span><span class="p">(</span><span class="s1">&#39;SimulatedHappiness&#39;</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;mid&#39;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span>
    <span class="s1">&#39;A&#39;</span>   <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="s1">&#39;happiness&#39;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span>
<span class="p">})</span>

<span class="k">def</span> <span class="nf">model_6_9</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="n">A</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
      <span class="n">a</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>      
      <span class="n">bA</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">2.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;bA&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>    
      <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        
      <span class="n">mu</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">bA</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">A</span>        
      <span class="n">scale</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  
        
      <span class="n">h</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    
    
<span class="n">jdc_6_9</span> <span class="o">=</span> <span class="n">model_6_9</span><span class="p">(</span><span class="n">mid</span><span class="o">=</span><span class="n">tdf</span><span class="o">.</span><span class="n">mid</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="n">tdf</span><span class="o">.</span><span class="n">A</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NUM_CHAINS_FOR_6_9</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_9</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_9</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_9</span><span class="p">])</span>    
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">()</span>
<span class="p">]</span>

<span class="n">observed_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">happiness</span><span class="p">,)</span>

<span class="n">posterior_6_9</span><span class="p">,</span> <span class="n">trace_6_9</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                    <span class="n">jdc_6_9</span><span class="p">,</span> 
                    <span class="n">observed_data</span><span class="o">=</span><span class="n">observed_value</span><span class="p">,</span> 
                    <span class="n">num_chains</span><span class="o">=</span><span class="n">NUM_CHAINS_FOR_6_9</span><span class="p">,</span>
                    <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                    <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">,</span>
                    <span class="n">num_samples</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> 
                    <span class="n">burnin</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;bA&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">])</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_6_9</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a[0]</th>
      <td>-0.186</td>
      <td>0.063</td>
      <td>-0.287</td>
      <td>-0.089</td>
      <td>0.002</td>
      <td>0.001</td>
      <td>1057.0</td>
      <td>1553.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>a[1]</th>
      <td>1.341</td>
      <td>0.088</td>
      <td>1.209</td>
      <td>1.483</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>928.0</td>
      <td>1255.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>bA</th>
      <td>-0.837</td>
      <td>0.112</td>
      <td>-1.008</td>
      <td>-0.648</td>
      <td>0.004</td>
      <td>0.003</td>
      <td>792.0</td>
      <td>1200.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>0.989</td>
      <td>0.022</td>
      <td>0.956</td>
      <td>1.025</td>
      <td>0.001</td>
      <td>0.000</td>
      <td>1540.0</td>
      <td>2012.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The model here is quite sure that age is negatively associated with happiness.</p>
</div>
<div class="section" id="code-6-24">
<h4>Code 6.24<a class="headerlink" href="#code-6-24" title="Permalink to this headline">¶</a></h4>
<p>What would happen if omit the marriage status ?</p>
<p>Note - <span class="math notranslate nohighlight">\(a\)</span> is not any more a vector; just a plain intercept</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_6_10</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
      <span class="n">a</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>      
      <span class="n">bA</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">2.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;bA&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>    
      <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        
      <span class="n">mu</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">bA</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">A</span>        
      <span class="n">scale</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  
        
      <span class="n">h</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    
    
<span class="n">jdc_6_10</span> <span class="o">=</span> <span class="n">model_6_10</span><span class="p">(</span><span class="n">A</span><span class="o">=</span><span class="n">tdf</span><span class="o">.</span><span class="n">A</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NUM_CHAINS_FOR_6_10</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_10</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_10</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_10</span><span class="p">])</span>    
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">()</span>
<span class="p">]</span>

<span class="n">observed_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">happiness</span><span class="p">,)</span>

<span class="n">posterior_6_10</span><span class="p">,</span> <span class="n">trace_6_10</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                    <span class="n">jdc_6_10</span><span class="p">,</span> 
                    <span class="n">observed_data</span><span class="o">=</span><span class="n">observed_value</span><span class="p">,</span> 
                    <span class="n">num_chains</span><span class="o">=</span><span class="n">NUM_CHAINS_FOR_6_10</span><span class="p">,</span>
                    <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                    <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">,</span>
                    <span class="n">num_samples</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> 
                    <span class="n">burnin</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;bA&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">])</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_6_10</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <td>-0.001</td>
      <td>0.078</td>
      <td>-0.133</td>
      <td>0.115</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>825.0</td>
      <td>1563.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>bA</th>
      <td>0.002</td>
      <td>0.134</td>
      <td>-0.192</td>
      <td>0.231</td>
      <td>0.005</td>
      <td>0.004</td>
      <td>704.0</td>
      <td>1357.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>1.218</td>
      <td>0.028</td>
      <td>1.173</td>
      <td>1.262</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>702.0</td>
      <td>1048.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The value is <span class="math notranslate nohighlight">\(a\)</span> is close to zero. This implies that the model finds no association between age and happiness.</p>
<p>The pattern above is exactly what we should expect when condition on a <strong>collider</strong>. Here the <strong>collider</strong> is marriage status. It is a common consequence of age and happiness and therefore if we condition on it we are bound to induce a spurious association between the two causes</p>
</div>
</div>
<div class="section" id="the-hanted-dag">
<h3>6.3.2 The hanted DAG<a class="headerlink" href="#the-hanted-dag" title="Permalink to this headline">¶</a></h3>
<p>Collider may not be easily avoidable because they may be unmesasured causes. “Unmeasured” =&gt; Our DAG is haunted</p>
<div class="section" id="code-6-25">
<h4>Code 6.25<a class="headerlink" href="#code-6-25" title="Permalink to this headline">¶</a></h4>
<p>Here we will simulate another dataset using which we will try to infer the direct influene of both parents (P) and grandparents (G) on the educational achievement of childern (C)</p>
<p>It should be obvious that G -&gt; P, P-&gt;C and G-&gt;C</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">200</span>  <span class="c1"># number of grandparent-parent-child triads</span>
<span class="n">b_GP</span> <span class="o">=</span> <span class="mf">1.</span>  <span class="c1"># direct effect of G on P</span>
<span class="n">b_GC</span> <span class="o">=</span> <span class="mf">0.</span>  <span class="c1"># direct effect of G on C</span>
<span class="n">b_PC</span> <span class="o">=</span> <span class="mf">1.</span>  <span class="c1"># direct effect of P on C</span>
<span class="n">b_U</span> <span class="o">=</span> <span class="mf">2.</span>  <span class="c1"># direct effect of U on P and C</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-6-26">
<h4>Code 6.26<a class="headerlink" href="#code-6-26" title="Permalink to this headline">¶</a></h4>
<p>Here is our “functional” (relationship) modeling</p>
<ul class="simple">
<li><p>P is some function of G &amp; U</p></li>
<li><p>C is some function of G, P &amp; U</p></li>
<li><p>G &amp; U are not functions of any other known variables</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">grand_parent_sim</span><span class="p">():</span>
    <span class="n">seed</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">SeedStream</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="s2">&quot;sim_grand_parent&quot;</span><span class="p">)</span>
    <span class="n">U</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Bernoulli</span><span class="p">(</span><span class="n">probs</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">(),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="n">N</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">(),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>    
    <span class="n">temp</span> <span class="o">=</span> <span class="n">b_GP</span> <span class="o">*</span> <span class="n">G</span> <span class="o">+</span> <span class="n">b_U</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>    
    <span class="n">P</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">temp</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">())</span>    
    <span class="n">temp2</span> <span class="o">=</span> <span class="n">b_PC</span> <span class="o">*</span> <span class="n">P</span> <span class="o">+</span> <span class="n">b_GC</span> <span class="o">*</span> <span class="n">G</span> <span class="o">+</span> <span class="n">b_U</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  
    <span class="n">C</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">temp2</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">())</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="n">C</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="s2">&quot;P&quot;</span><span class="p">:</span> <span class="n">P</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="s2">&quot;G&quot;</span><span class="p">:</span> <span class="n">G</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="s2">&quot;U&quot;</span><span class="p">:</span> <span class="n">U</span><span class="o">.</span><span class="n">numpy</span><span class="p">()})</span>
    
    <span class="k">return</span> <span class="n">d</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">grand_parent_sim</span><span class="p">()</span>

<span class="n">d</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>C</th>
      <th>P</th>
      <th>G</th>
      <th>U</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>3.512862</td>
      <td>1.650976</td>
      <td>-1.042326</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-4.590997</td>
      <td>-1.555232</td>
      <td>0.232263</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>4.886199</td>
      <td>3.082321</td>
      <td>1.986989</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1.636396</td>
      <td>1.243976</td>
      <td>-1.034003</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>-8.797684</td>
      <td>-5.349887</td>
      <td>-3.269576</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>195</th>
      <td>3.745021</td>
      <td>0.391891</td>
      <td>0.254253</td>
      <td>1</td>
    </tr>
    <tr>
      <th>196</th>
      <td>-4.513893</td>
      <td>-2.212740</td>
      <td>-1.100699</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>197</th>
      <td>-3.206512</td>
      <td>-0.455612</td>
      <td>0.602985</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>198</th>
      <td>1.082468</td>
      <td>-0.115803</td>
      <td>0.106212</td>
      <td>1</td>
    </tr>
    <tr>
      <th>199</th>
      <td>-2.545109</td>
      <td>0.838045</td>
      <td>2.178708</td>
      <td>-1</td>
    </tr>
  </tbody>
</table>
<p>200 rows × 4 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tdf</span> <span class="o">=</span> <span class="n">df_to_tensors</span><span class="p">(</span><span class="s1">&#39;SimulatedEducation&#39;</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-6-27">
<h4>Code 6.27<a class="headerlink" href="#code-6-27" title="Permalink to this headline">¶</a></h4>
<p>Simple regression of C on P &amp; G</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_6_11</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">G</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
      <span class="n">a</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>      
      <span class="n">b_PC</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;b_PC&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>      
      <span class="n">b_GC</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;b_GC&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>      
      <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
       
      <span class="n">mu</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">b_PC</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">P</span> <span class="o">+</span> <span class="n">b_GC</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">G</span>    
      <span class="n">scale</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  
        
      <span class="n">h</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    
    
<span class="n">jdc_6_11</span> <span class="o">=</span> <span class="n">model_6_11</span><span class="p">(</span><span class="n">P</span><span class="o">=</span><span class="n">tdf</span><span class="o">.</span><span class="n">P</span><span class="p">,</span> <span class="n">G</span><span class="o">=</span><span class="n">tdf</span><span class="o">.</span><span class="n">G</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NUM_CHAINS_FOR_6_11</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_11</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_11</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_11</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_11</span><span class="p">])</span>    
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">()</span>
<span class="p">]</span>

<span class="n">observed_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">C</span><span class="p">,)</span>

<span class="n">posterior_6_11</span><span class="p">,</span> <span class="n">trace_6_11</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                    <span class="n">jdc_6_11</span><span class="p">,</span> 
                    <span class="n">observed_data</span><span class="o">=</span><span class="n">observed_value</span><span class="p">,</span> 
                    <span class="n">num_chains</span><span class="o">=</span><span class="n">NUM_CHAINS_FOR_6_11</span><span class="p">,</span>
                    <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                    <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">,</span>
                    <span class="n">num_samples</span><span class="o">=</span><span class="mi">4000</span><span class="p">,</span> 
                    <span class="n">burnin</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;bPC&#39;</span><span class="p">,</span> <span class="s1">&#39;bGC&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">])</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_6_11</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <td>0.057</td>
      <td>0.095</td>
      <td>-0.097</td>
      <td>0.210</td>
      <td>0.001</td>
      <td>0.002</td>
      <td>7634.0</td>
      <td>1317.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>bPC</th>
      <td>1.817</td>
      <td>0.045</td>
      <td>1.743</td>
      <td>1.887</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>3660.0</td>
      <td>3336.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>bGC</th>
      <td>-0.896</td>
      <td>0.100</td>
      <td>-1.053</td>
      <td>-0.737</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>6555.0</td>
      <td>1740.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>1.378</td>
      <td>0.068</td>
      <td>1.268</td>
      <td>1.484</td>
      <td>0.002</td>
      <td>0.001</td>
      <td>1320.0</td>
      <td>2157.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The inferred effect of parents looks too big, almost twice as large as it should be i.e. 1 vs 1.8</p>
<p>Some correlation between P &amp; C is due to U and that’s a simple confound.</p>
<p>Interestingly model is confident (bGC) that the direct effect of grandparents is to hurt their grandkids</p>
</div>
<div class="section" id="code-6-28">
<h4>Code 6.28<a class="headerlink" href="#code-6-28" title="Permalink to this headline">¶</a></h4>
<p>Regression that conditions on U as well</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_6_12</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">U</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
      <span class="n">a</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>      
      <span class="n">b_PC</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;b_PC&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>      
      <span class="n">b_GC</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;b_GC&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>      
      <span class="n">b_U</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;b_U&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>      
      <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
       
      <span class="n">mu</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> \
            <span class="n">b_PC</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">P</span> <span class="o">+</span> \
            <span class="n">b_GC</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">G</span> <span class="o">+</span> \
            <span class="n">b_U</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">U</span>
    
      <span class="n">scale</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  
        
      <span class="n">h</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    
    
<span class="n">jdc_6_12</span> <span class="o">=</span> <span class="n">model_6_12</span><span class="p">(</span><span class="n">P</span><span class="o">=</span><span class="n">tdf</span><span class="o">.</span><span class="n">P</span><span class="p">,</span> <span class="n">G</span><span class="o">=</span><span class="n">tdf</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="n">U</span><span class="o">=</span><span class="n">tdf</span><span class="o">.</span><span class="n">U</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NUM_CHAINS_FOR_6_12</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_12</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_12</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_12</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_12</span><span class="p">]),</span>  <span class="c1"># &lt;-- note 1 instead of zero here. Necessary !!</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_12</span><span class="p">])</span>    
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">()</span>
<span class="p">]</span>

<span class="n">observed_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">C</span><span class="p">,)</span>

<span class="n">posterior_6_12</span><span class="p">,</span> <span class="n">trace_6_12</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                    <span class="n">jdc_6_12</span><span class="p">,</span> 
                    <span class="n">observed_data</span><span class="o">=</span><span class="n">observed_value</span><span class="p">,</span> 
                    <span class="n">num_chains</span><span class="o">=</span><span class="n">NUM_CHAINS_FOR_6_12</span><span class="p">,</span>
                    <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                    <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">,</span>
                    <span class="n">num_samples</span><span class="o">=</span><span class="mi">4000</span><span class="p">,</span> 
                    <span class="n">burnin</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;bPC&#39;</span><span class="p">,</span> <span class="s1">&#39;bGC&#39;</span><span class="p">,</span> <span class="s1">&#39;bU&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">])</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_6_12</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <td>-0.058</td>
      <td>0.074</td>
      <td>-0.170</td>
      <td>0.063</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>7160.0</td>
      <td>1837.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>bPC</th>
      <td>0.929</td>
      <td>0.077</td>
      <td>0.804</td>
      <td>1.051</td>
      <td>0.002</td>
      <td>0.002</td>
      <td>973.0</td>
      <td>1625.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>bGC</th>
      <td>0.077</td>
      <td>0.109</td>
      <td>-0.096</td>
      <td>0.254</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>1222.0</td>
      <td>1988.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>bU</th>
      <td>2.141</td>
      <td>0.168</td>
      <td>1.880</td>
      <td>2.424</td>
      <td>0.006</td>
      <td>0.004</td>
      <td>902.0</td>
      <td>1268.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>1.033</td>
      <td>0.051</td>
      <td>0.946</td>
      <td>1.108</td>
      <td>0.001</td>
      <td>0.000</td>
      <td>6467.0</td>
      <td>2768.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>These are similar to the slopes we used to simulate (compare to the constants in Code 6.25)</p>
<p>This is an example of <strong>SIMPSON’s PARADOX</strong>. Usually Simpson’s paradox is presented in cases where adding the new predictor helps use. But in this case it misleads us.</p>
</div>
</div>
</div>
<div class="section" id="confronting-confounding">
<h2>6.4 Confronting confounding<a class="headerlink" href="#confronting-confounding" title="Permalink to this headline">¶</a></h2>
<p>We have now seen that in multiple regression if we control for wrong variables they can ruin the inference</p>
<div class="section" id="shutting-the-backdoor">
<h3>6.4.1 Shutting the backdoor<a class="headerlink" href="#shutting-the-backdoor" title="Permalink to this headline">¶</a></h3>
<p>Blocking all confounding paths between some predictor X &amp; some outcome Y is known as shutting the <strong>BACKDOOR</strong></p>
<p>In simple words, we do not want any spurrious corrleation sneaking in through a non-causal path</p>
<p>We will create the graphs for 4 elemental confounds.</p>
<p><strong>Note that there is no corresponding code section in the book for drawing and hence these section are not marked with Codde 6.X heading</strong></p>
<p><strong>The Fork</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dag_the_fork</span> <span class="o">=</span> <span class="n">CausalGraphicalModel</span><span class="p">(</span>
    <span class="n">nodes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">],</span>
    <span class="n">edges</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">)])</span>

<span class="n">pgm</span> <span class="o">=</span> <span class="n">daft</span><span class="o">.</span><span class="n">PGM</span><span class="p">()</span>
<span class="n">coordinates</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;Y&quot;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)}</span>
<span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">dag_the_fork</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
    <span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">coordinates</span><span class="p">[</span><span class="n">node</span><span class="p">])</span>
<span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">dag_the_fork</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
    <span class="n">pgm</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="o">*</span><span class="n">edge</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">render</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06_the_haunted_dag_and_the_causal_terror_119_0.png" src="../_images/06_the_haunted_dag_and_the_causal_terror_119_0.png" />
</div>
</div>
<p>Fork is a classic confounder. Z is common cause of X &amp; Y. Learning X tells us nothing about Y</p>
<p><strong>The Pipe</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dag_the_pipe</span> <span class="o">=</span> <span class="n">CausalGraphicalModel</span><span class="p">(</span>
    <span class="n">nodes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">],</span>
    <span class="n">edges</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">)])</span>

<span class="n">pgm</span> <span class="o">=</span> <span class="n">daft</span><span class="o">.</span><span class="n">PGM</span><span class="p">()</span>
<span class="n">coordinates</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;Y&quot;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)}</span>
<span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">dag_the_pipe</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
    <span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">coordinates</span><span class="p">[</span><span class="n">node</span><span class="p">])</span>
<span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">dag_the_pipe</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
    <span class="n">pgm</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="o">*</span><span class="n">edge</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">render</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06_the_haunted_dag_and_the_causal_terror_122_0.png" src="../_images/06_the_haunted_dag_and_the_causal_terror_122_0.png" />
</div>
</div>
<p>If we condition on Z we block the path from X to Y. Recall the treatment &amp; fungus experiment</p>
<p><strong>The Collider</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dag_the_collider</span> <span class="o">=</span> <span class="n">CausalGraphicalModel</span><span class="p">(</span>
    <span class="n">nodes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">],</span>
    <span class="n">edges</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">)])</span>

<span class="n">pgm</span> <span class="o">=</span> <span class="n">daft</span><span class="o">.</span><span class="n">PGM</span><span class="p">()</span>
<span class="n">coordinates</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;Y&quot;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)}</span>
<span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">dag_the_collider</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
    <span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">coordinates</span><span class="p">[</span><span class="n">node</span><span class="p">])</span>
<span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">dag_the_collider</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
    <span class="n">pgm</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="o">*</span><span class="n">edge</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">render</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06_the_haunted_dag_and_the_causal_terror_125_0.png" src="../_images/06_the_haunted_dag_and_the_causal_terror_125_0.png" />
</div>
</div>
<p>Conditioning on collider i.e Z opens the path i.e info flows between X and Y</p>
<p><strong>The Descendant</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dag_the_descendant</span> <span class="o">=</span> <span class="n">CausalGraphicalModel</span><span class="p">(</span>
    <span class="n">nodes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">],</span>
    <span class="n">edges</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">)])</span>

<span class="n">pgm</span> <span class="o">=</span> <span class="n">daft</span><span class="o">.</span><span class="n">PGM</span><span class="p">()</span>
<span class="n">coordinates</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;Y&quot;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;D&quot;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)}</span>
<span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">dag_the_descendant</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
    <span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">coordinates</span><span class="p">[</span><span class="n">node</span><span class="p">])</span>
<span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">dag_the_descendant</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
    <span class="n">pgm</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="o">*</span><span class="n">edge</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">render</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06_the_haunted_dag_and_the_causal_terror_128_0.png" src="../_images/06_the_haunted_dag_and_the_causal_terror_128_0.png" />
</div>
</div>
<p>Here is D is the descendant variable. if we condition on it then it will be similar to closig the pipe.</p>
</div>
<div class="section" id="two-roads">
<h3>6.4.2 Two roads<a class="headerlink" href="#two-roads" title="Permalink to this headline">¶</a></h3>
<p>DAG shown below (Code 6.29) has U which is unobserved variable</p>
<p>We are interested in X-&gt;Y but which observed covariates (A, B, C) do we need to add to the model ?</p>
<div class="section" id="code-6-29">
<h4>Code 6.29<a class="headerlink" href="#code-6-29" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dag_6_1</span> <span class="o">=</span> <span class="n">CausalGraphicalModel</span><span class="p">(</span>
    <span class="n">nodes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;U&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">],</span>
    <span class="n">edges</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;U&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;U&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">),</span>
           <span class="p">(</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;U&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">)])</span>


<span class="c1"># let&#39;s render the DAG as well (note - no code section for it in the book but is displayed)</span>
<span class="c1"># so instead of copying the picture we are generating it</span>
<span class="n">pgm</span> <span class="o">=</span> <span class="n">daft</span><span class="o">.</span><span class="n">PGM</span><span class="p">()</span>
<span class="n">coordinates</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="s2">&quot;Y&quot;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="s2">&quot;U&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;B&quot;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)}</span>
<span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">dag_6_1</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
    <span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">coordinates</span><span class="p">[</span><span class="n">node</span><span class="p">])</span>
<span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">dag_6_1</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
    <span class="n">pgm</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="o">*</span><span class="n">edge</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">render</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06_the_haunted_dag_and_the_causal_terror_132_0.png" src="../_images/06_the_haunted_dag_and_the_causal_terror_132_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_adjustment_sets</span> <span class="o">=</span> <span class="n">dag_6_1</span><span class="o">.</span><span class="n">get_all_backdoor_adjustment_sets</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">all_adjustment_sets</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="ow">not</span> <span class="n">t</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_adjustment_sets</span> <span class="k">if</span> <span class="n">t</span> <span class="o">!=</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">s</span> <span class="o">!=</span> <span class="p">{</span><span class="s2">&quot;U&quot;</span><span class="p">}:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>frozenset({&#39;A&#39;})
frozenset({&#39;C&#39;})
</pre></div>
</div>
</div>
</div>
<p>Read above results as -</p>
<p>Conditioning on either A or C would suffice</p>
</div>
</div>
<div class="section" id="backdoor-waffles">
<h3>6.4.3 Backdoor waffles<a class="headerlink" href="#backdoor-waffles" title="Permalink to this headline">¶</a></h3>
<p>Let’s consider the Waffle House &amp; Divorce rate correlation and with the help of graph we can find the covariates we should include in our model</p>
<div class="section" id="code-6-30">
<h4>Code 6.30<a class="headerlink" href="#code-6-30" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>S =&gt; Whether or not state is in southern USA</p></li>
<li><p>A =&gt; Median Age</p></li>
<li><p>M =&gt; Marriage Rate</p></li>
<li><p>W =&gt; Number of Waffle Houses</p></li>
<li><p>D =&gt; Divorce Rate</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dag_6_2</span> <span class="o">=</span> <span class="n">CausalGraphicalModel</span><span class="p">(</span>
    <span class="n">nodes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">],</span>
    <span class="n">edges</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">),</span>
           <span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">),</span>
           <span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;W&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">),</span>
           <span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">)])</span>

<span class="c1"># let&#39;s render the DAG as well (note - no code section for it in the book but is displayed)</span>
<span class="c1"># so instead of copying the picture we are generating it</span>

<span class="n">pgm</span> <span class="o">=</span> <span class="n">daft</span><span class="o">.</span><span class="n">PGM</span><span class="p">()</span>
<span class="n">coordinates</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;W&quot;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;D&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),}</span>
<span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">dag_6_2</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
    <span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">coordinates</span><span class="p">[</span><span class="n">node</span><span class="p">])</span>
<span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">dag_6_2</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
    <span class="n">pgm</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="o">*</span><span class="n">edge</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">render</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06_the_haunted_dag_and_the_causal_terror_137_0.png" src="../_images/06_the_haunted_dag_and_the_causal_terror_137_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_adjustment_sets</span> <span class="o">=</span> <span class="n">dag_6_2</span><span class="o">.</span><span class="n">get_all_backdoor_adjustment_sets</span><span class="p">(</span><span class="s2">&quot;W&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">all_adjustment_sets</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="ow">not</span> <span class="n">t</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_adjustment_sets</span> <span class="k">if</span> <span class="n">t</span> <span class="o">!=</span> <span class="n">s</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>frozenset({&#39;S&#39;})
frozenset({&#39;A&#39;, &#39;M&#39;})
</pre></div>
</div>
</div>
</div>
<p>This shows that we could control either for S alone or A and M</p>
</div>
<div class="section" id="code-6-31">
<h4>Code 6.31<a class="headerlink" href="#code-6-31" title="Permalink to this headline">¶</a></h4>
<p>Above DAG is not satisfactory as it assumes that there are <strong>no</strong> unobserved confounds.</p>
<p>We can further test the graph by finding the <strong>conditional independencies</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_independencies</span> <span class="o">=</span> <span class="n">dag_6_2</span><span class="o">.</span><span class="n">get_all_independence_relationships</span><span class="p">()</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">all_independencies</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
           <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_independencies</span> <span class="k">if</span> <span class="n">t</span> <span class="o">!=</span> <span class="n">s</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;S&#39;, &#39;D&#39;, {&#39;W&#39;, &#39;A&#39;, &#39;M&#39;})
(&#39;A&#39;, &#39;W&#39;, {&#39;S&#39;})
(&#39;M&#39;, &#39;W&#39;, {&#39;S&#39;})
</pre></div>
</div>
</div>
</div>
<p>Read above result as :</p>
<ul class="simple">
<li><p>Marriage Rate &amp; Waffle Houses should be independent if conditioning on S</p></li>
<li><p>Median Age &amp; Waffle Houses should be independent if conditioning on S</p></li>
<li><p>Being in south and Divorce Rate should be indpendent if condition on (W, M and A)</p></li>
</ul>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="05_the_many_variables_and_the_spurious_waffles.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Chapter 5 - The Many Variables &amp; The Spurious Waffles</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="07_ulysses_compass.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Chapter 7 - Ulysses’ Compass</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Richard McElreath<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>