
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chapter 13 - Models with Memory &#8212; Statistical Rethinking (2nd Edition)</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="canonical" href="https://ksachdeva.github.io/rethinking-tensorflow-probability/notebooks/13_models_with_memory.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Chapter 14 - Adventures in Covariance" href="14_adventures_in_covariance.html" />
    <link rel="prev" title="Chapter 12 - Monsters and Mixtures" href="12_monsters_and_mixtures.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Statistical Rethinking (2nd Edition)</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../README.html">
   Statistical Rethinking (2nd Edition) with Tensorflow Probability
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="00_preface.html">
   Preface
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="01_the_golem_of_prague.html">
   Chapter 1 The Gloem of Prague
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02_small_worlds_and_large_worlds.html">
   Chapter 2 - Small Worlds and Large Worlds
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03_sampling_the_imaginary.html">
   Chapter 3 - Sampling the Imaginary
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="04_geocentric_models.html">
   Chapter 4 - Geocentric Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="05_the_many_variables_and_the_spurious_waffles.html">
   Chapter 5 - The Many Variables &amp; The Spurious Waffles
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="06_the_haunted_dag_and_the_causal_terror.html">
   Chapter 6 - The Haunted DAG and The Causal Terror
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="07_ulysses_compass.html">
   Chapter 7 - Ulyssesâ€™ Compass
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="08_conditional_manatees.html">
   Chapter 8 - Conditional Manatees
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="09_markov_chain_monte_carlo.html">
   Chapter 9 - Markov Chain Monte Carlo
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="10_big_entropy_and_the_generalized_linear_model.html">
   Chapter 10 - Big Entropy and The Generalized Linear Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="11_god_spiked_the_integers.html">
   Chapter 11 - God Spiked the Integers
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="12_monsters_and_mixtures.html">
   Chapter 12 - Monsters and Mixtures
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Chapter 13 - Models with Memory
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="14_adventures_in_covariance.html">
   Chapter 14 - Adventures in Covariance
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="15_missing_data_and_other_opportunities.html">
   Chapter 15 - Missing Data and Other Opportunities
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="16_generalized_linear_madness.html">
   Chapter 16 - Generalized Linear Madness
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="17_horoscopes.html">
   Chapter 17 - Horoscopes
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/notebooks/13_models_with_memory.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/ksachdeva/rethinking-tensorflow-probability"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/ksachdeva/rethinking-tensorflow-probability/issues/new?title=Issue%20on%20page%20%2Fnotebooks/13_models_with_memory.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/ksachdeva/rethinking-tensorflow-probability/master?urlpath=tree/notebooks/13_models_with_memory.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Chapter 13 - Models with Memory
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#imports-and-utility-functions">
     Imports and utility functions
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dataset-url-utils">
     Dataset URL &amp; Utils
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#example-multilevel-tadpoles">
     13.1 Example: Multilevel tadpoles
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-13-1">
       Code 13.1
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-13-2">
       Code 13.2
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-13-3">
       Code 13.3
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-13-4">
       Code 13.4
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-13-5">
       Code 13.5
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-13-6">
       Code 13.6
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#varying-effects-and-the-underlying-overfitting-trade-off">
     13.2 Varying effects and the underlying/overfitting trade-off
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#the-model">
       13.2.1 The model
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#assign-values-to-the-parameters">
       13.2.2 Assign values to the parameters
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-7">
         Code 13.7
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-8">
         Code 13.8
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-9">
         Code 13.9
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-10">
         Code 13.10
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#simulate-survivors">
       13.2.3 Simulate survivors
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-11">
         Code 13.11
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#compute-the-no-pooling-estimates">
       13.2.4 Compute the no-pooling estimates
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-12">
         Code 13.12
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#compute-partial-pooling-estimates">
       13.2.5 Compute partial pooling estimates
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-13">
         Code 13.13
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-14">
         Code 13.14
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-15">
         Code 13.15
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-16">
         Code 13.16
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-17">
         Code 13.17
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-18">
         Code 13.18
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-19">
         Code 13.19
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#overthiking-repeating-the-pond-simulation">
       Overthiking: Repeating the pond simulation
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-20">
         Code 13.20
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#more-than-one-type-of-cluster">
     13.3 More than one type of cluster
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#multilevel-chimpanzees">
       13.3.1 Multilevel chimpanzees
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-21">
         Code 13.21
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-22">
         Code 13.22
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-23">
         Code 13.23
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-24">
         Code 13.24
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#even-more-clusters">
       13.3.2 Even more clusters
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-25">
         Code 13.25
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#divergent-transitions-and-non-centered-priors">
     13.4 Divergent transitions and non-centered priors
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#the-devil-s-funnel">
       13.4.1 The Devilâ€™s Funnel
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-26-todo-add-notes-on-divergence">
         Code 13.26 (TODO - add notes on divergence)
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-27">
         Code 13.27
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#non-centered-chimpanzees">
       13.4.2 Non-centered chimpanzees
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-28-todo-parameterize-the-target-accept-prob">
         Code 13.28 [TODO - parameterize the target accept prob]
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-29">
         Code 13.29
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-30-todo-do-not-how-to-compute-ess">
         Code 13.30 [TODO - do not how to compute ess]
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#multilevel-posterior-predictions">
     13.5 Multilevel posterior predictions
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#posterior-prediction-for-same-clusters">
       13.5.1 Posterior prediction for same clusters
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-31">
         Code 13.31
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-32">
         Code 13.32
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-33">
         Code 13.33
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-34">
         Code 13.34
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-35">
         Code 13.35
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#posterior-prediction-for-new-clusters">
       13.5.2 Posterior prediction for new clusters
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-36">
         Code 13.36
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-37">
         Code 13.37
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-38">
         Code 13.38
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-39">
         Code 13.39
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Chapter 13 - Models with Memory</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Chapter 13 - Models with Memory
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#imports-and-utility-functions">
     Imports and utility functions
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dataset-url-utils">
     Dataset URL &amp; Utils
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#example-multilevel-tadpoles">
     13.1 Example: Multilevel tadpoles
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-13-1">
       Code 13.1
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-13-2">
       Code 13.2
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-13-3">
       Code 13.3
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-13-4">
       Code 13.4
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-13-5">
       Code 13.5
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-13-6">
       Code 13.6
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#varying-effects-and-the-underlying-overfitting-trade-off">
     13.2 Varying effects and the underlying/overfitting trade-off
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#the-model">
       13.2.1 The model
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#assign-values-to-the-parameters">
       13.2.2 Assign values to the parameters
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-7">
         Code 13.7
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-8">
         Code 13.8
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-9">
         Code 13.9
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-10">
         Code 13.10
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#simulate-survivors">
       13.2.3 Simulate survivors
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-11">
         Code 13.11
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#compute-the-no-pooling-estimates">
       13.2.4 Compute the no-pooling estimates
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-12">
         Code 13.12
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#compute-partial-pooling-estimates">
       13.2.5 Compute partial pooling estimates
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-13">
         Code 13.13
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-14">
         Code 13.14
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-15">
         Code 13.15
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-16">
         Code 13.16
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-17">
         Code 13.17
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-18">
         Code 13.18
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-19">
         Code 13.19
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#overthiking-repeating-the-pond-simulation">
       Overthiking: Repeating the pond simulation
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-20">
         Code 13.20
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#more-than-one-type-of-cluster">
     13.3 More than one type of cluster
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#multilevel-chimpanzees">
       13.3.1 Multilevel chimpanzees
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-21">
         Code 13.21
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-22">
         Code 13.22
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-23">
         Code 13.23
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-24">
         Code 13.24
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#even-more-clusters">
       13.3.2 Even more clusters
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-25">
         Code 13.25
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#divergent-transitions-and-non-centered-priors">
     13.4 Divergent transitions and non-centered priors
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#the-devil-s-funnel">
       13.4.1 The Devilâ€™s Funnel
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-26-todo-add-notes-on-divergence">
         Code 13.26 (TODO - add notes on divergence)
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-27">
         Code 13.27
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#non-centered-chimpanzees">
       13.4.2 Non-centered chimpanzees
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-28-todo-parameterize-the-target-accept-prob">
         Code 13.28 [TODO - parameterize the target accept prob]
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-29">
         Code 13.29
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-30-todo-do-not-how-to-compute-ess">
         Code 13.30 [TODO - do not how to compute ess]
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#multilevel-posterior-predictions">
     13.5 Multilevel posterior predictions
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#posterior-prediction-for-same-clusters">
       13.5.1 Posterior prediction for same clusters
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-31">
         Code 13.31
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-32">
         Code 13.32
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-33">
         Code 13.33
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-34">
         Code 13.34
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-35">
         Code 13.35
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#posterior-prediction-for-new-clusters">
       13.5.2 Posterior prediction for new clusters
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-36">
         Code 13.36
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-37">
         Code 13.37
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-38">
         Code 13.38
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-13-39">
         Code 13.39
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <p><a class="reference external" href="https://colab.research.google.com/github/ksachdeva/rethinking-tensorflow-probability/blob/master/notebooks/13_models_with_memory.ipynb"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg" /></a></p>
<div class="tex2jax_ignore mathjax_ignore section" id="chapter-13-models-with-memory">
<h1>Chapter 13 - Models with Memory<a class="headerlink" href="#chapter-13-models-with-memory" title="Permalink to this headline">Â¶</a></h1>
<div class="section" id="imports-and-utility-functions">
<h2>Imports and utility functions<a class="headerlink" href="#imports-and-utility-functions" title="Permalink to this headline">Â¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Install packages that are not installed in colab</span>
<span class="k">try</span><span class="p">:</span>
  <span class="kn">import</span> <span class="nn">google.colab</span>
  <span class="n">IN_COLAB</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span><span class="p">:</span>
  <span class="n">IN_COLAB</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">if</span> <span class="n">IN_COLAB</span><span class="p">:</span>
    <span class="o">!</span>pip install -q watermark
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> watermark
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Core</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">arviz</span> <span class="k">as</span> <span class="nn">az</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">tensorflow_probability</span> <span class="k">as</span> <span class="nn">tfp</span>

<span class="c1"># visualization </span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># aliases</span>
<span class="n">tfd</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">distributions</span>
<span class="n">tfb</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">bijectors</span>
<span class="n">Root</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="o">.</span><span class="n">Root</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-01-17 21:35:33.362799: W tensorflow/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library &#39;libcudart.so.11.0&#39;; dlerror: libcudart.so.11.0: cannot open shared object file: No such file or directory
2022-01-17 21:35:33.362841: I tensorflow/stream_executor/cuda/cudart_stub.cc:29] Ignore above cudart dlerror if you do not have a GPU set up on your machine.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">watermark</span> -p numpy,tensorflow,tensorflow_probability,arviz,scipy,pandas
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>numpy                 : 1.21.5
tensorflow            : 2.7.0
tensorflow_probability: 0.15.0
arviz                 : 0.11.4
scipy                 : 1.7.3
pandas                : 1.3.5
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># config of various plotting libraries</span>
<span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">USE_XLA</span> <span class="o">=</span> <span class="kc">False</span>              <span class="c1">#@param</span>
<span class="n">NUMBER_OF_CHAINS</span>  <span class="o">=</span> <span class="mi">2</span>        <span class="c1">#@param </span>
<span class="n">NUMBER_OF_BURNIN</span>  <span class="o">=</span> <span class="mi">500</span>      <span class="c1">#@param</span>
<span class="n">NUMBER_OF_SAMPLES</span> <span class="o">=</span> <span class="mi">500</span>      <span class="c1">#@param</span>
<span class="n">NUMBER_OF_LEAPFROG_STEPS</span> <span class="o">=</span> <span class="mi">4</span> <span class="c1">#@param</span>

<span class="k">def</span> <span class="nf">_trace_to_arviz</span><span class="p">(</span><span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">sample_stats</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">observed_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">prior_predictive</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">posterior_predictive</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">trace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                 <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">trace</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="n">sample_stats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sample_stats</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">sample_stats</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sample_stats</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="n">prior_predictive</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prior_predictive</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">prior_predictive</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">prior_predictive</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="n">posterior_predictive</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">posterior_predictive</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">az</span><span class="o">.</span><span class="n">InferenceData</span><span class="p">)</span> <span class="ow">and</span> <span class="n">inplace</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">trace</span> <span class="o">+</span> <span class="n">az</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">posterior_predictive</span><span class="o">=</span><span class="n">posterior_predictive</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">az</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
        <span class="n">posterior</span><span class="o">=</span><span class="n">trace</span><span class="p">,</span>
        <span class="n">sample_stats</span><span class="o">=</span><span class="n">sample_stats</span><span class="p">,</span>
        <span class="n">prior_predictive</span><span class="o">=</span><span class="n">prior_predictive</span><span class="p">,</span>
        <span class="n">posterior_predictive</span><span class="o">=</span><span class="n">posterior_predictive</span><span class="p">,</span>
        <span class="n">observed_data</span><span class="o">=</span><span class="n">observed_data</span><span class="p">,</span>
    <span class="p">)</span>

<span class="nd">@tf</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="n">autograph</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">experimental_compile</span><span class="o">=</span><span class="n">USE_XLA</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">run_hmc_chain</span><span class="p">(</span><span class="n">init_state</span><span class="p">,</span>
              <span class="n">bijectors</span><span class="p">,</span> 
              <span class="n">step_size</span><span class="p">,</span> 
              <span class="n">target_log_prob_fn</span><span class="p">,</span> 
              <span class="n">num_leapfrog_steps</span><span class="o">=</span><span class="n">NUMBER_OF_LEAPFROG_STEPS</span><span class="p">,</span>
              <span class="n">num_samples</span><span class="o">=</span><span class="n">NUMBER_OF_SAMPLES</span><span class="p">,</span>
              <span class="n">burnin</span><span class="o">=</span><span class="n">NUMBER_OF_BURNIN</span><span class="p">,</span>
              <span class="p">):</span>    

    <span class="k">def</span> <span class="nf">_trace_fn_transitioned</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">pkr</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">pkr</span><span class="o">.</span><span class="n">inner_results</span><span class="o">.</span><span class="n">inner_results</span><span class="o">.</span><span class="n">log_accept_ratio</span>
        <span class="p">)</span>

    <span class="n">hmc_kernel</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">mcmc</span><span class="o">.</span><span class="n">HamiltonianMonteCarlo</span><span class="p">(</span>
                    <span class="n">target_log_prob_fn</span><span class="p">,</span>
                    <span class="n">num_leapfrog_steps</span><span class="o">=</span><span class="n">num_leapfrog_steps</span><span class="p">,</span>
                    <span class="n">step_size</span><span class="o">=</span><span class="n">step_size</span><span class="p">)</span>         

    <span class="n">inner_kernel</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">mcmc</span><span class="o">.</span><span class="n">TransformedTransitionKernel</span><span class="p">(</span>
        <span class="n">inner_kernel</span><span class="o">=</span><span class="n">hmc_kernel</span><span class="p">,</span>
        <span class="n">bijector</span><span class="o">=</span><span class="n">bijectors</span><span class="p">)</span>       

    <span class="n">kernel</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">mcmc</span><span class="o">.</span><span class="n">SimpleStepSizeAdaptation</span><span class="p">(</span>
        <span class="n">inner_kernel</span><span class="o">=</span><span class="n">inner_kernel</span><span class="p">,</span>
        <span class="n">target_accept_prob</span><span class="o">=</span><span class="mf">.8</span><span class="p">,</span>
        <span class="n">num_adaptation_steps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.8</span><span class="o">*</span><span class="n">burnin</span><span class="p">),</span>
        <span class="n">log_accept_prob_getter_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">pkr</span><span class="p">:</span> <span class="n">pkr</span><span class="o">.</span><span class="n">inner_results</span><span class="o">.</span><span class="n">log_accept_ratio</span>
    <span class="p">)</span>    

    <span class="n">results</span><span class="p">,</span> <span class="n">sampler_stat</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">mcmc</span><span class="o">.</span><span class="n">sample_chain</span><span class="p">(</span>
        <span class="n">num_results</span><span class="o">=</span><span class="n">num_samples</span><span class="p">,</span>
        <span class="n">num_burnin_steps</span><span class="o">=</span><span class="n">burnin</span><span class="p">,</span>
        <span class="n">current_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
        <span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span>
        <span class="n">trace_fn</span><span class="o">=</span><span class="n">_trace_fn_transitioned</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="n">sampler_stat</span>    

<span class="k">def</span> <span class="nf">sample_posterior</span><span class="p">(</span><span class="n">jdc</span><span class="p">,</span> 
              <span class="n">observed_data</span><span class="p">,</span> 
              <span class="n">params</span><span class="p">,</span> 
              <span class="n">init_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
              <span class="n">bijectors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
              <span class="n">step_size</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
              <span class="n">num_chains</span><span class="o">=</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">,</span>                  
              <span class="n">num_samples</span><span class="o">=</span><span class="n">NUMBER_OF_SAMPLES</span><span class="p">,</span> 
              <span class="n">burnin</span><span class="o">=</span><span class="n">NUMBER_OF_BURNIN</span><span class="p">):</span>
        
    <span class="k">if</span> <span class="n">init_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">init_state</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">jdc</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">bijectors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span><span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">init_state</span><span class="p">]</span>

    <span class="n">target_log_prob_fn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">x</span><span class="p">:</span> <span class="n">jdc</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">observed_data</span><span class="p">)</span>  

    <span class="n">results</span><span class="p">,</span> <span class="n">sample_stats</span> <span class="o">=</span> <span class="n">run_hmc_chain</span><span class="p">(</span><span class="n">init_state</span><span class="p">,</span>
                                  <span class="n">bijectors</span><span class="p">,</span>
                                  <span class="n">step_size</span><span class="o">=</span><span class="n">step_size</span><span class="p">,</span>
                                  <span class="n">target_log_prob_fn</span><span class="o">=</span><span class="n">target_log_prob_fn</span><span class="p">,</span>                                      
                                  <span class="n">num_samples</span><span class="o">=</span><span class="n">num_samples</span><span class="p">,</span> 
                                  <span class="n">burnin</span><span class="o">=</span><span class="n">burnin</span><span class="p">)</span>

    <span class="n">stat_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mean_tree_accept&#39;</span><span class="p">]</span>
    <span class="n">sampler_stats</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">stat_names</span><span class="p">,</span> <span class="p">[</span><span class="n">sample_stats</span><span class="p">]))</span>      
        
    <span class="n">transposed_results</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">transposed_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">transposed_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> 
        
        <span class="n">transposed_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">transposed_shape</span><span class="p">))</span>

    <span class="n">posterior</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">transposed_results</span><span class="p">))</span>        

    <span class="n">az_trace</span> <span class="o">=</span> <span class="n">_trace_to_arviz</span><span class="p">(</span><span class="n">trace</span><span class="o">=</span><span class="n">posterior</span><span class="p">,</span> 
                           <span class="n">sample_stats</span><span class="o">=</span><span class="n">sampler_stats</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">posterior</span><span class="p">,</span> <span class="n">az_trace</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="dataset-url-utils">
<h2>Dataset URL &amp; Utils<a class="headerlink" href="#dataset-url-utils" title="Permalink to this headline">Â¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># You could change base url to local dir or a remoate raw github content</span>
<span class="n">_BASE_URL</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/rmcelreath/rethinking/master/data&quot;</span>

<span class="n">REEDFROGS_DATASET_PATH</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_BASE_URL</span><span class="si">}</span><span class="s2">/reedfrogs.csv&quot;</span>
<span class="n">CHIMPANZEES_DATASET_PATH</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_BASE_URL</span><span class="si">}</span><span class="s2">/chimpanzees.csv&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># A utility method to convert data (columns) from pandas dataframe</span>
<span class="c1"># into tensors with appropriate type</span>
<span class="k">def</span> <span class="nf">df_to_tensors</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">default_type</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; name : Name of the dataset</span>
<span class="sd">        df : pandas dataframe</span>
<span class="sd">        colums : a list of names that have the same type or</span>
<span class="sd">                 a dictionary where keys are the column names and values are the tensorflow type (e.g. tf.float32)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
        <span class="n">column_names</span> <span class="o">=</span> <span class="n">columns</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">columns</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>    
    <span class="k">else</span><span class="p">:</span>
        <span class="n">column_names</span> <span class="o">=</span> <span class="n">columns</span>        
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">default_type</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">]</span>    
        
    <span class="c1"># build the cls</span>
    <span class="n">tuple_cls</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">column_names</span><span class="p">)</span>    
    <span class="c1"># build the obj</span>
    <span class="k">return</span> <span class="n">tuple_cls</span><span class="o">.</span><span class="n">_make</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="introduction">
<h1>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">Â¶</a></h1>
<div class="section" id="example-multilevel-tadpoles">
<h2>13.1 Example: Multilevel tadpoles<a class="headerlink" href="#example-multilevel-tadpoles" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="code-13-1">
<h3>Code 13.1<a class="headerlink" href="#code-13-1" title="Permalink to this headline">Â¶</a></h3>
<p>Reedfrogs dataset is about the tadpole mortality. The objective will be determine the <code class="docutils literal notranslate"><span class="pre">surv</span></code> out of an initial count, <code class="docutils literal notranslate"><span class="pre">density</span></code>.</p>
<p>Author explains that within each tank there are things that go unmeasured and these unmeasured factors create variation in survival across tanks.</p>
<p>These tanks are an example of <strong>cluster</strong> variable</p>
<p>He argues that both of the approaches -
* treat the tanks independetly i.e. each of them have their unique intecepts
* treat them togather</p>
<p>have issues.</p>
<p>for e.g.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>- unique intecepts will imply that we are not using information from other tanks.
- all togather will have the problem ignoring varations in baseline survival 
</pre></div>
</div>
<p>A multilevel model, in which we simultaneously estimate both an intercept for each tank and the variation among tanks, is what we want !</p>
<p>This type of a model is called <strong>Varying intercepts</strong> model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">REEDFROGS_DATASET_PATH</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>density</th>
      <th>pred</th>
      <th>size</th>
      <th>surv</th>
      <th>propsurv</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>10</td>
      <td>no</td>
      <td>big</td>
      <td>9</td>
      <td>0.9</td>
    </tr>
    <tr>
      <th>1</th>
      <td>10</td>
      <td>no</td>
      <td>big</td>
      <td>10</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>10</td>
      <td>no</td>
      <td>big</td>
      <td>7</td>
      <td>0.7</td>
    </tr>
    <tr>
      <th>3</th>
      <td>10</td>
      <td>no</td>
      <td>big</td>
      <td>10</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>10</td>
      <td>no</td>
      <td>small</td>
      <td>9</td>
      <td>0.9</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="code-13-2">
<h3>Code 13.2<a class="headerlink" href="#code-13-2" title="Permalink to this headline">Â¶</a></h3>
<p>Our simple model. This will give us 48 different intercepts. This means that it does not use the information available between each tank</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;tank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">alpha_sample_shape</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;tank&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># dat = dict(</span>
<span class="c1">#     S=tf.cast(d.surv.values, dtype=tf.float32),</span>
<span class="c1">#     N=tf.cast(d.density.values, dtype=tf.float32),</span>
<span class="c1">#     tank=d.tank.values)</span>

<span class="n">tdf</span> <span class="o">=</span> <span class="n">df_to_tensors</span><span class="p">(</span><span class="s2">&quot;ReedFrogs&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="p">{</span>
    <span class="s2">&quot;tank&quot;</span>    <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span>
    <span class="s2">&quot;surv&quot;</span>    <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="s2">&quot;density&quot;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span>
<span class="p">})</span>

<span class="k">def</span> <span class="nf">model_13_1</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">density</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>      
      <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="n">alpha_sample_shape</span><span class="p">))</span>
      <span class="n">p</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)))</span>        
        
      <span class="n">S</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span><span class="n">total_count</span><span class="o">=</span><span class="n">density</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="n">p</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>             
      
    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    
    
<span class="n">jdc_13_1</span> <span class="o">=</span> <span class="n">model_13_1</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">tank</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">density</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-01-17 21:35:36.143959: W tensorflow/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library &#39;libcuda.so.1&#39;; dlerror: libcuda.so.1: cannot open shared object file: No such file or directory
2022-01-17 21:35:36.143995: W tensorflow/stream_executor/cuda/cuda_driver.cc:269] failed call to cuInit: UNKNOWN ERROR (303)
2022-01-17 21:35:36.144037: I tensorflow/stream_executor/cuda/cuda_diagnostics.cc:156] kernel driver does not appear to be running on this host (fv-az272-145): /proc/driver/nvidia/version does not exist
2022-01-17 21:35:36.144381: I tensorflow/core/platform/cpu_feature_guard.cc:151] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  AVX2 FMA
To enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NUM_CHAINS_FOR_13_1</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_13_1</span><span class="p">,</span> <span class="n">alpha_sample_shape</span><span class="p">])</span>
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
<span class="p">]</span>

<span class="n">posterior_13_1</span><span class="p">,</span> <span class="n">trace_13_1</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span><span class="n">jdc_13_1</span><span class="p">,</span>
                               <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">surv</span><span class="p">,),</span>
                               <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span>
                               <span class="n">num_chains</span><span class="o">=</span><span class="n">NUM_CHAINS_FOR_13_1</span><span class="p">,</span>
                               <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                               <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">)</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_13_1</span><span class="p">,</span> <span class="n">round_to</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:@custom_gradient grad_fn has &#39;variables&#39; in signature, but no ResourceVariables were used on the forward pass.
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha[0]</th>
      <td>1.72</td>
      <td>0.74</td>
      <td>0.53</td>
      <td>2.85</td>
      <td>0.03</td>
      <td>0.02</td>
      <td>662.51</td>
      <td>426.34</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[1]</th>
      <td>2.41</td>
      <td>0.92</td>
      <td>1.01</td>
      <td>3.97</td>
      <td>0.04</td>
      <td>0.03</td>
      <td>518.08</td>
      <td>372.48</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[2]</th>
      <td>0.72</td>
      <td>0.59</td>
      <td>-0.22</td>
      <td>1.57</td>
      <td>0.02</td>
      <td>0.02</td>
      <td>1039.16</td>
      <td>415.47</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[3]</th>
      <td>2.41</td>
      <td>0.92</td>
      <td>1.21</td>
      <td>4.04</td>
      <td>0.05</td>
      <td>0.04</td>
      <td>398.92</td>
      <td>492.58</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[4]</th>
      <td>1.69</td>
      <td>0.78</td>
      <td>0.44</td>
      <td>2.87</td>
      <td>0.03</td>
      <td>0.02</td>
      <td>667.52</td>
      <td>371.82</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[5]</th>
      <td>1.71</td>
      <td>0.74</td>
      <td>0.62</td>
      <td>3.02</td>
      <td>0.03</td>
      <td>0.02</td>
      <td>729.48</td>
      <td>358.92</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[6]</th>
      <td>2.42</td>
      <td>0.88</td>
      <td>0.96</td>
      <td>3.67</td>
      <td>0.04</td>
      <td>0.03</td>
      <td>497.18</td>
      <td>386.50</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[7]</th>
      <td>1.76</td>
      <td>0.77</td>
      <td>0.61</td>
      <td>3.03</td>
      <td>0.03</td>
      <td>0.03</td>
      <td>657.65</td>
      <td>323.13</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[8]</th>
      <td>-0.38</td>
      <td>0.63</td>
      <td>-1.34</td>
      <td>0.58</td>
      <td>0.02</td>
      <td>0.03</td>
      <td>1079.47</td>
      <td>413.87</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[9]</th>
      <td>1.79</td>
      <td>0.83</td>
      <td>0.53</td>
      <td>3.12</td>
      <td>0.04</td>
      <td>0.03</td>
      <td>469.64</td>
      <td>410.50</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[10]</th>
      <td>0.79</td>
      <td>0.63</td>
      <td>-0.27</td>
      <td>1.70</td>
      <td>0.02</td>
      <td>0.02</td>
      <td>1135.93</td>
      <td>495.84</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[11]</th>
      <td>0.38</td>
      <td>0.59</td>
      <td>-0.55</td>
      <td>1.24</td>
      <td>0.02</td>
      <td>0.02</td>
      <td>1156.55</td>
      <td>509.43</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[12]</th>
      <td>0.73</td>
      <td>0.64</td>
      <td>-0.41</td>
      <td>1.62</td>
      <td>0.02</td>
      <td>0.02</td>
      <td>847.87</td>
      <td>378.83</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[13]</th>
      <td>0.00</td>
      <td>0.54</td>
      <td>-0.76</td>
      <td>0.86</td>
      <td>0.02</td>
      <td>0.02</td>
      <td>994.56</td>
      <td>618.91</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[14]</th>
      <td>1.72</td>
      <td>0.79</td>
      <td>0.44</td>
      <td>2.97</td>
      <td>0.03</td>
      <td>0.02</td>
      <td>718.83</td>
      <td>485.77</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[15]</th>
      <td>1.72</td>
      <td>0.76</td>
      <td>0.40</td>
      <td>2.77</td>
      <td>0.03</td>
      <td>0.03</td>
      <td>543.59</td>
      <td>384.21</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[16]</th>
      <td>2.57</td>
      <td>0.71</td>
      <td>1.54</td>
      <td>3.68</td>
      <td>0.03</td>
      <td>0.02</td>
      <td>749.87</td>
      <td>372.15</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[17]</th>
      <td>2.14</td>
      <td>0.58</td>
      <td>1.26</td>
      <td>3.04</td>
      <td>0.02</td>
      <td>0.01</td>
      <td>1497.08</td>
      <td>386.57</td>
      <td>1.02</td>
    </tr>
    <tr>
      <th>alpha[18]</th>
      <td>1.82</td>
      <td>0.54</td>
      <td>1.05</td>
      <td>2.74</td>
      <td>0.02</td>
      <td>0.01</td>
      <td>1268.57</td>
      <td>404.19</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[19]</th>
      <td>3.17</td>
      <td>0.85</td>
      <td>1.97</td>
      <td>4.65</td>
      <td>0.04</td>
      <td>0.03</td>
      <td>474.11</td>
      <td>308.06</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[20]</th>
      <td>2.18</td>
      <td>0.67</td>
      <td>1.11</td>
      <td>3.20</td>
      <td>0.03</td>
      <td>0.02</td>
      <td>752.48</td>
      <td>160.87</td>
      <td>1.03</td>
    </tr>
    <tr>
      <th>alpha[21]</th>
      <td>2.13</td>
      <td>0.61</td>
      <td>1.15</td>
      <td>3.03</td>
      <td>0.02</td>
      <td>0.01</td>
      <td>1090.62</td>
      <td>336.92</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[22]</th>
      <td>2.13</td>
      <td>0.58</td>
      <td>1.33</td>
      <td>3.18</td>
      <td>0.02</td>
      <td>0.02</td>
      <td>1168.09</td>
      <td>307.88</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[23]</th>
      <td>1.55</td>
      <td>0.51</td>
      <td>0.73</td>
      <td>2.22</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>1157.83</td>
      <td>163.58</td>
      <td>1.04</td>
    </tr>
    <tr>
      <th>alpha[24]</th>
      <td>-1.11</td>
      <td>0.41</td>
      <td>-1.77</td>
      <td>-0.50</td>
      <td>0.01</td>
      <td>0.02</td>
      <td>1137.35</td>
      <td>28.59</td>
      <td>1.24</td>
    </tr>
    <tr>
      <th>alpha[25]</th>
      <td>0.08</td>
      <td>0.38</td>
      <td>-0.43</td>
      <td>0.74</td>
      <td>0.01</td>
      <td>0.03</td>
      <td>1659.76</td>
      <td>185.91</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[26]</th>
      <td>-1.54</td>
      <td>0.45</td>
      <td>-2.35</td>
      <td>-0.88</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>1940.88</td>
      <td>181.86</td>
      <td>1.06</td>
    </tr>
    <tr>
      <th>alpha[27]</th>
      <td>-0.54</td>
      <td>0.40</td>
      <td>-1.21</td>
      <td>0.02</td>
      <td>0.01</td>
      <td>0.02</td>
      <td>1126.60</td>
      <td>217.74</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[28]</th>
      <td>0.08</td>
      <td>0.38</td>
      <td>-0.45</td>
      <td>0.71</td>
      <td>0.01</td>
      <td>0.02</td>
      <td>922.85</td>
      <td>344.11</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[29]</th>
      <td>1.31</td>
      <td>0.43</td>
      <td>0.58</td>
      <td>1.91</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>1250.60</td>
      <td>146.74</td>
      <td>1.06</td>
    </tr>
    <tr>
      <th>alpha[30]</th>
      <td>-0.72</td>
      <td>0.41</td>
      <td>-1.31</td>
      <td>0.00</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>1743.48</td>
      <td>206.33</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[31]</th>
      <td>-0.38</td>
      <td>0.35</td>
      <td>-0.98</td>
      <td>0.10</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>1397.87</td>
      <td>385.87</td>
      <td>1.02</td>
    </tr>
    <tr>
      <th>alpha[32]</th>
      <td>2.83</td>
      <td>0.60</td>
      <td>1.90</td>
      <td>3.80</td>
      <td>0.02</td>
      <td>0.02</td>
      <td>747.39</td>
      <td>363.79</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[33]</th>
      <td>2.46</td>
      <td>0.60</td>
      <td>1.43</td>
      <td>3.36</td>
      <td>0.02</td>
      <td>0.01</td>
      <td>1138.93</td>
      <td>232.33</td>
      <td>1.03</td>
    </tr>
    <tr>
      <th>alpha[34]</th>
      <td>2.49</td>
      <td>0.60</td>
      <td>1.66</td>
      <td>3.45</td>
      <td>0.02</td>
      <td>0.02</td>
      <td>769.79</td>
      <td>309.06</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[35]</th>
      <td>1.91</td>
      <td>0.45</td>
      <td>1.26</td>
      <td>2.71</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>1391.90</td>
      <td>103.37</td>
      <td>1.02</td>
    </tr>
    <tr>
      <th>alpha[36]</th>
      <td>1.90</td>
      <td>0.43</td>
      <td>1.22</td>
      <td>2.58</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>1179.36</td>
      <td>104.00</td>
      <td>1.15</td>
    </tr>
    <tr>
      <th>alpha[37]</th>
      <td>3.34</td>
      <td>0.78</td>
      <td>2.09</td>
      <td>4.47</td>
      <td>0.03</td>
      <td>0.02</td>
      <td>621.62</td>
      <td>461.22</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[38]</th>
      <td>2.43</td>
      <td>0.56</td>
      <td>1.55</td>
      <td>3.26</td>
      <td>0.02</td>
      <td>0.01</td>
      <td>1025.77</td>
      <td>271.02</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[39]</th>
      <td>2.15</td>
      <td>0.52</td>
      <td>1.41</td>
      <td>2.99</td>
      <td>0.02</td>
      <td>0.01</td>
      <td>1074.54</td>
      <td>138.57</td>
      <td>1.06</td>
    </tr>
    <tr>
      <th>alpha[40]</th>
      <td>-1.92</td>
      <td>0.52</td>
      <td>-2.70</td>
      <td>-1.18</td>
      <td>0.02</td>
      <td>0.02</td>
      <td>1321.46</td>
      <td>44.93</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[41]</th>
      <td>-0.62</td>
      <td>0.34</td>
      <td>-1.12</td>
      <td>-0.07</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>992.93</td>
      <td>545.30</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[42]</th>
      <td>-0.54</td>
      <td>0.35</td>
      <td>-1.15</td>
      <td>-0.02</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>900.27</td>
      <td>486.65</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[43]</th>
      <td>-0.38</td>
      <td>0.31</td>
      <td>-0.90</td>
      <td>0.07</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>782.73</td>
      <td>767.33</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[44]</th>
      <td>0.52</td>
      <td>0.31</td>
      <td>0.04</td>
      <td>1.02</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>853.81</td>
      <td>731.75</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[45]</th>
      <td>-0.62</td>
      <td>0.33</td>
      <td>-1.14</td>
      <td>-0.09</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>854.92</td>
      <td>563.42</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[46]</th>
      <td>1.90</td>
      <td>0.49</td>
      <td>1.10</td>
      <td>2.61</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>1414.90</td>
      <td>47.56</td>
      <td>1.07</td>
    </tr>
    <tr>
      <th>alpha[47]</th>
      <td>-0.07</td>
      <td>0.33</td>
      <td>-0.56</td>
      <td>0.45</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>717.40</td>
      <td>695.93</td>
      <td>1.01</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="code-13-3">
<h3>Code 13.3<a class="headerlink" href="#code-13-3" title="Permalink to this headline">Â¶</a></h3>
<p>We now build a multilevel model, which adaptively pools information across tanks.</p>
<p>In order to do so, we must make the prior for the parameter <strong>alpha</strong> a function of some new parameters.</p>
<p>Prior itself has priors !</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_13_2</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">density</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>     
      <span class="n">a_bar</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">a_bar</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="n">alpha_sample_shape</span><span class="p">)</span>
      <span class="n">p</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)))</span>              
        
      <span class="n">S</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span><span class="n">total_count</span><span class="o">=</span><span class="n">density</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="n">p</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>             
      
    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    
    
<span class="n">jdc_13_2</span> <span class="o">=</span> <span class="n">model_13_2</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">tank</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">density</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NUM_CHAINS_FOR_13_2</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_13_2</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_13_2</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_13_2</span><span class="p">,</span> <span class="n">alpha_sample_shape</span><span class="p">])</span>
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_13_2</span><span class="p">,</span> <span class="n">trace_13_2</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span><span class="n">jdc_13_2</span><span class="p">,</span>
                                       <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">surv</span><span class="p">,),</span>
                                       <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a_bar&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">],</span>
                                       <span class="n">num_chains</span><span class="o">=</span><span class="n">NUM_CHAINS_FOR_13_2</span><span class="p">,</span> 
                                       <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                                       <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">)</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_13_2</span><span class="p">,</span> <span class="n">round_to</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a_bar</th>
      <td>1.36</td>
      <td>0.28</td>
      <td>0.93</td>
      <td>1.81</td>
      <td>0.02</td>
      <td>0.01</td>
      <td>367.94</td>
      <td>202.31</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>1.63</td>
      <td>0.22</td>
      <td>1.29</td>
      <td>1.98</td>
      <td>0.02</td>
      <td>0.02</td>
      <td>88.27</td>
      <td>144.21</td>
      <td>1.02</td>
    </tr>
    <tr>
      <th>alpha[0]</th>
      <td>1.99</td>
      <td>0.86</td>
      <td>0.70</td>
      <td>3.24</td>
      <td>0.09</td>
      <td>0.07</td>
      <td>86.35</td>
      <td>130.53</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[1]</th>
      <td>2.98</td>
      <td>1.04</td>
      <td>1.38</td>
      <td>4.48</td>
      <td>0.12</td>
      <td>0.09</td>
      <td>75.27</td>
      <td>130.82</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[2]</th>
      <td>1.02</td>
      <td>0.66</td>
      <td>0.05</td>
      <td>2.12</td>
      <td>0.05</td>
      <td>0.04</td>
      <td>164.64</td>
      <td>253.38</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[3]</th>
      <td>3.49</td>
      <td>1.30</td>
      <td>1.46</td>
      <td>5.50</td>
      <td>0.18</td>
      <td>0.13</td>
      <td>56.62</td>
      <td>80.46</td>
      <td>1.07</td>
    </tr>
    <tr>
      <th>alpha[4]</th>
      <td>2.13</td>
      <td>0.79</td>
      <td>0.86</td>
      <td>3.34</td>
      <td>0.08</td>
      <td>0.06</td>
      <td>99.47</td>
      <td>168.47</td>
      <td>1.04</td>
    </tr>
    <tr>
      <th>alpha[5]</th>
      <td>2.40</td>
      <td>0.96</td>
      <td>0.89</td>
      <td>3.83</td>
      <td>0.10</td>
      <td>0.07</td>
      <td>91.47</td>
      <td>186.95</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[6]</th>
      <td>3.23</td>
      <td>1.12</td>
      <td>1.71</td>
      <td>4.69</td>
      <td>0.16</td>
      <td>0.13</td>
      <td>62.30</td>
      <td>28.60</td>
      <td>1.03</td>
    </tr>
    <tr>
      <th>alpha[7]</th>
      <td>2.15</td>
      <td>0.87</td>
      <td>0.89</td>
      <td>3.51</td>
      <td>0.17</td>
      <td>0.12</td>
      <td>26.38</td>
      <td>150.28</td>
      <td>1.10</td>
    </tr>
    <tr>
      <th>alpha[8]</th>
      <td>-0.19</td>
      <td>0.61</td>
      <td>-1.07</td>
      <td>0.87</td>
      <td>0.05</td>
      <td>0.03</td>
      <td>160.32</td>
      <td>213.08</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[9]</th>
      <td>2.09</td>
      <td>0.88</td>
      <td>0.59</td>
      <td>3.38</td>
      <td>0.09</td>
      <td>0.06</td>
      <td>107.27</td>
      <td>226.14</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[10]</th>
      <td>1.01</td>
      <td>0.68</td>
      <td>-0.16</td>
      <td>1.99</td>
      <td>0.05</td>
      <td>0.04</td>
      <td>161.87</td>
      <td>238.06</td>
      <td>1.03</td>
    </tr>
    <tr>
      <th>alpha[11]</th>
      <td>0.52</td>
      <td>0.64</td>
      <td>-0.44</td>
      <td>1.52</td>
      <td>0.05</td>
      <td>0.03</td>
      <td>176.35</td>
      <td>428.86</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[12]</th>
      <td>0.97</td>
      <td>0.66</td>
      <td>-0.06</td>
      <td>1.96</td>
      <td>0.06</td>
      <td>0.04</td>
      <td>144.25</td>
      <td>199.21</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[13]</th>
      <td>0.22</td>
      <td>0.61</td>
      <td>-0.65</td>
      <td>1.16</td>
      <td>0.04</td>
      <td>0.03</td>
      <td>235.10</td>
      <td>330.90</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[14]</th>
      <td>2.15</td>
      <td>0.80</td>
      <td>0.90</td>
      <td>3.36</td>
      <td>0.07</td>
      <td>0.05</td>
      <td>118.37</td>
      <td>193.03</td>
      <td>1.03</td>
    </tr>
    <tr>
      <th>alpha[15]</th>
      <td>2.19</td>
      <td>0.88</td>
      <td>0.86</td>
      <td>3.69</td>
      <td>0.09</td>
      <td>0.06</td>
      <td>93.17</td>
      <td>161.29</td>
      <td>1.05</td>
    </tr>
    <tr>
      <th>alpha[16]</th>
      <td>2.94</td>
      <td>0.87</td>
      <td>1.69</td>
      <td>4.16</td>
      <td>0.10</td>
      <td>0.07</td>
      <td>91.59</td>
      <td>84.43</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[17]</th>
      <td>2.42</td>
      <td>0.67</td>
      <td>1.36</td>
      <td>3.39</td>
      <td>0.05</td>
      <td>0.04</td>
      <td>153.47</td>
      <td>241.01</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[18]</th>
      <td>1.97</td>
      <td>0.60</td>
      <td>1.05</td>
      <td>2.87</td>
      <td>0.05</td>
      <td>0.04</td>
      <td>198.49</td>
      <td>260.12</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[19]</th>
      <td>3.78</td>
      <td>0.91</td>
      <td>2.32</td>
      <td>5.20</td>
      <td>0.09</td>
      <td>0.06</td>
      <td>115.25</td>
      <td>139.50</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[20]</th>
      <td>2.48</td>
      <td>0.74</td>
      <td>1.43</td>
      <td>3.70</td>
      <td>0.07</td>
      <td>0.05</td>
      <td>127.06</td>
      <td>256.94</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[21]</th>
      <td>2.37</td>
      <td>0.62</td>
      <td>1.43</td>
      <td>3.37</td>
      <td>0.05</td>
      <td>0.03</td>
      <td>187.99</td>
      <td>222.59</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[22]</th>
      <td>2.33</td>
      <td>0.64</td>
      <td>1.27</td>
      <td>3.35</td>
      <td>0.05</td>
      <td>0.04</td>
      <td>159.78</td>
      <td>188.13</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[23]</th>
      <td>1.74</td>
      <td>0.54</td>
      <td>1.01</td>
      <td>2.73</td>
      <td>0.04</td>
      <td>0.03</td>
      <td>190.44</td>
      <td>230.36</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[24]</th>
      <td>-1.02</td>
      <td>0.43</td>
      <td>-1.79</td>
      <td>-0.42</td>
      <td>0.02</td>
      <td>0.02</td>
      <td>373.15</td>
      <td>473.34</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[25]</th>
      <td>0.16</td>
      <td>0.38</td>
      <td>-0.37</td>
      <td>0.82</td>
      <td>0.02</td>
      <td>0.01</td>
      <td>510.96</td>
      <td>549.92</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[26]</th>
      <td>-1.43</td>
      <td>0.48</td>
      <td>-2.21</td>
      <td>-0.73</td>
      <td>0.03</td>
      <td>0.02</td>
      <td>273.94</td>
      <td>404.33</td>
      <td>1.02</td>
    </tr>
    <tr>
      <th>alpha[27]</th>
      <td>-0.45</td>
      <td>0.42</td>
      <td>-1.15</td>
      <td>0.17</td>
      <td>0.02</td>
      <td>0.01</td>
      <td>486.42</td>
      <td>532.11</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[28]</th>
      <td>0.14</td>
      <td>0.41</td>
      <td>-0.53</td>
      <td>0.79</td>
      <td>0.02</td>
      <td>0.01</td>
      <td>409.77</td>
      <td>415.44</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[29]</th>
      <td>1.41</td>
      <td>0.48</td>
      <td>0.77</td>
      <td>2.30</td>
      <td>0.03</td>
      <td>0.02</td>
      <td>341.73</td>
      <td>428.00</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[30]</th>
      <td>-0.64</td>
      <td>0.40</td>
      <td>-1.22</td>
      <td>-0.03</td>
      <td>0.02</td>
      <td>0.01</td>
      <td>383.71</td>
      <td>543.00</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[31]</th>
      <td>-0.31</td>
      <td>0.41</td>
      <td>-0.93</td>
      <td>0.36</td>
      <td>0.02</td>
      <td>0.01</td>
      <td>563.95</td>
      <td>509.02</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[32]</th>
      <td>3.09</td>
      <td>0.79</td>
      <td>1.91</td>
      <td>4.15</td>
      <td>0.08</td>
      <td>0.06</td>
      <td>104.12</td>
      <td>129.07</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[33]</th>
      <td>2.83</td>
      <td>0.70</td>
      <td>1.74</td>
      <td>3.80</td>
      <td>0.07</td>
      <td>0.05</td>
      <td>122.97</td>
      <td>97.33</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[34]</th>
      <td>2.74</td>
      <td>0.62</td>
      <td>1.75</td>
      <td>3.65</td>
      <td>0.04</td>
      <td>0.03</td>
      <td>205.87</td>
      <td>386.62</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[35]</th>
      <td>2.08</td>
      <td>0.51</td>
      <td>1.25</td>
      <td>2.84</td>
      <td>0.03</td>
      <td>0.02</td>
      <td>273.63</td>
      <td>310.67</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[36]</th>
      <td>2.07</td>
      <td>0.48</td>
      <td>1.35</td>
      <td>2.87</td>
      <td>0.03</td>
      <td>0.02</td>
      <td>299.65</td>
      <td>492.27</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[37]</th>
      <td>3.97</td>
      <td>1.01</td>
      <td>2.39</td>
      <td>5.57</td>
      <td>0.12</td>
      <td>0.09</td>
      <td>80.66</td>
      <td>120.93</td>
      <td>1.02</td>
    </tr>
    <tr>
      <th>alpha[38]</th>
      <td>2.69</td>
      <td>0.68</td>
      <td>1.67</td>
      <td>3.75</td>
      <td>0.05</td>
      <td>0.04</td>
      <td>183.89</td>
      <td>180.47</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[39]</th>
      <td>2.35</td>
      <td>0.56</td>
      <td>1.39</td>
      <td>3.17</td>
      <td>0.04</td>
      <td>0.03</td>
      <td>227.21</td>
      <td>309.37</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[40]</th>
      <td>-1.79</td>
      <td>0.48</td>
      <td>-2.50</td>
      <td>-0.98</td>
      <td>0.03</td>
      <td>0.02</td>
      <td>309.82</td>
      <td>353.33</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[41]</th>
      <td>-0.58</td>
      <td>0.34</td>
      <td>-1.11</td>
      <td>-0.06</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>708.85</td>
      <td>552.46</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[42]</th>
      <td>-0.46</td>
      <td>0.32</td>
      <td>-0.95</td>
      <td>0.07</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>709.79</td>
      <td>680.51</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[43]</th>
      <td>-0.33</td>
      <td>0.36</td>
      <td>-0.93</td>
      <td>0.22</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>684.13</td>
      <td>657.00</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[44]</th>
      <td>0.58</td>
      <td>0.34</td>
      <td>0.09</td>
      <td>1.14</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>748.36</td>
      <td>465.38</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[45]</th>
      <td>-0.58</td>
      <td>0.39</td>
      <td>-1.16</td>
      <td>0.06</td>
      <td>0.02</td>
      <td>0.01</td>
      <td>474.21</td>
      <td>480.37</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[46]</th>
      <td>2.03</td>
      <td>0.52</td>
      <td>1.20</td>
      <td>2.85</td>
      <td>0.03</td>
      <td>0.02</td>
      <td>217.80</td>
      <td>321.81</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[47]</th>
      <td>0.02</td>
      <td>0.34</td>
      <td>-0.47</td>
      <td>0.61</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>720.38</td>
      <td>484.37</td>
      <td>1.00</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="code-13-4">
<h3>Code 13.4<a class="headerlink" href="#code-13-4" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># we must compute the likelhood before using arviz to do comparison</span>
<span class="k">def</span> <span class="nf">compute_and_store_log_likelihood_for_model_13_1</span><span class="p">():</span>
    
    <span class="n">sample_alpha</span> <span class="o">=</span> <span class="n">posterior_13_1</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span>
    
    <span class="n">ds</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">jdc_13_1</span><span class="o">.</span><span class="n">sample_distributions</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span>
        <span class="n">sample_alpha</span><span class="p">,</span> 
        <span class="kc">None</span>
    <span class="p">])</span>
    
    <span class="n">log_likelihood_13_1</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">surv</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

    <span class="c1"># we need to insert this in the sampler_stats</span>
    <span class="n">sample_stats_13_1</span> <span class="o">=</span> <span class="n">trace_13_1</span><span class="o">.</span><span class="n">sample_stats</span>

    <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">sample_stats_13_1</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">],</span> <span class="n">sample_stats_13_1</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;draw&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">48</span><span class="p">)]</span>

    <span class="n">sample_stats_13_1</span><span class="p">[</span><span class="s2">&quot;log_likelihood&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
        <span class="n">log_likelihood_13_1</span><span class="p">,</span> 
        <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span>  
        <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">,</span> <span class="s1">&#39;draw&#39;</span><span class="p">,</span> <span class="s1">&#39;log_likelihood_dim_0&#39;</span><span class="p">])</span>
    
<span class="n">compute_and_store_log_likelihood_for_model_13_1</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_and_store_log_likelihood_for_model_13_2</span><span class="p">():</span>
    
    <span class="n">sample_abar</span>  <span class="o">=</span> <span class="n">posterior_13_2</span><span class="p">[</span><span class="s2">&quot;a_bar&quot;</span><span class="p">]</span>
    <span class="n">sample_sigma</span> <span class="o">=</span> <span class="n">posterior_13_2</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">]</span>
    <span class="n">sample_alpha</span> <span class="o">=</span> <span class="n">posterior_13_2</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span>
    
    <span class="n">ds</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">jdc_13_2</span><span class="o">.</span><span class="n">sample_distributions</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span>
        <span class="n">sample_abar</span><span class="p">,</span> 
        <span class="n">sample_sigma</span><span class="p">,</span> 
        <span class="n">sample_alpha</span><span class="p">,</span> 
        <span class="kc">None</span>
    <span class="p">])</span>
    
    <span class="n">log_likelihood_13_2</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">surv</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>    

    <span class="c1"># we need to insert this in the sampler_stats</span>
    <span class="n">sample_stats_13_2</span> <span class="o">=</span> <span class="n">trace_13_2</span><span class="o">.</span><span class="n">sample_stats</span>

    <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">sample_stats_13_2</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">],</span> <span class="n">sample_stats_13_2</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;draw&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">48</span><span class="p">)]</span>

    <span class="n">sample_stats_13_2</span><span class="p">[</span><span class="s2">&quot;log_likelihood&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
        <span class="n">log_likelihood_13_2</span><span class="p">,</span> 
        <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span>  
        <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">,</span> <span class="s1">&#39;draw&#39;</span><span class="p">,</span> <span class="s1">&#39;log_likelihood_dim_0&#39;</span><span class="p">])</span>
    
<span class="n">compute_and_store_log_likelihood_for_model_13_2</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">compare</span><span class="p">({</span><span class="s2">&quot;m13.1&quot;</span><span class="p">:</span> <span class="n">trace_13_1</span><span class="p">,</span> <span class="s2">&quot;m13.2&quot;</span><span class="p">:</span> <span class="n">trace_13_2</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/arviz/stats/stats.py:695: UserWarning: Estimated shape parameter of Pareto distribution is greater than 0.7 for one or more samples. You should consider using a more robust model, this is because importance sampling is less likely to work well if the marginal posterior and LOO posterior are very different. This is more likely to happen with a non-robust model and highly influential observations.
  &quot;Estimated shape parameter of Pareto distribution is greater than 0.7 for &quot;
/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/arviz/stats/stats.py:695: UserWarning: Estimated shape parameter of Pareto distribution is greater than 0.7 for one or more samples. You should consider using a more robust model, this is because importance sampling is less likely to work well if the marginal posterior and LOO posterior are very different. This is more likely to happen with a non-robust model and highly influential observations.
  &quot;Estimated shape parameter of Pareto distribution is greater than 0.7 for &quot;
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>rank</th>
      <th>loo</th>
      <th>p_loo</th>
      <th>d_loo</th>
      <th>weight</th>
      <th>se</th>
      <th>dse</th>
      <th>warning</th>
      <th>loo_scale</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>m13.2</th>
      <td>0</td>
      <td>-104.734108</td>
      <td>25.713756</td>
      <td>0.000000</td>
      <td>1.0</td>
      <td>4.086675</td>
      <td>0.00000</td>
      <td>True</td>
      <td>log</td>
    </tr>
    <tr>
      <th>m13.1</th>
      <td>1</td>
      <td>-112.724097</td>
      <td>31.482522</td>
      <td>7.989989</td>
      <td>0.0</td>
      <td>2.221175</td>
      <td>3.13262</td>
      <td>True</td>
      <td>log</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="code-13-5">
<h3>Code 13.5<a class="headerlink" href="#code-13-5" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute median intercept for each tank</span>
<span class="c1"># also transform to probability with logistic</span>

<span class="n">sample_alpha</span> <span class="o">=</span> <span class="n">trace_13_2</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">d</span><span class="p">[</span><span class="s2">&quot;propsurv.est&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sample_alpha</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

<span class="c1"># display raw proportions surviving in each tank</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">49</span><span class="p">),</span> <span class="n">d</span><span class="o">.</span><span class="n">propsurv</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">),</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;tank&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;proportion survival&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xticks</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">48</span><span class="p">],</span> <span class="n">xticklabels</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">48</span><span class="p">])</span>

<span class="c1"># overlay posterior means</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">49</span><span class="p">),</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;propsurv.est&quot;</span><span class="p">],</span> <span class="s2">&quot;ko&quot;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>

<span class="n">sample_a_bar</span> <span class="o">=</span> <span class="n">trace_13_2</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;a_bar&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># mark posterior mean probability across tanks</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">sample_a_bar</span><span class="p">))</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># draw vertical dividers between tank densities</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">16.5</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">32.5</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s2">&quot;small tanks&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s2">&quot;medium tanks&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">16</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s2">&quot;large tanks&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">32</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/13_models_with_memory_28_0.png" src="../_images/13_models_with_memory_28_0.png" />
</div>
</div>
<p>Here is how to read above plot -</p>
<ul class="simple">
<li><p>The dashed line locates the average proportion of survivors across all tanks</p></li>
<li><p>The vertical lines divide tanks with different initial densities of tadpoles: small tanks (10 tad- poles), medium tanks (25), and large tanks (35).</p></li>
<li><p>Empirical proportions of survivors in each tadpole tank, shown by the filled blue points, plotted with the 48 per-tank parameters from the multilevel model, shown by the black circles</p></li>
</ul>
<p>In every tank, the posterior mean from the multilevel model is closer to the dashed line than the empir- ical proportion is.</p>
</div>
<div class="section" id="code-13-6">
<h3>Code 13.6<a class="headerlink" href="#code-13-6" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sample_sigma</span> <span class="o">=</span> <span class="n">trace_13_2</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># show first 100 populations in the posterior</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">),</span>
            <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;log-odds survive&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Density&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">101</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">sample_a_bar</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sample_sigma</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                       <span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># sample 8000 imaginary tanks from the posterior distribution</span>
<span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">8000</span><span class="p">,),</span> <span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">499</span><span class="p">)</span>

<span class="n">sim_tanks</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">sample_a_bar</span><span class="p">[</span><span class="n">idxs</span><span class="p">],</span> <span class="n">sample_sigma</span><span class="p">[</span><span class="n">idxs</span><span class="p">])</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>

<span class="c1"># transform to probability and visualize</span>
<span class="n">az</span><span class="o">.</span><span class="n">plot_kde</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">sim_tanks</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">bw</span><span class="o">=</span><span class="mf">0.3</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/13_models_with_memory_31_0.png" src="../_images/13_models_with_memory_31_0.png" />
<img alt="../_images/13_models_with_memory_31_1.png" src="../_images/13_models_with_memory_31_1.png" />
</div>
</div>
</div>
</div>
<div class="section" id="varying-effects-and-the-underlying-overfitting-trade-off">
<h2>13.2 Varying effects and the underlying/overfitting trade-off<a class="headerlink" href="#varying-effects-and-the-underlying-overfitting-trade-off" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="the-model">
<h3>13.2.1 The model<a class="headerlink" href="#the-model" title="Permalink to this headline">Â¶</a></h3>
</div>
<div class="section" id="assign-values-to-the-parameters">
<h3>13.2.2 Assign values to the parameters<a class="headerlink" href="#assign-values-to-the-parameters" title="Permalink to this headline">Â¶</a></h3>
<div class="section" id="code-13-7">
<h4>Code 13.7<a class="headerlink" href="#code-13-7" title="Permalink to this headline">Â¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a_bar</span> <span class="o">=</span> <span class="mf">1.5</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mf">1.5</span>
<span class="n">nponds</span> <span class="o">=</span> <span class="mi">60</span>
<span class="n">Ni</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">35</span><span class="p">]),</span> <span class="n">repeats</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-13-8">
<h4>Code 13.8<a class="headerlink" href="#code-13-8" title="Permalink to this headline">Â¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a_pond</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">a_bar</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">((</span><span class="n">nponds</span><span class="p">,))</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-13-9">
<h4>Code 13.9<a class="headerlink" href="#code-13-9" title="Permalink to this headline">Â¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dsim</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">pond</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nponds</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">Ni</span><span class="o">=</span><span class="n">Ni</span><span class="p">,</span> <span class="n">true_a</span><span class="o">=</span><span class="n">a_pond</span><span class="p">))</span>

<span class="n">dsim</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>pond</th>
      <th>Ni</th>
      <th>true_a</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>60.000000</td>
      <td>60.000000</td>
      <td>60.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>30.500000</td>
      <td>18.750000</td>
      <td>1.516947</td>
    </tr>
    <tr>
      <th>std</th>
      <td>17.464249</td>
      <td>12.024868</td>
      <td>1.242640</td>
    </tr>
    <tr>
      <th>min</th>
      <td>1.000000</td>
      <td>5.000000</td>
      <td>-2.009335</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>15.750000</td>
      <td>8.750000</td>
      <td>0.774565</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>30.500000</td>
      <td>17.500000</td>
      <td>1.291840</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>45.250000</td>
      <td>27.500000</td>
      <td>2.201137</td>
    </tr>
    <tr>
      <th>max</th>
      <td>60.000000</td>
      <td>35.000000</td>
      <td>4.204990</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="code-13-10">
<h4>Code 13.10<a class="headerlink" href="#code-13-10" title="Permalink to this headline">Â¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;range&#39;&gt;
&lt;class &#39;numpy.ndarray&#39;&gt;
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="simulate-survivors">
<h3>13.2.3 Simulate survivors<a class="headerlink" href="#simulate-survivors" title="Permalink to this headline">Â¶</a></h3>
<div class="section" id="code-13-11">
<h4>Code 13.11<a class="headerlink" href="#code-13-11" title="Permalink to this headline">Â¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;Si&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">dsim</span><span class="o">.</span><span class="n">Ni</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">logits</span><span class="o">=</span><span class="n">dsim</span><span class="o">.</span><span class="n">true_a</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="compute-the-no-pooling-estimates">
<h3>13.2.4 Compute the no-pooling estimates<a class="headerlink" href="#compute-the-no-pooling-estimates" title="Permalink to this headline">Â¶</a></h3>
<div class="section" id="code-13-12">
<h4>Code 13.12<a class="headerlink" href="#code-13-12" title="Permalink to this headline">Â¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;p_nopool&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dsim</span><span class="o">.</span><span class="n">Si</span> <span class="o">/</span> <span class="n">dsim</span><span class="o">.</span><span class="n">Ni</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="compute-partial-pooling-estimates">
<h3>13.2.5 Compute partial pooling estimates<a class="headerlink" href="#compute-partial-pooling-estimates" title="Permalink to this headline">Â¶</a></h3>
<div class="section" id="code-13-13">
<h4>Code 13.13<a class="headerlink" href="#code-13-13" title="Permalink to this headline">Â¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">alpha_sample_shape</span> <span class="o">=</span> <span class="n">dsim</span><span class="o">.</span><span class="n">pond</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;pond_adj&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dsim</span><span class="o">.</span><span class="n">pond</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="mi">1</span>

<span class="n">tdf</span> <span class="o">=</span> <span class="n">df_to_tensors</span><span class="p">(</span><span class="s2">&quot;SimulatedPonds&quot;</span><span class="p">,</span> <span class="n">dsim</span><span class="p">,</span> <span class="p">{</span>
    <span class="s2">&quot;Si&quot;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="s2">&quot;true_a&quot;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="s2">&quot;Ni&quot;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="s2">&quot;pond_adj&quot;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_13_3</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>     
      <span class="n">a_bar</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">a_bar</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="n">alpha_sample_shape</span><span class="p">)</span>
      <span class="n">p</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)))</span>              
        
      <span class="n">Si</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span><span class="n">total_count</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="n">p</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>             
      
    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    
    
<span class="n">jdc_13_3</span> <span class="o">=</span> <span class="n">model_13_3</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">pond_adj</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">Ni</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NUM_CHAINS_FOR_13_3</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_13_3</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_13_3</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_13_3</span><span class="p">,</span> <span class="n">alpha_sample_shape</span><span class="p">])</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_13_3</span><span class="p">,</span> <span class="n">trace_13_3</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span><span class="n">jdc_13_3</span><span class="p">,</span>
                                   <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">Si</span><span class="p">,),</span>
                                   <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a_bar&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">],</span>
                                   <span class="n">num_chains</span><span class="o">=</span><span class="n">NUM_CHAINS_FOR_13_3</span><span class="p">,</span> 
                                   <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                                   <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:@custom_gradient grad_fn has &#39;variables&#39; in signature, but no ResourceVariables were used on the forward pass.
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-13-14">
<h4>Code 13.14<a class="headerlink" href="#code-13-14" title="Permalink to this headline">Â¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_13_3</span><span class="p">,</span> <span class="n">round_to</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a_bar</th>
      <td>1.55</td>
      <td>0.19</td>
      <td>1.25</td>
      <td>1.86</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>166.72</td>
      <td>168.87</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>1.25</td>
      <td>0.20</td>
      <td>0.94</td>
      <td>1.51</td>
      <td>0.04</td>
      <td>0.03</td>
      <td>31.04</td>
      <td>18.39</td>
      <td>1.04</td>
    </tr>
    <tr>
      <th>alpha[0]</th>
      <td>2.35</td>
      <td>0.94</td>
      <td>0.81</td>
      <td>3.79</td>
      <td>0.11</td>
      <td>0.08</td>
      <td>69.94</td>
      <td>154.30</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[1]</th>
      <td>2.50</td>
      <td>1.16</td>
      <td>0.75</td>
      <td>4.39</td>
      <td>0.16</td>
      <td>0.12</td>
      <td>51.89</td>
      <td>82.30</td>
      <td>1.03</td>
    </tr>
    <tr>
      <th>alpha[2]</th>
      <td>0.30</td>
      <td>0.84</td>
      <td>-0.99</td>
      <td>1.58</td>
      <td>0.10</td>
      <td>0.07</td>
      <td>78.20</td>
      <td>86.42</td>
      <td>1.03</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>alpha[55]</th>
      <td>2.10</td>
      <td>0.52</td>
      <td>1.29</td>
      <td>2.89</td>
      <td>0.04</td>
      <td>0.03</td>
      <td>161.46</td>
      <td>271.21</td>
      <td>1.03</td>
    </tr>
    <tr>
      <th>alpha[56]</th>
      <td>0.99</td>
      <td>0.36</td>
      <td>0.40</td>
      <td>1.56</td>
      <td>0.02</td>
      <td>0.01</td>
      <td>436.90</td>
      <td>592.74</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[57]</th>
      <td>0.99</td>
      <td>0.38</td>
      <td>0.36</td>
      <td>1.58</td>
      <td>0.02</td>
      <td>0.01</td>
      <td>447.02</td>
      <td>512.59</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[58]</th>
      <td>1.03</td>
      <td>0.37</td>
      <td>0.47</td>
      <td>1.63</td>
      <td>0.02</td>
      <td>0.01</td>
      <td>537.75</td>
      <td>575.27</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[59]</th>
      <td>3.52</td>
      <td>0.82</td>
      <td>2.36</td>
      <td>4.98</td>
      <td>0.10</td>
      <td>0.07</td>
      <td>65.81</td>
      <td>102.74</td>
      <td>1.04</td>
    </tr>
  </tbody>
</table>
<p>62 rows Ã— 9 columns</p>
</div></div></div>
</div>
</div>
<div class="section" id="code-13-15">
<h4>Code 13.15<a class="headerlink" href="#code-13-15" title="Permalink to this headline">Â¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sample_alpha</span> <span class="o">=</span> <span class="n">trace_13_3</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;p_partpool&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">sample_alpha</span><span class="p">))</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-13-16">
<h4>Code 13.16<a class="headerlink" href="#code-13-16" title="Permalink to this headline">Â¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;p_true&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">dsim</span><span class="o">.</span><span class="n">true_a</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-13-17">
<h4>Code 13.17<a class="headerlink" href="#code-13-17" title="Permalink to this headline">Â¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nopool_error</span> <span class="o">=</span> <span class="p">(</span><span class="n">dsim</span><span class="o">.</span><span class="n">p_nopool</span> <span class="o">-</span> <span class="n">dsim</span><span class="o">.</span><span class="n">p_true</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
<span class="n">partpool_error</span> <span class="o">=</span> <span class="p">(</span><span class="n">dsim</span><span class="o">.</span><span class="n">p_partpool</span> <span class="o">-</span> <span class="n">dsim</span><span class="o">.</span><span class="n">p_true</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-13-18">
<h4>Code 13.18<a class="headerlink" href="#code-13-18" title="Permalink to this headline">Â¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">61</span><span class="p">),</span> <span class="n">nopool_error</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;nopool&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;pond&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;absolute error&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">61</span><span class="p">),</span> <span class="n">partpool_error</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;partpool&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/13_models_with_memory_66_0.png" src="../_images/13_models_with_memory_66_0.png" />
</div>
</div>
</div>
<div class="section" id="code-13-19">
<h4>Code 13.19<a class="headerlink" href="#code-13-19" title="Permalink to this headline">Â¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;nopool_error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nopool_error</span>
<span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;partpool_error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">partpool_error</span>
<span class="n">nopool_avg</span> <span class="o">=</span> <span class="n">dsim</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Ni&quot;</span><span class="p">)[</span><span class="s2">&quot;nopool_error&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">partpool_avg</span> <span class="o">=</span> <span class="n">dsim</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Ni&quot;</span><span class="p">)[</span><span class="s2">&quot;partpool_error&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="overthiking-repeating-the-pond-simulation">
<h3>Overthiking: Repeating the pond simulation<a class="headerlink" href="#overthiking-repeating-the-pond-simulation" title="Permalink to this headline">Â¶</a></h3>
<div class="section" id="code-13-20">
<h4>Code 13.20<a class="headerlink" href="#code-13-20" title="Permalink to this headline">Â¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a_bar</span> <span class="o">=</span> <span class="mf">1.5</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mf">1.5</span>
<span class="n">nponds</span> <span class="o">=</span> <span class="mi">60</span>
<span class="n">Ni</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">35</span><span class="p">]),</span> <span class="n">repeats</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">a_pond</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">a_bar</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">((</span><span class="n">nponds</span><span class="p">,))</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">dsim</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">pond</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nponds</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">Ni</span><span class="o">=</span><span class="n">Ni</span><span class="p">,</span> <span class="n">true_a</span><span class="o">=</span><span class="n">a_pond</span><span class="p">))</span>
<span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;Si&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">dsim</span><span class="o">.</span><span class="n">Ni</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">logits</span><span class="o">=</span><span class="n">dsim</span><span class="o">.</span><span class="n">true_a</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
<span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;p_nopool&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dsim</span><span class="o">.</span><span class="n">Si</span> <span class="o">/</span> <span class="n">dsim</span><span class="o">.</span><span class="n">Ni</span>

<span class="n">newdat</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">Si</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">dsim</span><span class="o">.</span><span class="n">Si</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
              <span class="n">Ni</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">dsim</span><span class="o">.</span><span class="n">Ni</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
              <span class="n">pond</span><span class="o">=</span><span class="n">dsim</span><span class="o">.</span><span class="n">pond</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="mi">1</span>
<span class="p">)</span>

<span class="n">jdc_13_3new</span> <span class="o">=</span> <span class="n">model_13_3</span><span class="p">(</span><span class="n">newdat</span><span class="p">[</span><span class="s2">&quot;pond&quot;</span><span class="p">],</span> <span class="n">newdat</span><span class="p">[</span><span class="s2">&quot;Ni&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_13_3new</span><span class="p">,</span> <span class="n">trace_13_3new</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span><span class="n">jdc_13_3new</span><span class="p">,</span>
                                       <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">newdat</span><span class="p">[</span><span class="s2">&quot;Si&quot;</span><span class="p">],),</span>
                                       <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a_bar&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">],</span>
                                       <span class="n">num_chains</span><span class="o">=</span><span class="n">NUM_CHAINS_FOR_13_3</span><span class="p">,</span> 
                                       <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                                       <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sample_alpha</span> <span class="o">=</span> <span class="n">trace_13_3new</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;p_partpool&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">sample_alpha</span><span class="p">))</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">dsim</span><span class="p">[</span><span class="s2">&quot;p_true&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">dsim</span><span class="o">.</span><span class="n">true_a</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">nopool_error</span> <span class="o">=</span> <span class="p">(</span><span class="n">dsim</span><span class="o">.</span><span class="n">p_nopool</span> <span class="o">-</span> <span class="n">dsim</span><span class="o">.</span><span class="n">p_true</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
<span class="n">partpool_error</span> <span class="o">=</span> <span class="p">(</span><span class="n">dsim</span><span class="o">.</span><span class="n">p_partpool</span> <span class="o">-</span> <span class="n">dsim</span><span class="o">.</span><span class="n">p_true</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">61</span><span class="p">),</span> <span class="n">nopool_error</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;nopool&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;pond&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;absolute error&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">61</span><span class="p">),</span> <span class="n">partpool_error</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;partpool&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/13_models_with_memory_73_0.png" src="../_images/13_models_with_memory_73_0.png" />
</div>
</div>
</div>
</div>
</div>
<div class="section" id="more-than-one-type-of-cluster">
<h2>13.3 More than one type of cluster<a class="headerlink" href="#more-than-one-type-of-cluster" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="multilevel-chimpanzees">
<h3>13.3.1 Multilevel chimpanzees<a class="headerlink" href="#multilevel-chimpanzees" title="Permalink to this headline">Â¶</a></h3>
<div class="section" id="code-13-21">
<h4>Code 13.21<a class="headerlink" href="#code-13-21" title="Permalink to this headline">Â¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">CHIMPANZEES_DATASET_PATH</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>

<span class="n">d</span><span class="p">[</span><span class="s2">&quot;treatment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">d</span><span class="o">.</span><span class="n">prosoc_left</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">d</span><span class="o">.</span><span class="n">condition</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">d</span><span class="p">[</span><span class="s2">&quot;block_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">d</span><span class="p">[</span><span class="s2">&quot;actor_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="mi">1</span>

<span class="n">tdf</span> <span class="o">=</span> <span class="n">df_to_tensors</span><span class="p">(</span><span class="s2">&quot;Chimpanzee&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="p">{</span>
    <span class="s2">&quot;treatment&quot;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span>
    <span class="s2">&quot;block_id&quot;</span>  <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span>
    <span class="s2">&quot;actor_id&quot;</span>  <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span>
    <span class="s2">&quot;pulled_left&quot;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span>
<span class="p">})</span>


<span class="k">def</span> <span class="nf">model_13_4</span><span class="p">(</span><span class="n">actor</span><span class="p">,</span> <span class="n">block_id</span><span class="p">,</span> <span class="n">treatment</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>  
      <span class="c1"># hyper-priors</span>
      <span class="n">a_bar</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">sigma_a</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">sigma_g</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="c1"># adaptive priors</span>
      <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">a_bar</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma_a</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
      <span class="n">gamma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma_g</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>  
      <span class="n">beta</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> 
        
      <span class="c1"># three terms</span>
      <span class="n">term1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">actor</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">term2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">gamma</span><span class="p">,</span> <span class="n">block_id</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">term3</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">treatment</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
        
      <span class="n">p</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span> <span class="o">+</span> <span class="n">term3</span><span class="p">)</span>              
        
      <span class="n">PL</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span><span class="n">total_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="n">p</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>             
      
    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    
    
<span class="n">jdc_13_4</span> <span class="o">=</span> <span class="n">model_13_4</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">actor_id</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">block_id</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">treatment</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NUM_CHAINS_FOR_13_4</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_13_4</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_13_4</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_13_4</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_13_4</span><span class="p">,</span> <span class="mi">7</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_13_4</span><span class="p">,</span> <span class="mi">6</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_13_4</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
<span class="p">]</span>

<span class="n">posterior_13_4</span><span class="p">,</span> <span class="n">trace_13_4</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span><span class="n">jdc_13_4</span><span class="p">,</span>
                               <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">pulled_left</span><span class="p">,),</span>
                               <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a_bar&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma_a&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma_g&#39;</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;gamma&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">],</span>
                               <span class="n">num_chains</span><span class="o">=</span><span class="n">NUM_CHAINS_FOR_13_4</span><span class="p">,</span> 
                               <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                               <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:@custom_gradient grad_fn has &#39;variables&#39; in signature, but no ResourceVariables were used on the forward pass.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:5 out of the last 5 calls to &lt;function run_hmc_chain at 0x7fb28fa82320&gt; triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has experimental_relax_shapes=True option that relaxes argument shapes that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-13-22">
<h4>Code 13.22<a class="headerlink" href="#code-13-22" title="Permalink to this headline">Â¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_13_4</span><span class="p">,</span> <span class="n">round_to</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a_bar</th>
      <td>0.33</td>
      <td>0.76</td>
      <td>-0.72</td>
      <td>1.55</td>
      <td>0.28</td>
      <td>0.21</td>
      <td>7.45</td>
      <td>19.41</td>
      <td>1.21</td>
    </tr>
    <tr>
      <th>sigma_a</th>
      <td>1.91</td>
      <td>0.59</td>
      <td>1.08</td>
      <td>2.67</td>
      <td>0.07</td>
      <td>0.05</td>
      <td>68.01</td>
      <td>172.34</td>
      <td>1.05</td>
    </tr>
    <tr>
      <th>sigma_g</th>
      <td>0.21</td>
      <td>0.14</td>
      <td>0.04</td>
      <td>0.39</td>
      <td>0.03</td>
      <td>0.02</td>
      <td>19.63</td>
      <td>92.54</td>
      <td>1.12</td>
    </tr>
    <tr>
      <th>alpha[0]</th>
      <td>-0.41</td>
      <td>0.41</td>
      <td>-1.03</td>
      <td>0.25</td>
      <td>0.09</td>
      <td>0.06</td>
      <td>21.44</td>
      <td>120.84</td>
      <td>1.08</td>
    </tr>
    <tr>
      <th>alpha[1]</th>
      <td>4.26</td>
      <td>1.11</td>
      <td>2.75</td>
      <td>5.87</td>
      <td>0.51</td>
      <td>0.39</td>
      <td>5.45</td>
      <td>23.76</td>
      <td>1.30</td>
    </tr>
    <tr>
      <th>alpha[2]</th>
      <td>-0.72</td>
      <td>0.38</td>
      <td>-1.42</td>
      <td>-0.19</td>
      <td>0.09</td>
      <td>0.06</td>
      <td>20.10</td>
      <td>151.16</td>
      <td>1.08</td>
    </tr>
    <tr>
      <th>alpha[3]</th>
      <td>-0.74</td>
      <td>0.39</td>
      <td>-1.41</td>
      <td>-0.15</td>
      <td>0.10</td>
      <td>0.07</td>
      <td>16.31</td>
      <td>88.67</td>
      <td>1.09</td>
    </tr>
    <tr>
      <th>alpha[4]</th>
      <td>-0.41</td>
      <td>0.37</td>
      <td>-0.98</td>
      <td>0.18</td>
      <td>0.08</td>
      <td>0.06</td>
      <td>19.51</td>
      <td>94.43</td>
      <td>1.09</td>
    </tr>
    <tr>
      <th>alpha[5]</th>
      <td>0.53</td>
      <td>0.38</td>
      <td>-0.07</td>
      <td>1.11</td>
      <td>0.09</td>
      <td>0.06</td>
      <td>18.76</td>
      <td>93.08</td>
      <td>1.09</td>
    </tr>
    <tr>
      <th>alpha[6]</th>
      <td>2.04</td>
      <td>0.46</td>
      <td>1.25</td>
      <td>2.68</td>
      <td>0.08</td>
      <td>0.06</td>
      <td>35.72</td>
      <td>182.04</td>
      <td>1.06</td>
    </tr>
    <tr>
      <th>gamma[0]</th>
      <td>-0.17</td>
      <td>0.19</td>
      <td>-0.49</td>
      <td>0.06</td>
      <td>0.03</td>
      <td>0.02</td>
      <td>75.73</td>
      <td>209.50</td>
      <td>1.04</td>
    </tr>
    <tr>
      <th>gamma[1]</th>
      <td>0.05</td>
      <td>0.18</td>
      <td>-0.24</td>
      <td>0.33</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>219.74</td>
      <td>199.00</td>
      <td>1.04</td>
    </tr>
    <tr>
      <th>gamma[2]</th>
      <td>0.06</td>
      <td>0.18</td>
      <td>-0.24</td>
      <td>0.33</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>348.60</td>
      <td>230.68</td>
      <td>1.05</td>
    </tr>
    <tr>
      <th>gamma[3]</th>
      <td>0.02</td>
      <td>0.16</td>
      <td>-0.19</td>
      <td>0.27</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>324.76</td>
      <td>258.54</td>
      <td>1.03</td>
    </tr>
    <tr>
      <th>gamma[4]</th>
      <td>-0.03</td>
      <td>0.18</td>
      <td>-0.30</td>
      <td>0.25</td>
      <td>0.01</td>
      <td>0.02</td>
      <td>259.75</td>
      <td>208.65</td>
      <td>1.05</td>
    </tr>
    <tr>
      <th>gamma[5]</th>
      <td>0.13</td>
      <td>0.19</td>
      <td>-0.12</td>
      <td>0.44</td>
      <td>0.02</td>
      <td>0.01</td>
      <td>153.91</td>
      <td>182.22</td>
      <td>1.02</td>
    </tr>
    <tr>
      <th>beta[0]</th>
      <td>-0.11</td>
      <td>0.32</td>
      <td>-0.66</td>
      <td>0.39</td>
      <td>0.08</td>
      <td>0.06</td>
      <td>15.83</td>
      <td>58.17</td>
      <td>1.11</td>
    </tr>
    <tr>
      <th>beta[1]</th>
      <td>0.46</td>
      <td>0.33</td>
      <td>-0.04</td>
      <td>0.94</td>
      <td>0.07</td>
      <td>0.05</td>
      <td>18.58</td>
      <td>179.77</td>
      <td>1.08</td>
    </tr>
    <tr>
      <th>beta[2]</th>
      <td>-0.44</td>
      <td>0.33</td>
      <td>-0.97</td>
      <td>0.04</td>
      <td>0.06</td>
      <td>0.04</td>
      <td>29.21</td>
      <td>73.68</td>
      <td>1.05</td>
    </tr>
    <tr>
      <th>beta[3]</th>
      <td>0.32</td>
      <td>0.33</td>
      <td>-0.12</td>
      <td>0.91</td>
      <td>0.07</td>
      <td>0.05</td>
      <td>22.56</td>
      <td>118.07</td>
      <td>1.09</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Note that there is variation across parameters when it comes to effective sample size (ess_mean). This is because some parameters spends a lot of time near a boundary.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">trace_13_4</span><span class="p">,</span> <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">);</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/13_models_with_memory_82_0.png" src="../_images/13_models_with_memory_82_0.png" />
</div>
</div>
</div>
<div class="section" id="code-13-23">
<h4>Code 13.23<a class="headerlink" href="#code-13-23" title="Permalink to this headline">Â¶</a></h4>
<p>Build a model that ignores block so that we can then compare it with the above model</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_13_5</span><span class="p">(</span><span class="n">actor</span><span class="p">,</span> <span class="n">treatment</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>  
      <span class="c1"># hyper-priors</span>
      <span class="n">a_bar</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">sigma_a</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="c1"># adaptive priors</span>
      <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">a_bar</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma_a</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
      <span class="n">beta</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> 
        
      <span class="c1"># two terms</span>
      <span class="n">term1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">actor</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">term2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span><span class="n">treatment</span><span class="p">,</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
        
      <span class="n">p</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span><span class="p">)</span>              
        
      <span class="n">PL</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span><span class="n">total_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="n">p</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>             
      
    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    
    
<span class="n">jdc_13_5</span> <span class="o">=</span> <span class="n">model_13_5</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">actor_id</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">treatment</span><span class="p">)</span>


<span class="n">NUM_CHAINS_FOR_13_5</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_13_5</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_13_5</span><span class="p">]),</span>    
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_13_5</span><span class="p">,</span> <span class="mi">7</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_13_5</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">(),</span>        
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
<span class="p">]</span>

<span class="n">posterior_13_5</span><span class="p">,</span> <span class="n">trace_13_5</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span><span class="n">jdc_13_5</span><span class="p">,</span>
                               <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">pulled_left</span><span class="p">,),</span>
                               <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a_bar&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma_a&#39;</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">],</span>
                               <span class="n">num_chains</span><span class="o">=</span><span class="n">NUM_CHAINS_FOR_13_5</span><span class="p">,</span> 
                               <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                               <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:6 out of the last 6 calls to &lt;function run_hmc_chain at 0x7fb28fa82320&gt; triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has experimental_relax_shapes=True option that relaxes argument shapes that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-13-24">
<h4>Code 13.24<a class="headerlink" href="#code-13-24" title="Permalink to this headline">Â¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_and_store_log_likelihood_for_model_13_4</span><span class="p">():</span>
    
    <span class="n">sample_a_bar</span>    <span class="o">=</span> <span class="n">posterior_13_4</span><span class="p">[</span><span class="s2">&quot;a_bar&quot;</span><span class="p">]</span>
    <span class="n">sample_sigma_a</span>  <span class="o">=</span> <span class="n">posterior_13_4</span><span class="p">[</span><span class="s2">&quot;sigma_a&quot;</span><span class="p">]</span>
    <span class="n">sample_sigma_g</span>  <span class="o">=</span> <span class="n">posterior_13_4</span><span class="p">[</span><span class="s2">&quot;sigma_g&quot;</span><span class="p">]</span>
    
    <span class="n">sample_alpha</span> <span class="o">=</span> <span class="n">posterior_13_4</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span>
    <span class="n">sample_gamma</span> <span class="o">=</span> <span class="n">posterior_13_4</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]</span>
    <span class="n">sample_beta</span>  <span class="o">=</span> <span class="n">posterior_13_4</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span>
    
    <span class="n">ds</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">jdc_13_4</span><span class="o">.</span><span class="n">sample_distributions</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span>
        <span class="n">sample_a_bar</span><span class="p">,</span>
        <span class="n">sample_sigma_a</span><span class="p">,</span>
        <span class="n">sample_sigma_g</span><span class="p">,</span>
        
        <span class="n">sample_alpha</span><span class="p">,</span> 
        <span class="n">sample_gamma</span><span class="p">,</span> 
        <span class="n">sample_beta</span><span class="p">,</span> 
        <span class="kc">None</span>
    <span class="p">])</span>
    
    <span class="n">log_likelihood_13_4</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">pulled_left</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

    <span class="c1"># we need to insert this in the sampler_stats</span>
    <span class="n">sample_stats_13_4</span> <span class="o">=</span> <span class="n">trace_13_4</span><span class="o">.</span><span class="n">sample_stats</span>

    <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">sample_stats_13_4</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">],</span> <span class="n">sample_stats_13_4</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;draw&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">504</span><span class="p">)]</span>

    <span class="n">sample_stats_13_4</span><span class="p">[</span><span class="s2">&quot;log_likelihood&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
        <span class="n">log_likelihood_13_4</span><span class="p">,</span> 
        <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span>  
        <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">,</span> <span class="s1">&#39;draw&#39;</span><span class="p">,</span> <span class="s1">&#39;log_likelihood_dim_0&#39;</span><span class="p">])</span>
    
<span class="n">compute_and_store_log_likelihood_for_model_13_4</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_and_store_log_likelihood_for_model_13_5</span><span class="p">():</span>
    
    <span class="n">sample_a_bar</span>    <span class="o">=</span> <span class="n">posterior_13_5</span><span class="p">[</span><span class="s2">&quot;a_bar&quot;</span><span class="p">]</span>
    <span class="n">sample_sigma_a</span>  <span class="o">=</span> <span class="n">posterior_13_5</span><span class="p">[</span><span class="s2">&quot;sigma_a&quot;</span><span class="p">]</span>
    
    <span class="n">sample_alpha</span> <span class="o">=</span> <span class="n">posterior_13_5</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span>
    <span class="n">sample_beta</span>  <span class="o">=</span> <span class="n">posterior_13_5</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span>
    
    <span class="n">ds</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">jdc_13_5</span><span class="o">.</span><span class="n">sample_distributions</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span>
        <span class="n">sample_a_bar</span><span class="p">,</span> 
        <span class="n">sample_sigma_a</span><span class="p">,</span>
                
        <span class="n">sample_alpha</span><span class="p">,</span> 
        <span class="n">sample_beta</span><span class="p">,</span> 
        <span class="kc">None</span>
    <span class="p">])</span>
    
    <span class="n">log_likelihood_13_5</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">pulled_left</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

    <span class="c1"># we need to insert this in the sampler_stats</span>
    <span class="n">sample_stats_13_5</span> <span class="o">=</span> <span class="n">trace_13_5</span><span class="o">.</span><span class="n">sample_stats</span>

    <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">sample_stats_13_5</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">],</span> <span class="n">sample_stats_13_5</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;draw&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">504</span><span class="p">)]</span>

    <span class="n">sample_stats_13_5</span><span class="p">[</span><span class="s2">&quot;log_likelihood&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
        <span class="n">log_likelihood_13_5</span><span class="p">,</span> 
        <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span>  
        <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">,</span> <span class="s1">&#39;draw&#39;</span><span class="p">,</span> <span class="s1">&#39;log_likelihood_dim_0&#39;</span><span class="p">])</span>
    
<span class="n">compute_and_store_log_likelihood_for_model_13_5</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">compare</span><span class="p">({</span><span class="s2">&quot;m13.4&quot;</span><span class="p">:</span> <span class="n">trace_13_4</span><span class="p">,</span> <span class="s2">&quot;m13.5&quot;</span><span class="p">:</span> <span class="n">trace_13_5</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>rank</th>
      <th>loo</th>
      <th>p_loo</th>
      <th>d_loo</th>
      <th>weight</th>
      <th>se</th>
      <th>dse</th>
      <th>warning</th>
      <th>loo_scale</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>m13.5</th>
      <td>0</td>
      <td>-264.535997</td>
      <td>7.335587</td>
      <td>0.000000</td>
      <td>1.000000e+00</td>
      <td>9.566555</td>
      <td>0.000000</td>
      <td>False</td>
      <td>log</td>
    </tr>
    <tr>
      <th>m13.4</th>
      <td>1</td>
      <td>-265.885940</td>
      <td>10.259751</td>
      <td>1.349943</td>
      <td>4.440892e-16</td>
      <td>9.691416</td>
      <td>0.935878</td>
      <td>False</td>
      <td>log</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Above 2 models seem to imply nearly identical predictions. Should we select m13.4 as it is simpler among the two ?. Author here suggests that to select a model, we should rather want to test conditional independencies of different causal models.</p>
</div>
</div>
<div class="section" id="even-more-clusters">
<h3>13.3.2 Even more clusters<a class="headerlink" href="#even-more-clusters" title="Permalink to this headline">Â¶</a></h3>
<div class="section" id="code-13-25">
<h4>Code 13.25<a class="headerlink" href="#code-13-25" title="Permalink to this headline">Â¶</a></h4>
<p>m13.4 with partial pooling on the treatments</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_13_6</span><span class="p">(</span><span class="n">actor</span><span class="p">,</span> <span class="n">block_id</span><span class="p">,</span> <span class="n">treatment</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>  
      <span class="c1"># hyper-priors</span>
      <span class="n">a_bar</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">sigma_a</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">sigma_g</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">sigma_b</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>  
      <span class="c1"># adaptive priors</span>
      <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">a_bar</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma_a</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
      <span class="n">gamma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma_g</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>  
      <span class="n">beta</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma_b</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> 
        
      <span class="c1"># three terms</span>
      <span class="n">term1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">actor</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">term2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">gamma</span><span class="p">,</span><span class="n">block_id</span><span class="p">,</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">term3</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span><span class="n">treatment</span><span class="p">,</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
        
      <span class="n">p</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span> <span class="o">+</span> <span class="n">term3</span><span class="p">)</span>              
        
      <span class="n">PL</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span><span class="n">total_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="n">p</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>             
      
    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    
    
<span class="n">jdc_13_6</span> <span class="o">=</span> <span class="n">model_13_6</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">actor_id</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">block_id</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">treatment</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NUM_CHAINS_FOR_13_6</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_13_6</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_13_6</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_13_6</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_13_6</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_13_6</span><span class="p">,</span> <span class="mi">7</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_13_6</span><span class="p">,</span> <span class="mi">6</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_13_6</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
<span class="p">]</span>

<span class="n">posterior_13_6</span><span class="p">,</span> <span class="n">trace_13_6</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span><span class="n">jdc_13_6</span><span class="p">,</span>
                               <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">pulled_left</span><span class="p">,),</span>
                               <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a_bar&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma_a&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma_g&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma_b&#39;</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;gamma&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">],</span>
                               <span class="n">num_chains</span><span class="o">=</span><span class="n">NUM_CHAINS_FOR_13_6</span><span class="p">,</span> 
                               <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                               <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s2">&quot;m13.4&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">trace_13_4</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span>
 <span class="s2">&quot;m13.6&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">trace_13_6</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">)}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;m13.4&#39;: array([-0.02128875,  0.5373235 , -0.36056   ,  0.4143581 ], dtype=float32),
 &#39;m13.6&#39;: array([-0.10890973,  0.40464061, -0.40600276,  0.32542264], dtype=float32)}
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="divergent-transitions-and-non-centered-priors">
<h2>13.4 Divergent transitions and non-centered priors<a class="headerlink" href="#divergent-transitions-and-non-centered-priors" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="the-devil-s-funnel">
<h3>13.4.1 The Devilâ€™s Funnel<a class="headerlink" href="#the-devil-s-funnel" title="Permalink to this headline">Â¶</a></h3>
<div class="section" id="code-13-26-todo-add-notes-on-divergence">
<h4>Code 13.26 (TODO - add notes on divergence)<a class="headerlink" href="#code-13-26-todo-add-notes-on-divergence" title="Permalink to this headline">Â¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_13_7</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>  
      <span class="n">v</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">3.</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">x</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">v</span><span class="p">)),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>       
      
    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    
    
<span class="n">jdc_13_7</span> <span class="o">=</span> <span class="n">model_13_7</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NUM_CHAINS_FOR_13_7</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_13_7</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_13_7</span><span class="p">])</span>   
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>    
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
<span class="p">]</span>

<span class="n">posterior_13_7</span><span class="p">,</span> <span class="n">trace_13_7</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span><span class="n">jdc_13_7</span><span class="p">,</span>
                                   <span class="n">observed_data</span><span class="o">=</span><span class="p">(),</span>
                                   <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">],</span>
                                   <span class="n">num_chains</span><span class="o">=</span><span class="n">NUM_CHAINS_FOR_13_7</span><span class="p">,</span> 
                                   <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                                   <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_13_7</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>v</th>
      <td>-1.806</td>
      <td>0.971</td>
      <td>-2.777</td>
      <td>-0.819</td>
      <td>0.681</td>
      <td>0.575</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>2.55</td>
    </tr>
    <tr>
      <th>x</th>
      <td>0.390</td>
      <td>0.387</td>
      <td>0.003</td>
      <td>0.785</td>
      <td>0.272</td>
      <td>0.229</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>8.06</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="code-13-27">
<h4>Code 13.27<a class="headerlink" href="#code-13-27" title="Permalink to this headline">Â¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_13_7nc</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>  
      <span class="n">v</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">3.</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">z</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">x</span> <span class="o">=</span> <span class="n">z</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
      
    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    
    
<span class="n">jdc_13_7nc</span> <span class="o">=</span> <span class="n">model_13_7nc</span><span class="p">()</span>

<span class="n">NUM_CHAINS_FOR_13_7nc</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_13_7nc</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_13_7nc</span><span class="p">])</span>   
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>    
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
<span class="p">]</span>

<span class="n">posterior_13_7nc</span><span class="p">,</span> <span class="n">trace_13_7nc</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span><span class="n">jdc_13_7nc</span><span class="p">,</span>
                               <span class="n">observed_data</span><span class="o">=</span><span class="p">(),</span>
                               <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">],</span>
                               <span class="n">num_chains</span><span class="o">=</span><span class="n">NUM_CHAINS_FOR_13_7nc</span><span class="p">,</span> 
                               <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                               <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">)</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_13_7nc</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>v</th>
      <td>-0.014</td>
      <td>3.120</td>
      <td>-4.745</td>
      <td>5.126</td>
      <td>0.080</td>
      <td>0.092</td>
      <td>1536.0</td>
      <td>634.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>z</th>
      <td>0.142</td>
      <td>1.154</td>
      <td>-1.970</td>
      <td>1.670</td>
      <td>0.285</td>
      <td>0.205</td>
      <td>18.0</td>
      <td>133.0</td>
      <td>1.11</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
</div>
<div class="section" id="non-centered-chimpanzees">
<h3>13.4.2 Non-centered chimpanzees<a class="headerlink" href="#non-centered-chimpanzees" title="Permalink to this headline">Â¶</a></h3>
<div class="section" id="code-13-28-todo-parameterize-the-target-accept-prob">
<h4>Code 13.28 [TODO - parameterize the target accept prob]<a class="headerlink" href="#code-13-28-todo-parameterize-the-target-accept-prob" title="Permalink to this headline">Â¶</a></h4>
</div>
<div class="section" id="code-13-29">
<h4>Code 13.29<a class="headerlink" href="#code-13-29" title="Permalink to this headline">Â¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_13_4nc</span><span class="p">(</span><span class="n">actor</span><span class="p">,</span> <span class="n">block_id</span><span class="p">,</span> <span class="n">treatment</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>  
      <span class="c1"># hyper-priors</span>
      <span class="n">a_bar</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">sigma_a</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">sigma_g</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="c1"># adaptive priors</span>
      <span class="n">z</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
      <span class="n">x</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>  
      <span class="n">b</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> 
        
      <span class="c1"># three terms</span>
      <span class="n">term1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">actor</span><span class="p">,</span>     <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">term2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">block_id</span><span class="p">,</span>  <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">term3</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">treatment</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>        
        
      <span class="c1"># reparamertization </span>
      <span class="n">r</span> <span class="o">=</span> <span class="n">a_bar</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">sigma_a</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">term1</span>  \
                                <span class="o">+</span> <span class="n">sigma_g</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">term2</span>  \
                                <span class="o">+</span> <span class="n">term3</span>
        
      <span class="n">p</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>        
        
      <span class="n">PL</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span><span class="n">total_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="n">p</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>             
      
    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    
    
<span class="n">jdc_13_4nc</span> <span class="o">=</span> <span class="n">model_13_4nc</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">actor_id</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">block_id</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">treatment</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="n">jdc_13_4nc</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">jdc_13_4nc</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:5 out of the last 11 calls to &lt;function _random_binomial at 0x7fb290353ef0&gt; triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has experimental_relax_shapes=True option that relaxes argument shapes that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:@custom_gradient grad_fn has &#39;variables&#39; in signature, but no ResourceVariables were used on the forward pass.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(2, 2), dtype=float32, numpy=
array([[-330.25497, -330.49432],
       [-298.34113, -298.58047]], dtype=float32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NUM_CHAINS_FOR_13_4</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_13_4</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_13_4</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_13_4</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_13_4</span><span class="p">,</span> <span class="mi">7</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_13_4</span><span class="p">,</span> <span class="mi">6</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_13_4</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
<span class="p">]</span>

<span class="n">posterior_13_4nc</span><span class="p">,</span> <span class="n">trace_13_4nc</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span><span class="n">jdc_13_4nc</span><span class="p">,</span>
                               <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">pulled_left</span><span class="p">,),</span>
                               <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a_bar&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma_a&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma_g&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">],</span>
                               <span class="n">num_chains</span><span class="o">=</span><span class="n">NUM_CHAINS_FOR_13_4</span><span class="p">,</span> 
                               <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                               <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_13_4nc</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a_bar</th>
      <td>0.605</td>
      <td>0.554</td>
      <td>-0.261</td>
      <td>1.444</td>
      <td>0.122</td>
      <td>0.095</td>
      <td>17.0</td>
      <td>29.0</td>
      <td>1.10</td>
    </tr>
    <tr>
      <th>sigma_a</th>
      <td>1.925</td>
      <td>0.520</td>
      <td>1.144</td>
      <td>2.780</td>
      <td>0.124</td>
      <td>0.091</td>
      <td>20.0</td>
      <td>29.0</td>
      <td>1.11</td>
    </tr>
    <tr>
      <th>sigma_g</th>
      <td>0.067</td>
      <td>0.094</td>
      <td>0.000</td>
      <td>0.198</td>
      <td>0.028</td>
      <td>0.020</td>
      <td>4.0</td>
      <td>20.0</td>
      <td>1.53</td>
    </tr>
    <tr>
      <th>z[0]</th>
      <td>-0.528</td>
      <td>0.336</td>
      <td>-1.062</td>
      <td>-0.099</td>
      <td>0.050</td>
      <td>0.036</td>
      <td>45.0</td>
      <td>70.0</td>
      <td>1.02</td>
    </tr>
    <tr>
      <th>z[1]</th>
      <td>2.169</td>
      <td>0.612</td>
      <td>1.023</td>
      <td>2.957</td>
      <td>0.143</td>
      <td>0.103</td>
      <td>26.0</td>
      <td>32.0</td>
      <td>1.10</td>
    </tr>
    <tr>
      <th>z[2]</th>
      <td>-0.679</td>
      <td>0.346</td>
      <td>-1.197</td>
      <td>-0.104</td>
      <td>0.050</td>
      <td>0.036</td>
      <td>47.0</td>
      <td>96.0</td>
      <td>1.04</td>
    </tr>
    <tr>
      <th>z[3]</th>
      <td>-0.685</td>
      <td>0.336</td>
      <td>-1.244</td>
      <td>-0.182</td>
      <td>0.050</td>
      <td>0.035</td>
      <td>45.0</td>
      <td>104.0</td>
      <td>1.03</td>
    </tr>
    <tr>
      <th>z[4]</th>
      <td>-0.521</td>
      <td>0.336</td>
      <td>-1.007</td>
      <td>0.011</td>
      <td>0.049</td>
      <td>0.035</td>
      <td>48.0</td>
      <td>57.0</td>
      <td>1.04</td>
    </tr>
    <tr>
      <th>z[5]</th>
      <td>-0.007</td>
      <td>0.306</td>
      <td>-0.480</td>
      <td>0.470</td>
      <td>0.047</td>
      <td>0.034</td>
      <td>41.0</td>
      <td>43.0</td>
      <td>1.05</td>
    </tr>
    <tr>
      <th>z[6]</th>
      <td>0.847</td>
      <td>0.383</td>
      <td>0.351</td>
      <td>1.494</td>
      <td>0.090</td>
      <td>0.065</td>
      <td>15.0</td>
      <td>137.0</td>
      <td>1.12</td>
    </tr>
    <tr>
      <th>x[0]</th>
      <td>-0.358</td>
      <td>0.965</td>
      <td>-1.646</td>
      <td>1.340</td>
      <td>0.226</td>
      <td>0.163</td>
      <td>19.0</td>
      <td>84.0</td>
      <td>1.12</td>
    </tr>
    <tr>
      <th>x[1]</th>
      <td>0.354</td>
      <td>0.929</td>
      <td>-0.788</td>
      <td>2.107</td>
      <td>0.189</td>
      <td>0.137</td>
      <td>25.0</td>
      <td>30.0</td>
      <td>1.06</td>
    </tr>
    <tr>
      <th>x[2]</th>
      <td>-0.228</td>
      <td>0.939</td>
      <td>-1.675</td>
      <td>1.053</td>
      <td>0.150</td>
      <td>0.107</td>
      <td>40.0</td>
      <td>90.0</td>
      <td>1.02</td>
    </tr>
    <tr>
      <th>x[3]</th>
      <td>0.223</td>
      <td>0.981</td>
      <td>-1.096</td>
      <td>1.566</td>
      <td>0.305</td>
      <td>0.222</td>
      <td>12.0</td>
      <td>23.0</td>
      <td>1.19</td>
    </tr>
    <tr>
      <th>x[4]</th>
      <td>0.141</td>
      <td>0.882</td>
      <td>-1.204</td>
      <td>1.391</td>
      <td>0.255</td>
      <td>0.185</td>
      <td>13.0</td>
      <td>29.0</td>
      <td>1.14</td>
    </tr>
    <tr>
      <th>x[5]</th>
      <td>0.021</td>
      <td>1.205</td>
      <td>-2.267</td>
      <td>1.585</td>
      <td>0.484</td>
      <td>0.360</td>
      <td>6.0</td>
      <td>19.0</td>
      <td>1.29</td>
    </tr>
    <tr>
      <th>b[0]</th>
      <td>-0.148</td>
      <td>0.289</td>
      <td>-0.662</td>
      <td>0.251</td>
      <td>0.024</td>
      <td>0.017</td>
      <td>141.0</td>
      <td>180.0</td>
      <td>1.02</td>
    </tr>
    <tr>
      <th>b[1]</th>
      <td>0.376</td>
      <td>0.278</td>
      <td>-0.021</td>
      <td>0.866</td>
      <td>0.023</td>
      <td>0.017</td>
      <td>144.0</td>
      <td>146.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>b[2]</th>
      <td>-0.513</td>
      <td>0.296</td>
      <td>-1.039</td>
      <td>-0.087</td>
      <td>0.029</td>
      <td>0.021</td>
      <td>108.0</td>
      <td>95.0</td>
      <td>1.03</td>
    </tr>
    <tr>
      <th>b[3]</th>
      <td>0.250</td>
      <td>0.285</td>
      <td>-0.182</td>
      <td>0.711</td>
      <td>0.025</td>
      <td>0.018</td>
      <td>128.0</td>
      <td>146.0</td>
      <td>1.01</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="code-13-30-todo-do-not-how-to-compute-ess">
<h4>Code 13.30 [TODO - do not how to compute ess]<a class="headerlink" href="#code-13-30-todo-do-not-how-to-compute-ess" title="Permalink to this headline">Â¶</a></h4>
</div>
</div>
</div>
<div class="section" id="multilevel-posterior-predictions">
<h2>13.5 Multilevel posterior predictions<a class="headerlink" href="#multilevel-posterior-predictions" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="posterior-prediction-for-same-clusters">
<h3>13.5.1 Posterior prediction for same clusters<a class="headerlink" href="#posterior-prediction-for-same-clusters" title="Permalink to this headline">Â¶</a></h3>
<div class="section" id="code-13-31">
<h4>Code 13.31<a class="headerlink" href="#code-13-31" title="Permalink to this headline">Â¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">chimp</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">d_pred</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">actor</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">chimp</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
              <span class="n">treatment</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
              <span class="n">block_id</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># we want to calculate the p using the posterior</span>

<span class="n">sample_alpha</span> <span class="o">=</span> <span class="n">posterior_13_4</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sample_gamma</span> <span class="o">=</span> <span class="n">posterior_13_4</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sample_beta</span>  <span class="o">=</span> <span class="n">posterior_13_4</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="n">term1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">sample_alpha</span><span class="p">,</span> <span class="n">d_pred</span><span class="p">[</span><span class="s1">&#39;actor&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
<span class="n">term2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">sample_gamma</span><span class="p">,</span> <span class="n">d_pred</span><span class="p">[</span><span class="s1">&#39;block_id&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
<span class="n">term3</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">sample_beta</span><span class="p">,</span> <span class="n">d_pred</span><span class="p">[</span><span class="s1">&#39;treatment&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span> <span class="o">+</span> <span class="n">term3</span><span class="p">)</span>

<span class="n">p_mu</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">p_ci</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="p">(</span><span class="mf">5.5</span><span class="p">,</span> <span class="mf">94.5</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">p_mu</span><span class="p">,</span> <span class="n">p_ci</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&lt;tf.Tensor: shape=(4,), dtype=float32, numpy=array([0.97803   , 0.98732346, 0.97009546, 0.98516184], dtype=float32)&gt;,
 &lt;tf.Tensor: shape=(2, 4), dtype=float32, numpy=
 array([[0.9392224 , 0.9624746 , 0.91749585, 0.95743203],
        [0.99894774, 0.99946046, 0.99858505, 0.99932003]], dtype=float32)&gt;)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-13-32">
<h4>Code 13.32<a class="headerlink" href="#code-13-32" title="Permalink to this headline">Â¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">trace_13_4</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;a_bar&#39;: array([-0.10972342, -0.10972342, -0.01750485, -0.01750485, -0.40955615],
       dtype=float32),
 &#39;sigma_a&#39;: array([1.8145773, 1.8145773, 1.6243709, 1.6243709, 1.5476165],
       dtype=float32),
 &#39;sigma_g&#39;: array([0.24898139, 0.24898139, 0.25848684, 0.25848684, 0.3660943 ],
       dtype=float32),
 &#39;alpha&#39;: array([-1.5749468,  4.316332 , -1.2481049, -1.2367179, -1.0210643],
       dtype=float32),
 &#39;gamma&#39;: array([0.00870606, 0.4365757 , 0.07284477, 0.00286431, 0.03532003],
       dtype=float32),
 &#39;beta&#39;: array([0.08499438, 0.92257273, 0.06369378, 0.7334794 , 0.08499438],
       dtype=float32)}
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-13-33">
<h4>Code 13.33<a class="headerlink" href="#code-13-33" title="Permalink to this headline">Â¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_kde</span><span class="p">(</span><span class="n">trace_13_4</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="mi">4</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/13_models_with_memory_119_0.png" src="../_images/13_models_with_memory_119_0.png" />
</div>
</div>
</div>
<div class="section" id="code-13-34">
<h4>Code 13.34<a class="headerlink" href="#code-13-34" title="Permalink to this headline">Â¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">post</span> <span class="o">=</span> <span class="n">trace_13_4</span><span class="o">.</span><span class="n">posterior</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">p_link</span><span class="p">(</span><span class="n">treatment</span><span class="p">,</span> <span class="n">actor</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">block_id</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>    
    <span class="n">a</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">logodds</span> <span class="o">=</span> <span class="n">a</span><span class="p">[:,</span> <span class="n">actor</span><span class="p">]</span> <span class="o">+</span> <span class="n">g</span><span class="p">[:,</span> <span class="n">block_id</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[:,</span> <span class="n">treatment</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">logodds</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-13-35">
<h4>Code 13.35<a class="headerlink" href="#code-13-35" title="Permalink to this headline">Â¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p_raw</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">p_link</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">actor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">block_id</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">)))</span>
<span class="n">p_mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">p_raw</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">p_ci</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">p_raw</span><span class="p">,</span> <span class="p">(</span><span class="mf">5.5</span><span class="p">,</span> <span class="mf">94.5</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="posterior-prediction-for-new-clusters">
<h3>13.5.2 Posterior prediction for new clusters<a class="headerlink" href="#posterior-prediction-for-new-clusters" title="Permalink to this headline">Â¶</a></h3>
<div class="section" id="code-13-36">
<h4>Code 13.36<a class="headerlink" href="#code-13-36" title="Permalink to this headline">Â¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">p_link_abar</span><span class="p">(</span><span class="n">treatment</span><span class="p">):</span>    
    <span class="n">logodds</span> <span class="o">=</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;a_bar&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="n">treatment</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">logodds</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-13-37">
<h4>Code 13.37<a class="headerlink" href="#code-13-37" title="Permalink to this headline">Â¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p_raw</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">p_link_abar</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">)))</span>
<span class="n">p_mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">p_raw</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">p_ci</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">p_raw</span><span class="p">,</span> <span class="p">(</span><span class="mf">5.5</span><span class="p">,</span> <span class="mf">94.5</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;treatment&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;proportion pulled left&quot;</span><span class="p">,</span>
            <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">4.1</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xticks</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">xticklabels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;R/N&quot;</span><span class="p">,</span> <span class="s2">&quot;L/N&quot;</span><span class="p">,</span> <span class="s2">&quot;R/P&quot;</span><span class="p">,</span> <span class="s2">&quot;L/P&quot;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">p_mu</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">p_ci</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p_ci</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/13_models_with_memory_129_0.png" src="../_images/13_models_with_memory_129_0.png" />
</div>
</div>
</div>
<div class="section" id="code-13-38">
<h4>Code 13.38<a class="headerlink" href="#code-13-38" title="Permalink to this headline">Â¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a_sim</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">post</span><span class="p">[</span><span class="s2">&quot;a_bar&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="n">post</span><span class="p">[</span><span class="s2">&quot;sigma_a&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">p_link_asim</span><span class="p">(</span><span class="n">treatment</span><span class="p">):</span>
    <span class="n">logodds</span> <span class="o">=</span> <span class="n">a_sim</span> <span class="o">+</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="n">treatment</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">logodds</span><span class="p">)</span>

<span class="n">p_raw_asim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">p_link_asim</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">))))</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-13-39">
<h4>Code 13.39<a class="headerlink" href="#code-13-39" title="Permalink to this headline">Â¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;treatment&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;proportion pulled left&quot;</span><span class="p">,</span>
            <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">4.1</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xticks</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">xticklabels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;R/N&quot;</span><span class="p">,</span> <span class="s2">&quot;L/N&quot;</span><span class="p">,</span> <span class="s2">&quot;R/P&quot;</span><span class="p">,</span> <span class="s2">&quot;L/P&quot;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">p_raw_asim</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/13_models_with_memory_133_0.png" src="../_images/13_models_with_memory_133_0.png" />
</div>
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="12_monsters_and_mixtures.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Chapter 12 - Monsters and Mixtures</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="14_adventures_in_covariance.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Chapter 14 - Adventures in Covariance</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Richard McElreath<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>