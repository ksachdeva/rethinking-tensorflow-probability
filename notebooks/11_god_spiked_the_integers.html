
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chapter 11 - God Spiked the Integers &#8212; Statistical Rethinking (2nd Edition)</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="canonical" href="https://ksachdeva.github.io/rethinking-tensorflow-probability/notebooks/11_god_spiked_the_integers.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Chapter 12 - Monsters and Mixtures" href="12_monsters_and_mixtures.html" />
    <link rel="prev" title="Chapter 10 - Big Entropy and The Generalized Linear Model" href="10_big_entropy_and_the_generalized_linear_model.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Statistical Rethinking (2nd Edition)</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../README.html">
   Statistical Rethinking (2nd Edition) with Tensorflow Probability
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="00_preface.html">
   Preface
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="01_the_golem_of_prague.html">
   Chapter 1 The Gloem of Prague
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02_small_worlds_and_large_worlds.html">
   Chapter 2 - Small Worlds and Large Worlds
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03_sampling_the_imaginary.html">
   Chapter 3 - Sampling the Imaginary
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="04_geocentric_models.html">
   Chapter 4 - Geocentric Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="05_the_many_variables_and_the_spurious_waffles.html">
   Chapter 5 - The Many Variables &amp; The Spurious Waffles
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="06_the_haunted_dag_and_the_causal_terror.html">
   Chapter 6 - The Haunted DAG and The Causal Terror
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="07_ulysses_compass.html">
   Chapter 7 - Ulysses’ Compass
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="08_conditional_manatees.html">
   Chapter 8 - Conditional Manatees
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="09_markov_chain_monte_carlo.html">
   Chapter 9 - Markov Chain Monte Carlo
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="10_big_entropy_and_the_generalized_linear_model.html">
   Chapter 10 - Big Entropy and The Generalized Linear Model
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Chapter 11 - God Spiked the Integers
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="12_monsters_and_mixtures.html">
   Chapter 12 - Monsters and Mixtures
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="13_models_with_memory.html">
   Chapter 13 - Models with Memory
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="14_adventures_in_covariance.html">
   Chapter 14 - Adventures in Covariance
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="15_missing_data_and_other_opportunities.html">
   Chapter 15 - Missing Data and Other Opportunities
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="16_generalized_linear_madness.html">
   Chapter 16 - Generalized Linear Madness
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="17_horoscopes.html">
   Chapter 17 - Horoscopes
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/notebooks/11_god_spiked_the_integers.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/ksachdeva/rethinking-tensorflow-probability"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/ksachdeva/rethinking-tensorflow-probability/issues/new?title=Issue%20on%20page%20%2Fnotebooks/11_god_spiked_the_integers.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/ksachdeva/rethinking-tensorflow-probability/master?urlpath=tree/notebooks/11_god_spiked_the_integers.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Chapter 11 - God Spiked the Integers
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#imports-and-utility-functions">
     Imports and utility functions
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tensorflow-mcmc-sampling-helpers">
       Tensorflow MCMC sampling helpers
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#dataset-urls-utils">
       Dataset URLS &amp; Utils
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#binomial-regression">
     11.1 Binomial regression
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#logistic-regression-prosocial-chimpanzees">
       11.1.1 Logistic regression: Prosocial chimpanzees
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-1">
         Code 11.1
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-2">
         Code 11.2
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-3">
         Code 11.3
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-4">
         Code 11.4
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-5">
         Code 11.5
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-6">
         Code 11.6
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-7">
         Code 11.7
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-8">
         Code 11.8
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-9">
         Code 11.9
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-10">
         Code 11.10
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-11">
         Code 11.11
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-12">
         Code 11.12
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-13">
         Code 11.13
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-14">
         Code 11.14
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-11-15">
     Code 11.15
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-16">
       Code 11.16
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-17">
       Code 11.17
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-18">
       Code 11.18
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-19">
       Code 11.19
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-20">
       Code 11.20
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#overthinking-adding-log-probability-calculations">
       Overthinking: Adding log-probability calculations
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-21">
         Code 11.21
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-22">
         Code 11.22
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#relative-shark-and-absolute-penguin">
       11.1.2 Relative shark and absolute penguin
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-23">
         Code 11.23
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#aggregated-binomial-chimpanzees-again-condensed">
       Aggregated binomial: Chimpanzees again,condensed
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-24">
         Code 11.24
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-25">
         Code 11.25
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-26-find-a-way-to-get-the-comparison-even-if-different-number-of-obs">
         Code 11.26 (Find a way to get the comparison even if different number of obs)
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-27">
         Code 11.27
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#aggregated-binomial-graduate-school-admissions">
       11.1.4 Aggregated binomial: Graduate school admissions
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-28">
         Code 11.28
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-29">
         Code 11.29
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-30">
         Code 11.30
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-31">
         Code 11.31
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-32">
         Code 11.32
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-33">
         Code 11.33
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-34">
         Code 11.34
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#poisson-regression">
     11.2 Poisson regression
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-35">
       Code 11.35
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-36">
       Code 11.36
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-37">
       Code 11.37
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-38">
       Code 11.38
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-39">
       Code 11.39
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-40">
       Code 11.40
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-41">
       Code 11.41
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-42">
       Code 11.42
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-43">
       Code 11.43
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-44">
       Code 11.44
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-45">
       Code 11.45
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-46">
       Code 11.46
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-47">
       Code 11.47
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-48">
       Code 11.48
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-49">
       Code 11.49
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#negative-binomial-gamm-poisson-models">
       11.2.2 Negative binomial (gamm-poisson) models
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-exposure-and-the-offset">
       11.2.3 Example: Exposure and the offset
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-50">
         Code 11.50
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-11-51">
     Code 11.51
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-52">
       Code 11.52
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-53">
       Code 11.53
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-54">
       Code 11.54
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#multinomial-and-categorical-models">
     11.3 Multinomial and categorical models
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#predictors-matched-to-outcomes">
       11.3.1 Predictors matched to outcomes
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-55">
         Code 11.55
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-56">
         Code 11.56
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-57-todo-not-able-to-make-it-work-with-2-chains">
         Code 11.57 (TODO - not able to make it work with 2 chains)
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#multinomial-in-disguise-as-poisson">
       11.3.3 Multinomial in disguise as Poisson
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-60">
         Code 11.60
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-61">
         Code 11.61
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-62">
         Code 11.62
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-63">
         Code 11.63
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#censoring-and-survival">
     11.4 Censoring and survival
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-64">
       Code 11.64
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-65">
       Code 11.65
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-66-11-69-todo">
       Code 11.66  - 11.69 (TODO)
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Chapter 11 - God Spiked the Integers</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Chapter 11 - God Spiked the Integers
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#imports-and-utility-functions">
     Imports and utility functions
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tensorflow-mcmc-sampling-helpers">
       Tensorflow MCMC sampling helpers
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#dataset-urls-utils">
       Dataset URLS &amp; Utils
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#binomial-regression">
     11.1 Binomial regression
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#logistic-regression-prosocial-chimpanzees">
       11.1.1 Logistic regression: Prosocial chimpanzees
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-1">
         Code 11.1
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-2">
         Code 11.2
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-3">
         Code 11.3
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-4">
         Code 11.4
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-5">
         Code 11.5
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-6">
         Code 11.6
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-7">
         Code 11.7
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-8">
         Code 11.8
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-9">
         Code 11.9
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-10">
         Code 11.10
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-11">
         Code 11.11
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-12">
         Code 11.12
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-13">
         Code 11.13
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-14">
         Code 11.14
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-11-15">
     Code 11.15
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-16">
       Code 11.16
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-17">
       Code 11.17
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-18">
       Code 11.18
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-19">
       Code 11.19
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-20">
       Code 11.20
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#overthinking-adding-log-probability-calculations">
       Overthinking: Adding log-probability calculations
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-21">
         Code 11.21
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-22">
         Code 11.22
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#relative-shark-and-absolute-penguin">
       11.1.2 Relative shark and absolute penguin
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-23">
         Code 11.23
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#aggregated-binomial-chimpanzees-again-condensed">
       Aggregated binomial: Chimpanzees again,condensed
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-24">
         Code 11.24
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-25">
         Code 11.25
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-26-find-a-way-to-get-the-comparison-even-if-different-number-of-obs">
         Code 11.26 (Find a way to get the comparison even if different number of obs)
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-27">
         Code 11.27
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#aggregated-binomial-graduate-school-admissions">
       11.1.4 Aggregated binomial: Graduate school admissions
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-28">
         Code 11.28
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-29">
         Code 11.29
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-30">
         Code 11.30
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-31">
         Code 11.31
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-32">
         Code 11.32
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-33">
         Code 11.33
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-34">
         Code 11.34
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#poisson-regression">
     11.2 Poisson regression
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-35">
       Code 11.35
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-36">
       Code 11.36
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-37">
       Code 11.37
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-38">
       Code 11.38
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-39">
       Code 11.39
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-40">
       Code 11.40
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-41">
       Code 11.41
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-42">
       Code 11.42
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-43">
       Code 11.43
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-44">
       Code 11.44
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-45">
       Code 11.45
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-46">
       Code 11.46
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-47">
       Code 11.47
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-48">
       Code 11.48
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-49">
       Code 11.49
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#negative-binomial-gamm-poisson-models">
       11.2.2 Negative binomial (gamm-poisson) models
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-exposure-and-the-offset">
       11.2.3 Example: Exposure and the offset
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-50">
         Code 11.50
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-11-51">
     Code 11.51
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-52">
       Code 11.52
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-53">
       Code 11.53
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-54">
       Code 11.54
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#multinomial-and-categorical-models">
     11.3 Multinomial and categorical models
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#predictors-matched-to-outcomes">
       11.3.1 Predictors matched to outcomes
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-55">
         Code 11.55
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-56">
         Code 11.56
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-57-todo-not-able-to-make-it-work-with-2-chains">
         Code 11.57 (TODO - not able to make it work with 2 chains)
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#multinomial-in-disguise-as-poisson">
       11.3.3 Multinomial in disguise as Poisson
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-60">
         Code 11.60
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-61">
         Code 11.61
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-62">
         Code 11.62
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-11-63">
         Code 11.63
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#censoring-and-survival">
     11.4 Censoring and survival
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-64">
       Code 11.64
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-65">
       Code 11.65
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-11-66-11-69-todo">
       Code 11.66  - 11.69 (TODO)
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <p><a class="reference external" href="https://colab.research.google.com/github/ksachdeva/rethinking-tensorflow-probability/blob/master/notebooks/11_god_spiked_the_integers.ipynb"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg" /></a></p>
<div class="tex2jax_ignore mathjax_ignore section" id="chapter-11-god-spiked-the-integers">
<h1>Chapter 11 - God Spiked the Integers<a class="headerlink" href="#chapter-11-god-spiked-the-integers" title="Permalink to this headline">¶</a></h1>
<div class="section" id="imports-and-utility-functions">
<h2>Imports and utility functions<a class="headerlink" href="#imports-and-utility-functions" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Install packages that are not installed in colab</span>
<span class="k">try</span><span class="p">:</span>
  <span class="kn">import</span> <span class="nn">google.colab</span>
  <span class="n">IN_COLAB</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span><span class="p">:</span>
  <span class="n">IN_COLAB</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">if</span> <span class="n">IN_COLAB</span><span class="p">:</span>
    <span class="o">!</span>pip install -q watermark
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> watermark
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Core</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">arviz</span> <span class="k">as</span> <span class="nn">az</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">tensorflow_probability</span> <span class="k">as</span> <span class="nn">tfp</span>

<span class="c1"># visualization </span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># aliases</span>
<span class="n">tfd</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">distributions</span>
<span class="n">tfb</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">bijectors</span>
<span class="n">Root</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="o">.</span><span class="n">Root</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-01-17 21:34:07.158503: W tensorflow/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library &#39;libcudart.so.11.0&#39;; dlerror: libcudart.so.11.0: cannot open shared object file: No such file or directory
2022-01-17 21:34:07.158539: I tensorflow/stream_executor/cuda/cudart_stub.cc:29] Ignore above cudart dlerror if you do not have a GPU set up on your machine.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">watermark</span> -p numpy,tensorflow,tensorflow_probability,arviz,scipy,pandas
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>numpy                 : 1.21.5
tensorflow            : 2.7.0
tensorflow_probability: 0.15.0
arviz                 : 0.11.4
scipy                 : 1.7.3
pandas                : 1.3.5
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># config of various plotting libraries</span>
<span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
</pre></div>
</div>
</div>
</div>
<div class="section" id="tensorflow-mcmc-sampling-helpers">
<h3>Tensorflow MCMC sampling helpers<a class="headerlink" href="#tensorflow-mcmc-sampling-helpers" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">USE_XLA</span> <span class="o">=</span> <span class="kc">False</span>              <span class="c1">#@param</span>
<span class="n">NUMBER_OF_CHAINS</span>  <span class="o">=</span> <span class="mi">2</span>        <span class="c1">#@param </span>
<span class="n">NUMBER_OF_BURNIN</span>  <span class="o">=</span> <span class="mi">500</span>      <span class="c1">#@param</span>
<span class="n">NUMBER_OF_SAMPLES</span> <span class="o">=</span> <span class="mi">500</span>      <span class="c1">#@param</span>
<span class="n">NUMBER_OF_LEAPFROG_STEPS</span> <span class="o">=</span> <span class="mi">4</span> <span class="c1">#@param</span>

<span class="k">def</span> <span class="nf">_trace_to_arviz</span><span class="p">(</span><span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">sample_stats</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">observed_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">prior_predictive</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">posterior_predictive</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">trace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                 <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">trace</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="n">sample_stats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sample_stats</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">sample_stats</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sample_stats</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="n">prior_predictive</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prior_predictive</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">prior_predictive</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">prior_predictive</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="n">posterior_predictive</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">posterior_predictive</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">az</span><span class="o">.</span><span class="n">InferenceData</span><span class="p">)</span> <span class="ow">and</span> <span class="n">inplace</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">trace</span> <span class="o">+</span> <span class="n">az</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">posterior_predictive</span><span class="o">=</span><span class="n">posterior_predictive</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">az</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
        <span class="n">posterior</span><span class="o">=</span><span class="n">trace</span><span class="p">,</span>
        <span class="n">sample_stats</span><span class="o">=</span><span class="n">sample_stats</span><span class="p">,</span>
        <span class="n">prior_predictive</span><span class="o">=</span><span class="n">prior_predictive</span><span class="p">,</span>
        <span class="n">posterior_predictive</span><span class="o">=</span><span class="n">posterior_predictive</span><span class="p">,</span>
        <span class="n">observed_data</span><span class="o">=</span><span class="n">observed_data</span><span class="p">,</span>
    <span class="p">)</span>

<span class="nd">@tf</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="n">autograph</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">experimental_compile</span><span class="o">=</span><span class="n">USE_XLA</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">run_hmc_chain</span><span class="p">(</span><span class="n">init_state</span><span class="p">,</span>
              <span class="n">bijectors</span><span class="p">,</span> 
              <span class="n">step_size</span><span class="p">,</span> 
              <span class="n">target_log_prob_fn</span><span class="p">,</span> 
              <span class="n">num_leapfrog_steps</span><span class="o">=</span><span class="n">NUMBER_OF_LEAPFROG_STEPS</span><span class="p">,</span>
              <span class="n">num_samples</span><span class="o">=</span><span class="n">NUMBER_OF_SAMPLES</span><span class="p">,</span>
              <span class="n">burnin</span><span class="o">=</span><span class="n">NUMBER_OF_BURNIN</span><span class="p">,</span>
              <span class="p">):</span>    

    <span class="k">def</span> <span class="nf">_trace_fn_transitioned</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">pkr</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">pkr</span><span class="o">.</span><span class="n">inner_results</span><span class="o">.</span><span class="n">inner_results</span><span class="o">.</span><span class="n">log_accept_ratio</span>
        <span class="p">)</span>

    <span class="n">hmc_kernel</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">mcmc</span><span class="o">.</span><span class="n">HamiltonianMonteCarlo</span><span class="p">(</span>
                    <span class="n">target_log_prob_fn</span><span class="p">,</span>
                    <span class="n">num_leapfrog_steps</span><span class="o">=</span><span class="n">num_leapfrog_steps</span><span class="p">,</span>
                    <span class="n">step_size</span><span class="o">=</span><span class="n">step_size</span><span class="p">)</span>         

    <span class="n">inner_kernel</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">mcmc</span><span class="o">.</span><span class="n">TransformedTransitionKernel</span><span class="p">(</span>
        <span class="n">inner_kernel</span><span class="o">=</span><span class="n">hmc_kernel</span><span class="p">,</span>
        <span class="n">bijector</span><span class="o">=</span><span class="n">bijectors</span><span class="p">)</span>       

    <span class="n">kernel</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">mcmc</span><span class="o">.</span><span class="n">SimpleStepSizeAdaptation</span><span class="p">(</span>
        <span class="n">inner_kernel</span><span class="o">=</span><span class="n">inner_kernel</span><span class="p">,</span>
        <span class="n">target_accept_prob</span><span class="o">=</span><span class="mf">.8</span><span class="p">,</span>
        <span class="n">num_adaptation_steps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.8</span><span class="o">*</span><span class="n">burnin</span><span class="p">),</span>
        <span class="n">log_accept_prob_getter_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">pkr</span><span class="p">:</span> <span class="n">pkr</span><span class="o">.</span><span class="n">inner_results</span><span class="o">.</span><span class="n">log_accept_ratio</span>
    <span class="p">)</span>    

    <span class="n">results</span><span class="p">,</span> <span class="n">sampler_stat</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">mcmc</span><span class="o">.</span><span class="n">sample_chain</span><span class="p">(</span>
        <span class="n">num_results</span><span class="o">=</span><span class="n">num_samples</span><span class="p">,</span>
        <span class="n">num_burnin_steps</span><span class="o">=</span><span class="n">burnin</span><span class="p">,</span>
        <span class="n">current_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
        <span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span>
        <span class="n">trace_fn</span><span class="o">=</span><span class="n">_trace_fn_transitioned</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="n">sampler_stat</span>    

<span class="k">def</span> <span class="nf">sample_posterior</span><span class="p">(</span><span class="n">jdc</span><span class="p">,</span> 
              <span class="n">observed_data</span><span class="p">,</span> 
              <span class="n">params</span><span class="p">,</span> 
              <span class="n">init_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
              <span class="n">bijectors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
              <span class="n">step_size</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
              <span class="n">num_chains</span><span class="o">=</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">,</span>                  
              <span class="n">num_samples</span><span class="o">=</span><span class="n">NUMBER_OF_SAMPLES</span><span class="p">,</span> 
              <span class="n">burnin</span><span class="o">=</span><span class="n">NUMBER_OF_BURNIN</span><span class="p">):</span>
        
    <span class="k">if</span> <span class="n">init_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">init_state</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">jdc</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">bijectors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span><span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">init_state</span><span class="p">]</span>

    <span class="n">target_log_prob_fn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">x</span><span class="p">:</span> <span class="n">jdc</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">observed_data</span><span class="p">)</span>  

    <span class="n">results</span><span class="p">,</span> <span class="n">sample_stats</span> <span class="o">=</span> <span class="n">run_hmc_chain</span><span class="p">(</span><span class="n">init_state</span><span class="p">,</span>
                                  <span class="n">bijectors</span><span class="p">,</span>
                                  <span class="n">step_size</span><span class="o">=</span><span class="n">step_size</span><span class="p">,</span>
                                  <span class="n">target_log_prob_fn</span><span class="o">=</span><span class="n">target_log_prob_fn</span><span class="p">,</span>                                      
                                  <span class="n">num_samples</span><span class="o">=</span><span class="n">num_samples</span><span class="p">,</span> 
                                  <span class="n">burnin</span><span class="o">=</span><span class="n">burnin</span><span class="p">)</span>

    <span class="n">stat_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mean_tree_accept&#39;</span><span class="p">]</span>
    <span class="n">sampler_stats</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">stat_names</span><span class="p">,</span> <span class="p">[</span><span class="n">sample_stats</span><span class="p">]))</span>      
        
    <span class="n">transposed_results</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">transposed_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">transposed_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">transposed_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> 
        
        <span class="n">transposed_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">transposed_shape</span><span class="p">))</span>

    <span class="n">posterior</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">transposed_results</span><span class="p">))</span>        

    <span class="n">az_trace</span> <span class="o">=</span> <span class="n">_trace_to_arviz</span><span class="p">(</span><span class="n">trace</span><span class="o">=</span><span class="n">posterior</span><span class="p">,</span> 
                           <span class="n">sample_stats</span><span class="o">=</span><span class="n">sampler_stats</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">posterior</span><span class="p">,</span> <span class="n">az_trace</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="dataset-urls-utils">
<h3>Dataset URLS &amp; Utils<a class="headerlink" href="#dataset-urls-utils" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># You could change base url to local dir or a remoate raw github content</span>
<span class="n">_BASE_URL</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/rmcelreath/rethinking/master/data&quot;</span>

<span class="n">CHIMPANZEES_DATASET_PATH</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_BASE_URL</span><span class="si">}</span><span class="s2">/chimpanzees.csv&quot;</span>
<span class="n">UCBADMIT_DATASET_PATH</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_BASE_URL</span><span class="si">}</span><span class="s2">/UCBadmit.csv&quot;</span>
<span class="n">KLINE_DATASET_PATH</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_BASE_URL</span><span class="si">}</span><span class="s2">/Kline.csv&quot;</span>
<span class="n">AUSTIN_CATS_DATASET_PATH</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_BASE_URL</span><span class="si">}</span><span class="s2">/AustinCats.csv&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># A utility method to convert data (columns) from pandas dataframe</span>
<span class="c1"># into tensors with appropriate type</span>
<span class="k">def</span> <span class="nf">df_to_tensors</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">default_type</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; name : Name of the dataset</span>
<span class="sd">        df : pandas dataframe</span>
<span class="sd">        colums : a list of names that have the same type or</span>
<span class="sd">                 a dictionary where keys are the column names and values are the tensorflow type (e.g. tf.float32)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
        <span class="n">column_names</span> <span class="o">=</span> <span class="n">columns</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">columns</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>    
    <span class="k">else</span><span class="p">:</span>
        <span class="n">column_names</span> <span class="o">=</span> <span class="n">columns</span>        
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">default_type</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">]</span>    
        
    <span class="c1"># build the cls</span>
    <span class="n">tuple_cls</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">column_names</span><span class="p">)</span>    
    <span class="c1"># build the obj</span>
    <span class="k">return</span> <span class="n">tuple_cls</span><span class="o">.</span><span class="n">_make</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="introduction">
<h1>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h1>
<div class="section" id="binomial-regression">
<h2>11.1 Binomial regression<a class="headerlink" href="#binomial-regression" title="Permalink to this headline">¶</a></h2>
<div class="section" id="logistic-regression-prosocial-chimpanzees">
<h3>11.1.1 Logistic regression: Prosocial chimpanzees<a class="headerlink" href="#logistic-regression-prosocial-chimpanzees" title="Permalink to this headline">¶</a></h3>
<div class="section" id="code-11-1">
<h4>Code 11.1<a class="headerlink" href="#code-11-1" title="Permalink to this headline">¶</a></h4>
<p>Authors start the chapter by highlighting one key difference between <strong>Generalized Linear Models</strong> and <strong>Gaussian Linear Models</strong>. He says, that unlike Gaussian Linear Models where we had some interpretation of parameters, in the case of <strong>GLM</strong> it is the combination of parameters that matter.</p>
<p>Most common &amp; <strong>useful</strong> GLM models are about <strong>counts</strong> but they are also difficult to model. What is the reason for that ?</p>
<p>He says - “When we <em>wish</em> to predict the outcome in the form of counts, the scale of parameters is <strong>never the same</strong> as the scale of outcome. This is another way of saying that it is the combination of parameters that help in prediction and hence some where we lose human intution that could have connected the parmaeters with the outcome.</p>
<p><strong>Binomial Regression</strong> -: model the outcome (count) when both of the categories are known.</p>
<p><strong>Poisson Regression</strong> -: model the outcome (count) when the maximum count is unknown.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">CHIMPANZEES_DATASET_PATH</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-11-2">
<h4>Code 11.2<a class="headerlink" href="#code-11-2" title="Permalink to this headline">¶</a></h4>
<p>We aim to build index variables instead of using dummy variables. Below is a quick way to do it. Treatment here is about the 4 possible situations.</p>
<ol class="simple">
<li><p>prosoc_left= 0 and condition= 0: Two food items on right and no partner.</p></li>
<li><p>prosoc_left= 1 and condition= 0: Two food items on left and no partner.</p></li>
<li><p>prosoc_left= 0 and condition= 1: Two food items on right and partner present.</p></li>
<li><p>prosoc_left= 1 and condition= 1: Two food items on left and partner present.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># In the book there is an additional 1 in the code snippet.</span>
<span class="c1"># That is because of R as in R index does not starts with 0</span>

<span class="n">d</span><span class="p">[</span><span class="s2">&quot;treatment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">prosoc_left</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">d</span><span class="o">.</span><span class="n">condition</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-11-3">
<h4>Code 11.3<a class="headerlink" href="#code-11-3" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
    <span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">,</span> <span class="s2">&quot;prosoc_left&quot;</span><span class="p">,</span> <span class="s2">&quot;treatment&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">()[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>condition  prosoc_left  treatment
0          0            0            126
           1            1            126
1          0            2            126
           1            3            126
Name: index, dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>actor</th>
      <th>recipient</th>
      <th>condition</th>
      <th>block</th>
      <th>trial</th>
      <th>prosoc_left</th>
      <th>chose_prosoc</th>
      <th>pulled_left</th>
      <th>treatment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>504.000000</td>
      <td>252.00000</td>
      <td>504.000000</td>
      <td>504.000000</td>
      <td>504.000000</td>
      <td>504.000000</td>
      <td>504.00000</td>
      <td>504.000000</td>
      <td>504.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>4.000000</td>
      <td>5.00000</td>
      <td>0.500000</td>
      <td>3.500000</td>
      <td>36.500000</td>
      <td>0.500000</td>
      <td>0.56746</td>
      <td>0.579365</td>
      <td>1.500000</td>
    </tr>
    <tr>
      <th>std</th>
      <td>2.001987</td>
      <td>2.00398</td>
      <td>0.500497</td>
      <td>1.709522</td>
      <td>20.803253</td>
      <td>0.500497</td>
      <td>0.49592</td>
      <td>0.494151</td>
      <td>1.119145</td>
    </tr>
    <tr>
      <th>min</th>
      <td>1.000000</td>
      <td>2.00000</td>
      <td>0.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>0.000000</td>
      <td>0.00000</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>2.000000</td>
      <td>3.00000</td>
      <td>0.000000</td>
      <td>2.000000</td>
      <td>18.750000</td>
      <td>0.000000</td>
      <td>0.00000</td>
      <td>0.000000</td>
      <td>0.750000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>4.000000</td>
      <td>5.00000</td>
      <td>0.500000</td>
      <td>3.500000</td>
      <td>36.500000</td>
      <td>0.500000</td>
      <td>1.00000</td>
      <td>1.000000</td>
      <td>1.500000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>6.000000</td>
      <td>7.00000</td>
      <td>1.000000</td>
      <td>5.000000</td>
      <td>54.250000</td>
      <td>1.000000</td>
      <td>1.00000</td>
      <td>1.000000</td>
      <td>2.250000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>7.000000</td>
      <td>8.00000</td>
      <td>1.000000</td>
      <td>6.000000</td>
      <td>72.000000</td>
      <td>1.000000</td>
      <td>1.00000</td>
      <td>1.000000</td>
      <td>3.000000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="code-11-4">
<h4>Code 11.4<a class="headerlink" href="#code-11-4" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_11_1</span><span class="p">(</span><span class="n">alpha_scale</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
      <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">alpha_scale</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">logit</span> <span class="o">=</span> <span class="n">alpha</span>
      <span class="n">pulled_left</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span><span class="n">total_count</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">logits</span><span class="o">=</span><span class="n">logit</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    
    
<span class="n">jdc_11_1</span> <span class="o">=</span> <span class="n">model_11_1</span><span class="p">(</span><span class="n">alpha_scale</span><span class="o">=</span><span class="mf">10.</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-11-5">
<h4>Code 11.5<a class="headerlink" href="#code-11-5" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prior</span> <span class="o">=</span> <span class="n">jdc_11_1</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-01-17 21:34:12.503475: W tensorflow/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library &#39;libcuda.so.1&#39;; dlerror: libcuda.so.1: cannot open shared object file: No such file or directory
2022-01-17 21:34:12.503519: W tensorflow/stream_executor/cuda/cuda_driver.cc:269] failed call to cuInit: UNKNOWN ERROR (303)
2022-01-17 21:34:12.503565: I tensorflow/stream_executor/cuda/cuda_diagnostics.cc:156] kernel driver does not appear to be running on this host (fv-az272-145): /proc/driver/nvidia/version does not exist
2022-01-17 21:34:12.503802: I tensorflow/core/platform/cpu_feature_guard.cc:151] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  AVX2 FMA
To enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-11-6">
<h4>Code 11.6<a class="headerlink" href="#code-11-6" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">prior</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">az</span><span class="o">.</span><span class="n">plot_kde</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">bw</span><span class="o">=</span><span class="mf">0.3</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/11_god_spiked_the_integers_28_0.png" src="../_images/11_god_spiked_the_integers_28_0.png" />
</div>
</div>
<p>Most of the probability mass in the above plot is piled up near zero or one. A flat prior in the logit space is not a flat prior in the outcome probability space.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jdc_11_1b</span> <span class="o">=</span> <span class="n">model_11_1</span><span class="p">(</span><span class="n">alpha_scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">prior_with_1_5</span> <span class="o">=</span> <span class="n">jdc_11_1b</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">prior_with_1_5</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">az</span><span class="o">.</span><span class="n">plot_kde</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">bw</span><span class="o">=</span><span class="mf">0.3</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/11_god_spiked_the_integers_30_0.png" src="../_images/11_god_spiked_the_integers_30_0.png" />
</div>
</div>
<p>A more concentrated Normal(0,1.5) prior produces something more reasonable</p>
</div>
<div class="section" id="code-11-7">
<h4>Code 11.7<a class="headerlink" href="#code-11-7" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tdf</span> <span class="o">=</span> <span class="n">df_to_tensors</span><span class="p">(</span><span class="s2">&quot;Chimpanzee&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;treatment&#39;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_11_2</span><span class="p">(</span><span class="n">treatments</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
      <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">beta_treatment</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">10.0</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
    
      <span class="n">logit</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">beta_treatment</span><span class="p">,</span> <span class="n">treatments</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
        
      <span class="n">pulled_left</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span>
          <span class="n">tfd</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span><span class="n">total_count</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">logits</span><span class="o">=</span><span class="n">logit</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    
    
<span class="n">jdc_11_2</span> <span class="o">=</span> <span class="n">model_11_2</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">treatment</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prior_a</span><span class="p">,</span> <span class="n">prior_b</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">jdc_11_2</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prior_a</span> <span class="o">=</span> <span class="n">prior_a</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">prior_b</span> <span class="o">=</span> <span class="n">prior_b</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_p_for_given_treatment</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">prior_a</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">prior_b</span><span class="p">[:,</span><span class="n">t</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">compute_p_for_given_treatment</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">))))</span><span class="o">.</span><span class="n">T</span>

<span class="n">p</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(1000, 4)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-11-8">
<h4>Code 11.8<a class="headerlink" href="#code-11-8" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_kde</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">p</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">bw</span><span class="o">=</span><span class="mf">0.3</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/11_god_spiked_the_integers_39_0.png" src="../_images/11_god_spiked_the_integers_39_0.png" />
</div>
</div>
</div>
<div class="section" id="code-11-9">
<h4>Code 11.9<a class="headerlink" href="#code-11-9" title="Permalink to this headline">¶</a></h4>
<p>Sample model as 11_2 but with a different scale for beta_treatment</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_11_3</span><span class="p">(</span><span class="n">treatments</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
      <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">beta_treatment</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
    
      <span class="n">logit</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">beta_treatment</span><span class="p">,</span> <span class="n">treatments</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
        
      <span class="n">pulled_left</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span>
          <span class="n">tfd</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span><span class="n">total_count</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">logits</span><span class="o">=</span><span class="n">logit</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    
    
<span class="n">jdc_11_3</span> <span class="o">=</span> <span class="n">model_11_3</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">treatment</span><span class="p">)</span>


<span class="n">prior_a</span><span class="p">,</span> <span class="n">prior_b</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">jdc_11_3</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>

<span class="n">prior_a</span> <span class="o">=</span> <span class="n">prior_a</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">prior_b</span> <span class="o">=</span> <span class="n">prior_b</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">compute_p_for_given_treatment</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">))))</span><span class="o">.</span><span class="n">T</span>

<span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">p</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.098545216
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-11-10">
<h4>Code 11.10<a class="headerlink" href="#code-11-10" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>actor</th>
      <th>recipient</th>
      <th>condition</th>
      <th>block</th>
      <th>trial</th>
      <th>prosoc_left</th>
      <th>chose_prosoc</th>
      <th>pulled_left</th>
      <th>treatment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>2</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>4</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>6</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>8</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>10</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>499</th>
      <td>7</td>
      <td>4.0</td>
      <td>1</td>
      <td>6</td>
      <td>64</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>3</td>
    </tr>
    <tr>
      <th>500</th>
      <td>7</td>
      <td>6.0</td>
      <td>1</td>
      <td>6</td>
      <td>66</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>3</td>
    </tr>
    <tr>
      <th>501</th>
      <td>7</td>
      <td>3.0</td>
      <td>1</td>
      <td>6</td>
      <td>68</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>502</th>
      <td>7</td>
      <td>7.0</td>
      <td>1</td>
      <td>6</td>
      <td>70</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>503</th>
      <td>7</td>
      <td>2.0</td>
      <td>1</td>
      <td>6</td>
      <td>72</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
<p>504 rows × 9 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;actor_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tdf</span> <span class="o">=</span> <span class="n">df_to_tensors</span><span class="p">(</span><span class="s2">&quot;Chimpanzee&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;pulled_left&#39;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="s1">&#39;treatment&#39;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span>
    <span class="s1">&#39;actor_id&#39;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-11-11">
<h4>Code 11.11<a class="headerlink" href="#code-11-11" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_11_4</span><span class="p">(</span><span class="n">actors</span><span class="p">,</span> <span class="n">treatments</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
      <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">7</span><span class="p">))</span>
      <span class="n">beta_treatment</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
        
      <span class="n">term1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">actors</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">term2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">beta_treatment</span><span class="p">,</span> <span class="n">treatments</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    
      <span class="n">logit</span> <span class="o">=</span> <span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span>
        
      <span class="n">pulled_left</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span>
          <span class="n">tfd</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span><span class="n">total_count</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">logits</span><span class="o">=</span><span class="n">logit</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    
    
<span class="n">jdc_11_4</span> <span class="o">=</span> <span class="n">model_11_4</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">actor_id</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">treatment</span><span class="p">)</span>
<span class="n">jdc_11_4</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>StructTuple(
  var0=&lt;tf.Tensor: shape=(7,), dtype=float32, numpy=
    array([ 1.7116835 ,  1.9397771 , -0.05834224,  0.65075964,  0.2702733 ,
            1.0859287 , -1.5222527 ], dtype=float32)&gt;,
  var1=&lt;tf.Tensor: shape=(4,), dtype=float32, numpy=array([ 0.23647411, -0.15032959, -0.35830316,  0.8987468 ], dtype=float32)&gt;,
  var2=&lt;tf.Tensor: shape=(504,), dtype=float32, numpy=
    array([1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1.,
           1., 0., 1., 1., 1., 1., 1., 1., 1., 1., 0., 1., 1., 1., 1., 1., 1.,
           1., 1., 0., 1., 1., 1., 0., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1.,
           1., 1., 0., 1., 1., 1., 1., 0., 0., 1., 1., 0., 1., 0., 1., 1., 1.,
           0., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1.,
           1., 0., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1.,
           1., 1., 1., 1., 0., 1., 0., 1., 1., 0., 1., 1., 0., 1., 1., 1., 1.,
           1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1.,
           1., 1., 1., 1., 0., 1., 1., 1., 0., 0., 1., 1., 1., 1., 0., 0., 1.,
           0., 1., 1., 0., 0., 1., 0., 1., 0., 0., 1., 0., 0., 0., 1., 1., 0.,
           1., 1., 1., 1., 1., 1., 0., 0., 1., 0., 0., 0., 1., 1., 1., 1., 1.,
           0., 0., 1., 1., 0., 0., 1., 0., 1., 1., 1., 1., 1., 0., 0., 0., 0.,
           1., 1., 0., 1., 0., 0., 0., 1., 0., 1., 0., 0., 0., 0., 1., 0., 0.,
           1., 0., 1., 1., 1., 1., 0., 1., 0., 1., 1., 0., 1., 1., 1., 1., 1.,
           1., 0., 1., 0., 1., 0., 1., 1., 1., 0., 0., 0., 1., 1., 1., 1., 1.,
           0., 1., 0., 1., 1., 0., 1., 1., 1., 0., 0., 1., 1., 1., 1., 1., 1.,
           1., 1., 1., 0., 1., 1., 1., 1., 1., 1., 1., 1., 1., 0., 0., 1., 0.,
           1., 1., 1., 1., 0., 0., 1., 1., 0., 0., 1., 0., 1., 1., 0., 1., 0.,
           0., 1., 1., 0., 0., 1., 0., 1., 0., 1., 1., 1., 1., 0., 0., 0., 1.,
           1., 1., 1., 1., 1., 0., 1., 1., 1., 1., 1., 0., 0., 0., 1., 0., 1.,
           1., 0., 1., 0., 0., 0., 1., 1., 0., 1., 0., 0., 0., 0., 0., 1., 0.,
           0., 1., 1., 0., 1., 1., 0., 1., 1., 0., 1., 1., 1., 1., 1., 1., 1.,
           1., 1., 1., 1., 1., 0., 1., 1., 0., 0., 0., 1., 0., 1., 1., 1., 1.,
           1., 1., 1., 1., 1., 1., 1., 1., 1., 0., 1., 1., 1., 1., 1., 1., 1.,
           0., 1., 1., 1., 0., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 0.,
           1., 1., 1., 1., 1., 1., 1., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0.,
           0., 0., 0., 0., 0., 1., 0., 0., 1., 0., 0., 0., 0., 0., 0., 1., 1.,
           0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 1., 0., 1., 0.,
           0., 0., 0., 1., 0., 0., 0., 0., 0., 1., 1., 0., 1., 1., 0., 1., 1.,
           0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.], dtype=float32)&gt;
)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">,</span> <span class="mi">7</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
<span class="p">]</span>

<span class="n">observed_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">pulled_left</span><span class="p">,</span> <span class="p">)</span>

<span class="n">posterior_11_4</span><span class="p">,</span> <span class="n">trace_11_4</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                                <span class="n">jdc_11_4</span><span class="p">,</span> 
                                <span class="n">observed_data</span><span class="o">=</span><span class="n">observed_data</span><span class="p">,</span> 
                                <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                                <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">,</span>
                                <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;beta_treatment&quot;</span><span class="p">])</span>


<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_11_4</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:@custom_gradient grad_fn has &#39;variables&#39; in signature, but no ResourceVariables were used on the forward pass.
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha[0]</th>
      <td>-0.426</td>
      <td>0.303</td>
      <td>-0.921</td>
      <td>0.046</td>
      <td>0.017</td>
      <td>0.012</td>
      <td>336.0</td>
      <td>529.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[1]</th>
      <td>3.829</td>
      <td>0.697</td>
      <td>2.727</td>
      <td>4.919</td>
      <td>0.040</td>
      <td>0.029</td>
      <td>308.0</td>
      <td>402.0</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[2]</th>
      <td>-0.734</td>
      <td>0.334</td>
      <td>-1.291</td>
      <td>-0.258</td>
      <td>0.015</td>
      <td>0.014</td>
      <td>533.0</td>
      <td>317.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[3]</th>
      <td>-0.735</td>
      <td>0.321</td>
      <td>-1.278</td>
      <td>-0.279</td>
      <td>0.016</td>
      <td>0.012</td>
      <td>382.0</td>
      <td>562.0</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[4]</th>
      <td>-0.444</td>
      <td>0.333</td>
      <td>-0.971</td>
      <td>0.082</td>
      <td>0.015</td>
      <td>0.011</td>
      <td>485.0</td>
      <td>626.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[5]</th>
      <td>0.480</td>
      <td>0.305</td>
      <td>-0.010</td>
      <td>0.934</td>
      <td>0.014</td>
      <td>0.010</td>
      <td>506.0</td>
      <td>327.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[6]</th>
      <td>1.966</td>
      <td>0.391</td>
      <td>1.289</td>
      <td>2.539</td>
      <td>0.017</td>
      <td>0.012</td>
      <td>561.0</td>
      <td>318.0</td>
      <td>1.02</td>
    </tr>
    <tr>
      <th>beta_treatment[0]</th>
      <td>-0.044</td>
      <td>0.281</td>
      <td>-0.448</td>
      <td>0.430</td>
      <td>0.017</td>
      <td>0.012</td>
      <td>269.0</td>
      <td>412.0</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>beta_treatment[1]</th>
      <td>0.468</td>
      <td>0.272</td>
      <td>0.095</td>
      <td>0.941</td>
      <td>0.016</td>
      <td>0.012</td>
      <td>291.0</td>
      <td>347.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>beta_treatment[2]</th>
      <td>-0.385</td>
      <td>0.282</td>
      <td>-0.830</td>
      <td>0.047</td>
      <td>0.017</td>
      <td>0.014</td>
      <td>266.0</td>
      <td>304.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>beta_treatment[3]</th>
      <td>0.381</td>
      <td>0.274</td>
      <td>-0.039</td>
      <td>0.819</td>
      <td>0.016</td>
      <td>0.011</td>
      <td>309.0</td>
      <td>183.0</td>
      <td>1.01</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Clearly interpretation of all these varying parameters is difficult now. The alphas above represent intercepts unique to each chimpanzee. Each of these expresses the tendency of each individual to pull the left lever.</p>
</div>
<div class="section" id="code-11-12">
<h4>Code 11.12<a class="headerlink" href="#code-11-12" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">post</span> <span class="o">=</span> <span class="n">trace_11_4</span><span class="o">.</span><span class="n">posterior</span>
<span class="n">p_left</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">post</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">({</span><span class="s2">&quot;p_left&quot;</span><span class="p">:</span> <span class="n">p_left</span><span class="p">},</span> <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">1.01</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/11_god_spiked_the_integers_51_0.png" src="../_images/11_god_spiked_the_integers_51_0.png" />
</div>
</div>
<p>What above plot shows is that 0,2,3,4 show preference for right lever.
Two chimps (1 &amp; 6) show strong preference for left lever and it is also reflected in the data</p>
</div>
<div class="section" id="code-11-13">
<h4>Code 11.13<a class="headerlink" href="#code-11-13" title="Permalink to this headline">¶</a></h4>
<p>Here we are now considering treatment effects and hoping that they are estimated more precisely</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;R/N&quot;</span><span class="p">,</span> <span class="s2">&quot;L/N&quot;</span><span class="p">,</span> <span class="s2">&quot;R/P&quot;</span><span class="p">,</span> <span class="s2">&quot;L/P&quot;</span><span class="p">]</span>
<span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">trace_11_4</span><span class="p">,</span> <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
               <span class="n">var_names</span><span class="o">=</span><span class="s2">&quot;beta_treatment&quot;</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">labs</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/11_god_spiked_the_integers_54_0.png" src="../_images/11_god_spiked_the_integers_54_0.png" />
</div>
</div>
<ul class="simple">
<li><p>L/N =&gt; prosocial on left / no partner</p></li>
<li><p>R/P =&gt; proscoial on right / partner</p></li>
</ul>
<p>What we are looking for is evidence that the chimpanzees choose the prosocial option more when a partner is present. This implies comparing the first row with the third row and the second row with the fourth row</p>
</div>
<div class="section" id="code-11-14">
<h4>Code 11.14<a class="headerlink" href="#code-11-14" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">diffs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;db13&quot;</span><span class="p">:</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;beta_treatment&quot;</span><span class="p">][</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;beta_treatment&quot;</span><span class="p">][</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
         <span class="s2">&quot;db24&quot;</span><span class="p">:</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;beta_treatment&quot;</span><span class="p">][</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;beta_treatment&quot;</span><span class="p">][</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">]}</span>
<span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">diffs</span><span class="p">,</span> <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/11_god_spiked_the_integers_57_0.png" src="../_images/11_god_spiked_the_integers_57_0.png" />
</div>
</div>
<p>db13 is the difference between no-partner/partner treatments when the prosocial option was on the right.</p>
<p>There is a weak evidence that individual pulled left more when the partner was absent</p>
</div>
</div>
</div>
<div class="section" id="code-11-15">
<h2>Code 11.15<a class="headerlink" href="#code-11-15" title="Permalink to this headline">¶</a></h2>
<p>Compute proportion in each combination of actor &amp; treatment</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pl</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;actor&quot;</span><span class="p">,</span> <span class="s2">&quot;treatment&quot;</span><span class="p">])[</span><span class="s2">&quot;pulled_left&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
<span class="n">pl</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>treatment
0    0.333333
1    0.500000
2    0.277778
3    0.555556
Name: 1, dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pl</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>treatment</th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
    </tr>
    <tr>
      <th>actor</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>0.333333</td>
      <td>0.500000</td>
      <td>0.277778</td>
      <td>0.555556</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.277778</td>
      <td>0.611111</td>
      <td>0.166667</td>
      <td>0.333333</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.333333</td>
      <td>0.500000</td>
      <td>0.111111</td>
      <td>0.444444</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0.333333</td>
      <td>0.555556</td>
      <td>0.277778</td>
      <td>0.500000</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0.777778</td>
      <td>0.611111</td>
      <td>0.555556</td>
      <td>0.611111</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.777778</td>
      <td>0.833333</td>
      <td>0.944444</td>
      <td>1.000000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>the cells contain proportions of pulls that were of the left lever</p>
<div class="section" id="code-11-16">
<h3>Code 11.16<a class="headerlink" href="#code-11-16" title="Permalink to this headline">¶</a></h3>
<p>Plotting observed proportions</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">28.5</span><span class="p">),</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">),</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                 <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;proportion left lever&quot;</span><span class="p">,</span> <span class="n">xticks</span><span class="o">=</span><span class="p">[])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">((</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mf">4.5</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s2">&quot;actor </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="p">((</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">),</span>
                <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">annotation_clip</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span> <span class="n">pl</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]],</span> <span class="s2">&quot;b&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]),</span> <span class="n">pl</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]],</span> <span class="s2">&quot;b&quot;</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">29</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
           <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
           <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
<span class="n">yoff</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s2">&quot;R/N&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">yoff</span><span class="p">),</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s2">&quot;L/N&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">yoff</span><span class="p">),</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s2">&quot;R/P&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">yoff</span><span class="p">),</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s2">&quot;L/P&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">yoff</span><span class="p">),</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;observed proportions</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/11_god_spiked_the_integers_64_0.png" src="../_images/11_god_spiked_the_integers_64_0.png" />
</div>
</div>
</div>
<div class="section" id="code-11-17">
<h3>Code 11.17<a class="headerlink" href="#code-11-17" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dat</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;actor&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="mi">4</span><span class="p">),</span>
       <span class="s2">&quot;treatment&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="mi">7</span><span class="p">)}</span>

<span class="k">def</span> <span class="nf">compute_p_for_given_actor_treatment</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span><span class="n">a</span><span class="p">]</span> <span class="o">+</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;beta_treatment&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span><span class="n">t</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

<span class="n">params</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s2">&quot;actor&quot;</span><span class="p">],</span> <span class="n">dat</span><span class="p">[</span><span class="s2">&quot;treatment&quot;</span><span class="p">])</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">compute_p_for_given_actor_treatment</span><span class="p">,</span> <span class="n">params</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span>

<span class="n">p_mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">p_ci</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="p">(</span><span class="mf">4.5</span><span class="p">,</span> <span class="mf">95.5</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-11-18">
<h3>Code 11.18<a class="headerlink" href="#code-11-18" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;side&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">prosoc_left</span>  <span class="c1"># right 0, left 1</span>
<span class="n">d</span><span class="p">[</span><span class="s2">&quot;cond&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">condition</span>  <span class="c1"># no partner 0, partner 1</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-11-19">
<h3>Code 11.19<a class="headerlink" href="#code-11-19" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tdf</span> <span class="o">=</span> <span class="n">df_to_tensors</span><span class="p">(</span><span class="s2">&quot;Chimpanzee&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="p">{</span>
    <span class="s2">&quot;pulled_left&quot;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="s2">&quot;actor_id&quot;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span>
    <span class="s2">&quot;side&quot;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span>
    <span class="s2">&quot;cond&quot;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span>
<span class="p">})</span>

<span class="k">def</span> <span class="nf">model_11_5</span><span class="p">(</span><span class="n">actors</span><span class="p">,</span> <span class="n">sides</span><span class="p">,</span> <span class="n">conds</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
      <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">7</span><span class="p">))</span>
      <span class="n">beta_side</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
      <span class="n">beta_cond</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>  
        
      <span class="n">term1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">actors</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">term2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">beta_side</span><span class="p">,</span> <span class="n">sides</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">term3</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">beta_cond</span><span class="p">,</span> <span class="n">conds</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  
    
      <span class="n">logit</span> <span class="o">=</span> <span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span> <span class="o">+</span> <span class="n">term3</span>
        
      <span class="n">pulled_left</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span>
          <span class="n">tfd</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span><span class="n">total_count</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">logits</span><span class="o">=</span><span class="n">logit</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    
    
<span class="n">jdc_11_5</span> <span class="o">=</span> <span class="n">model_11_5</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">actor_id</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">side</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">cond</span><span class="p">)</span>
<span class="n">jdc_11_5</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>StructTuple(
  var0=&lt;tf.Tensor: shape=(7,), dtype=float32, numpy=
    array([ 0.6607092 ,  0.32307565, -2.5221875 , -1.4223509 , -0.4242038 ,
           -0.35710993,  0.82164556], dtype=float32)&gt;,
  var1=&lt;tf.Tensor: shape=(2,), dtype=float32, numpy=array([-1.2213022, -0.0997249], dtype=float32)&gt;,
  var2=&lt;tf.Tensor: shape=(2,), dtype=float32, numpy=array([ 0.33822396, -0.04783153], dtype=float32)&gt;,
  var3=&lt;tf.Tensor: shape=(504,), dtype=float32, numpy=
    array([0., 0., 1., 1., 1., 1., 1., 1., 1., 0., 0., 1., 1., 1., 0., 1., 1.,
           1., 1., 0., 0., 1., 1., 1., 0., 1., 1., 0., 1., 1., 1., 1., 1., 1.,
           0., 0., 1., 0., 0., 1., 0., 1., 0., 1., 0., 1., 1., 0., 1., 0., 1.,
           0., 1., 1., 1., 0., 1., 0., 1., 0., 1., 1., 1., 1., 1., 1., 1., 1.,
           0., 1., 1., 1., 1., 1., 0., 1., 1., 0., 1., 1., 1., 0., 1., 0., 1.,
           1., 1., 0., 0., 1., 1., 0., 1., 1., 1., 0., 1., 1., 1., 0., 1., 0.,
           0., 0., 1., 0., 0., 0., 1., 0., 1., 0., 0., 0., 0., 1., 1., 0., 0.,
           0., 0., 1., 0., 1., 1., 1., 1., 1., 1., 0., 1., 0., 0., 1., 0., 0.,
           1., 0., 0., 1., 0., 1., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
           0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0.,
           1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
           0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
           0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 1.,
           0., 0., 0., 1., 0., 0., 0., 1., 0., 1., 1., 0., 0., 0., 0., 0., 1.,
           0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0.,
           0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0.,
           0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1.,
           1., 0., 0., 0., 1., 0., 0., 0., 0., 0., 1., 0., 1., 1., 0., 0., 1.,
           1., 1., 1., 0., 0., 0., 1., 0., 1., 0., 0., 0., 0., 1., 0., 1., 0.,
           0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0.,
           0., 1., 0., 0., 1., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
           0., 0., 0., 1., 0., 0., 0., 0., 1., 0., 0., 1., 0., 0., 1., 0., 1.,
           0., 0., 1., 0., 0., 1., 0., 1., 0., 0., 1., 1., 0., 1., 0., 1., 0.,
           1., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 1., 1., 1.,
           0., 0., 0., 1., 0., 0., 0., 0., 1., 0., 0., 1., 1., 0., 0., 0., 0.,
           0., 0., 0., 1., 0., 1., 0., 1., 1., 0., 1., 0., 1., 0., 1., 1., 0.,
           1., 0., 1., 1., 1., 0., 1., 1., 1., 1., 0., 0., 0., 1., 0., 0., 1.,
           0., 1., 1., 0., 0., 0., 1., 0., 0., 0., 0., 1., 0., 1., 0., 1., 0.,
           1., 0., 1., 1., 1., 1., 0., 0., 1., 1., 0., 1., 1., 0., 0., 0., 1.,
           0., 0., 0., 1., 1., 1., 1., 1., 0., 0., 0.], dtype=float32)&gt;
)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">,</span> <span class="mi">7</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
<span class="p">]</span>

<span class="n">observed_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">pulled_left</span><span class="p">,</span> <span class="p">)</span>

<span class="n">posterior_11_5</span><span class="p">,</span> <span class="n">trace_11_5</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                                <span class="n">jdc_11_5</span><span class="p">,</span> 
                                <span class="n">observed_data</span><span class="o">=</span><span class="n">observed_data</span><span class="p">,</span> 
                                <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                                <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">,</span>
                                <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;beta_side&quot;</span><span class="p">,</span> <span class="s2">&quot;beta_cond&quot;</span><span class="p">])</span>


<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_11_5</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha[0]</th>
      <td>-0.647</td>
      <td>0.443</td>
      <td>-1.259</td>
      <td>0.110</td>
      <td>0.047</td>
      <td>0.033</td>
      <td>89.0</td>
      <td>181.0</td>
      <td>1.05</td>
    </tr>
    <tr>
      <th>alpha[1]</th>
      <td>3.811</td>
      <td>0.840</td>
      <td>2.494</td>
      <td>5.147</td>
      <td>0.097</td>
      <td>0.069</td>
      <td>75.0</td>
      <td>156.0</td>
      <td>1.04</td>
    </tr>
    <tr>
      <th>alpha[2]</th>
      <td>-0.956</td>
      <td>0.445</td>
      <td>-1.688</td>
      <td>-0.278</td>
      <td>0.049</td>
      <td>0.035</td>
      <td>82.0</td>
      <td>123.0</td>
      <td>1.04</td>
    </tr>
    <tr>
      <th>alpha[3]</th>
      <td>-0.957</td>
      <td>0.450</td>
      <td>-1.600</td>
      <td>-0.144</td>
      <td>0.050</td>
      <td>0.035</td>
      <td>82.0</td>
      <td>146.0</td>
      <td>1.04</td>
    </tr>
    <tr>
      <th>alpha[4]</th>
      <td>-0.658</td>
      <td>0.460</td>
      <td>-1.532</td>
      <td>-0.042</td>
      <td>0.050</td>
      <td>0.036</td>
      <td>84.0</td>
      <td>169.0</td>
      <td>1.05</td>
    </tr>
    <tr>
      <th>alpha[5]</th>
      <td>0.277</td>
      <td>0.436</td>
      <td>-0.430</td>
      <td>0.975</td>
      <td>0.049</td>
      <td>0.035</td>
      <td>78.0</td>
      <td>156.0</td>
      <td>1.04</td>
    </tr>
    <tr>
      <th>alpha[6]</th>
      <td>1.745</td>
      <td>0.516</td>
      <td>0.939</td>
      <td>2.517</td>
      <td>0.049</td>
      <td>0.035</td>
      <td>110.0</td>
      <td>216.0</td>
      <td>1.03</td>
    </tr>
    <tr>
      <th>beta_side[0]</th>
      <td>-0.175</td>
      <td>0.334</td>
      <td>-0.656</td>
      <td>0.394</td>
      <td>0.024</td>
      <td>0.017</td>
      <td>188.0</td>
      <td>383.0</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>beta_side[1]</th>
      <td>0.517</td>
      <td>0.333</td>
      <td>0.049</td>
      <td>1.086</td>
      <td>0.024</td>
      <td>0.017</td>
      <td>190.0</td>
      <td>288.0</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>beta_cond[0]</th>
      <td>0.278</td>
      <td>0.341</td>
      <td>-0.256</td>
      <td>0.836</td>
      <td>0.028</td>
      <td>0.020</td>
      <td>144.0</td>
      <td>227.0</td>
      <td>1.02</td>
    </tr>
    <tr>
      <th>beta_cond[1]</th>
      <td>0.024</td>
      <td>0.337</td>
      <td>-0.479</td>
      <td>0.590</td>
      <td>0.028</td>
      <td>0.020</td>
      <td>142.0</td>
      <td>228.0</td>
      <td>1.03</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="code-11-20">
<h3>Code 11.20<a class="headerlink" href="#code-11-20" title="Permalink to this headline">¶</a></h3>
<p>We need to compute likelihoods in order to use arviz’s compare method</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_and_store_log_likelihood_for_model_11_4</span><span class="p">():</span>   
    
    <span class="n">sample_alpha</span> <span class="o">=</span> <span class="n">posterior_11_4</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span>
    <span class="n">sample_beta</span>  <span class="o">=</span> <span class="n">posterior_11_4</span><span class="p">[</span><span class="s2">&quot;beta_treatment&quot;</span><span class="p">]</span>
    
    <span class="n">ds</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">jdc_11_4</span><span class="o">.</span><span class="n">sample_distributions</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span>
        <span class="n">sample_alpha</span><span class="p">,</span> 
        <span class="n">sample_beta</span><span class="p">,</span> 
        <span class="kc">None</span>
    <span class="p">])</span>
    
    <span class="n">log_likelihood_11_4</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">pulled_left</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

    <span class="c1"># we need to insert this in the sampler_stats</span>
    <span class="n">sample_stats_11_4</span> <span class="o">=</span> <span class="n">trace_11_4</span><span class="o">.</span><span class="n">sample_stats</span>

    <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">sample_stats_11_4</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">],</span> <span class="n">sample_stats_11_4</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;draw&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">504</span><span class="p">)]</span>

    <span class="n">sample_stats_11_4</span><span class="p">[</span><span class="s2">&quot;log_likelihood&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
        <span class="n">log_likelihood_11_4</span><span class="p">,</span> 
        <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span>  
        <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">,</span> <span class="s1">&#39;draw&#39;</span><span class="p">,</span> <span class="s1">&#39;log_likelihood_dim_0&#39;</span><span class="p">])</span>
    
<span class="n">compute_and_store_log_likelihood_for_model_11_4</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_and_store_log_likelihood_for_model_11_5</span><span class="p">():</span>   
    
    <span class="n">sample_alpha</span>      <span class="o">=</span> <span class="n">posterior_11_5</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span>
    <span class="n">sample_beta_side</span>  <span class="o">=</span> <span class="n">posterior_11_5</span><span class="p">[</span><span class="s2">&quot;beta_side&quot;</span><span class="p">]</span>
    <span class="n">sample_beta_cond</span>  <span class="o">=</span> <span class="n">posterior_11_5</span><span class="p">[</span><span class="s2">&quot;beta_cond&quot;</span><span class="p">]</span>
    
    <span class="n">ds</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">jdc_11_5</span><span class="o">.</span><span class="n">sample_distributions</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span>
        <span class="n">sample_alpha</span><span class="p">,</span> 
        <span class="n">sample_beta_side</span><span class="p">,</span>
        <span class="n">sample_beta_cond</span><span class="p">,</span>
        <span class="kc">None</span>
    <span class="p">])</span>
    
    <span class="n">log_likelihood_11_5</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">pulled_left</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

    <span class="c1"># we need to insert this in the sampler_stats</span>
    <span class="n">sample_stats_11_5</span> <span class="o">=</span> <span class="n">trace_11_5</span><span class="o">.</span><span class="n">sample_stats</span>

    <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">sample_stats_11_5</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">],</span> <span class="n">sample_stats_11_5</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;draw&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">504</span><span class="p">)]</span>

    <span class="n">sample_stats_11_5</span><span class="p">[</span><span class="s2">&quot;log_likelihood&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
        <span class="n">log_likelihood_11_5</span><span class="p">,</span> 
        <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span>  
        <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">,</span> <span class="s1">&#39;draw&#39;</span><span class="p">,</span> <span class="s1">&#39;log_likelihood_dim_0&#39;</span><span class="p">])</span>
    
<span class="n">compute_and_store_log_likelihood_for_model_11_5</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">compare</span><span class="p">({</span><span class="s2">&quot;m11.5&quot;</span><span class="p">:</span> <span class="n">trace_11_5</span><span class="p">,</span> <span class="s2">&quot;m11.4&quot;</span><span class="p">:</span> <span class="n">trace_11_4</span><span class="p">},</span>   <span class="n">ic</span><span class="o">=</span><span class="s2">&quot;loo&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>rank</th>
      <th>loo</th>
      <th>p_loo</th>
      <th>d_loo</th>
      <th>weight</th>
      <th>se</th>
      <th>dse</th>
      <th>warning</th>
      <th>loo_scale</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>m11.5</th>
      <td>0</td>
      <td>-265.311388</td>
      <td>7.720088</td>
      <td>0.000000</td>
      <td>1.0</td>
      <td>9.542484</td>
      <td>0.000000</td>
      <td>False</td>
      <td>log</td>
    </tr>
    <tr>
      <th>m11.4</th>
      <td>1</td>
      <td>-265.995401</td>
      <td>8.259512</td>
      <td>0.684013</td>
      <td>0.0</td>
      <td>9.415858</td>
      <td>0.723384</td>
      <td>False</td>
      <td>log</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="overthinking-adding-log-probability-calculations">
<h3>Overthinking: Adding log-probability calculations<a class="headerlink" href="#overthinking-adding-log-probability-calculations" title="Permalink to this headline">¶</a></h3>
<div class="section" id="code-11-21">
<h4>Code 11.21<a class="headerlink" href="#code-11-21" title="Permalink to this headline">¶</a></h4>
<p>Since I am making use of xarray and above computation of likelihood has stored it as part of
sample_stats here is one way to see it</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trace_11_4</span><span class="o">.</span><span class="n">sample_stats</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewBox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewBox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme=dark],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1F1F1F;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block !important;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 20px 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: none;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: '►';
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: '▼';
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: '(';
}

.xr-dim-list:after {
  content: ')';
}

.xr-dim-list li:not(:last-child):after {
  content: ',';
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2 {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class='xr-text-repr-fallback'>&lt;xarray.Dataset&gt;
Dimensions:               (chain: 2, draw: 500, log_likelihood_dim_0: 504)
Coordinates:
  * chain                 (chain) int64 0 1
  * draw                  (draw) int64 0 1 2 3 4 5 6 ... 494 495 496 497 498 499
  * log_likelihood_dim_0  (log_likelihood_dim_0) int64 0 1 2 3 ... 501 502 503
Data variables:
    mean_tree_accept      (chain, draw) float32 0.02417 -0.3414 ... -1.378
    log_likelihood        (chain, draw, log_likelihood_dim_0) float32 -0.7387...
Attributes:
    created_at:     2022-01-17T21:34:19.564682
    arviz_version:  0.11.4</pre><div class='xr-wrap' style='display:none'><div class='xr-header'><div class='xr-obj-type'>xarray.Dataset</div></div><ul class='xr-sections'><li class='xr-section-item'><input id='section-3fbb039b-5e97-4c08-a4ea-c973d5737fcf' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-3fbb039b-5e97-4c08-a4ea-c973d5737fcf' class='xr-section-summary'  title='Expand/collapse section'>Dimensions:</label><div class='xr-section-inline-details'><ul class='xr-dim-list'><li><span class='xr-has-index'>chain</span>: 2</li><li><span class='xr-has-index'>draw</span>: 500</li><li><span class='xr-has-index'>log_likelihood_dim_0</span>: 504</li></ul></div><div class='xr-section-details'></div></li><li class='xr-section-item'><input id='section-284fa10a-1b6d-4ac8-a0f5-625ab43cc518' class='xr-section-summary-in' type='checkbox'  checked><label for='section-284fa10a-1b6d-4ac8-a0f5-625ab43cc518' class='xr-section-summary' >Coordinates: <span>(3)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>chain</span></div><div class='xr-var-dims'>(chain)</div><div class='xr-var-dtype'>int64</div><div class='xr-var-preview xr-preview'>0 1</div><input id='attrs-1b7474b6-6113-4eb3-966f-4fe420d15c4d' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-1b7474b6-6113-4eb3-966f-4fe420d15c4d' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-6c2473c2-e38a-47fa-9f19-547fd3c2285c' class='xr-var-data-in' type='checkbox'><label for='data-6c2473c2-e38a-47fa-9f19-547fd3c2285c' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([0, 1])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>draw</span></div><div class='xr-var-dims'>(draw)</div><div class='xr-var-dtype'>int64</div><div class='xr-var-preview xr-preview'>0 1 2 3 4 5 ... 495 496 497 498 499</div><input id='attrs-b743da1c-83aa-44a8-a4a8-827dde774bb4' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-b743da1c-83aa-44a8-a4a8-827dde774bb4' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-62110011-70d9-4a7c-9cbd-3de34f701d71' class='xr-var-data-in' type='checkbox'><label for='data-62110011-70d9-4a7c-9cbd-3de34f701d71' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([  0,   1,   2, ..., 497, 498, 499])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>log_likelihood_dim_0</span></div><div class='xr-var-dims'>(log_likelihood_dim_0)</div><div class='xr-var-dtype'>int64</div><div class='xr-var-preview xr-preview'>0 1 2 3 4 5 ... 499 500 501 502 503</div><input id='attrs-60f16d74-69c9-46ed-9ff4-f3748edd00c7' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-60f16d74-69c9-46ed-9ff4-f3748edd00c7' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-dd847b85-1373-4642-a988-137d59d2aecb' class='xr-var-data-in' type='checkbox'><label for='data-dd847b85-1373-4642-a988-137d59d2aecb' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([  0,   1,   2, ..., 501, 502, 503])</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-218dcc50-d3c6-4833-9031-5e10f689cd39' class='xr-section-summary-in' type='checkbox'  checked><label for='section-218dcc50-d3c6-4833-9031-5e10f689cd39' class='xr-section-summary' >Data variables: <span>(2)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span>mean_tree_accept</span></div><div class='xr-var-dims'>(chain, draw)</div><div class='xr-var-dtype'>float32</div><div class='xr-var-preview xr-preview'>0.02417 -0.3414 ... -0.1521 -1.378</div><input id='attrs-a38ec53c-55ef-4e08-a5e7-e3da59513e4b' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-a38ec53c-55ef-4e08-a5e7-e3da59513e4b' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-b1dda184-32eb-4f82-a2ac-4a6fcb9758ee' class='xr-var-data-in' type='checkbox'><label for='data-b1dda184-32eb-4f82-a2ac-4a6fcb9758ee' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([[ 2.41699219e-02, -3.41369629e-01, -2.26110840e+00,
        -2.31359863e+00,  7.46429443e-01, -2.96997070e+00,
        -1.38073730e+00, -1.99209595e+00, -3.25714111e-01,
         2.52471924e-01, -4.45587158e-01, -4.35791016e-02,
        -3.26538086e-03, -1.11553955e+00, -5.33111572e-01,
         6.02020264e-01,  6.43341064e-01,  3.14422607e-01,
        -1.45269775e+00, -3.43109131e-01, -9.47875977e-02,
        -1.87835693e-01, -1.58502197e+00, -2.89733887e-01,
         9.28100586e-01, -1.94833374e+00,  4.20227051e-02,
        -5.00640869e-01,  2.42034912e-01, -1.24200439e+00,
         3.40087891e-01, -5.11596680e-01,  1.87713623e-01,
        -6.88079834e-01,  3.05725098e-01, -1.96075439e-01,
        -4.37072754e-01, -1.10488892e+00, -9.63256836e-01,
        -5.16113281e-01,  1.01074219e+00, -6.21002197e-01,
        -6.53930664e-01,  2.99591064e-01, -9.99450684e-02,
         1.75750732e-01, -2.12588501e+00,  9.15527344e-03,
         4.88433838e-01, -2.47467041e-01, -1.81951904e+00,
        -1.10867310e+00, -2.16278076e-01, -9.18853760e-01,
        -9.38720703e-02,  2.22900391e-01, -3.64074707e-02,
         8.34045410e-02, -5.66894531e-01, -9.40643311e-01,
...
        -9.24682617e-02, -7.93701172e-01, -1.50299072e+00,
         1.46136475e+00,  2.61444092e-01,  5.24566650e-01,
        -1.05004883e+00, -1.40661621e+00, -2.19421387e-02,
        -9.02465820e-01, -3.93646240e-01,  8.88946533e-01,
        -1.64035034e+00, -5.93963623e-01,  2.64526367e-01,
         7.27142334e-01, -7.06787109e-02, -7.00683594e-01,
         9.17938232e-01, -1.60586548e+00, -5.28717041e-01,
        -1.65832520e-01, -1.63235474e+00, -3.60626221e-01,
         8.11950684e-01, -1.46047974e+00, -2.56442261e+00,
        -8.47381592e-01,  1.45233154e-01,  1.17919922e-01,
        -2.14233398e-02, -5.57617188e-01,  5.11779785e-01,
        -1.66195679e+00, -6.18286133e-01, -5.37139893e-01,
         2.17224121e-01, -2.26013184e-01, -1.00585938e-01,
        -7.01599121e-02, -8.03039551e-01, -1.92108154e-01,
         2.49206543e-01,  1.68365479e-01, -8.92272949e-01,
        -2.51617432e-01,  4.16412354e-01, -8.63800049e-01,
         1.14959717e+00,  4.19128418e-01, -2.88085938e-01,
        -5.17425537e-01,  5.71868896e-01,  4.29809570e-01,
        -3.99810791e-01,  6.68762207e-01, -1.90594482e+00,
        -1.52069092e-01, -1.37756348e+00]], dtype=float32)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>log_likelihood</span></div><div class='xr-var-dims'>(chain, draw, log_likelihood_dim_0)</div><div class='xr-var-dtype'>float32</div><div class='xr-var-preview xr-preview'>-0.7387 -0.6495 ... -0.2351 -0.2351</div><input id='attrs-01dc70b6-6d59-4884-9173-b72dfd65b5e7' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-01dc70b6-6d59-4884-9173-b72dfd65b5e7' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-5da258ae-a077-4332-a8f5-7802415d83d1' class='xr-var-data-in' type='checkbox'><label for='data-5da258ae-a077-4332-a8f5-7802415d83d1' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([[[-0.7387387 , -0.6495439 , -1.011357  , ..., -0.1618356 ,
         -0.1618356 , -0.1618356 ],
        [-0.41529614, -1.0792356 , -0.63236797, ..., -0.22401692,
         -0.22401692, -0.22401692],
        [-0.41529614, -1.0792356 , -0.63236797, ..., -0.22401692,
         -0.22401692, -0.22401692],
        ...,
        [-0.5553346 , -0.8530346 , -0.81229204, ..., -0.17635833,
         -0.17635833, -0.17635833],
        [-0.5402642 , -0.8736967 , -0.76674366, ..., -0.22331478,
         -0.22331478, -0.22331478],
        [-0.61857796, -0.7737283 , -1.0908499 , ..., -0.24959601,
         -0.24959601, -0.24959601]],

       [[-0.4856444 , -0.95529294, -0.6716302 , ..., -0.20784244,
         -0.20784244, -0.20784244],
        [-0.43495962, -1.0421114 , -0.80505043, ..., -0.13793835,
         -0.13793835, -0.13793835],
        [-0.5462975 , -0.865336  , -0.6745673 , ..., -0.17246644,
         -0.17246644, -0.17246644],
        ...,
        [-0.36935133, -1.175005  , -0.7077482 , ..., -0.15783362,
         -0.15783362, -0.15783362],
        [-0.4793927 , -0.96537405, -0.7417756 , ..., -0.23514572,
         -0.23514572, -0.23514572],
        [-0.4793927 , -0.96537405, -0.7417756 , ..., -0.23514572,
         -0.23514572, -0.23514572]]], dtype=float32)</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-8f37f153-32cf-4b20-9329-d03653a3f4f9' class='xr-section-summary-in' type='checkbox'  checked><label for='section-8f37f153-32cf-4b20-9329-d03653a3f4f9' class='xr-section-summary' >Attributes: <span>(2)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><dl class='xr-attrs'><dt><span>created_at :</span></dt><dd>2022-01-17T21:34:19.564682</dd><dt><span>arviz_version :</span></dt><dd>0.11.4</dd></dl></div></li></ul></div></div></div></div>
</div>
</div>
<div class="section" id="code-11-22">
<h4>Code 11.22<a class="headerlink" href="#code-11-22" title="Permalink to this headline">¶</a></h4>
<p>This code cell in the book is showing how underneath Stan is computing the log likelihood and since I have been doing it anyways there is no need to fill this section.</p>
<p>See compute_and_store_log_likelihood_for_model_11_4 for the equivalent code</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># nothing to do here</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="relative-shark-and-absolute-penguin">
<h3>11.1.2 Relative shark and absolute penguin<a class="headerlink" href="#relative-shark-and-absolute-penguin" title="Permalink to this headline">¶</a></h3>
<div class="section" id="code-11-23">
<h4>Code 11.23<a class="headerlink" href="#code-11-23" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">post</span> <span class="o">=</span> <span class="n">trace_11_4</span><span class="o">.</span><span class="n">posterior</span>

<span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">post</span><span class="p">[</span><span class="s2">&quot;beta_treatment&quot;</span><span class="p">][:,:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;beta_treatment&quot;</span><span class="p">][:,:,</span> <span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewBox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewBox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme=dark],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1F1F1F;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block !important;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 20px 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: none;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: '►';
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: '▼';
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: '(';
}

.xr-dim-list:after {
  content: ')';
}

.xr-dim-list li:not(:last-child):after {
  content: ',';
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2 {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class='xr-text-repr-fallback'>&lt;xarray.DataArray &#x27;beta_treatment&#x27; ()&gt;
array(0.9508796, dtype=float32)</pre><div class='xr-wrap' style='display:none'><div class='xr-header'><div class='xr-obj-type'>xarray.DataArray</div><div class='xr-array-name'>'beta_treatment'</div></div><ul class='xr-sections'><li class='xr-section-item'><div class='xr-array-wrap'><input id='section-b3a53ce4-9c2c-4531-9860-a080ba6cf53c' class='xr-array-in' type='checkbox' checked><label for='section-b3a53ce4-9c2c-4531-9860-a080ba6cf53c' title='Show/hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-array-preview xr-preview'><span>0.9509</span></div><div class='xr-array-data'><pre>array(0.9508796, dtype=float32)</pre></div></div></li><li class='xr-section-item'><input id='section-f66f172a-465a-4265-8b30-d3093d6dc06f' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-f66f172a-465a-4265-8b30-d3093d6dc06f' class='xr-section-summary'  title='Expand/collapse section'>Coordinates: <span>(0)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'></ul></div></li><li class='xr-section-item'><input id='section-396349b4-c5d3-453f-9908-ee764344955f' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-396349b4-c5d3-453f-9908-ee764344955f' class='xr-section-summary'  title='Expand/collapse section'>Attributes: <span>(0)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><dl class='xr-attrs'></dl></div></li></ul></div></div></div></div>
</div>
</div>
</div>
<div class="section" id="aggregated-binomial-chimpanzees-again-condensed">
<h3>Aggregated binomial: Chimpanzees again,condensed<a class="headerlink" href="#aggregated-binomial-chimpanzees-again-condensed" title="Permalink to this headline">¶</a></h3>
<div class="section" id="code-11-24">
<h4>Code 11.24<a class="headerlink" href="#code-11-24" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">CHIMPANZEES_DATASET_PATH</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
<span class="n">d</span><span class="p">[</span><span class="s2">&quot;treatment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">prosoc_left</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">d</span><span class="o">.</span><span class="n">condition</span>
<span class="n">d</span><span class="p">[</span><span class="s2">&quot;side&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">prosoc_left</span>  <span class="c1"># right 0, left 1</span>
<span class="n">d</span><span class="p">[</span><span class="s2">&quot;cond&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">condition</span>  <span class="c1"># no partner 0, partner 1</span>
<span class="n">d_aggregated</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
    <span class="p">[</span><span class="s2">&quot;treatment&quot;</span><span class="p">,</span> <span class="s2">&quot;actor&quot;</span><span class="p">,</span> <span class="s2">&quot;side&quot;</span><span class="p">,</span> <span class="s2">&quot;cond&quot;</span><span class="p">])[</span><span class="s2">&quot;pulled_left&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">d_aggregated</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pulled_left&quot;</span><span class="p">:</span> <span class="s2">&quot;left_pulls&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">d_aggregated</span><span class="p">[</span><span class="s2">&quot;actor_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_aggregated</span><span class="p">[</span><span class="s2">&quot;actor&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="mi">1</span>

<span class="n">d_aggregated</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>treatment</th>
      <th>actor</th>
      <th>side</th>
      <th>cond</th>
      <th>left_pulls</th>
      <th>actor_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>6</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>18</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>3</td>
      <td>0</td>
      <td>0</td>
      <td>5</td>
      <td>2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0</td>
      <td>4</td>
      <td>0</td>
      <td>0</td>
      <td>6</td>
      <td>3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>5</td>
      <td>0</td>
      <td>0</td>
      <td>6</td>
      <td>4</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0</td>
      <td>6</td>
      <td>0</td>
      <td>0</td>
      <td>14</td>
      <td>5</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0</td>
      <td>7</td>
      <td>0</td>
      <td>0</td>
      <td>14</td>
      <td>6</td>
    </tr>
    <tr>
      <th>7</th>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>9</td>
      <td>0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>1</td>
      <td>2</td>
      <td>1</td>
      <td>0</td>
      <td>18</td>
      <td>1</td>
    </tr>
    <tr>
      <th>9</th>
      <td>1</td>
      <td>3</td>
      <td>1</td>
      <td>0</td>
      <td>11</td>
      <td>2</td>
    </tr>
    <tr>
      <th>10</th>
      <td>1</td>
      <td>4</td>
      <td>1</td>
      <td>0</td>
      <td>9</td>
      <td>3</td>
    </tr>
    <tr>
      <th>11</th>
      <td>1</td>
      <td>5</td>
      <td>1</td>
      <td>0</td>
      <td>10</td>
      <td>4</td>
    </tr>
    <tr>
      <th>12</th>
      <td>1</td>
      <td>6</td>
      <td>1</td>
      <td>0</td>
      <td>11</td>
      <td>5</td>
    </tr>
    <tr>
      <th>13</th>
      <td>1</td>
      <td>7</td>
      <td>1</td>
      <td>0</td>
      <td>15</td>
      <td>6</td>
    </tr>
    <tr>
      <th>14</th>
      <td>2</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>5</td>
      <td>0</td>
    </tr>
    <tr>
      <th>15</th>
      <td>2</td>
      <td>2</td>
      <td>0</td>
      <td>1</td>
      <td>18</td>
      <td>1</td>
    </tr>
    <tr>
      <th>16</th>
      <td>2</td>
      <td>3</td>
      <td>0</td>
      <td>1</td>
      <td>3</td>
      <td>2</td>
    </tr>
    <tr>
      <th>17</th>
      <td>2</td>
      <td>4</td>
      <td>0</td>
      <td>1</td>
      <td>2</td>
      <td>3</td>
    </tr>
    <tr>
      <th>18</th>
      <td>2</td>
      <td>5</td>
      <td>0</td>
      <td>1</td>
      <td>5</td>
      <td>4</td>
    </tr>
    <tr>
      <th>19</th>
      <td>2</td>
      <td>6</td>
      <td>0</td>
      <td>1</td>
      <td>10</td>
      <td>5</td>
    </tr>
    <tr>
      <th>20</th>
      <td>2</td>
      <td>7</td>
      <td>0</td>
      <td>1</td>
      <td>17</td>
      <td>6</td>
    </tr>
    <tr>
      <th>21</th>
      <td>3</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>10</td>
      <td>0</td>
    </tr>
    <tr>
      <th>22</th>
      <td>3</td>
      <td>2</td>
      <td>1</td>
      <td>1</td>
      <td>18</td>
      <td>1</td>
    </tr>
    <tr>
      <th>23</th>
      <td>3</td>
      <td>3</td>
      <td>1</td>
      <td>1</td>
      <td>6</td>
      <td>2</td>
    </tr>
    <tr>
      <th>24</th>
      <td>3</td>
      <td>4</td>
      <td>1</td>
      <td>1</td>
      <td>8</td>
      <td>3</td>
    </tr>
    <tr>
      <th>25</th>
      <td>3</td>
      <td>5</td>
      <td>1</td>
      <td>1</td>
      <td>9</td>
      <td>4</td>
    </tr>
    <tr>
      <th>26</th>
      <td>3</td>
      <td>6</td>
      <td>1</td>
      <td>1</td>
      <td>11</td>
      <td>5</td>
    </tr>
    <tr>
      <th>27</th>
      <td>3</td>
      <td>7</td>
      <td>1</td>
      <td>1</td>
      <td>18</td>
      <td>6</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="code-11-25">
<h4>Code 11.25<a class="headerlink" href="#code-11-25" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># dat = dict(zip(d_aggregated.columns, d_aggregated.values.T))</span>

<span class="n">tdf</span> <span class="o">=</span> <span class="n">df_to_tensors</span><span class="p">(</span><span class="s2">&quot;Chimpanzee&quot;</span><span class="p">,</span> <span class="n">d_aggregated</span><span class="p">,</span> <span class="p">{</span>
    <span class="s2">&quot;actor_id&quot;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span>
    <span class="s2">&quot;treatment&quot;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span>
    <span class="s2">&quot;left_pulls&quot;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span>
<span class="p">})</span>

<span class="k">def</span> <span class="nf">model_11_6</span><span class="p">(</span><span class="n">actors</span><span class="p">,</span> <span class="n">treatments</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
      <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">7</span><span class="p">))</span>
      <span class="n">beta_treatment</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
              
      <span class="n">term1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">actors</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">term2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">beta_treatment</span><span class="p">,</span> <span class="n">treatments</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
          
      <span class="n">logit</span> <span class="o">=</span> <span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span> 
        
      <span class="n">pulled_left</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span>
          <span class="n">tfd</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span><span class="n">total_count</span><span class="o">=</span><span class="mf">18.</span><span class="p">,</span> <span class="n">logits</span><span class="o">=</span><span class="n">logit</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    
    
<span class="n">jdc_11_6</span> <span class="o">=</span> <span class="n">model_11_6</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">actor_id</span><span class="p">,</span><span class="n">tdf</span><span class="o">.</span><span class="n">treatment</span><span class="p">)</span>
<span class="n">jdc_11_6</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>StructTuple(
  var0=&lt;tf.Tensor: shape=(7,), dtype=float32, numpy=
    array([ 1.6247706 , -1.700309  ,  3.698658  , -1.8563445 , -1.8328525 ,
           -2.004643  ,  0.44146344], dtype=float32)&gt;,
  var1=&lt;tf.Tensor: shape=(4,), dtype=float32, numpy=array([-0.6285849 , -0.0938658 , -0.09778212, -0.6569927 ], dtype=float32)&gt;,
  var2=&lt;tf.Tensor: shape=(28,), dtype=float32, numpy=
    array([10.,  1., 18.,  0.,  0.,  1., 11., 15.,  3., 16.,  2.,  1.,  1.,
           12., 15.,  2., 18.,  4.,  2.,  1., 13., 13.,  0., 18.,  2.,  0.,
            0.,  9.], dtype=float32)&gt;
)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">,</span> <span class="mi">7</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
<span class="p">]</span>

<span class="n">observed_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">left_pulls</span><span class="p">,</span> <span class="p">)</span>

<span class="n">posterior_11_6</span><span class="p">,</span> <span class="n">trace_11_6</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                                <span class="n">jdc_11_6</span><span class="p">,</span> 
                                <span class="n">observed_data</span><span class="o">=</span><span class="n">observed_data</span><span class="p">,</span> 
                                <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                                <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">,</span>
                                <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;beta_treatment&quot;</span><span class="p">])</span>


<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_11_6</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:@custom_gradient grad_fn has &#39;variables&#39; in signature, but no ResourceVariables were used on the forward pass.
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha[0]</th>
      <td>-0.458</td>
      <td>0.335</td>
      <td>-0.980</td>
      <td>0.057</td>
      <td>0.016</td>
      <td>0.013</td>
      <td>435.0</td>
      <td>376.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[1]</th>
      <td>3.803</td>
      <td>0.729</td>
      <td>2.538</td>
      <td>4.797</td>
      <td>0.047</td>
      <td>0.033</td>
      <td>244.0</td>
      <td>282.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[2]</th>
      <td>-0.756</td>
      <td>0.331</td>
      <td>-1.267</td>
      <td>-0.259</td>
      <td>0.016</td>
      <td>0.012</td>
      <td>403.0</td>
      <td>465.0</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[3]</th>
      <td>-0.748</td>
      <td>0.330</td>
      <td>-1.260</td>
      <td>-0.242</td>
      <td>0.021</td>
      <td>0.015</td>
      <td>236.0</td>
      <td>444.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[4]</th>
      <td>-0.457</td>
      <td>0.315</td>
      <td>-0.932</td>
      <td>0.031</td>
      <td>0.015</td>
      <td>0.011</td>
      <td>454.0</td>
      <td>578.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[5]</th>
      <td>0.480</td>
      <td>0.346</td>
      <td>-0.098</td>
      <td>0.976</td>
      <td>0.016</td>
      <td>0.011</td>
      <td>483.0</td>
      <td>327.0</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[6]</th>
      <td>1.955</td>
      <td>0.430</td>
      <td>1.234</td>
      <td>2.576</td>
      <td>0.018</td>
      <td>0.014</td>
      <td>576.0</td>
      <td>438.0</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>beta_treatment[0]</th>
      <td>-0.022</td>
      <td>0.286</td>
      <td>-0.438</td>
      <td>0.451</td>
      <td>0.015</td>
      <td>0.011</td>
      <td>364.0</td>
      <td>419.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>beta_treatment[1]</th>
      <td>0.486</td>
      <td>0.272</td>
      <td>0.036</td>
      <td>0.920</td>
      <td>0.016</td>
      <td>0.011</td>
      <td>279.0</td>
      <td>498.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>beta_treatment[2]</th>
      <td>-0.367</td>
      <td>0.275</td>
      <td>-0.813</td>
      <td>0.060</td>
      <td>0.017</td>
      <td>0.014</td>
      <td>259.0</td>
      <td>386.0</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>beta_treatment[3]</th>
      <td>0.391</td>
      <td>0.272</td>
      <td>-0.006</td>
      <td>0.868</td>
      <td>0.015</td>
      <td>0.011</td>
      <td>278.0</td>
      <td>430.0</td>
      <td>1.00</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="code-11-26-find-a-way-to-get-the-comparison-even-if-different-number-of-obs">
<h4>Code 11.26 (Find a way to get the comparison even if different number of obs)<a class="headerlink" href="#code-11-26-find-a-way-to-get-the-comparison-even-if-different-number-of-obs" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># need to compute likelihood in order to do comparison</span>

<span class="k">def</span> <span class="nf">compute_and_store_log_likelihood_for_model_11_6</span><span class="p">():</span>   
    
    <span class="n">sample_alpha</span> <span class="o">=</span> <span class="n">posterior_11_6</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span>
    <span class="n">sample_beta</span>  <span class="o">=</span> <span class="n">posterior_11_6</span><span class="p">[</span><span class="s2">&quot;beta_treatment&quot;</span><span class="p">]</span>
    
    <span class="n">ds</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">jdc_11_6</span><span class="o">.</span><span class="n">sample_distributions</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span>
        <span class="n">sample_alpha</span><span class="p">,</span> 
        <span class="n">sample_beta</span><span class="p">,</span> 
        <span class="kc">None</span>
    <span class="p">])</span>
    
    <span class="n">log_likelihood_11_6</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">left_pulls</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

    <span class="c1"># we need to insert this in the sampler_stats</span>
    <span class="n">sample_stats_11_6</span> <span class="o">=</span> <span class="n">trace_11_6</span><span class="o">.</span><span class="n">sample_stats</span>

    <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">sample_stats_11_6</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">],</span> <span class="n">sample_stats_11_6</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;draw&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">28</span><span class="p">)]</span>

    <span class="n">sample_stats_11_6</span><span class="p">[</span><span class="s2">&quot;log_likelihood&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
        <span class="n">log_likelihood_11_6</span><span class="p">,</span> 
        <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span>  
        <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">,</span> <span class="s1">&#39;draw&#39;</span><span class="p">,</span> <span class="s1">&#39;log_likelihood_dim_0&#39;</span><span class="p">])</span>
    
<span class="n">compute_and_store_log_likelihood_for_model_11_6</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># in order to use comparison the number of observations should be same</span>
<span class="c1"># which is not the case with m11.4 (504) and m11.6 (28)</span>
<span class="c1"># and hence not able to compare using the arviz method</span>

<span class="kn">import</span> <span class="nn">warnings</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">az</span><span class="o">.</span><span class="n">compare</span><span class="p">({</span><span class="s2">&quot;m11.6&quot;</span><span class="p">:</span> <span class="n">trace_11_6</span><span class="p">,</span> <span class="s2">&quot;m11.4&quot;</span><span class="p">:</span> <span class="n">trace_11_4</span><span class="p">},</span> <span class="n">ic</span><span class="o">=</span><span class="s2">&quot;loo&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/arviz/stats/stats.py:695: UserWarning: Estimated shape parameter of Pareto distribution is greater than 0.7 for one or more samples. You should consider using a more robust model, this is because importance sampling is less likely to work well if the marginal posterior and LOO posterior are very different. This is more likely to happen with a non-robust model and highly influential observations.
  &quot;Estimated shape parameter of Pareto distribution is greater than 0.7 for &quot;
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/ipykernel_launcher.py:10: UserWarning: 
ValueError: The number of observations should be the same across all models
  # Remove the CWD from sys.path while we load stuff.
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-11-27">
<h4>Code 11.27<a class="headerlink" href="#code-11-27" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># deviance of aggregated 6-in-9</span>
<span class="nb">print</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span><span class="n">total_count</span><span class="o">=</span><span class="mf">9.</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
<span class="c1"># deviance of dis-aggregated</span>
<span class="nb">print</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
    <span class="n">tfd</span><span class="o">.</span><span class="n">Bernoulli</span><span class="p">(</span><span class="n">probs</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:@custom_gradient grad_fn has &#39;variables&#39; in signature, but no ResourceVariables were used on the forward pass.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>tf.Tensor(11.7904825, shape=(), dtype=float32)
20.652116775512695
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="aggregated-binomial-graduate-school-admissions">
<h3>11.1.4 Aggregated binomial: Graduate school admissions<a class="headerlink" href="#aggregated-binomial-graduate-school-admissions" title="Permalink to this headline">¶</a></h3>
<div class="section" id="code-11-28">
<h4>Code 11.28<a class="headerlink" href="#code-11-28" title="Permalink to this headline">¶</a></h4>
<p>Evaluate if there is a gender bias in admissions</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">UCBADMIT_DATASET_PATH</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
<span class="n">d</span><span class="p">[</span><span class="s2">&quot;gid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;applicant.gender&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;male&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">d</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>dept</th>
      <th>applicant.gender</th>
      <th>admit</th>
      <th>reject</th>
      <th>applications</th>
      <th>gid</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>A</td>
      <td>male</td>
      <td>512</td>
      <td>313</td>
      <td>825</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>A</td>
      <td>female</td>
      <td>89</td>
      <td>19</td>
      <td>108</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>B</td>
      <td>male</td>
      <td>353</td>
      <td>207</td>
      <td>560</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>B</td>
      <td>female</td>
      <td>17</td>
      <td>8</td>
      <td>25</td>
      <td>1</td>
    </tr>
    <tr>
      <th>5</th>
      <td>C</td>
      <td>male</td>
      <td>120</td>
      <td>205</td>
      <td>325</td>
      <td>0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>C</td>
      <td>female</td>
      <td>202</td>
      <td>391</td>
      <td>593</td>
      <td>1</td>
    </tr>
    <tr>
      <th>7</th>
      <td>D</td>
      <td>male</td>
      <td>138</td>
      <td>279</td>
      <td>417</td>
      <td>0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>D</td>
      <td>female</td>
      <td>131</td>
      <td>244</td>
      <td>375</td>
      <td>1</td>
    </tr>
    <tr>
      <th>9</th>
      <td>E</td>
      <td>male</td>
      <td>53</td>
      <td>138</td>
      <td>191</td>
      <td>0</td>
    </tr>
    <tr>
      <th>10</th>
      <td>E</td>
      <td>female</td>
      <td>94</td>
      <td>299</td>
      <td>393</td>
      <td>1</td>
    </tr>
    <tr>
      <th>11</th>
      <td>F</td>
      <td>male</td>
      <td>22</td>
      <td>351</td>
      <td>373</td>
      <td>0</td>
    </tr>
    <tr>
      <th>12</th>
      <td>F</td>
      <td>female</td>
      <td>24</td>
      <td>317</td>
      <td>341</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>There are 12 rows in the above dataset however they collectively represent 4526 applications. Counting the rows in the data table is not a sensible way to assess sample size</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tdf</span> <span class="o">=</span> <span class="n">df_to_tensors</span><span class="p">(</span><span class="s2">&quot;UCBAdmit&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="p">{</span>
    <span class="s2">&quot;gid&quot;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span>
    <span class="s2">&quot;applications&quot;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="s2">&quot;admit&quot;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-11-29">
<h4>Code 11.29<a class="headerlink" href="#code-11-29" title="Permalink to this headline">¶</a></h4>
<p>We will model the admission as the outcome that depends on the gender</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_11_7</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>      
      <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
      <span class="n">p</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)))</span>        
        
      <span class="n">A</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span><span class="n">total_count</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="n">p</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>             
      
    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    
    
<span class="n">jdc_11_7</span> <span class="o">=</span> <span class="n">model_11_7</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">applications</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span>
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
<span class="p">]</span>

<span class="n">posterior_11_7</span><span class="p">,</span> <span class="n">trace_11_7</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                                <span class="n">jdc_11_7</span><span class="p">,</span> 
                                <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">admit</span><span class="p">,),</span> 
                                <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span>
                                <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                                <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">)</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_11_7</span><span class="p">,</span> <span class="n">round_to</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:@custom_gradient grad_fn has &#39;variables&#39; in signature, but no ResourceVariables were used on the forward pass.
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha[0]</th>
      <td>-0.22</td>
      <td>0.04</td>
      <td>-0.29</td>
      <td>-0.16</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1977.60</td>
      <td>296.89</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[1]</th>
      <td>-0.83</td>
      <td>0.06</td>
      <td>-0.91</td>
      <td>-0.75</td>
      <td>0.02</td>
      <td>0.02</td>
      <td>6.98</td>
      <td>20.00</td>
      <td>1.22</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="code-11-30">
<h4>Code 11.30<a class="headerlink" href="#code-11-30" title="Permalink to this headline">¶</a></h4>
<p>Posterior of males is higher than females, here we compute the contrast</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">diff_a</span> <span class="o">=</span> <span class="n">trace_11_7</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">][:,:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">trace_11_7</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">][:,:,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">trace_11_7</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;diff_a&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">diff_a</span>

<span class="c1"># to add diff_p have to do lot of massaging to make xarray happy !</span>
<span class="n">diff_p</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">trace_11_7</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">][:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">-</span> <span class="n">tf</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">trace_11_7</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">][:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

<span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">trace_11_7</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">],</span> <span class="n">trace_11_7</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;draw&#39;</span><span class="p">]]</span>
<span class="n">trace_11_7</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;diff_p&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">diff_p</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span>  <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">,</span> <span class="s1">&#39;draw&#39;</span><span class="p">])</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_11_7</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha[0]</th>
      <td>-0.220</td>
      <td>0.042</td>
      <td>-0.289</td>
      <td>-0.156</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>1978.0</td>
      <td>297.0</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[1]</th>
      <td>-0.830</td>
      <td>0.056</td>
      <td>-0.910</td>
      <td>-0.749</td>
      <td>0.022</td>
      <td>0.017</td>
      <td>7.0</td>
      <td>20.0</td>
      <td>1.22</td>
    </tr>
    <tr>
      <th>diff_a</th>
      <td>0.610</td>
      <td>0.072</td>
      <td>0.488</td>
      <td>0.705</td>
      <td>0.024</td>
      <td>0.017</td>
      <td>9.0</td>
      <td>35.0</td>
      <td>1.15</td>
    </tr>
    <tr>
      <th>diff_p</th>
      <td>0.141</td>
      <td>0.016</td>
      <td>0.113</td>
      <td>0.163</td>
      <td>0.005</td>
      <td>0.004</td>
      <td>10.0</td>
      <td>42.0</td>
      <td>1.13</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Log odds difference is certainly positive, corresponding to a higher prob of admissions for male applicants.</p>
</div>
<div class="section" id="code-11-31">
<h4>Code 11.31<a class="headerlink" href="#code-11-31" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute the posterior predictive given the posterior parameters</span>

<span class="n">N</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">applications</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">gid</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">gid</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># only picking the first chain</span>
<span class="n">sample_alpha</span> <span class="o">=</span> <span class="n">posterior_11_7</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">:,]</span>

<span class="n">sample_pbar</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">sample_alpha</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)))</span>    

<span class="n">dist</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span><span class="n">total_count</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="n">sample_pbar</span><span class="p">)</span>

<span class="c1"># taking the samples from first chain</span>
<span class="n">predictive_samples</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:5 out of the last 11 calls to &lt;function _random_binomial at 0x7fb1bfd75f80&gt; triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has experimental_relax_shapes=True option that relaxes argument shapes that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">admit_rate</span> <span class="o">=</span> <span class="n">predictive_samples</span> <span class="o">/</span> <span class="n">N</span>

<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">admit_rate</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">admit_rate</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
             <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">elinewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">admit_rate</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;k+&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">admit_rate</span><span class="p">,</span> <span class="mf">94.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;k+&quot;</span><span class="p">)</span>
<span class="c1"># draw lines connecting points from same dept</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">admit</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">d</span><span class="o">.</span><span class="n">applications</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">admit</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">/</span> <span class="n">d</span><span class="o">.</span><span class="n">applications</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">),</span> <span class="s2">&quot;bo-&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">dept</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="n">y1</span> <span class="o">+</span> <span class="n">y2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">),</span>
                 <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;royalblue&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">xticks</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;admit&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;case&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/11_god_spiked_the_integers_108_0.png" src="../_images/11_god_spiked_the_integers_108_0.png" />
</div>
</div>
<p>What above plot shows is that only for departments C &amp; E, there was a lower rate of admissions for females. Now this is not in sync with what we observed earlier where the model was telling that females should expect an overall 14% lower chance of admission.</p>
<p>What is going on ?</p>
<p>Problem here is that male and females do not apply to same departments &amp; departments also vary in their rate of admissions. Females do not apply to A &amp; B that has higher rate of acceptance. Instead they applied to departments that have lower rate (10% of applicants) of acceptance.</p>
</div>
<div class="section" id="code-11-32">
<h4>Code 11.32<a class="headerlink" href="#code-11-32" title="Permalink to this headline">¶</a></h4>
<p>Changing the question to be asked -</p>
<p>Instead of asking -</p>
<p><em>What are the average probabilities of admission for females and males across all departments?</em></p>
<p>we are now going to ask -</p>
<p><em>What is the average difference in probability of admis- sion between females and males within departments?</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># construct 6 unique indexes such that there are 2 entries per index</span>
<span class="n">dept_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">model_11_8</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span> <span class="n">dept_id</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>      
      <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
      <span class="n">delta</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">6</span><span class="p">))</span>
        
      <span class="n">p</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="n">dept_id</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)))</span>
        
      <span class="n">A</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span><span class="n">total_count</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="n">p</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>             
      
    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    
    
<span class="n">jdc_11_8</span> <span class="o">=</span> <span class="n">model_11_8</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">dept_id</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">applications</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
  <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span>
  <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">,</span> <span class="mi">6</span><span class="p">]),</span>
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
<span class="p">]</span>

<span class="n">posterior_11_8</span><span class="p">,</span> <span class="n">trace_11_8</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span><span class="n">jdc_11_8</span><span class="p">,</span> 
                                       <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">admit</span><span class="p">,),</span> 
                                       <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;delta&#39;</span><span class="p">],</span> 
                                       <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                                       <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">,</span>
                                       <span class="n">num_samples</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_11_8</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:5 out of the last 5 calls to &lt;function run_hmc_chain at 0x7fb1bf4a5a70&gt; triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has experimental_relax_shapes=True option that relaxes argument shapes that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha[0]</th>
      <td>-0.470</td>
      <td>0.559</td>
      <td>-1.353</td>
      <td>0.374</td>
      <td>0.161</td>
      <td>0.117</td>
      <td>12.0</td>
      <td>45.0</td>
      <td>1.12</td>
    </tr>
    <tr>
      <th>alpha[1]</th>
      <td>-0.372</td>
      <td>0.557</td>
      <td>-1.271</td>
      <td>0.451</td>
      <td>0.162</td>
      <td>0.117</td>
      <td>12.0</td>
      <td>46.0</td>
      <td>1.12</td>
    </tr>
    <tr>
      <th>delta[0]</th>
      <td>1.050</td>
      <td>0.560</td>
      <td>0.182</td>
      <td>1.922</td>
      <td>0.160</td>
      <td>0.116</td>
      <td>12.0</td>
      <td>48.0</td>
      <td>1.12</td>
    </tr>
    <tr>
      <th>delta[1]</th>
      <td>1.007</td>
      <td>0.565</td>
      <td>0.111</td>
      <td>1.872</td>
      <td>0.160</td>
      <td>0.116</td>
      <td>13.0</td>
      <td>39.0</td>
      <td>1.12</td>
    </tr>
    <tr>
      <th>delta[2]</th>
      <td>-0.208</td>
      <td>0.560</td>
      <td>-1.068</td>
      <td>0.672</td>
      <td>0.161</td>
      <td>0.117</td>
      <td>12.0</td>
      <td>36.0</td>
      <td>1.12</td>
    </tr>
    <tr>
      <th>delta[3]</th>
      <td>-0.241</td>
      <td>0.561</td>
      <td>-1.118</td>
      <td>0.624</td>
      <td>0.163</td>
      <td>0.118</td>
      <td>12.0</td>
      <td>34.0</td>
      <td>1.12</td>
    </tr>
    <tr>
      <th>delta[4]</th>
      <td>-0.686</td>
      <td>0.564</td>
      <td>-1.546</td>
      <td>0.195</td>
      <td>0.165</td>
      <td>0.120</td>
      <td>12.0</td>
      <td>33.0</td>
      <td>1.13</td>
    </tr>
    <tr>
      <th>delta[5]</th>
      <td>-2.243</td>
      <td>0.573</td>
      <td>-3.126</td>
      <td>-1.339</td>
      <td>0.160</td>
      <td>0.116</td>
      <td>13.0</td>
      <td>33.0</td>
      <td>1.12</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="code-11-33">
<h4>Code 11.33<a class="headerlink" href="#code-11-33" title="Permalink to this headline">¶</a></h4>
<p>Computing the contrast</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">diff_a</span> <span class="o">=</span> <span class="n">trace_11_8</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">][:,:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">trace_11_8</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">][:,:,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">diff_p</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">trace_11_8</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">][:,:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">-</span> <span class="n">tf</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">trace_11_8</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">][:,:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

<span class="n">trace_11_8</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;diff_a&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">diff_a</span>

<span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">trace_11_8</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">],</span> <span class="n">trace_11_8</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;draw&#39;</span><span class="p">]]</span>
<span class="n">trace_11_8</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;diff_p&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">diff_p</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span>  <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">,</span> <span class="s1">&#39;draw&#39;</span><span class="p">])</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_11_8</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha[0]</th>
      <td>-0.470</td>
      <td>0.559</td>
      <td>-1.353</td>
      <td>0.374</td>
      <td>0.161</td>
      <td>0.117</td>
      <td>12.0</td>
      <td>45.0</td>
      <td>1.12</td>
    </tr>
    <tr>
      <th>alpha[1]</th>
      <td>-0.372</td>
      <td>0.557</td>
      <td>-1.271</td>
      <td>0.451</td>
      <td>0.162</td>
      <td>0.117</td>
      <td>12.0</td>
      <td>46.0</td>
      <td>1.12</td>
    </tr>
    <tr>
      <th>delta[0]</th>
      <td>1.050</td>
      <td>0.560</td>
      <td>0.182</td>
      <td>1.922</td>
      <td>0.160</td>
      <td>0.116</td>
      <td>12.0</td>
      <td>48.0</td>
      <td>1.12</td>
    </tr>
    <tr>
      <th>delta[1]</th>
      <td>1.007</td>
      <td>0.565</td>
      <td>0.111</td>
      <td>1.872</td>
      <td>0.160</td>
      <td>0.116</td>
      <td>13.0</td>
      <td>39.0</td>
      <td>1.12</td>
    </tr>
    <tr>
      <th>delta[2]</th>
      <td>-0.208</td>
      <td>0.560</td>
      <td>-1.068</td>
      <td>0.672</td>
      <td>0.161</td>
      <td>0.117</td>
      <td>12.0</td>
      <td>36.0</td>
      <td>1.12</td>
    </tr>
    <tr>
      <th>delta[3]</th>
      <td>-0.241</td>
      <td>0.561</td>
      <td>-1.118</td>
      <td>0.624</td>
      <td>0.163</td>
      <td>0.118</td>
      <td>12.0</td>
      <td>34.0</td>
      <td>1.12</td>
    </tr>
    <tr>
      <th>delta[4]</th>
      <td>-0.686</td>
      <td>0.564</td>
      <td>-1.546</td>
      <td>0.195</td>
      <td>0.165</td>
      <td>0.120</td>
      <td>12.0</td>
      <td>33.0</td>
      <td>1.13</td>
    </tr>
    <tr>
      <th>delta[5]</th>
      <td>-2.243</td>
      <td>0.573</td>
      <td>-3.126</td>
      <td>-1.339</td>
      <td>0.160</td>
      <td>0.116</td>
      <td>13.0</td>
      <td>33.0</td>
      <td>1.12</td>
    </tr>
    <tr>
      <th>diff_a</th>
      <td>-0.098</td>
      <td>0.081</td>
      <td>-0.238</td>
      <td>0.020</td>
      <td>0.002</td>
      <td>0.002</td>
      <td>1075.0</td>
      <td>1221.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>diff_p</th>
      <td>-0.022</td>
      <td>0.018</td>
      <td>-0.049</td>
      <td>0.009</td>
      <td>0.001</td>
      <td>0.000</td>
      <td>861.0</td>
      <td>1036.0</td>
      <td>1.00</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="code-11-34">
<h4>Code 11.34<a class="headerlink" href="#code-11-34" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">applications</span><span class="p">[</span><span class="n">dept_id</span> <span class="o">==</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                        <span class="n">d</span><span class="o">.</span><span class="n">applications</span><span class="p">[</span><span class="n">dept_id</span> <span class="o">==</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">))),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
<span class="n">pg</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pg</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;male&quot;</span><span class="p">,</span> <span class="s2">&quot;female&quot;</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">dept</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">pg</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>A</th>
      <th>B</th>
      <th>C</th>
      <th>D</th>
      <th>E</th>
      <th>F</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>male</th>
      <td>0.88</td>
      <td>0.96</td>
      <td>0.35</td>
      <td>0.53</td>
      <td>0.33</td>
      <td>0.52</td>
    </tr>
    <tr>
      <th>female</th>
      <td>0.12</td>
      <td>0.04</td>
      <td>0.65</td>
      <td>0.47</td>
      <td>0.67</td>
      <td>0.48</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Department A receives 88% of its applications from males. Department E receives 33% from males.</p>
</div>
</div>
</div>
<div class="section" id="poisson-regression">
<h2>11.2 Poisson regression<a class="headerlink" href="#poisson-regression" title="Permalink to this headline">¶</a></h2>
<div class="section" id="code-11-35">
<h3>Code 11.35<a class="headerlink" href="#code-11-35" title="Permalink to this headline">¶</a></h3>
<p>Binomial is good when the count is known but quite often it is not the case.</p>
<p>When the count goes extremely high then mean and variance of Binomial starts to become same and this is known as Poisson Distribution</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="mf">1e5</span><span class="p">),))</span>
<span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:6 out of the last 12 calls to &lt;function _random_binomial at 0x7fb1bfd75f80&gt; triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has experimental_relax_shapes=True option that relaxes argument shapes that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(1.00454, 0.9987194)
</pre></div>
</div>
</div>
</div>
<p>Useful for binomial events for which the number of trials N is unknown or uncountably large.</p>
</div>
<div class="section" id="code-11-36">
<h3>Code 11.36<a class="headerlink" href="#code-11-36" title="Permalink to this headline">¶</a></h3>
<p>Counts of unique tool types for 10 historical Oceanic societies</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">KLINE_DATASET_PATH</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
<span class="n">d</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>culture</th>
      <th>population</th>
      <th>contact</th>
      <th>total_tools</th>
      <th>mean_TU</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Malekula</td>
      <td>1100</td>
      <td>low</td>
      <td>13</td>
      <td>3.2</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Tikopia</td>
      <td>1500</td>
      <td>low</td>
      <td>22</td>
      <td>4.7</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Santa Cruz</td>
      <td>3600</td>
      <td>low</td>
      <td>24</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Yap</td>
      <td>4791</td>
      <td>high</td>
      <td>43</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Lau Fiji</td>
      <td>7400</td>
      <td>high</td>
      <td>33</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Trobriand</td>
      <td>8000</td>
      <td>high</td>
      <td>19</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Chuuk</td>
      <td>9200</td>
      <td>high</td>
      <td>40</td>
      <td>3.8</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Manus</td>
      <td>13000</td>
      <td>low</td>
      <td>28</td>
      <td>6.6</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Tonga</td>
      <td>17500</td>
      <td>high</td>
      <td>55</td>
      <td>5.4</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Hawaii</td>
      <td>275000</td>
      <td>low</td>
      <td>71</td>
      <td>6.6</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>To remember - Number of rows in count based models is not same as the sample size</p>
</div>
<div class="section" id="code-11-37">
<h3>Code 11.37<a class="headerlink" href="#code-11-37" title="Permalink to this headline">¶</a></h3>
<p>Here the outcome variable is <strong>total tools</strong></p>
<p>We want to establish a relationship between <strong>log population</strong> and our outcome variable.</p>
<p>We also want to see the interaction between <strong>contact</strong> and <strong>log population</strong></p>
<p>So first and foremost let’s create a column for <strong>log population</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;P&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
<span class="n">d</span><span class="p">[</span><span class="s2">&quot;cid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">contact</span> <span class="o">==</span> <span class="s2">&quot;high&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-11-38">
<h3>Code 11.38<a class="headerlink" href="#code-11-38" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">LogNormal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">10.</span><span class="p">)</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">x</span><span class="p">)));</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/11_god_spiked_the_integers_128_0.png" src="../_images/11_god_spiked_the_integers_128_0.png" />
</div>
</div>
</div>
<div class="section" id="code-11-39">
<h3>Code 11.39<a class="headerlink" href="#code-11-39" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">10.</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mf">1e4</span><span class="p">))</span>
<span class="n">lambda_</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">lambda_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(), dtype=float32, numpy=191385930000.0&gt;
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-11-40">
<h3>Code 11.40<a class="headerlink" href="#code-11-40" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">LogNormal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">x</span><span class="p">)));</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/11_god_spiked_the_integers_132_0.png" src="../_images/11_god_spiked_the_integers_132_0.png" />
</div>
</div>
</div>
<div class="section" id="code-11-41">
<h3>Code 11.41<a class="headerlink" href="#code-11-41" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">10.</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/11_god_spiked_the_integers_134_0.png" src="../_images/11_god_spiked_the_integers_134_0.png" />
</div>
</div>
</div>
<div class="section" id="code-11-42">
<h3>Code 11.42<a class="headerlink" href="#code-11-42" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/11_god_spiked_the_integers_136_0.png" src="../_images/11_god_spiked_the_integers_136_0.png" />
</div>
</div>
</div>
<div class="section" id="code-11-43">
<h3>Code 11.43<a class="headerlink" href="#code-11-43" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">200000</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">lambda_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">x</span><span class="p">),</span> <span class="n">x_seq</span><span class="p">)))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x_seq</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x_seq</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()),</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span>
            <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;log population&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;total tools&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_seq</span> <span class="p">,</span><span class="n">lambda_</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/11_god_spiked_the_integers_138_0.png" src="../_images/11_god_spiked_the_integers_138_0.png" />
</div>
</div>
</div>
<div class="section" id="code-11-44">
<h3>Code 11.44<a class="headerlink" href="#code-11-44" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x_seq</span><span class="p">))</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x_seq</span><span class="p">))</span><span class="o">.</span><span class="n">item</span><span class="p">()),</span>
            <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;population&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;total tools&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x_seq</span><span class="p">),</span> <span class="n">lambda_</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/11_god_spiked_the_integers_140_0.png" src="../_images/11_god_spiked_the_integers_140_0.png" />
</div>
</div>
</div>
<div class="section" id="code-11-45">
<h3>Code 11.45<a class="headerlink" href="#code-11-45" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># dat = dict(T=d.total_tools.values, P=d.P.values, cid=d.cid.values)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># d.total_tools.values</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tdf</span> <span class="o">=</span> <span class="n">df_to_tensors</span><span class="p">(</span><span class="s2">&quot;Kline&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="p">{</span>
    <span class="s2">&quot;total_tools&quot;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="s2">&quot;P&quot;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="s2">&quot;cid&quot;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># intercept only</span>
<span class="k">def</span> <span class="nf">model_11_9</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>      
      <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">lambda_</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">alpha</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
        
      <span class="n">T</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Poisson</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="n">lambda_</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>             
      
    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    
    
<span class="n">jdc_11_9</span> <span class="o">=</span> <span class="n">model_11_9</span><span class="p">()</span>

<span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
   <span class="mf">3.</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">])</span>
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
<span class="p">]</span>

<span class="n">posterior_11_9</span><span class="p">,</span> <span class="n">trace_11_9</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span><span class="n">jdc_11_9</span><span class="p">,</span> 
                                   <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">total_tools</span><span class="p">,),</span> 
                                   <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                                   <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">,</span>
                                   <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:From /opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow_probability/python/distributions/distribution.py:342: calling Poisson.__init__ (from tensorflow_probability.python.distributions.poisson) with interpolate_nondiscrete is deprecated and will be removed after 2021-02-01.
Instructions for updating:
The `interpolate_nondiscrete` flag is deprecated; instead use `force_probs_to_zero_outside_support` (with the opposite sense).
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:6 out of the last 6 calls to &lt;function run_hmc_chain at 0x7fb1bf4a5a70&gt; triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has experimental_relax_shapes=True option that relaxes argument shapes that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># interaction model</span>
<span class="k">def</span> <span class="nf">model_11_10</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="n">P</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>      
      <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
      <span class="n">beta</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
        
      <span class="n">lambda_</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                  <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> \
                  <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">P</span>
              <span class="p">)</span>
                
        
      <span class="n">T</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Poisson</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="n">lambda_</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>             
      
    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    
    
<span class="n">jdc_11_10</span> <span class="o">=</span> <span class="n">model_11_10</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">cid</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">P</span><span class="p">)</span>

<span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
<span class="p">]</span>

<span class="n">posterior_11_10</span><span class="p">,</span> <span class="n">trace_11_10</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span><span class="n">jdc_11_10</span><span class="p">,</span> 
                                <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">total_tools</span><span class="p">,),</span>
                                <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                                <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">,</span>
                                <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-11-46">
<h3>Code 11.46<a class="headerlink" href="#code-11-46" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We need to compute the log likelihood for model_11_9</span>
<span class="c1"># and then store it in the trace_11_9</span>
<span class="c1">#</span>
<span class="c1"># Reason to store it as it is expected by az.compare</span>

<span class="k">def</span> <span class="nf">compute_and_store_log_likelihood_for_model_11_9</span><span class="p">():</span>
    
    <span class="n">sample_alpha</span> <span class="o">=</span> <span class="n">posterior_11_9</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span>
    
    <span class="n">ds</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">jdc_11_9</span><span class="o">.</span><span class="n">sample_distributions</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span>
        <span class="n">sample_alpha</span><span class="p">,</span> 
        <span class="kc">None</span>
    <span class="p">])</span>
    
    <span class="n">log_likelihood_11_9</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">total_tools</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

    <span class="c1"># we need to insert this in the sampler_stats</span>
    <span class="n">sample_stats_11_9</span> <span class="o">=</span> <span class="n">trace_11_9</span><span class="o">.</span><span class="n">sample_stats</span>

    <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">sample_stats_11_9</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">],</span> <span class="n">sample_stats_11_9</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;draw&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>

    <span class="n">sample_stats_11_9</span><span class="p">[</span><span class="s2">&quot;log_likelihood&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
        <span class="n">log_likelihood_11_9</span><span class="p">,</span> 
        <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span>  
        <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">,</span> <span class="s1">&#39;draw&#39;</span><span class="p">,</span> <span class="s1">&#39;log_likelihood_dim_0&#39;</span><span class="p">])</span>
    
<span class="n">compute_and_store_log_likelihood_for_model_11_9</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We need to compute the log likelihood for model_11_10</span>
<span class="c1"># and then store it in the trace_11_10</span>
<span class="c1">#</span>
<span class="c1"># Reason to store it as it is expected by az.compare</span>

<span class="k">def</span> <span class="nf">compute_and_store_log_likelihood_for_model_11_10</span><span class="p">():</span>
    
    <span class="n">sample_alpha</span> <span class="o">=</span> <span class="n">posterior_11_10</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span>
    <span class="n">sample_beta</span> <span class="o">=</span> <span class="n">posterior_11_10</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span>
    
    <span class="n">ds</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">jdc_11_10</span><span class="o">.</span><span class="n">sample_distributions</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span>
        <span class="n">sample_alpha</span><span class="p">,</span> 
        <span class="n">sample_beta</span><span class="p">,</span> 
        <span class="kc">None</span>
    <span class="p">])</span>
    
    <span class="n">log_likelihood_11_10</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">total_tools</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

    <span class="c1"># we need to insert this in the sampler_stats</span>
    <span class="n">sample_stats_11_10</span> <span class="o">=</span> <span class="n">trace_11_10</span><span class="o">.</span><span class="n">sample_stats</span>

    <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">sample_stats_11_10</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">],</span> <span class="n">sample_stats_11_10</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;draw&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>

    <span class="n">sample_stats_11_10</span><span class="p">[</span><span class="s2">&quot;log_likelihood&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
        <span class="n">log_likelihood_11_10</span><span class="p">,</span> 
        <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span>  
        <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">,</span> <span class="s1">&#39;draw&#39;</span><span class="p">,</span> <span class="s1">&#39;log_likelihood_dim_0&#39;</span><span class="p">])</span>

<span class="n">compute_and_store_log_likelihood_for_model_11_10</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">compare</span><span class="p">({</span><span class="s2">&quot;m11.9&quot;</span><span class="p">:</span> <span class="n">trace_11_9</span><span class="p">,</span>
            <span class="s2">&quot;m11.10&quot;</span><span class="p">:</span> <span class="n">trace_11_10</span><span class="p">},</span> <span class="n">ic</span><span class="o">=</span><span class="s2">&quot;loo&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/arviz/stats/stats.py:695: UserWarning: Estimated shape parameter of Pareto distribution is greater than 0.7 for one or more samples. You should consider using a more robust model, this is because importance sampling is less likely to work well if the marginal posterior and LOO posterior are very different. This is more likely to happen with a non-robust model and highly influential observations.
  &quot;Estimated shape parameter of Pareto distribution is greater than 0.7 for &quot;
/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/arviz/stats/stats.py:695: UserWarning: Estimated shape parameter of Pareto distribution is greater than 0.7 for one or more samples. You should consider using a more robust model, this is because importance sampling is less likely to work well if the marginal posterior and LOO posterior are very different. This is more likely to happen with a non-robust model and highly influential observations.
  &quot;Estimated shape parameter of Pareto distribution is greater than 0.7 for &quot;
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>rank</th>
      <th>loo</th>
      <th>p_loo</th>
      <th>d_loo</th>
      <th>weight</th>
      <th>se</th>
      <th>dse</th>
      <th>warning</th>
      <th>loo_scale</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>m11.10</th>
      <td>0</td>
      <td>-42.571274</td>
      <td>6.899319</td>
      <td>0.000000</td>
      <td>0.945424</td>
      <td>6.362159</td>
      <td>0.00000</td>
      <td>True</td>
      <td>log</td>
    </tr>
    <tr>
      <th>m11.9</th>
      <td>1</td>
      <td>-70.365727</td>
      <td>7.786589</td>
      <td>27.794454</td>
      <td>0.054576</td>
      <td>15.796287</td>
      <td>15.67845</td>
      <td>True</td>
      <td>log</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="code-11-47">
<h3>Code 11.47<a class="headerlink" href="#code-11-47" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">k</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">loo</span><span class="p">(</span><span class="n">trace_11_10</span><span class="p">,</span> <span class="n">pointwise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">pareto_k</span><span class="o">.</span><span class="n">values</span>

<span class="n">cex</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">P</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">total_tools</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">40</span> <span class="o">*</span> <span class="n">cex</span><span class="p">,</span>
            <span class="n">edgecolors</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;none&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;b&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">cid</span><span class="p">],</span>
            <span class="n">facecolors</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;none&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;b&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">cid</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;log population (std)&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;total tools&quot;</span><span class="p">,</span>
              <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">75</span><span class="p">))</span>

<span class="c1"># set up the horizontal axis values to compute predictions at</span>
<span class="n">ns</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">P_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">ns</span><span class="p">)</span>


<span class="c1"># only using chain 0</span>
<span class="n">sample_alpha</span> <span class="o">=</span> <span class="n">posterior_11_10</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sample_beta</span> <span class="o">=</span> <span class="n">posterior_11_10</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">predict_and_plot</span><span class="p">(</span><span class="n">cid</span><span class="p">):</span>
    <span class="n">term1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">sample_alpha</span><span class="p">,</span> <span class="p">[</span><span class="n">cid</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">term2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">sample_beta</span><span class="p">,</span> <span class="p">[</span><span class="n">cid</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">P_seq</span>
    <span class="n">lambda_</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span><span class="p">)</span>
    <span class="n">lmu</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">lambda_</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">lci</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">lambda_</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.55</span><span class="p">,</span> <span class="mf">94.5</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">P_seq</span><span class="p">,</span> <span class="n">lmu</span><span class="p">,</span> <span class="s2">&quot;k--&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">P_seq</span><span class="p">,</span> <span class="n">lmu</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">P_seq</span><span class="p">,</span> <span class="n">lci</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lci</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>


<span class="c1"># make predictions when cid = 1 i.e. have low contact</span>
<span class="n">predict_and_plot</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">predict_and_plot</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/arviz/stats/stats.py:695: UserWarning: Estimated shape parameter of Pareto distribution is greater than 0.7 for one or more samples. You should consider using a more robust model, this is because importance sampling is less likely to work well if the marginal posterior and LOO posterior are very different. This is more likely to happen with a non-robust model and highly influential observations.
  &quot;Estimated shape parameter of Pareto distribution is greater than 0.7 for &quot;
</pre></div>
</div>
<img alt="../_images/11_god_spiked_the_integers_152_1.png" src="../_images/11_god_spiked_the_integers_152_1.png" />
</div>
</div>
<p>Open points are low contact societies and closed points are the high contact ones. Dashed curve is the posterior mean for low contact societies.</p>
</div>
<div class="section" id="code-11-48">
<h3>Code 11.48<a class="headerlink" href="#code-11-48" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cex</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">population</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">total_tools</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">40</span> <span class="o">*</span> <span class="n">cex</span><span class="p">,</span>
            <span class="n">edgecolors</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;none&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;b&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">cid</span><span class="p">],</span>
            <span class="n">facecolors</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;none&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;b&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">cid</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;population&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;total tools&quot;</span><span class="p">,</span>
              <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">300000</span><span class="p">),</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">75</span><span class="p">))</span>

<span class="n">ns</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">P_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">ns</span><span class="p">)</span>
<span class="c1"># 1.53 is sd of log(population)</span>
<span class="c1"># 9 is mean of log(population)</span>
<span class="n">pop_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">P_seq</span> <span class="o">*</span> <span class="mf">1.53</span> <span class="o">+</span> <span class="mi">9</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">predict_and_plot</span><span class="p">(</span><span class="n">cid</span><span class="p">):</span>
    <span class="n">term1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">sample_alpha</span><span class="p">,</span> <span class="p">[</span><span class="n">cid</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">term2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">sample_beta</span><span class="p">,</span> <span class="p">[</span><span class="n">cid</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">P_seq</span>
    <span class="n">lambda_</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span><span class="p">)</span>
    <span class="n">lmu</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">lambda_</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">lci</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">lambda_</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.55</span><span class="p">,</span> <span class="mf">94.5</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pop_seq</span><span class="p">,</span> <span class="n">lmu</span><span class="p">,</span> <span class="s2">&quot;k--&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pop_seq</span><span class="p">,</span> <span class="n">lmu</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">pop_seq</span><span class="p">,</span> <span class="n">lci</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lci</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>


<span class="c1"># make predictions when cid = 1 i.e. have low contact</span>
<span class="n">predict_and_plot</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">predict_and_plot</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/11_god_spiked_the_integers_155_0.png" src="../_images/11_god_spiked_the_integers_155_0.png" />
</div>
</div>
</div>
<div class="section" id="code-11-49">
<h3>Code 11.49<a class="headerlink" href="#code-11-49" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tdf</span> <span class="o">=</span> <span class="n">df_to_tensors</span><span class="p">(</span><span class="s2">&quot;Kline&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="p">{</span>
    <span class="s2">&quot;total_tools&quot;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="s2">&quot;population&quot;</span>  <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="s2">&quot;cid&quot;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span>
<span class="p">})</span>

<span class="k">def</span> <span class="nf">model_11_11</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="n">P</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
        <span class="n">g</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="mf">1.0</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="mf">1.0</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
        
        <span class="n">term1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)))</span>
        <span class="n">term2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)))</span> <span class="o">/</span> <span class="n">g</span>
        
        <span class="n">lambda_</span> <span class="o">=</span> <span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span>
        
        <span class="n">T</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Poisson</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="n">lambda_</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>             
      
    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    
        
        
<span class="n">jdc_11_11</span> <span class="o">=</span> <span class="n">model_11_11</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">cid</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">population</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="negative-binomial-gamm-poisson-models">
<h3>11.2.2 Negative binomial (gamm-poisson) models<a class="headerlink" href="#negative-binomial-gamm-poisson-models" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="example-exposure-and-the-offset">
<h3>11.2.3 Example: Exposure and the offset<a class="headerlink" href="#example-exposure-and-the-offset" title="Permalink to this headline">¶</a></h3>
<div class="section" id="code-11-50">
<h4>Code 11.50<a class="headerlink" href="#code-11-50" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_days</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Poisson</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">((</span><span class="n">num_days</span><span class="p">,))</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="code-11-51">
<h2>Code 11.51<a class="headerlink" href="#code-11-51" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_weeks</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">y_new</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Poisson</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">0.5</span> <span class="o">*</span> <span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">((</span><span class="n">num_weeks</span><span class="p">,))</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="code-11-52">
<h3>Code 11.52<a class="headerlink" href="#code-11-52" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">y</span><span class="p">,</span> <span class="n">y_new</span><span class="p">])</span>
<span class="n">exposure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">)])</span>
<span class="n">monastery</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)])</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y_all</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="n">exposure</span><span class="p">,</span> <span class="n">monastery</span><span class="o">=</span><span class="n">monastery</span><span class="p">))</span>

<span class="n">d</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>y</th>
      <th>days</th>
      <th>monastery</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>3.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>1.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>9</th>
      <td>1.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>10</th>
      <td>2.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>11</th>
      <td>4.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>12</th>
      <td>1.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>13</th>
      <td>0.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>14</th>
      <td>2.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>15</th>
      <td>0.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>16</th>
      <td>1.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>17</th>
      <td>0.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>18</th>
      <td>2.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>19</th>
      <td>2.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>20</th>
      <td>0.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>21</th>
      <td>0.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>22</th>
      <td>1.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>23</th>
      <td>2.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>24</th>
      <td>4.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>25</th>
      <td>4.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>26</th>
      <td>4.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>27</th>
      <td>1.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>28</th>
      <td>2.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>29</th>
      <td>1.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>30</th>
      <td>5.0</td>
      <td>7</td>
      <td>1</td>
    </tr>
    <tr>
      <th>31</th>
      <td>3.0</td>
      <td>7</td>
      <td>1</td>
    </tr>
    <tr>
      <th>32</th>
      <td>3.0</td>
      <td>7</td>
      <td>1</td>
    </tr>
    <tr>
      <th>33</th>
      <td>4.0</td>
      <td>7</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="code-11-53">
<h3>Code 11.53<a class="headerlink" href="#code-11-53" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute the offset</span>
<span class="n">d</span><span class="p">[</span><span class="s2">&quot;log_days&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">days</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>

<span class="n">tdf</span> <span class="o">=</span> <span class="n">df_to_tensors</span><span class="p">(</span><span class="s2">&quot;Monastry&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="p">{</span>
    <span class="s2">&quot;log_days&quot;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="s2">&quot;monastery&quot;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="s2">&quot;y&quot;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span>
<span class="p">})</span>

<span class="k">def</span> <span class="nf">model_11_12</span><span class="p">(</span><span class="n">log_days</span><span class="p">,</span> <span class="n">monastery</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
        <span class="n">a</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">b</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        
        <span class="n">lambda_</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_days</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">monastery</span><span class="p">)</span>
        
        <span class="n">T</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Poisson</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="n">lambda_</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  
    
<span class="n">jdc_11_12</span> <span class="o">=</span> <span class="n">model_11_12</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">log_days</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">monastery</span><span class="p">)</span>

<span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">])</span>
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
<span class="p">]</span>


<span class="n">posterior_11_12</span><span class="p">,</span> <span class="n">trace_11_12</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                                <span class="n">jdc_11_12</span><span class="p">,</span> 
                                <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">y</span><span class="p">,),</span> 
                                <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                                <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">,</span>
                                <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;beta&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-11-54">
<h3>Code 11.54<a class="headerlink" href="#code-11-54" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># using only the first chain</span>
<span class="n">sample_alpha</span> <span class="o">=</span> <span class="n">posterior_11_12</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">:,]</span>
<span class="n">sample_beta</span> <span class="o">=</span> <span class="n">posterior_11_12</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">:,]</span>

<span class="n">lambda_old</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">sample_alpha</span><span class="p">)</span>
<span class="n">lambda_new</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">sample_alpha</span> <span class="o">+</span> <span class="n">sample_beta</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">az</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span>
    <span class="s1">&#39;lambda_old&#39;</span> <span class="p">:</span> <span class="n">lambda_old</span><span class="p">,</span>
    <span class="s1">&#39;lambda_new&#39;</span> <span class="p">:</span> <span class="n">lambda_new</span>
<span class="p">}),</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>lambda_old</th>
      <td>1.189</td>
      <td>0.199</td>
      <td>0.901</td>
      <td>1.491</td>
      <td>0.080</td>
      <td>0.060</td>
      <td>6.0</td>
      <td>28.0</td>
      <td>1.23</td>
    </tr>
    <tr>
      <th>lambda_new</th>
      <td>0.513</td>
      <td>0.137</td>
      <td>0.285</td>
      <td>0.704</td>
      <td>0.042</td>
      <td>0.031</td>
      <td>11.0</td>
      <td>31.0</td>
      <td>1.14</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
</div>
<div class="section" id="multinomial-and-categorical-models">
<h2>11.3 Multinomial and categorical models<a class="headerlink" href="#multinomial-and-categorical-models" title="Permalink to this headline">¶</a></h2>
<div class="section" id="predictors-matched-to-outcomes">
<h3>11.3.1 Predictors matched to outcomes<a class="headerlink" href="#predictors-matched-to-outcomes" title="Permalink to this headline">¶</a></h3>
<div class="section" id="code-11-55">
<h4>Code 11.55<a class="headerlink" href="#code-11-55" title="Permalink to this headline">¶</a></h4>
<p>Here we simulate career choice from three different careers, each with its own income trait. These traits are used to assign a score to each type of event. Then when the model is fit to the data, one of these scores is held constant, and the other two scores are estimated, using the known income traits</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># simulate career choices among 500 individuals</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">500</span>  <span class="c1"># number of individuals</span>
<span class="n">income</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>  <span class="c1"># expected income of each career</span>
<span class="n">score</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">income</span>  <span class="c1"># scores for each career, based on income</span>

<span class="c1"># next line converts scores to probabilities</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

<span class="c1"># now simulate choice</span>
<span class="c1"># outcome career holds event type values, not counts</span>
<span class="n">career</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>  <span class="c1"># empty vector of choices for each individual</span>

<span class="c1"># sample chosen career for each individual</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="n">career</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">probs</span><span class="o">=</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
    
<span class="n">career</span> <span class="o">=</span> <span class="n">career</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-11-56">
<h4>Code 11.56<a class="headerlink" href="#code-11-56" title="Permalink to this headline">¶</a></h4>
<p>Categorical likelihood is a multinomial logistic regression distribution.</p>
<p>Each possible career will gets its own linear model with its own features.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_11_13</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">career_income</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;==== start&quot;</span><span class="p">)</span>
        <span class="c1"># intercepts</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="n">K</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
        <span class="c1"># association of income with choice</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;alpja&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;beta&quot;</span><span class="p">,</span> <span class="n">beta</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        
        <span class="n">s_1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">career_income</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">s_2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">career_income</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">s_3</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">s_1</span><span class="p">)</span>  <span class="c1"># pivot</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;s1&quot;</span><span class="p">,</span><span class="n">s_1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;s2&quot;</span><span class="p">,</span> <span class="n">s_2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        
        <span class="n">ts</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">s_1</span><span class="p">,</span> <span class="n">s_2</span><span class="p">,</span> <span class="n">s_3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">p</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        
        <span class="n">p_p</span> <span class="o">=</span> <span class="n">p</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;==== end&quot;</span><span class="p">)</span>
        
        <span class="n">career</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">probs</span><span class="o">=</span><span class="n">p_p</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-11-57-todo-not-able-to-make-it-work-with-2-chains">
<h4>Code 11.57 (TODO - not able to make it work with 2 chains)<a class="headerlink" href="#code-11-57-todo-not-able-to-make-it-work-with-2-chains" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jdc_11_13</span> <span class="o">=</span> <span class="n">model_11_13</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">income</span><span class="p">)</span>

<span class="n">jdc_11_13</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>==== start
alpja (2,)
beta (1,)
s1 (1,)
s2 (1,)
p (1, 3)
==== end
==== start
alpja (2, 2)
beta (2, 1)
s1 (2, 1)
s2 (2, 1)
p (2, 3, 1)
==== end
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>StructTuple(
  var0=&lt;tf.Tensor: shape=(2, 2), dtype=float32, numpy=
    array([[-1.2697016 ,  0.91661775],
           [-0.7720224 , -0.33841774]], dtype=float32)&gt;,
  var1=&lt;tf.Tensor: shape=(2, 1), dtype=float32, numpy=
    array([[0.22933103],
           [0.8214222 ]], dtype=float32)&gt;,
  var2=&lt;tf.Tensor: shape=(2, 3), dtype=int32, numpy=
    array([[0, 0, 0],
           [0, 0, 0]], dtype=int32)&gt;
)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NUMBER_OF_CHAINS_11_13</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS_11_13</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS_11_13</span><span class="p">])</span>
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
<span class="p">]</span>

<span class="c1"># Not working !</span>

<span class="c1"># posterior_11_13, trace_11_13 = sample_posterior(jdc_11_13, </span>
<span class="c1">#                                     observed_data=(career,), </span>
<span class="c1">#                                     init_state=init_state,</span>
<span class="c1">#                                     bijectors=bijectors,</span>
<span class="c1">#                                     params=[&quot;alpha&quot;, &quot;beta&quot;])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># az.summary(trace_11_13)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="multinomial-in-disguise-as-poisson">
<h3>11.3.3 Multinomial in disguise as Poisson<a class="headerlink" href="#multinomial-in-disguise-as-poisson" title="Permalink to this headline">¶</a></h3>
<div class="section" id="code-11-60">
<h4>Code 11.60<a class="headerlink" href="#code-11-60" title="Permalink to this headline">¶</a></h4>
<p>Multinomial in disguise as Poisson. The author shows a technique here on how to fit a multinomial/categorical model as a series of Poisson Likelihoods.</p>
<p>It is computationally easier to use Poisson rather than multinomial likelihoods</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">UCBADMIT_DATASET_PATH</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>

<span class="n">d</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>dept</th>
      <th>applicant.gender</th>
      <th>admit</th>
      <th>reject</th>
      <th>applications</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>A</td>
      <td>male</td>
      <td>512</td>
      <td>313</td>
      <td>825</td>
    </tr>
    <tr>
      <th>2</th>
      <td>A</td>
      <td>female</td>
      <td>89</td>
      <td>19</td>
      <td>108</td>
    </tr>
    <tr>
      <th>3</th>
      <td>B</td>
      <td>male</td>
      <td>353</td>
      <td>207</td>
      <td>560</td>
    </tr>
    <tr>
      <th>4</th>
      <td>B</td>
      <td>female</td>
      <td>17</td>
      <td>8</td>
      <td>25</td>
    </tr>
    <tr>
      <th>5</th>
      <td>C</td>
      <td>male</td>
      <td>120</td>
      <td>205</td>
      <td>325</td>
    </tr>
    <tr>
      <th>6</th>
      <td>C</td>
      <td>female</td>
      <td>202</td>
      <td>391</td>
      <td>593</td>
    </tr>
    <tr>
      <th>7</th>
      <td>D</td>
      <td>male</td>
      <td>138</td>
      <td>279</td>
      <td>417</td>
    </tr>
    <tr>
      <th>8</th>
      <td>D</td>
      <td>female</td>
      <td>131</td>
      <td>244</td>
      <td>375</td>
    </tr>
    <tr>
      <th>9</th>
      <td>E</td>
      <td>male</td>
      <td>53</td>
      <td>138</td>
      <td>191</td>
    </tr>
    <tr>
      <th>10</th>
      <td>E</td>
      <td>female</td>
      <td>94</td>
      <td>299</td>
      <td>393</td>
    </tr>
    <tr>
      <th>11</th>
      <td>F</td>
      <td>male</td>
      <td>22</td>
      <td>351</td>
      <td>373</td>
    </tr>
    <tr>
      <th>12</th>
      <td>F</td>
      <td>female</td>
      <td>24</td>
      <td>317</td>
      <td>341</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tdf</span> <span class="o">=</span> <span class="n">df_to_tensors</span><span class="p">(</span><span class="s2">&quot;UCBAdmit&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="p">{</span>    
    <span class="s2">&quot;applications&quot;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
    <span class="s2">&quot;admit&quot;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> 
    <span class="s2">&quot;reject&quot;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-11-61">
<h4>Code 11.61<a class="headerlink" href="#code-11-61" title="Permalink to this headline">¶</a></h4>
<p>Using Poisson regression to model rate of admission &amp; rate of rejection</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_binomial</span><span class="p">(</span><span class="n">applications</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
        <span class="n">a</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">logit</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        
        <span class="n">T</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span><span class="n">total_count</span><span class="o">=</span><span class="n">applications</span><span class="p">,</span> <span class="n">logits</span><span class="o">=</span><span class="n">logit</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  
    
<span class="n">jdc_model_binom</span> <span class="o">=</span> <span class="n">model_binomial</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">applications</span><span class="p">)</span>

<span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">])</span>
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
<span class="p">]</span>

<span class="n">observed_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">admit</span><span class="p">,)</span>

<span class="n">posterior_model_binom</span><span class="p">,</span> <span class="n">trace_model_binom</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                                            <span class="n">jdc_model_binom</span><span class="p">,</span> 
                                            <span class="n">observed_data</span><span class="o">=</span><span class="n">observed_data</span><span class="p">,</span> 
                                            <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                                            <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">,</span>
                                            <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># d[&quot;rej&quot;] = d.reject</span>

<span class="k">def</span> <span class="nf">model_pois</span><span class="p">(</span><span class="n">applications</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
        <span class="n">a</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">lambda1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">lambda2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
        
        <span class="n">A</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span>
            <span class="n">tfd</span><span class="o">.</span><span class="n">Poisson</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="n">lambda1</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>        
        
        <span class="n">R</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span>
            <span class="n">tfd</span><span class="o">.</span><span class="n">Poisson</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="n">lambda2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>        
        
    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
    
<span class="n">jdc_model_pois</span> <span class="o">=</span> <span class="n">model_pois</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">applications</span><span class="p">)</span>

<span class="n">jdc_model_pois</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
<span class="p">]</span>


<span class="n">observed_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">admit</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">reject</span><span class="p">)</span>

<span class="n">posterior_model_pois</span><span class="p">,</span> <span class="n">trace_model_pois</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                                                <span class="n">jdc_model_pois</span><span class="p">,</span> 
                                                <span class="n">observed_data</span><span class="o">=</span><span class="n">observed_data</span><span class="p">,</span> 
                                                <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                                                <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">,</span>
                                                <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:5 out of the last 7 calls to &lt;function random_poisson at 0x7fb1bfa27cb0&gt; triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has experimental_relax_shapes=True option that relaxes argument shapes that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-11-62">
<h4>Code 11.62<a class="headerlink" href="#code-11-62" title="Permalink to this headline">¶</a></h4>
<p>Inferred binomial probability of admission across the entire dataset</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">posterior_model_pois</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(), dtype=float32, numpy=0.99462116&gt;
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-11-63">
<h4>Code 11.63<a class="headerlink" href="#code-11-63" title="Permalink to this headline">¶</a></h4>
<p>Inplied Poisson probability</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">k</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">posterior_model_pois</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">a1</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">a2</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">a2</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(), dtype=float32, numpy=0.38803053&gt;
</pre></div>
</div>
</div>
</div>
<p>This is same as that of binomial model</p>
</div>
</div>
</div>
<div class="section" id="censoring-and-survival">
<h2>11.4 Censoring and survival<a class="headerlink" href="#censoring-and-survival" title="Permalink to this headline">¶</a></h2>
<div class="section" id="code-11-64">
<h3>Code 11.64<a class="headerlink" href="#code-11-64" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="mf">1e5</span><span class="p">),</span> <span class="mi">2</span><span class="p">)),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">x5</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="mf">1e5</span><span class="p">),</span> <span class="mi">5</span><span class="p">)),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="n">x2</span><span class="p">,</span><span class="n">x5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(array([14.22732  , 73.56117  , 33.700947 , ...,  1.9458134, 33.47008  ,
        46.418575 ], dtype=float32),
 array([ 6.1186657, 28.1449   , 57.365204 , ..., 20.468306 , 11.636536 ,
        40.718983 ], dtype=float32))
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-11-65">
<h3>Code 11.65<a class="headerlink" href="#code-11-65" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">M</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="mf">1e5</span><span class="p">),</span> <span class="n">N</span><span class="p">)))[:,</span> <span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-11-66-11-69-todo">
<h3>Code 11.66  - 11.69 (TODO)<a class="headerlink" href="#code-11-66-11-69-todo" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">AUSTIN_CATS_DATASET_PATH</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>

<span class="n">d</span><span class="p">[</span><span class="s2">&quot;adopt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">out_event</span> <span class="o">==</span> <span class="s2">&quot;Adoption&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">dat</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">days_to_event</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">days_to_event</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
           <span class="n">color_id</span><span class="o">=</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">color</span> <span class="o">!=</span> <span class="s2">&quot;Black&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
           <span class="n">adopted</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">adopt</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="10_big_entropy_and_the_generalized_linear_model.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Chapter 10 - Big Entropy and The Generalized Linear Model</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="12_monsters_and_mixtures.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Chapter 12 - Monsters and Mixtures</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Richard McElreath<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>