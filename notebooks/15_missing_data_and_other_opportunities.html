
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chapter 15 - Missing Data and Other Opportunities &#8212; Statistical Rethinking (2nd Edition)</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="canonical" href="https://ksachdeva.github.io/rethinking-tensorflow-probability/notebooks/15_missing_data_and_other_opportunities.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Chapter 16 - Generalized Linear Madness" href="16_generalized_linear_madness.html" />
    <link rel="prev" title="Chapter 14 - Adventures in Covariance" href="14_adventures_in_covariance.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Statistical Rethinking (2nd Edition)</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../README.html">
   Statistical Rethinking (2nd Edition) with Tensorflow Probability
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="00_preface.html">
   Preface
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="01_the_golem_of_prague.html">
   Chapter 1 The Gloem of Prague
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02_small_worlds_and_large_worlds.html">
   Chapter 2 - Small Worlds and Large Worlds
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03_sampling_the_imaginary.html">
   Chapter 3 - Sampling the Imaginary
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="04_geocentric_models.html">
   Chapter 4 - Geocentric Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="05_the_many_variables_and_the_spurious_waffles.html">
   Chapter 5 - The Many Variables &amp; The Spurious Waffles
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="06_the_haunted_dag_and_the_causal_terror.html">
   Chapter 6 - The Haunted DAG and The Causal Terror
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="07_ulysses_compass.html">
   Chapter 7 - Ulysses’ Compass
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="08_conditional_manatees.html">
   Chapter 8 - Conditional Manatees
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="09_markov_chain_monte_carlo.html">
   Chapter 9 - Markov Chain Monte Carlo
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="10_big_entropy_and_the_generalized_linear_model.html">
   Chapter 10 - Big Entropy and The Generalized Linear Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="11_god_spiked_the_integers.html">
   Chapter 11 - God Spiked the Integers
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="12_monsters_and_mixtures.html">
   Chapter 12 - Monsters and Mixtures
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="13_models_with_memory.html">
   Chapter 13 - Models with Memory
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="14_adventures_in_covariance.html">
   Chapter 14 - Adventures in Covariance
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Chapter 15 - Missing Data and Other Opportunities
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="16_generalized_linear_madness.html">
   Chapter 16 - Generalized Linear Madness
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="17_horoscopes.html">
   Chapter 17 - Horoscopes
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/notebooks/15_missing_data_and_other_opportunities.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/ksachdeva/rethinking-tensorflow-probability"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/ksachdeva/rethinking-tensorflow-probability/issues/new?title=Issue%20on%20page%20%2Fnotebooks/15_missing_data_and_other_opportunities.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/ksachdeva/rethinking-tensorflow-probability/master?urlpath=tree/notebooks/15_missing_data_and_other_opportunities.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Chapter 15 - Missing Data and Other Opportunities
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#imports-and-utility-functions">
     Imports and utility functions
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#tensorflow-mcmc-sampling-helpers">
     Tensorflow MCMC Sampling helpers
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dataset-urls-utils">
     Dataset URLs &amp; Utils
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-15-1">
     Code 15.1
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#measurement-error">
     15.1 Measurement error
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-15-2">
       Code 15.2
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#error-on-the-outcome">
       15.1.1 Error on the outcome
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-15-3">
         Code 15.3
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-15-4">
         Code 15.4
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-15-5">
         Code 15.5
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-15-6">
         Code 15.6
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-15-7">
         Code 15.7
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#missing-data">
     15.2 Missing data
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#dag-ate-my-homework">
       15.2.1 DAG ate my homework
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-15-8">
         Code 15.8
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-15-9">
         Code 15.9
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-15-10">
         Code 15.10
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-15-11">
         Code 15.11
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-15-12">
         Code 15.12
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-15-13">
         Code 15.13
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-15-14">
         Code 15.14
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-15-15">
         Code 15.15
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#categorical-errors-and-discrete-absences-todo">
     15.3 Categorical errors and discrete absences (TODO)
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Chapter 15 - Missing Data and Other Opportunities</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Chapter 15 - Missing Data and Other Opportunities
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#imports-and-utility-functions">
     Imports and utility functions
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#tensorflow-mcmc-sampling-helpers">
     Tensorflow MCMC Sampling helpers
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dataset-urls-utils">
     Dataset URLs &amp; Utils
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-15-1">
     Code 15.1
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#measurement-error">
     15.1 Measurement error
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-15-2">
       Code 15.2
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#error-on-the-outcome">
       15.1.1 Error on the outcome
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-15-3">
         Code 15.3
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-15-4">
         Code 15.4
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-15-5">
         Code 15.5
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-15-6">
         Code 15.6
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-15-7">
         Code 15.7
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#missing-data">
     15.2 Missing data
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#dag-ate-my-homework">
       15.2.1 DAG ate my homework
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-15-8">
         Code 15.8
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-15-9">
         Code 15.9
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-15-10">
         Code 15.10
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-15-11">
         Code 15.11
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-15-12">
         Code 15.12
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-15-13">
         Code 15.13
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-15-14">
         Code 15.14
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-15-15">
         Code 15.15
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#categorical-errors-and-discrete-absences-todo">
     15.3 Categorical errors and discrete absences (TODO)
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <p><a class="reference external" href="https://colab.research.google.com/github/ksachdeva/rethinking-tensorflow-probability/blob/master/notebooks/15_missing_data_and_other_opportunities.ipynb"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg" /></a></p>
<div class="tex2jax_ignore mathjax_ignore section" id="chapter-15-missing-data-and-other-opportunities">
<h1>Chapter 15 - Missing Data and Other Opportunities<a class="headerlink" href="#chapter-15-missing-data-and-other-opportunities" title="Permalink to this headline">¶</a></h1>
<div class="section" id="imports-and-utility-functions">
<h2>Imports and utility functions<a class="headerlink" href="#imports-and-utility-functions" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Install packages that are not installed in colab</span>
<span class="k">try</span><span class="p">:</span>
  <span class="kn">import</span> <span class="nn">google.colab</span>
  <span class="n">IN_COLAB</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span><span class="p">:</span>
  <span class="n">IN_COLAB</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">if</span> <span class="n">IN_COLAB</span><span class="p">:</span>
    <span class="o">!</span>pip install -q watermark
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> watermark
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Core</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">arviz</span> <span class="k">as</span> <span class="nn">az</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">tensorflow_probability</span> <span class="k">as</span> <span class="nn">tfp</span>

<span class="c1"># visualization </span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># aliases</span>
<span class="n">tfd</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">distributions</span>
<span class="n">tfb</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">bijectors</span>
<span class="n">Root</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="o">.</span><span class="n">Root</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-01-17 22:46:25.106937: W tensorflow/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library &#39;libcudart.so.11.0&#39;; dlerror: libcudart.so.11.0: cannot open shared object file: No such file or directory
2022-01-17 22:46:25.106970: I tensorflow/stream_executor/cuda/cudart_stub.cc:29] Ignore above cudart dlerror if you do not have a GPU set up on your machine.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">watermark</span> -p numpy,tensorflow,tensorflow_probability,arviz,scipy,pandas
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>numpy                 : 1.21.5
tensorflow            : 2.7.0
tensorflow_probability: 0.15.0
arviz                 : 0.11.4
scipy                 : 1.7.3
pandas                : 1.3.5
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># config of various plotting libraries</span>
<span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="tensorflow-mcmc-sampling-helpers">
<h2>Tensorflow MCMC Sampling helpers<a class="headerlink" href="#tensorflow-mcmc-sampling-helpers" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">USE_XLA</span> <span class="o">=</span> <span class="kc">False</span>              <span class="c1">#@param</span>
<span class="n">NUMBER_OF_CHAINS</span>  <span class="o">=</span> <span class="mi">2</span>        <span class="c1">#@param </span>
<span class="n">NUMBER_OF_BURNIN</span>  <span class="o">=</span> <span class="mi">500</span>      <span class="c1">#@param</span>
<span class="n">NUMBER_OF_SAMPLES</span> <span class="o">=</span> <span class="mi">500</span>      <span class="c1">#@param</span>
<span class="n">NUMBER_OF_LEAPFROG_STEPS</span> <span class="o">=</span> <span class="mi">4</span> <span class="c1">#@param</span>

<span class="k">def</span> <span class="nf">_trace_to_arviz</span><span class="p">(</span><span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">sample_stats</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">observed_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">prior_predictive</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">posterior_predictive</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">trace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                 <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">trace</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="n">sample_stats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sample_stats</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">sample_stats</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sample_stats</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="n">prior_predictive</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prior_predictive</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">prior_predictive</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">prior_predictive</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">if</span> <span class="n">posterior_predictive</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">posterior_predictive</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">az</span><span class="o">.</span><span class="n">InferenceData</span><span class="p">)</span> <span class="ow">and</span> <span class="n">inplace</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">trace</span> <span class="o">+</span> <span class="n">az</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">posterior_predictive</span><span class="o">=</span><span class="n">posterior_predictive</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">az</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
        <span class="n">posterior</span><span class="o">=</span><span class="n">trace</span><span class="p">,</span>
        <span class="n">sample_stats</span><span class="o">=</span><span class="n">sample_stats</span><span class="p">,</span>
        <span class="n">prior_predictive</span><span class="o">=</span><span class="n">prior_predictive</span><span class="p">,</span>
        <span class="n">posterior_predictive</span><span class="o">=</span><span class="n">posterior_predictive</span><span class="p">,</span>
        <span class="n">observed_data</span><span class="o">=</span><span class="n">observed_data</span><span class="p">,</span>
    <span class="p">)</span>

<span class="nd">@tf</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="n">autograph</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">experimental_compile</span><span class="o">=</span><span class="n">USE_XLA</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">run_hmc_chain</span><span class="p">(</span><span class="n">init_state</span><span class="p">,</span>
              <span class="n">bijectors</span><span class="p">,</span> 
              <span class="n">step_size</span><span class="p">,</span> 
              <span class="n">target_log_prob_fn</span><span class="p">,</span> 
              <span class="n">num_leapfrog_steps</span><span class="o">=</span><span class="n">NUMBER_OF_LEAPFROG_STEPS</span><span class="p">,</span>
              <span class="n">num_samples</span><span class="o">=</span><span class="n">NUMBER_OF_SAMPLES</span><span class="p">,</span>
              <span class="n">burnin</span><span class="o">=</span><span class="n">NUMBER_OF_BURNIN</span><span class="p">,</span>
              <span class="p">):</span>    

    <span class="k">def</span> <span class="nf">_trace_fn_transitioned</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">pkr</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">pkr</span><span class="o">.</span><span class="n">inner_results</span><span class="o">.</span><span class="n">inner_results</span><span class="o">.</span><span class="n">log_accept_ratio</span>
        <span class="p">)</span>

    <span class="n">hmc_kernel</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">mcmc</span><span class="o">.</span><span class="n">HamiltonianMonteCarlo</span><span class="p">(</span>
                    <span class="n">target_log_prob_fn</span><span class="p">,</span>
                    <span class="n">num_leapfrog_steps</span><span class="o">=</span><span class="n">num_leapfrog_steps</span><span class="p">,</span>
                    <span class="n">step_size</span><span class="o">=</span><span class="n">step_size</span><span class="p">)</span>         

    <span class="n">inner_kernel</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">mcmc</span><span class="o">.</span><span class="n">TransformedTransitionKernel</span><span class="p">(</span>
        <span class="n">inner_kernel</span><span class="o">=</span><span class="n">hmc_kernel</span><span class="p">,</span>
        <span class="n">bijector</span><span class="o">=</span><span class="n">bijectors</span><span class="p">)</span>       

    <span class="n">kernel</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">mcmc</span><span class="o">.</span><span class="n">SimpleStepSizeAdaptation</span><span class="p">(</span>
        <span class="n">inner_kernel</span><span class="o">=</span><span class="n">inner_kernel</span><span class="p">,</span>
        <span class="n">target_accept_prob</span><span class="o">=</span><span class="mf">.8</span><span class="p">,</span>
        <span class="n">num_adaptation_steps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.8</span><span class="o">*</span><span class="n">burnin</span><span class="p">),</span>
        <span class="n">log_accept_prob_getter_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">pkr</span><span class="p">:</span> <span class="n">pkr</span><span class="o">.</span><span class="n">inner_results</span><span class="o">.</span><span class="n">log_accept_ratio</span>
    <span class="p">)</span>    

    <span class="n">results</span><span class="p">,</span> <span class="n">sampler_stat</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">mcmc</span><span class="o">.</span><span class="n">sample_chain</span><span class="p">(</span>
        <span class="n">num_results</span><span class="o">=</span><span class="n">num_samples</span><span class="p">,</span>
        <span class="n">num_burnin_steps</span><span class="o">=</span><span class="n">burnin</span><span class="p">,</span>
        <span class="n">current_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
        <span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span>
        <span class="n">trace_fn</span><span class="o">=</span><span class="n">_trace_fn_transitioned</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="n">sampler_stat</span>    

<span class="k">def</span> <span class="nf">sample_posterior</span><span class="p">(</span><span class="n">jdc</span><span class="p">,</span> 
              <span class="n">observed_data</span><span class="p">,</span> 
              <span class="n">params</span><span class="p">,</span> 
              <span class="n">init_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
              <span class="n">bijectors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
              <span class="n">step_size</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
              <span class="n">num_chains</span><span class="o">=</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">,</span>                  
              <span class="n">num_samples</span><span class="o">=</span><span class="n">NUMBER_OF_SAMPLES</span><span class="p">,</span> 
              <span class="n">burnin</span><span class="o">=</span><span class="n">NUMBER_OF_BURNIN</span><span class="p">):</span>
        
    <span class="k">if</span> <span class="n">init_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">init_state</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">jdc</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">bijectors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span><span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">init_state</span><span class="p">]</span>

    <span class="n">target_log_prob_fn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">x</span><span class="p">:</span> <span class="n">jdc</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">observed_data</span><span class="p">)</span>  

    <span class="n">results</span><span class="p">,</span> <span class="n">sample_stats</span> <span class="o">=</span> <span class="n">run_hmc_chain</span><span class="p">(</span><span class="n">init_state</span><span class="p">,</span>
                                  <span class="n">bijectors</span><span class="p">,</span>
                                  <span class="n">step_size</span><span class="o">=</span><span class="n">step_size</span><span class="p">,</span>
                                  <span class="n">target_log_prob_fn</span><span class="o">=</span><span class="n">target_log_prob_fn</span><span class="p">,</span>                                      
                                  <span class="n">num_samples</span><span class="o">=</span><span class="n">num_samples</span><span class="p">,</span> 
                                  <span class="n">burnin</span><span class="o">=</span><span class="n">burnin</span><span class="p">)</span>

    <span class="n">stat_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mean_tree_accept&#39;</span><span class="p">]</span>
    <span class="n">sampler_stats</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">stat_names</span><span class="p">,</span> <span class="p">[</span><span class="n">sample_stats</span><span class="p">]))</span>      
        
    <span class="n">transposed_results</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">transposed_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">transposed_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">transposed_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> 
        
        <span class="n">transposed_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">transposed_shape</span><span class="p">))</span>

    <span class="n">posterior</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">transposed_results</span><span class="p">))</span>        

    <span class="n">az_trace</span> <span class="o">=</span> <span class="n">_trace_to_arviz</span><span class="p">(</span><span class="n">trace</span><span class="o">=</span><span class="n">posterior</span><span class="p">,</span> 
                           <span class="n">sample_stats</span><span class="o">=</span><span class="n">sampler_stats</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">posterior</span><span class="p">,</span> <span class="n">az_trace</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="dataset-urls-utils">
<h2>Dataset URLs &amp; Utils<a class="headerlink" href="#dataset-urls-utils" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># You could change base url to local dir or a remoate raw github content</span>
<span class="n">_BASE_URL</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/rmcelreath/rethinking/master/data&quot;</span>

<span class="n">WAFFLE_DIVORCE_DATASET_PATH</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_BASE_URL</span><span class="si">}</span><span class="s2">/WaffleDivorce.csv&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># A utility method to convert data (columns) from pandas dataframe</span>
<span class="c1"># into tensors with appropriate type</span>
<span class="k">def</span> <span class="nf">df_to_tensors</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">default_type</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; name : Name of the dataset</span>
<span class="sd">        df : pandas dataframe</span>
<span class="sd">        colums : a list of names that have the same type or</span>
<span class="sd">                 a dictionary where keys are the column names and values are the tensorflow type (e.g. tf.float32)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
        <span class="n">column_names</span> <span class="o">=</span> <span class="n">columns</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">columns</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>    
    <span class="k">else</span><span class="p">:</span>
        <span class="n">column_names</span> <span class="o">=</span> <span class="n">columns</span>        
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">default_type</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">]</span>    
        
    <span class="c1"># build the cls</span>
    <span class="n">tuple_cls</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">column_names</span><span class="p">)</span>    
    <span class="c1"># build the obj</span>
    <span class="k">return</span> <span class="n">tuple_cls</span><span class="o">.</span><span class="n">_make</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> 
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="introduction">
<h1>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h1>
<div class="section" id="code-15-1">
<h2>Code 15.1<a class="headerlink" href="#code-15-1" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># simulate a pancake and return randomly ordered sides</span>
<span class="k">def</span> <span class="nf">sim_pancake</span><span class="p">():</span>
    <span class="n">pancake</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">logits</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">sides</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">[:,</span> <span class="n">pancake</span><span class="p">]</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">sides</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sides</span>

<span class="c1"># sim 10,000 pancakes</span>
<span class="n">pancakes</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10_000</span><span class="p">):</span>
    <span class="n">pancakes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sim_pancake</span><span class="p">())</span>
    
<span class="n">pancakes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pancakes</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

<span class="n">up</span> <span class="o">=</span> <span class="n">pancakes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">down</span> <span class="o">=</span> <span class="n">pancakes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># compute proportion 1/1 (BB) out of all 1/1 and 1/0</span>
<span class="n">num_11_10</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">up</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">num_11</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">up</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">down</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">num_11</span> <span class="o">/</span> <span class="n">num_11_10</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-01-17 22:46:27.141361: W tensorflow/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library &#39;libcuda.so.1&#39;; dlerror: libcuda.so.1: cannot open shared object file: No such file or directory
2022-01-17 22:46:27.141394: W tensorflow/stream_executor/cuda/cuda_driver.cc:269] failed call to cuInit: UNKNOWN ERROR (303)
2022-01-17 22:46:27.141414: I tensorflow/stream_executor/cuda/cuda_diagnostics.cc:156] kernel driver does not appear to be running on this host (fv-az182-821): /proc/driver/nvidia/version does not exist
2022-01-17 22:46:27.141697: I tensorflow/core/platform/cpu_feature_guard.cc:151] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  AVX2 AVX512F FMA
To enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.6594303923521211
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="measurement-error">
<h2>15.1 Measurement error<a class="headerlink" href="#measurement-error" title="Permalink to this headline">¶</a></h2>
<div class="section" id="code-15-2">
<h3>Code 15.2<a class="headerlink" href="#code-15-2" title="Permalink to this headline">¶</a></h3>
<p>In the waffle dataset, both divorce rate and marriage rate variables are measured with substantial error and that error is reported in the form of standard errors.</p>
<p>Also error varies across the states.</p>
<p>Below we are plotting the measurement errors</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">WAFFLE_DIVORCE_DATASET_PATH</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>

<span class="c1"># points</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">plot_pair</span><span class="p">(</span><span class="n">d</span><span class="p">[[</span><span class="s2">&quot;MedianAgeMarriage&quot;</span><span class="p">,</span> <span class="s2">&quot;Divorce&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;list&quot;</span><span class="p">),</span>
                  <span class="n">scatter_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">ms</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Median age marriage&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Divorce rate&quot;</span><span class="p">)</span>

<span class="c1"># standard errors</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">ci</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">Divorce</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;Divorce SE&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">MedianAgeMarriage</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">],</span> <span class="n">ci</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">)</span>
    
    
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/15_missing_data_and_other_opportunities_18_0.png" src="../_images/15_missing_data_and_other_opportunities_18_0.png" />
</div>
</div>
<p>In the above plot, the lenght of the vertical lines show how uncertain the observed divorce rate is.</p>
</div>
<div class="section" id="error-on-the-outcome">
<h3>15.1.1 Error on the outcome<a class="headerlink" href="#error-on-the-outcome" title="Permalink to this headline">¶</a></h3>
<div class="section" id="code-15-3">
<h4>Code 15.3<a class="headerlink" href="#code-15-3" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;D_obs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">Divorce</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">())</span><span class="o">.</span><span class="n">values</span>
<span class="n">d</span><span class="p">[</span><span class="s2">&quot;D_sd&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;Divorce SE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">/</span> <span class="n">d</span><span class="o">.</span><span class="n">Divorce</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">d</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">Marriage</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">())</span><span class="o">.</span><span class="n">values</span>
<span class="n">d</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">MedianAgeMarriage</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">())</span><span class="o">.</span><span class="n">values</span>

<span class="n">N</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">tdf</span> <span class="o">=</span> <span class="n">df_to_tensors</span><span class="p">(</span><span class="s2">&quot;Waffle&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;D_obs&quot;</span><span class="p">,</span> <span class="s2">&quot;D_sd&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">model_15_1</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">D_sd</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>      
      <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;alpha&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">betaA</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;betaA&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">betaM</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;betaM&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>  
      <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        
      <span class="n">mu</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">betaA</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">A</span> <span class="o">+</span> <span class="n">betaM</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">M</span>    
    
      <span class="n">scale</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
     
      <span class="n">D_true</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>    
      <span class="n">D_obs</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">D_true</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">D_sd</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>             
      
    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    
    
<span class="n">jdc_15_1</span> <span class="o">=</span> <span class="n">model_15_1</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">M</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">D_sd</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NUM_CHAINS_FOR_15_1</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_15_1</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_15_1</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_15_1</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_15_1</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_15_1</span><span class="p">,</span> <span class="n">N</span><span class="p">]),</span>
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
<span class="p">]</span>

<span class="n">posterior_15_1</span><span class="p">,</span> <span class="n">trace_15_1</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span><span class="n">jdc_15_1</span><span class="p">,</span>
                               <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">D_obs</span><span class="p">,),</span>
                               <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;betaA&#39;</span><span class="p">,</span> <span class="s1">&#39;betaM&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="s1">&#39;D_true&#39;</span><span class="p">],</span>
                               <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                               <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-15-4">
<h4>Code 15.4<a class="headerlink" href="#code-15-4" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_15_1</span><span class="p">,</span> <span class="n">round_to</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha</th>
      <td>-0.05</td>
      <td>0.10</td>
      <td>-0.20</td>
      <td>0.10</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>78.36</td>
      <td>194.12</td>
      <td>1.02</td>
    </tr>
    <tr>
      <th>betaA</th>
      <td>-0.58</td>
      <td>0.16</td>
      <td>-0.80</td>
      <td>-0.28</td>
      <td>0.02</td>
      <td>0.02</td>
      <td>51.71</td>
      <td>184.37</td>
      <td>1.03</td>
    </tr>
    <tr>
      <th>betaM</th>
      <td>0.10</td>
      <td>0.17</td>
      <td>-0.15</td>
      <td>0.36</td>
      <td>0.02</td>
      <td>0.01</td>
      <td>63.34</td>
      <td>107.52</td>
      <td>1.02</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>0.58</td>
      <td>0.10</td>
      <td>0.42</td>
      <td>0.75</td>
      <td>0.02</td>
      <td>0.02</td>
      <td>21.37</td>
      <td>49.04</td>
      <td>1.09</td>
    </tr>
    <tr>
      <th>D_true[0]</th>
      <td>1.12</td>
      <td>0.35</td>
      <td>0.61</td>
      <td>1.66</td>
      <td>0.03</td>
      <td>0.02</td>
      <td>133.11</td>
      <td>190.78</td>
      <td>1.02</td>
    </tr>
    <tr>
      <th>D_true[1]</th>
      <td>0.69</td>
      <td>0.54</td>
      <td>-0.18</td>
      <td>1.51</td>
      <td>0.07</td>
      <td>0.05</td>
      <td>56.53</td>
      <td>175.34</td>
      <td>1.04</td>
    </tr>
    <tr>
      <th>D_true[2]</th>
      <td>0.45</td>
      <td>0.34</td>
      <td>-0.11</td>
      <td>0.95</td>
      <td>0.03</td>
      <td>0.02</td>
      <td>178.47</td>
      <td>232.45</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>D_true[3]</th>
      <td>1.47</td>
      <td>0.50</td>
      <td>0.70</td>
      <td>2.25</td>
      <td>0.05</td>
      <td>0.04</td>
      <td>84.65</td>
      <td>156.74</td>
      <td>1.03</td>
    </tr>
    <tr>
      <th>D_true[4]</th>
      <td>-0.90</td>
      <td>0.15</td>
      <td>-1.11</td>
      <td>-0.67</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>861.99</td>
      <td>166.35</td>
      <td>1.04</td>
    </tr>
    <tr>
      <th>D_true[5]</th>
      <td>0.78</td>
      <td>0.45</td>
      <td>0.11</td>
      <td>1.53</td>
      <td>0.04</td>
      <td>0.03</td>
      <td>118.12</td>
      <td>202.34</td>
      <td>1.02</td>
    </tr>
    <tr>
      <th>D_true[6]</th>
      <td>-1.36</td>
      <td>0.34</td>
      <td>-1.91</td>
      <td>-0.84</td>
      <td>0.03</td>
      <td>0.02</td>
      <td>152.81</td>
      <td>253.33</td>
      <td>1.03</td>
    </tr>
    <tr>
      <th>D_true[7]</th>
      <td>-0.31</td>
      <td>0.49</td>
      <td>-1.15</td>
      <td>0.37</td>
      <td>0.06</td>
      <td>0.07</td>
      <td>87.03</td>
      <td>188.82</td>
      <td>1.06</td>
    </tr>
    <tr>
      <th>D_true[8]</th>
      <td>-1.81</td>
      <td>0.62</td>
      <td>-2.79</td>
      <td>-0.75</td>
      <td>0.11</td>
      <td>0.08</td>
      <td>32.42</td>
      <td>52.23</td>
      <td>1.07</td>
    </tr>
    <tr>
      <th>D_true[9]</th>
      <td>-0.62</td>
      <td>0.18</td>
      <td>-0.90</td>
      <td>-0.33</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>685.11</td>
      <td>404.18</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>D_true[10]</th>
      <td>0.79</td>
      <td>0.28</td>
      <td>0.30</td>
      <td>1.18</td>
      <td>0.02</td>
      <td>0.02</td>
      <td>176.06</td>
      <td>212.31</td>
      <td>1.02</td>
    </tr>
    <tr>
      <th>D_true[11]</th>
      <td>-0.50</td>
      <td>0.57</td>
      <td>-1.37</td>
      <td>0.39</td>
      <td>0.07</td>
      <td>0.05</td>
      <td>62.05</td>
      <td>122.19</td>
      <td>1.02</td>
    </tr>
    <tr>
      <th>D_true[12]</th>
      <td>0.17</td>
      <td>0.51</td>
      <td>-0.64</td>
      <td>1.01</td>
      <td>0.13</td>
      <td>0.10</td>
      <td>14.71</td>
      <td>106.51</td>
      <td>1.11</td>
    </tr>
    <tr>
      <th>D_true[13]</th>
      <td>-0.88</td>
      <td>0.24</td>
      <td>-1.20</td>
      <td>-0.43</td>
      <td>0.02</td>
      <td>0.01</td>
      <td>254.46</td>
      <td>366.81</td>
      <td>1.02</td>
    </tr>
    <tr>
      <th>D_true[14]</th>
      <td>0.54</td>
      <td>0.33</td>
      <td>0.05</td>
      <td>1.08</td>
      <td>0.02</td>
      <td>0.02</td>
      <td>198.50</td>
      <td>301.28</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>D_true[15]</th>
      <td>0.28</td>
      <td>0.40</td>
      <td>-0.33</td>
      <td>0.87</td>
      <td>0.04</td>
      <td>0.03</td>
      <td>111.39</td>
      <td>233.49</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>D_true[16]</th>
      <td>0.45</td>
      <td>0.40</td>
      <td>-0.20</td>
      <td>1.09</td>
      <td>0.04</td>
      <td>0.02</td>
      <td>129.87</td>
      <td>265.02</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>D_true[17]</th>
      <td>1.29</td>
      <td>0.33</td>
      <td>0.76</td>
      <td>1.77</td>
      <td>0.03</td>
      <td>0.02</td>
      <td>128.63</td>
      <td>304.70</td>
      <td>1.02</td>
    </tr>
    <tr>
      <th>D_true[18]</th>
      <td>0.45</td>
      <td>0.39</td>
      <td>-0.15</td>
      <td>1.11</td>
      <td>0.03</td>
      <td>0.02</td>
      <td>132.77</td>
      <td>308.56</td>
      <td>1.02</td>
    </tr>
    <tr>
      <th>D_true[19]</th>
      <td>0.30</td>
      <td>0.52</td>
      <td>-0.61</td>
      <td>1.09</td>
      <td>0.06</td>
      <td>0.04</td>
      <td>80.08</td>
      <td>140.38</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>D_true[20]</th>
      <td>-0.55</td>
      <td>0.32</td>
      <td>-1.09</td>
      <td>-0.09</td>
      <td>0.03</td>
      <td>0.02</td>
      <td>112.71</td>
      <td>173.44</td>
      <td>1.05</td>
    </tr>
    <tr>
      <th>D_true[21]</th>
      <td>-1.07</td>
      <td>0.25</td>
      <td>-1.46</td>
      <td>-0.66</td>
      <td>0.02</td>
      <td>0.01</td>
      <td>247.93</td>
      <td>289.62</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>D_true[22]</th>
      <td>-0.27</td>
      <td>0.24</td>
      <td>-0.68</td>
      <td>0.10</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>292.74</td>
      <td>316.58</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>D_true[23]</th>
      <td>-1.01</td>
      <td>0.29</td>
      <td>-1.44</td>
      <td>-0.54</td>
      <td>0.02</td>
      <td>0.01</td>
      <td>268.20</td>
      <td>257.79</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>D_true[24]</th>
      <td>0.42</td>
      <td>0.39</td>
      <td>-0.15</td>
      <td>1.08</td>
      <td>0.04</td>
      <td>0.03</td>
      <td>118.65</td>
      <td>189.34</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>D_true[25]</th>
      <td>-0.04</td>
      <td>0.31</td>
      <td>-0.54</td>
      <td>0.42</td>
      <td>0.02</td>
      <td>0.02</td>
      <td>206.82</td>
      <td>311.67</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>D_true[26]</th>
      <td>0.01</td>
      <td>0.44</td>
      <td>-0.62</td>
      <td>0.77</td>
      <td>0.05</td>
      <td>0.03</td>
      <td>99.68</td>
      <td>135.73</td>
      <td>1.02</td>
    </tr>
    <tr>
      <th>D_true[27]</th>
      <td>-0.15</td>
      <td>0.39</td>
      <td>-0.82</td>
      <td>0.42</td>
      <td>0.03</td>
      <td>0.02</td>
      <td>129.64</td>
      <td>163.25</td>
      <td>1.03</td>
    </tr>
    <tr>
      <th>D_true[28]</th>
      <td>-0.22</td>
      <td>0.53</td>
      <td>-1.03</td>
      <td>0.63</td>
      <td>0.09</td>
      <td>0.06</td>
      <td>38.06</td>
      <td>109.70</td>
      <td>1.04</td>
    </tr>
    <tr>
      <th>D_true[29]</th>
      <td>-1.79</td>
      <td>0.23</td>
      <td>-2.17</td>
      <td>-1.44</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>393.53</td>
      <td>474.39</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>D_true[30]</th>
      <td>0.20</td>
      <td>0.43</td>
      <td>-0.40</td>
      <td>0.97</td>
      <td>0.04</td>
      <td>0.03</td>
      <td>93.76</td>
      <td>151.43</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>D_true[31]</th>
      <td>-1.65</td>
      <td>0.17</td>
      <td>-1.93</td>
      <td>-1.38</td>
      <td>0.01</td>
      <td>0.00</td>
      <td>802.23</td>
      <td>330.77</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>D_true[32]</th>
      <td>0.10</td>
      <td>0.24</td>
      <td>-0.28</td>
      <td>0.47</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>394.26</td>
      <td>549.62</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>D_true[33]</th>
      <td>0.14</td>
      <td>0.52</td>
      <td>-0.68</td>
      <td>0.89</td>
      <td>0.09</td>
      <td>0.07</td>
      <td>32.91</td>
      <td>104.81</td>
      <td>1.03</td>
    </tr>
    <tr>
      <th>D_true[34]</th>
      <td>-0.12</td>
      <td>0.24</td>
      <td>-0.54</td>
      <td>0.22</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>355.26</td>
      <td>429.75</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>D_true[35]</th>
      <td>1.28</td>
      <td>0.42</td>
      <td>0.56</td>
      <td>1.90</td>
      <td>0.04</td>
      <td>0.03</td>
      <td>111.90</td>
      <td>190.69</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>D_true[36]</th>
      <td>0.28</td>
      <td>0.35</td>
      <td>-0.33</td>
      <td>0.80</td>
      <td>0.03</td>
      <td>0.02</td>
      <td>146.75</td>
      <td>254.26</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>D_true[37]</th>
      <td>-1.02</td>
      <td>0.23</td>
      <td>-1.37</td>
      <td>-0.68</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>304.88</td>
      <td>324.81</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>D_true[38]</th>
      <td>-0.95</td>
      <td>0.55</td>
      <td>-1.72</td>
      <td>-0.04</td>
      <td>0.07</td>
      <td>0.05</td>
      <td>61.30</td>
      <td>84.20</td>
      <td>1.03</td>
    </tr>
    <tr>
      <th>D_true[39]</th>
      <td>-0.64</td>
      <td>0.32</td>
      <td>-1.08</td>
      <td>-0.10</td>
      <td>0.02</td>
      <td>0.02</td>
      <td>187.83</td>
      <td>252.43</td>
      <td>1.02</td>
    </tr>
    <tr>
      <th>D_true[40]</th>
      <td>0.24</td>
      <td>0.51</td>
      <td>-0.69</td>
      <td>0.95</td>
      <td>0.06</td>
      <td>0.04</td>
      <td>74.23</td>
      <td>175.35</td>
      <td>1.03</td>
    </tr>
    <tr>
      <th>D_true[41]</th>
      <td>0.69</td>
      <td>0.34</td>
      <td>0.03</td>
      <td>1.15</td>
      <td>0.03</td>
      <td>0.02</td>
      <td>185.81</td>
      <td>259.27</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>D_true[42]</th>
      <td>0.19</td>
      <td>0.19</td>
      <td>-0.09</td>
      <td>0.47</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>657.33</td>
      <td>558.54</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>D_true[43]</th>
      <td>0.84</td>
      <td>0.43</td>
      <td>0.17</td>
      <td>1.51</td>
      <td>0.06</td>
      <td>0.04</td>
      <td>48.33</td>
      <td>166.86</td>
      <td>1.05</td>
    </tr>
    <tr>
      <th>D_true[44]</th>
      <td>-0.50</td>
      <td>0.53</td>
      <td>-1.32</td>
      <td>0.37</td>
      <td>0.07</td>
      <td>0.05</td>
      <td>62.53</td>
      <td>146.91</td>
      <td>1.03</td>
    </tr>
    <tr>
      <th>D_true[45]</th>
      <td>-0.36</td>
      <td>0.25</td>
      <td>-0.83</td>
      <td>-0.02</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>290.13</td>
      <td>449.16</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>D_true[46]</th>
      <td>0.17</td>
      <td>0.29</td>
      <td>-0.31</td>
      <td>0.59</td>
      <td>0.02</td>
      <td>0.01</td>
      <td>219.49</td>
      <td>248.90</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>D_true[47]</th>
      <td>0.65</td>
      <td>0.48</td>
      <td>-0.16</td>
      <td>1.35</td>
      <td>0.05</td>
      <td>0.04</td>
      <td>87.88</td>
      <td>193.88</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>D_true[48]</th>
      <td>-0.63</td>
      <td>0.28</td>
      <td>-1.12</td>
      <td>-0.23</td>
      <td>0.02</td>
      <td>0.01</td>
      <td>254.83</td>
      <td>378.56</td>
      <td>1.03</td>
    </tr>
    <tr>
      <th>D_true[49]</th>
      <td>0.99</td>
      <td>0.55</td>
      <td>0.12</td>
      <td>1.86</td>
      <td>0.08</td>
      <td>0.06</td>
      <td>49.16</td>
      <td>127.64</td>
      <td>1.05</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="code-15-5">
<h4>Code 15.5<a class="headerlink" href="#code-15-5" title="Permalink to this headline">¶</a></h4>
<p>What happens when there is a measurement error on predictor variables as well ?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;D_obs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">Divorce</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">())</span><span class="o">.</span><span class="n">values</span>
<span class="n">d</span><span class="p">[</span><span class="s2">&quot;D_sd&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;Divorce SE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">/</span> <span class="n">d</span><span class="o">.</span><span class="n">Divorce</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">d</span><span class="p">[</span><span class="s2">&quot;M_obs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">Marriage</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">())</span><span class="o">.</span><span class="n">values</span>
<span class="n">d</span><span class="p">[</span><span class="s2">&quot;M_sd&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;Marriage SE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">/</span> <span class="n">d</span><span class="o">.</span><span class="n">Marriage</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">d</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">MedianAgeMarriage</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">())</span><span class="o">.</span><span class="n">values</span>

<span class="n">N</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">tdf</span> <span class="o">=</span> <span class="n">df_to_tensors</span><span class="p">(</span><span class="s2">&quot;Waffle&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;D_obs&quot;</span><span class="p">,</span> <span class="s2">&quot;D_sd&quot;</span><span class="p">,</span> <span class="s2">&quot;M_obs&quot;</span><span class="p">,</span> <span class="s2">&quot;M_sd&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">model_15_2</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">M_sd</span><span class="p">,</span> <span class="n">D_sd</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>      
      <span class="n">alpha</span>  <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;alpha&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">betaA</span>  <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;betaA&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">betaM</span>  <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;betaM&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>  
      <span class="n">sigma</span>  <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>        
      <span class="n">M_true</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;M_true&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="n">N</span><span class="p">))</span>        
        
      <span class="n">mu</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">betaA</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">A</span> <span class="o">+</span> <span class="n">betaM</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">M_true</span>    
    
      <span class="n">scale</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
     
      <span class="n">D_true</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>    
      <span class="n">D_obs</span>  <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">D_true</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">D_sd</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">M_obs</span>  <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">M_true</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">M_sd</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;M_obs&quot;</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>    
      
    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    
    
<span class="n">jdc_15_2</span> <span class="o">=</span> <span class="n">model_15_2</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">M_sd</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">D_sd</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NUM_CHAINS_FOR_15_2</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_15_2</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_15_2</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_15_2</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_15_2</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_15_2</span><span class="p">,</span> <span class="n">N</span><span class="p">]),</span>  <span class="c1"># M_True</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_15_2</span><span class="p">,</span> <span class="n">N</span><span class="p">]),</span>  <span class="c1"># D_True</span>
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
<span class="p">]</span>

<span class="n">posterior_15_2</span><span class="p">,</span> <span class="n">trace_15_2</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span><span class="n">jdc_15_2</span><span class="p">,</span>
                                   <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">D_obs</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">M_obs</span><span class="p">),</span>                                   
                                   <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;betaA&#39;</span><span class="p">,</span> <span class="s1">&#39;betaM&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="s1">&#39;M_true&#39;</span><span class="p">,</span> <span class="s1">&#39;D_true&#39;</span><span class="p">],</span>
                                   <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                                   <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-15-6">
<h4>Code 15.6<a class="headerlink" href="#code-15-6" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">post_D_true</span> <span class="o">=</span> <span class="n">trace_15_2</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;D_true&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">post_M_true</span> <span class="o">=</span> <span class="n">trace_15_2</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;M_true&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">D_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">post_D_true</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">M_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">post_M_true</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;M_obs&quot;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;D_obs&quot;</span><span class="p">],</span> <span class="s2">&quot;bo&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;marriage rate (std)&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;divorce rate (std)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">M_est</span><span class="p">,</span> <span class="n">D_est</span><span class="p">,</span> <span class="s2">&quot;ko&quot;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;M_obs&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">M_est</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;D_obs&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">D_est</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span>
             <span class="s2">&quot;k-&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/15_missing_data_and_other_opportunities_30_0.png" src="../_images/15_missing_data_and_other_opportunities_30_0.png" />
</div>
</div>
<p>Above figure demonstrates shrinkage of both divorce rate and marriage rate. Solid points are the observed values. Open points are posterior means. Lines connect pairs of points for the same state. Both variables are shrunk towards the inferred regression relationship.</p>
<p>With measurement error, the insight is to realize that any uncertain piece of data can be replaced by a distribution that reflects uncertainty.</p>
</div>
<div class="section" id="code-15-7">
<h4>Code 15.7<a class="headerlink" href="#code-15-7" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Simulated toy data</span>

<span class="n">N</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">((</span><span class="n">N</span><span class="p">,))</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=-</span><span class="n">A</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
<span class="n">D</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">A</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
<span class="n">A_obs</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">A</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="missing-data">
<h2>15.2 Missing data<a class="headerlink" href="#missing-data" title="Permalink to this headline">¶</a></h2>
<div class="section" id="dag-ate-my-homework">
<h3>15.2.1 DAG ate my homework<a class="headerlink" href="#dag-ate-my-homework" title="Permalink to this headline">¶</a></h3>
<div class="section" id="code-15-8">
<h4>Code 15.8<a class="headerlink" href="#code-15-8" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">S</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">((</span><span class="n">N</span><span class="p">,))</span>
<span class="n">H</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span><span class="n">total_count</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">S</span><span class="p">))</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-15-9">
<h4>Code 15.9<a class="headerlink" href="#code-15-9" title="Permalink to this headline">¶</a></h4>
<p>Hm = Homework missing</p>
<p>Dog’s decision to eat a piece of homework or not is not influenced by any relevant variable</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">D</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Bernoulli</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>  <span class="c1"># dogs completely random</span>
<span class="n">Hm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">D</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span>

<span class="n">Hm</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 4.,  3.,  6.,  3.,  6.,  3.,  7.,  8.,  2.,  6., 10.,  5.,  9.,
        6.,  6.,  2.,  1.,  3.,  1.,  9.,  2.,  1.,  1.,  5.,  3.,  4.,
        6.,  6.,  0.,  6.,  3.,  2.,  4.,  3.,  7.,  6.,  2.,  8.,  5.,
        1.,  6.,  4.,  6.,  5.,  2.,  8.,  8.,  9.,  7.,  8.,  2.,  5.,
        3.,  2.,  4.,  8.,  3.,  4.,  5.,  5.,  4.,  2.,  5., 10.,  7.,
        1.,  7.,  3.,  4.,  1.,  6.,  3.,  7.,  5.,  6.,  4.,  7.,  3.,
        7.,  8.,  9.,  3.,  2.,  3.,  1.,  7.,  5.,  8.,  1.,  8.,  3.,
        8.,  7.,  4.,  5.,  1.,  4.,  8.,  5.,  4.], dtype=float32)
</pre></div>
</div>
</div>
</div>
<p>Since missing values are random, missignness does not necessiarily change the overall distribution of homework score.</p>
</div>
<div class="section" id="code-15-10">
<h4>Code 15.10<a class="headerlink" href="#code-15-10" title="Permalink to this headline">¶</a></h4>
<p>Here studying influences whether a dog eats homework S-&gt;D</p>
<p>Students who study a lot do not play with their Dogs and then dogs take revenge by eating homework</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">S</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">Hm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">D</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span>

<span class="n">Hm</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 4., nan,  6.,  3., nan,  3., nan, nan,  2., nan, nan,  5., nan,
       nan, nan,  2.,  1.,  3.,  1., nan,  2., nan,  1.,  5., nan, nan,
       nan,  6.,  0., nan,  3.,  2.,  4.,  3., nan, nan,  2., nan,  5.,
        1.,  6., nan,  6.,  5.,  2., nan, nan, nan, nan, nan,  2.,  5.,
        3.,  2., nan, nan,  3.,  4.,  5.,  5.,  4.,  2., nan, nan, nan,
        1., nan, nan, nan,  1., nan,  3.,  7., nan, nan, nan, nan,  3.,
       nan, nan, nan,  3.,  2.,  3.,  1., nan,  5., nan,  1., nan,  3.,
       nan, nan,  4., nan,  1.,  4., nan, nan, nan], dtype=float32)
</pre></div>
</div>
</div>
</div>
<p>Now every student who studies more than average (0) is missing homework</p>
</div>
<div class="section" id="code-15-11">
<h4>Code 15.11<a class="headerlink" href="#code-15-11" title="Permalink to this headline">¶</a></h4>
<p>The case of noisy home and its influence on homework &amp; Dog’s behavior</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TODO - use seed; have not been able to make it work with tfp</span>

<span class="n">N</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,))</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">S</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,))</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

<span class="n">logits</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">S</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">X</span>

<span class="n">H</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span><span class="n">total_count</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">logits</span><span class="o">=</span><span class="n">logits</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

<span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">X</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">Hm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">D</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-15-12">
<h4>Code 15.12<a class="headerlink" href="#code-15-12" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tdf</span> <span class="o">=</span> <span class="n">df_to_tensors</span><span class="p">(</span><span class="s2">&quot;SimulatedHomeWork&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">H</span><span class="o">=</span><span class="n">H</span><span class="p">,</span><span class="n">S</span><span class="o">=</span><span class="n">S</span><span class="p">)),</span> <span class="p">[</span><span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">model_15_3</span><span class="p">(</span><span class="n">S</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>      
      <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;alpha&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">betaS</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;betaS&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
              
      <span class="n">logits</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">alpha</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">betaS</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">S</span><span class="p">)</span>      
      
      <span class="n">H</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span><span class="n">total_count</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">logits</span><span class="o">=</span><span class="n">logits</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>    
      
    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    
    
<span class="n">jdc_15_3</span> <span class="o">=</span> <span class="n">model_15_3</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">S</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NUM_CHAINS_FOR_15_3</span> <span class="o">=</span> <span class="mi">4</span>

<span class="n">alpha_init</span><span class="p">,</span> <span class="n">betaS_init</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">jdc_15_3</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>

<span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">alpha_init</span><span class="p">,</span> <span class="p">(</span><span class="n">NUM_CHAINS_FOR_15_3</span><span class="p">,)),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">betaS_init</span><span class="p">,</span> <span class="p">(</span><span class="n">NUM_CHAINS_FOR_15_3</span><span class="p">,))</span>    
<span class="p">]</span>


<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>    
<span class="p">]</span>

<span class="n">posterior_15_3</span><span class="p">,</span> <span class="n">trace_15_3</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span><span class="n">jdc_15_3</span><span class="p">,</span>
                               <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">H</span><span class="p">,),</span>                                     
                               <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;betaS&#39;</span><span class="p">],</span>
                               <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                               <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:@custom_gradient grad_fn has &#39;variables&#39; in signature, but no ResourceVariables were used on the forward pass.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_15_3</span><span class="p">,</span> <span class="n">round_to</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha</th>
      <td>1.08</td>
      <td>0.03</td>
      <td>1.03</td>
      <td>1.13</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>7.46</td>
      <td>19.18</td>
      <td>1.50</td>
    </tr>
    <tr>
      <th>betaS</th>
      <td>0.57</td>
      <td>0.03</td>
      <td>0.52</td>
      <td>0.62</td>
      <td>0.01</td>
      <td>0.01</td>
      <td>6.85</td>
      <td>21.81</td>
      <td>1.58</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The true coefficient on S should be 1.00. We don’t expect to get that exactly, but the estimate above is way off</p>
</div>
<div class="section" id="code-15-13">
<h4>Code 15.13<a class="headerlink" href="#code-15-13" title="Permalink to this headline">¶</a></h4>
<p>We build the model with missing data now</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tdf</span> <span class="o">=</span> <span class="n">df_to_tensors</span><span class="p">(</span><span class="s2">&quot;SimulatedHomeWork&quot;</span><span class="p">,</span> 
                    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">H</span><span class="o">=</span><span class="n">H</span><span class="p">[</span><span class="n">D</span><span class="o">==</span><span class="mi">0</span><span class="p">],</span><span class="n">S</span><span class="o">=</span><span class="n">S</span><span class="p">[</span><span class="n">D</span><span class="o">==</span><span class="mi">0</span><span class="p">])),</span> <span class="p">[</span><span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">model_15_4</span><span class="p">(</span><span class="n">S</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>      
      <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;alpha&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">betaS</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;betaS&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
              
      <span class="n">logits</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">alpha</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">betaS</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">S</span><span class="p">)</span>      
      
      <span class="n">H</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span><span class="n">total_count</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">logits</span><span class="o">=</span><span class="n">logits</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>    
      
    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    
    
<span class="n">jdc_15_4</span> <span class="o">=</span> <span class="n">model_15_4</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">S</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NUM_CHAINS_FOR_15_4</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">alpha_init</span><span class="p">,</span> <span class="n">betaS_init</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">jdc_15_4</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>

<span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">alpha_init</span><span class="p">,</span> <span class="p">(</span><span class="n">NUM_CHAINS_FOR_15_4</span><span class="p">,)),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">betaS_init</span><span class="p">,</span> <span class="p">(</span><span class="n">NUM_CHAINS_FOR_15_4</span><span class="p">,))</span>    
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>    
<span class="p">]</span>

<span class="n">posterior_15_4</span><span class="p">,</span> <span class="n">trace_15_4</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span><span class="n">jdc_15_4</span><span class="p">,</span>
                               <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">H</span><span class="p">,),</span>                                     
                               <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;betaS&#39;</span><span class="p">],</span>
                               <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                               <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:@custom_gradient grad_fn has &#39;variables&#39; in signature, but no ResourceVariables were used on the forward pass.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_15_4</span><span class="p">,</span> <span class="n">round_to</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha</th>
      <td>1.76</td>
      <td>0.03</td>
      <td>1.72</td>
      <td>1.82</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>240.84</td>
      <td>325.14</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>betaS</th>
      <td>0.80</td>
      <td>0.03</td>
      <td>0.75</td>
      <td>0.84</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>238.84</td>
      <td>315.98</td>
      <td>1.00</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="code-15-14">
<h4>Code 15.14<a class="headerlink" href="#code-15-14" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-15-15">
<h4>Code 15.15<a class="headerlink" href="#code-15-15" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">S</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">((</span><span class="n">N</span><span class="p">,))</span>
<span class="n">H</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span><span class="n">total_count</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">logits</span><span class="o">=</span><span class="n">S</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">H</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">Hm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">D</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span>

<span class="n">Hm</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 7., nan, nan,  9.,  6.,  7.,  6., nan, nan,  5., nan, nan,  5.,
       nan,  7.,  5.,  5.,  8.,  6.,  7., nan,  8., 10.,  7.,  5.,  5.,
        8., nan, nan,  5., nan,  5.,  9.,  6.,  5., nan, nan, nan,  9.,
        7.,  8.,  8.,  6., nan,  8.,  6.,  6.,  8.,  7., nan,  8.,  7.,
       nan,  7.,  5., nan,  6., nan, nan,  5., nan,  6., nan,  6., nan,
       nan,  8., nan,  7., nan, nan,  8., nan, nan,  8.,  8., nan,  5.,
        6., nan, nan, nan,  7., nan,  6., nan,  8.,  9., nan, nan,  7.,
       nan, nan,  8., nan, nan,  7.,  7.,  7., nan], dtype=float32)
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="categorical-errors-and-discrete-absences-todo">
<h2>15.3 Categorical errors and discrete absences (TODO)<a class="headerlink" href="#categorical-errors-and-discrete-absences-todo" title="Permalink to this headline">¶</a></h2>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="14_adventures_in_covariance.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Chapter 14 - Adventures in Covariance</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="16_generalized_linear_madness.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Chapter 16 - Generalized Linear Madness</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Richard McElreath<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>