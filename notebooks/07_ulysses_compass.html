
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>7. Ulysses’ Compass &#8212; Statistical Rethinking (2nd Edition)</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="canonical" href="https://ksachdeva.github.io/rethinking-tensorflow-probability/notebooks/07_ulysses_compass.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="8. Conditional Manatees" href="08_conditional_manatees.html" />
    <link rel="prev" title="6. The Haunted DAG and The Causal Terror" href="06_the_haunted_dag_and_the_causal_terror.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Statistical Rethinking (2nd Edition)</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../README.html">
   Statistical Rethinking (2nd Edition) with Tensorflow Probability
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="00_preface.html">
   Preface
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="01_the_golem_of_prague.html">
   1. The Gloem of Prague
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02_small_worlds_and_large_worlds.html">
   2. Small Worlds and Large Worlds
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03_sampling_the_imaginary.html">
   3. Sampling the Imaginary
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="04_geocentric_models.html">
   4. Geocentric Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="05_the_many_variables_and_the_spurious_waffles.html">
   5. The Many Variables &amp; The Spurious Waffles
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="06_the_haunted_dag_and_the_causal_terror.html">
   6. The Haunted DAG and The Causal Terror
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   7. Ulysses’ Compass
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="08_conditional_manatees.html">
   8. Conditional Manatees
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="09_markov_chain_monte_carlo.html">
   9. Markov Chain Monte Carlo
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="10_big_entropy_and_the_generalized_linear_model.html">
   10. Big Entropy and The Generalized Linear Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="11_god_spiked_the_integers.html">
   11. God Spiked the Integers
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="12_monsters_and_mixtures.html">
   12. Monsters and Mixtures
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="13_models_with_memory.html">
   13. Models with Memory
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="14_adventures_in_covariance.html">
   14. Adventures in Covariance
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="15_missing_data_and_other_opportunities.html">
   15. Missing Data and Other Opportunities
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="16_generalized_linear_madness.html">
   16. Generalized Linear Madness
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="17_horoscopes.html">
   17. Horoscopes
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/notebooks/07_ulysses_compass.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/ksachdeva/rethinking-tensorflow-probability"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/ksachdeva/rethinking-tensorflow-probability/issues/new?title=Issue%20on%20page%20%2Fnotebooks/07_ulysses_compass.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/ksachdeva/rethinking-tensorflow-probability/master?urlpath=tree/notebooks/07_ulysses_compass.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-problem-with-parameters">
   7.1 The problem with parameters
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#more-parameters-almost-always-improve-fit">
     7.1.1 More parameters(almost) always improve fit
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-1">
       Code 7.1
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-2">
       Code 7.2
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-3">
       Code 7.3
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-4">
       Code 7.4
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-7-5">
         Code 7.5
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-7-6">
         Code 7.6
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-7-7">
         Code 7.7
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-7-8">
         Code 7.8
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-7-9">
         Code 7.9
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-7-10">
         Code 7.10
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#too-few-parameters-hurts-too">
     7.1.2 Too few parameters hurts,too
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-11">
       Code 7.11
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#entropy-and-accuracy">
   7.2 Entropy and accuracy
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#firing-the-weatherperson">
     7.2.1 Firing the weatherperson
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#information-and-uncertainity">
     7.2.2 Information and uncertainity
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-12">
       Code 7.12
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#from-entropy-to-accuracy">
     7.2.3 From entropy to accuracy
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#estimating-divergence">
     7.2.4 Estimating divergence
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-13">
       Code 7.13
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#overthinking">
     Overthinking
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-14">
       Code 7.14
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#scoring-the-right-data">
     Scoring the right data
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-15">
       Code 7.15
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Overthinking
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-16-7-18-todo">
       Code 7.16 - 7.18 [TODO]
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#golem-taming-regularization">
   7.3 Golem Taming: Regularization
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#predicting-predictive-accuracy">
   7.4 Predicting predictive accuracy
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#overthinking-waic-calculations">
     Overthinking: WAIC calculations
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-19">
       Code 7.19
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-20">
       Code 7.20
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-21">
       Code 7.21
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-22">
       Code 7.22
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-23">
       Code 7.23
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-24">
       Code 7.24
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#comparing-cv-psis-and-waic">
     7.4.3 Comparing CV, PSIS, and WAIC
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-comparison">
   7.5 Model comparison
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-7-25">
     Code 7.25
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-7-26">
     Code 7.26
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-7-27">
     Code 7.27
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-7-28">
     Code 7.28
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-7-29">
     Code 7.29
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-7-30">
     Code 7.30
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-7-31">
     Code 7.31
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#outliers-and-other-illusions">
     7.5.2 Outliers and other illusions
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-32">
       Code 7.32
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-33">
       Code 7.33
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-34">
       Code 7.34
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-35">
       Code 7.35
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>7. Ulysses’ Compass</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-problem-with-parameters">
   7.1 The problem with parameters
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#more-parameters-almost-always-improve-fit">
     7.1.1 More parameters(almost) always improve fit
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-1">
       Code 7.1
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-2">
       Code 7.2
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-3">
       Code 7.3
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-4">
       Code 7.4
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-7-5">
         Code 7.5
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-7-6">
         Code 7.6
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-7-7">
         Code 7.7
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-7-8">
         Code 7.8
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-7-9">
         Code 7.9
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#code-7-10">
         Code 7.10
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#too-few-parameters-hurts-too">
     7.1.2 Too few parameters hurts,too
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-11">
       Code 7.11
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#entropy-and-accuracy">
   7.2 Entropy and accuracy
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#firing-the-weatherperson">
     7.2.1 Firing the weatherperson
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#information-and-uncertainity">
     7.2.2 Information and uncertainity
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-12">
       Code 7.12
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#from-entropy-to-accuracy">
     7.2.3 From entropy to accuracy
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#estimating-divergence">
     7.2.4 Estimating divergence
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-13">
       Code 7.13
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#overthinking">
     Overthinking
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-14">
       Code 7.14
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#scoring-the-right-data">
     Scoring the right data
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-15">
       Code 7.15
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Overthinking
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-16-7-18-todo">
       Code 7.16 - 7.18 [TODO]
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#golem-taming-regularization">
   7.3 Golem Taming: Regularization
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#predicting-predictive-accuracy">
   7.4 Predicting predictive accuracy
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#overthinking-waic-calculations">
     Overthinking: WAIC calculations
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-19">
       Code 7.19
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-20">
       Code 7.20
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-21">
       Code 7.21
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-22">
       Code 7.22
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-23">
       Code 7.23
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-24">
       Code 7.24
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#comparing-cv-psis-and-waic">
     7.4.3 Comparing CV, PSIS, and WAIC
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-comparison">
   7.5 Model comparison
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-7-25">
     Code 7.25
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-7-26">
     Code 7.26
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-7-27">
     Code 7.27
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-7-28">
     Code 7.28
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-7-29">
     Code 7.29
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-7-30">
     Code 7.30
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-7-31">
     Code 7.31
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#outliers-and-other-illusions">
     7.5.2 Outliers and other illusions
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-32">
       Code 7.32
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-33">
       Code 7.33
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-34">
       Code 7.34
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#code-7-35">
       Code 7.35
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <p><a class="reference external" href="https://colab.research.google.com/github/ksachdeva/rethinking-tensorflow-probability/blob/master/notebooks/07_ulysses_compass.ipynb"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg" /></a></p>
<div class="tex2jax_ignore mathjax_ignore section" id="ulysses-compass">
<h1>7. Ulysses’ Compass<a class="headerlink" href="#ulysses-compass" title="Permalink to this headline">¶</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Install packages that are not installed in colab</span>
<span class="k">try</span><span class="p">:</span>
  <span class="kn">import</span> <span class="nn">google.colab</span>
  <span class="o">!</span>pip install -q watermark
  <span class="o">!</span>pip install git+https://github.com/ksachdeva/rethinking-tensorflow-probability.git
<span class="k">except</span><span class="p">:</span>
  <span class="k">pass</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> watermark
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Core</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">arviz</span> <span class="k">as</span> <span class="nn">az</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">tensorflow_probability</span> <span class="k">as</span> <span class="nn">tfp</span>
<span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span> 

<span class="c1"># visualization </span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">rethinking.data</span> <span class="kn">import</span> <span class="n">RethinkingDataset</span>
<span class="kn">from</span> <span class="nn">rethinking.data</span> <span class="kn">import</span> <span class="n">dataframe_to_tensors</span>
<span class="kn">from</span> <span class="nn">rethinking.mcmc</span> <span class="kn">import</span> <span class="n">sample_posterior</span>

<span class="c1"># aliases</span>
<span class="n">tfd</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">distributions</span>
<span class="n">tfb</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">bijectors</span>
<span class="n">Root</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="o">.</span><span class="n">Root</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-01-18 03:04:06.918316: W tensorflow/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library &#39;libcudart.so.11.0&#39;; dlerror: libcudart.so.11.0: cannot open shared object file: No such file or directory
2022-01-18 03:04:06.918351: I tensorflow/stream_executor/cuda/cudart_stub.cc:29] Ignore above cudart dlerror if you do not have a GPU set up on your machine.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">watermark</span> -p numpy,tensorflow,tensorflow_probability,arviz,scipy,pandas
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>numpy                 : 1.21.5
tensorflow            : 2.7.0
tensorflow_probability: 0.15.0
arviz                 : 0.11.4
scipy                 : 1.7.3
pandas                : 1.3.5
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># config of various plotting libraries</span>
<span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
</pre></div>
</div>
</div>
</div>
<div class="section" id="the-problem-with-parameters">
<h2>7.1 The problem with parameters<a class="headerlink" href="#the-problem-with-parameters" title="Permalink to this headline">¶</a></h2>
<div class="section" id="more-parameters-almost-always-improve-fit">
<h3>7.1.1 More parameters(almost) always improve fit<a class="headerlink" href="#more-parameters-almost-always-improve-fit" title="Permalink to this headline">¶</a></h3>
<div class="section" id="code-7-1">
<h4>Code 7.1<a class="headerlink" href="#code-7-1" title="Permalink to this headline">¶</a></h4>
<p>Below is a dataset for average brain volumes and body masses for 7 hominin species</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sppnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;afarensis&quot;</span><span class="p">,</span> <span class="s2">&quot;africanus&quot;</span><span class="p">,</span> <span class="s2">&quot;habilis&quot;</span><span class="p">,</span> <span class="s2">&quot;boisei&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rudolfensis&quot;</span><span class="p">,</span> <span class="s2">&quot;ergaster&quot;</span><span class="p">,</span> <span class="s2">&quot;sapiens&quot;</span><span class="p">]</span>
<span class="n">brainvolcc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">438</span><span class="p">,</span> <span class="mi">452</span><span class="p">,</span> <span class="mi">612</span><span class="p">,</span> <span class="mi">521</span><span class="p">,</span> <span class="mi">752</span><span class="p">,</span> <span class="mi">871</span><span class="p">,</span> <span class="mi">1350</span><span class="p">])</span>
<span class="n">masskg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">37.0</span><span class="p">,</span> <span class="mf">35.5</span><span class="p">,</span> <span class="mf">34.5</span><span class="p">,</span> <span class="mf">41.5</span><span class="p">,</span> <span class="mf">55.5</span><span class="p">,</span> <span class="mf">61.0</span><span class="p">,</span> <span class="mf">53.5</span><span class="p">])</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="n">sppnames</span><span class="p">,</span> <span class="s2">&quot;brain&quot;</span><span class="p">:</span> <span class="n">brainvolcc</span><span class="p">,</span> <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="n">masskg</span><span class="p">})</span>

<span class="n">d</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>species</th>
      <th>brain</th>
      <th>mass</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>afarensis</td>
      <td>438</td>
      <td>37.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>africanus</td>
      <td>452</td>
      <td>35.5</td>
    </tr>
    <tr>
      <th>2</th>
      <td>habilis</td>
      <td>612</td>
      <td>34.5</td>
    </tr>
    <tr>
      <th>3</th>
      <td>boisei</td>
      <td>521</td>
      <td>41.5</td>
    </tr>
    <tr>
      <th>4</th>
      <td>rudolfensis</td>
      <td>752</td>
      <td>55.5</td>
    </tr>
    <tr>
      <th>5</th>
      <td>ergaster</td>
      <td>871</td>
      <td>61.0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>sapiens</td>
      <td>1350</td>
      <td>53.5</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Reproducing the figure in the book (there is no code fragment for this in R in the book)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">mass</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">brain</span><span class="p">,</span> <span class="n">facecolors</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">70</span><span class="p">),</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;body mass (kg)&quot;</span><span class="p">,</span>
              <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span><span class="mi">1400</span><span class="p">),</span>
              <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;brain volume (cc)&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">species</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">mass</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">d</span><span class="o">.</span><span class="n">brain</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/07_ulysses_compass_11_0.png" src="../_images/07_ulysses_compass_11_0.png" />
</div>
</div>
</div>
<div class="section" id="code-7-2">
<h4>Code 7.2<a class="headerlink" href="#code-7-2" title="Permalink to this headline">¶</a></h4>
<p>Author talks about linear vs polynomial regression. He is of the opinion that most of the time polynomial regression is not a good idea (at least when used blindly). But why ?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;mass_std&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">mass</span> <span class="o">-</span> <span class="n">d</span><span class="o">.</span><span class="n">mass</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">d</span><span class="o">.</span><span class="n">mass</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">d</span><span class="p">[</span><span class="s2">&quot;brain_std&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">brain</span> <span class="o">/</span> <span class="n">d</span><span class="o">.</span><span class="n">brain</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tdf</span> <span class="o">=</span> <span class="n">dataframe_to_tensors</span><span class="p">(</span><span class="s2">&quot;Brain&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;mass_std&#39;</span><span class="p">,</span> <span class="s1">&#39;brain_std&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-01-18 03:04:09.416797: W tensorflow/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library &#39;libcuda.so.1&#39;; dlerror: libcuda.so.1: cannot open shared object file: No such file or directory
2022-01-18 03:04:09.416855: W tensorflow/stream_executor/cuda/cuda_driver.cc:269] failed call to cuInit: UNKNOWN ERROR (303)
2022-01-18 03:04:09.416878: I tensorflow/stream_executor/cuda/cuda_diagnostics.cc:156] kernel driver does not appear to be running on this host (fv-az269-271): /proc/driver/nvidia/version does not exist
2022-01-18 03:04:09.417185: I tensorflow/core/platform/cpu_feature_guard.cc:151] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  AVX2 FMA
To enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.
</pre></div>
</div>
</div>
</div>
<p>Note - brain is not standardized as such because you can not have -ive brain</p>
</div>
<div class="section" id="code-7-3">
<h4>Code 7.3<a class="headerlink" href="#code-7-3" title="Permalink to this headline">¶</a></h4>
<p>Simplest model is the linear one and this is what we will start with</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_7_1</span><span class="p">(</span><span class="n">mass_std</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;alpha&quot;</span><span class="p">)</span> <span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;beta&quot;</span><span class="p">)</span> <span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">)</span> <span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        
        <span class="n">mu</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">mass_std</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>        
        
        <span class="n">brain_std</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span>
            <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">scale</span><span class="p">)),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jdc_7_1</span> <span class="o">=</span> <span class="n">model_7_1</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">mass_std</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NUMBER_OF_CHAINS</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mf">0.5</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">]),</span>
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
<span class="p">]</span>

<span class="n">jdc</span> <span class="o">=</span> <span class="n">jdc_7_1</span>
<span class="n">observed_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">brain_std</span><span class="p">,</span> <span class="p">)</span>

<span class="n">posterior_7_1</span><span class="p">,</span> <span class="n">trace_7_1</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                    <span class="n">jdc</span><span class="p">,</span> 
                    <span class="n">observed_data</span><span class="o">=</span><span class="n">observed_data</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">],</span>
                    <span class="n">num_samples</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
                    <span class="n">burnin</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                    <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                    <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span>
                    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_7_1</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha</th>
      <td>0.529</td>
      <td>0.110</td>
      <td>0.364</td>
      <td>0.700</td>
      <td>0.002</td>
      <td>0.001</td>
      <td>2673.0</td>
      <td>2870.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>beta</th>
      <td>0.169</td>
      <td>0.122</td>
      <td>0.001</td>
      <td>0.362</td>
      <td>0.002</td>
      <td>0.002</td>
      <td>2313.0</td>
      <td>2916.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>-1.390</td>
      <td>0.377</td>
      <td>-2.016</td>
      <td>-0.881</td>
      <td>0.018</td>
      <td>0.015</td>
      <td>336.0</td>
      <td>151.0</td>
      <td>1.01</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(</span><span class="n">trace_7_1</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/07_ulysses_compass_21_0.png" src="../_images/07_ulysses_compass_21_0.png" />
</div>
</div>
</div>
<div class="section" id="code-7-4">
<h4>Code 7.4<a class="headerlink" href="#code-7-4" title="Permalink to this headline">¶</a></h4>
<p>OLS and Bayesian anti-essentialism.</p>
<p>Use OLS for the above model. Author has used R’s lm package so here we are using statsmodel (..sort of python counterpart to R’s lm package) to do oridinary least square.</p>
<p>The OLS from the non bayesian statistics is going to provide the point estimates (which would to some extent correspond to the mean (mu) if flat priors are used).</p>
<p>Note - In the text book you would see</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">m7</span><span class="mf">.1</span><span class="n">_OLS</span> <span class="o">&lt;-</span> <span class="n">lm</span><span class="p">(</span> <span class="n">brain_std</span> <span class="o">~</span> <span class="n">mass_std</span> <span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">d</span> <span class="p">)</span> 
<span class="n">post</span> <span class="o">&lt;-</span> <span class="n">extract</span><span class="o">.</span><span class="n">samples</span><span class="p">(</span> <span class="n">m7</span><span class="mf">.1</span><span class="n">_OLS</span> <span class="p">)</span>
</pre></div>
</div>
<p>extract.samples( m7.1_OLS ) is in the source file https://github.com/rmcelreath/rethinking/blob/master/R/map-quap-class.r</p>
<p>Below I have replicated the code for extract.samples for (non-bayesian OLS) using statsmodel &amp; tensorflow probabilty</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use statsmodel OLS</span>
<span class="n">m_7_1_OLS</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s1">&#39;brain_std ~ mass_std&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="n">m_7_1_OLS</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">m_7_1_OLS</span><span class="o">.</span><span class="n">cov_params</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(Intercept    0.528677
 mass_std     0.167118
 dtype: float64,
               Intercept      mass_std
 Intercept  4.980017e-03  3.981467e-19
 mass_std   3.981467e-19  5.810020e-03)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the mean of the two parameters (intercept &amp; coefficient for mass_std)</span>
<span class="c1"># and create the mu tensor</span>
<span class="n">mu</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">m_7_1_OLS</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="c1"># Get the variance-covariance matrix and create the cov tensor</span>
<span class="n">cov</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">m_7_1_OLS</span><span class="o">.</span><span class="n">cov_params</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># we can build a multivariate normal distribution using the mu &amp; cov obtained</span>
<span class="c1"># from the non bayesian land</span>
<span class="n">mvn</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">MultivariateNormalTriL</span><span class="p">(</span>
    <span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span>
    <span class="n">scale_tril</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">cov</span><span class="p">))</span>

<span class="n">posterior</span> <span class="o">=</span> <span class="n">mvn</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="code-7-5">
<h5>Code 7.5<a class="headerlink" href="#code-7-5" title="Permalink to this headline">¶</a></h5>
<p>Variance explained or <span class="math notranslate nohighlight">\(R^2\)</span> is defined as:</p>
<p><span class="math notranslate nohighlight">\(R^2\)</span> = 1 - <span class="math notranslate nohighlight">\(\frac{var(residuals)}{var(outcome)}\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We will have to simulate (compute) our posterior brain_std from the samples</span>
<span class="n">sample_alpha</span> <span class="o">=</span> <span class="n">posterior_7_1</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span>
<span class="n">sample_beta</span>  <span class="o">=</span> <span class="n">posterior_7_1</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span>
<span class="n">sample_sigma</span> <span class="o">=</span> <span class="n">posterior_7_1</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">]</span>

<span class="n">ds</span><span class="p">,</span> <span class="n">samples</span> <span class="o">=</span> <span class="n">jdc_7_1</span><span class="o">.</span><span class="n">sample_distributions</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span>
      <span class="n">sample_alpha</span><span class="p">,</span>
      <span class="n">sample_beta</span><span class="p">,</span> 
      <span class="n">sample_sigma</span><span class="p">,</span>
      <span class="kc">None</span>
    <span class="p">])</span>

<span class="n">sample_brain_std</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>

<span class="c1"># get the mean</span>
<span class="n">brain_std_mean</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">sample_brain_std</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># &lt;--note usage of axis 1</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">brain_std_mean</span> <span class="o">-</span> <span class="n">d</span><span class="o">.</span><span class="n">brain_std</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># compute the variance expained (R square)</span>
<span class="n">resid_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">outcome_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">brain_std</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="mi">1</span> <span class="o">-</span> <span class="n">resid_var</span> <span class="o">/</span> <span class="n">outcome_var</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.5213788651767998
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-7-6">
<h5>Code 7.6<a class="headerlink" href="#code-7-6" title="Permalink to this headline">¶</a></h5>
<p><span class="math notranslate nohighlight">\(R^2\)</span> is bad, the author says ! … here is  resuable function that will used multiple times later</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">RX_is_bad</span><span class="p">(</span><span class="n">jdc</span><span class="p">,</span> <span class="n">posterior</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>     
    
    <span class="n">sample_alpha</span> <span class="o">=</span> <span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span>
    <span class="n">sample_beta</span> <span class="o">=</span> <span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sample_sigma</span> <span class="o">=</span> <span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sample_sigma</span> <span class="o">=</span> <span class="mf">0.001</span>  <span class="c1"># model number 6</span>
        
    <span class="n">ds</span><span class="p">,</span> <span class="n">samples</span> <span class="o">=</span> <span class="n">jdc</span><span class="o">.</span><span class="n">sample_distributions</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span>
      <span class="n">sample_alpha</span><span class="p">,</span> 
      <span class="n">sample_beta</span><span class="p">,</span> 
      <span class="n">sample_sigma</span><span class="p">,</span>
      <span class="kc">None</span>
    <span class="p">])</span>

    <span class="n">sample_brain_std</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>

    <span class="c1"># get the mean</span>
    <span class="n">brain_std_mean</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">sample_brain_std</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># &lt;--note usage of axis 1</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">brain_std_mean</span> <span class="o">-</span> <span class="n">d</span><span class="o">.</span><span class="n">brain_std</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># compute the variance expained (R square)</span>
    <span class="n">resid_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">outcome_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">brain_std</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="mi">1</span> <span class="o">-</span> <span class="n">resid_var</span> <span class="o">/</span> <span class="n">outcome_var</span>
        
    <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">resid_var</span> <span class="o">/</span> <span class="n">outcome_var</span> 
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-7-7">
<h5>Code 7.7<a class="headerlink" href="#code-7-7" title="Permalink to this headline">¶</a></h5>
<p>Building some more models to compare to m7.1</p>
<p>This one is a poymomial of second degree</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_7_2</span><span class="p">(</span><span class="n">mass_std</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;alpha&quot;</span><span class="p">)</span> <span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;beta&quot;</span><span class="p">)</span> <span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">)</span> <span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        
        <span class="n">beta1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">beta2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
        
        <span class="n">mu</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta1</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">mass_std</span> <span class="o">+</span> \
                                     <span class="n">beta2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">mass_std</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        
        <span class="n">scale</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>        
        
        <span class="n">brain_std</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span>
            <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">scale</span><span class="p">)),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># will use this method for various models</span>
<span class="k">def</span> <span class="nf">compute_brain_body_posterior_for_simulation</span><span class="p">(</span><span class="n">beta_degree</span><span class="p">,</span> <span class="n">jdc</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">beta_degree</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>        
        <span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
            <span class="mf">0.5</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">]),</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">]),</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">]),</span>
        <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>    
        <span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
            <span class="mf">0.5</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">]),</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">,</span> <span class="n">beta_degree</span><span class="p">]),</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">]),</span>
        <span class="p">]</span>

    <span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
        <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
        <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="p">]</span>
    
    <span class="n">observed_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">brain_std</span><span class="p">,)</span>

    <span class="n">posterior</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
            <span class="n">jdc</span><span class="p">,</span> 
            <span class="n">observed_data</span><span class="o">=</span><span class="n">observed_data</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">],</span>
            <span class="n">num_samples</span><span class="o">=</span><span class="mi">4000</span><span class="p">,</span>
            <span class="n">burnin</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
            <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
            <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">posterior</span><span class="p">,</span> <span class="n">trace</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-7-8">
<h5>Code 7.8<a class="headerlink" href="#code-7-8" title="Permalink to this headline">¶</a></h5>
<p>Models of 3rd, 4th and 5th degrees</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_7_3</span><span class="p">(</span><span class="n">mass_std</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;alpha&quot;</span><span class="p">)</span> <span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;beta&quot;</span><span class="p">)</span> <span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">)</span> <span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        
        <span class="n">beta1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">beta2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">beta3</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
        
        <span class="n">mu</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta1</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">mass_std</span> <span class="o">+</span> \
                                     <span class="n">beta2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">mass_std</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> \
                                     <span class="n">beta3</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">mass_std</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span>
        
        <span class="n">scale</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>        
        
        <span class="n">brain_std</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span>
            <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">scale</span><span class="p">)),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                                          
                                          
<span class="k">def</span> <span class="nf">model_7_4</span><span class="p">(</span><span class="n">mass_std</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;alpha&quot;</span><span class="p">)</span> <span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;beta&quot;</span><span class="p">)</span> <span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">)</span> <span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        
        <span class="n">beta1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">beta2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">beta3</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">beta4</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>                                          
        
        <span class="n">mu</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta1</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">mass_std</span> <span class="o">+</span> \
                                     <span class="n">beta2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">mass_std</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> \
                                     <span class="n">beta3</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">mass_std</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> \
                                     <span class="n">beta4</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">mass_std</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> 
        
        <span class="n">scale</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>        
        
        <span class="n">brain_std</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span>
            <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">scale</span><span class="p">)),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">model_7_5</span><span class="p">(</span><span class="n">mass_std</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;alpha&quot;</span><span class="p">)</span> <span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;beta&quot;</span><span class="p">)</span> <span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">)</span> <span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        
        <span class="n">beta1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">beta2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">beta3</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">beta4</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>                                        
        <span class="n">beta5</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>                                        
        
        <span class="n">mu</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta1</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">mass_std</span> <span class="o">+</span> \
                                     <span class="n">beta2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">mass_std</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> \
                                     <span class="n">beta3</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">mass_std</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> \
                                     <span class="n">beta4</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">mass_std</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> \
                                     <span class="n">beta5</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">mass_std</span> <span class="o">**</span> <span class="mi">5</span><span class="p">)</span>
        
        <span class="n">scale</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>        
        
        <span class="n">brain_std</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span>
            <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">scale</span><span class="p">)),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-7-9">
<h5>Code 7.9<a class="headerlink" href="#code-7-9" title="Permalink to this headline">¶</a></h5>
<p>This one is of degree 6 but the standard deviation has been replaced with constant 0.001. The author mentions that otherwise it will not work and will be explained with the help of plot later</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_7_6</span><span class="p">(</span><span class="n">mass_std</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;alpha&quot;</span><span class="p">)</span> <span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;beta&quot;</span><span class="p">)</span> <span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">6</span><span class="p">))</span>        
        
        <span class="n">beta1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">beta2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">beta3</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">beta4</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>                                        
        <span class="n">beta5</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>    
        <span class="n">beta6</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>    
        
        <span class="n">mu</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta1</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">mass_std</span> <span class="o">+</span> \
                                     <span class="n">beta2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">mass_std</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> \
                                     <span class="n">beta3</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">mass_std</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> \
                                     <span class="n">beta4</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">mass_std</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> \
                                     <span class="n">beta5</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">mass_std</span> <span class="o">**</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> \
                                     <span class="n">beta6</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">mass_std</span> <span class="o">**</span> <span class="mi">6</span><span class="p">)</span>        
        
        
        <span class="n">brain_std</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span>
            <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.001</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># for this method we need to compute the posterior differently as the model is different in terms of params</span>
<span class="k">def</span> <span class="nf">compute_posterior_for_76_simulation</span><span class="p">(</span><span class="n">jdc_7_6</span><span class="p">):</span>    

    <span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
        <span class="mf">0.5</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">]),</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
    <span class="p">]</span>

    <span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
        <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
    <span class="p">]</span>
    
    <span class="n">observed_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">brain_std</span><span class="p">,)</span>

    <span class="n">posterior_7_6</span><span class="p">,</span> <span class="n">trace_7_6</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                    <span class="n">jdc_7_6</span><span class="p">,</span> 
                    <span class="n">observed_data</span><span class="o">=</span><span class="n">observed_data</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">],</span>
                    <span class="n">num_samples</span><span class="o">=</span><span class="mi">4000</span><span class="p">,</span>
                    <span class="n">burnin</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                    <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                    <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">posterior_7_6</span><span class="p">,</span> <span class="n">trace_7_6</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-7-10">
<h5>Code 7.10<a class="headerlink" href="#code-7-10" title="Permalink to this headline">¶</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jdc_7_1</span> <span class="o">=</span> <span class="n">model_7_1</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">mass_std</span><span class="p">)</span>
<span class="n">jdc_7_2</span> <span class="o">=</span> <span class="n">model_7_2</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">mass_std</span><span class="p">)</span>
<span class="n">jdc_7_3</span> <span class="o">=</span> <span class="n">model_7_3</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">mass_std</span><span class="p">)</span>
<span class="n">jdc_7_4</span> <span class="o">=</span> <span class="n">model_7_4</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">mass_std</span><span class="p">)</span>
<span class="n">jdc_7_5</span> <span class="o">=</span> <span class="n">model_7_5</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">mass_std</span><span class="p">)</span>    
<span class="n">jdc_7_6</span> <span class="o">=</span> <span class="n">model_7_6</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">mass_std</span><span class="p">)</span>    

<span class="n">posterior_7_1</span><span class="p">,</span> <span class="n">trace_7_1</span> <span class="o">=</span> <span class="n">compute_brain_body_posterior_for_simulation</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">jdc_7_1</span><span class="p">)</span>
<span class="n">posterior_7_2</span><span class="p">,</span> <span class="n">trace_7_2</span> <span class="o">=</span> <span class="n">compute_brain_body_posterior_for_simulation</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">jdc_7_2</span><span class="p">)</span>
<span class="n">posterior_7_3</span><span class="p">,</span> <span class="n">trace_7_3</span> <span class="o">=</span> <span class="n">compute_brain_body_posterior_for_simulation</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">jdc_7_3</span><span class="p">)</span>
<span class="n">posterior_7_4</span><span class="p">,</span> <span class="n">trace_7_4</span> <span class="o">=</span> <span class="n">compute_brain_body_posterior_for_simulation</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">jdc_7_4</span><span class="p">)</span>
<span class="n">posterior_7_5</span><span class="p">,</span> <span class="n">trace_7_5</span> <span class="o">=</span> <span class="n">compute_brain_body_posterior_for_simulation</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">jdc_7_5</span><span class="p">)</span>

<span class="n">posterior_7_6</span><span class="p">,</span> <span class="n">trace_7_6</span> <span class="o">=</span> <span class="n">compute_posterior_for_76_simulation</span><span class="p">(</span><span class="n">jdc_7_6</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">ipykernel_2002</span><span class="o">/</span><span class="mf">3035999005.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span> <span class="n">posterior_7_2</span><span class="p">,</span> <span class="n">trace_7_2</span> <span class="o">=</span> <span class="n">compute_brain_body_posterior_for_simulation</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">jdc_7_2</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span> <span class="n">posterior_7_3</span><span class="p">,</span> <span class="n">trace_7_3</span> <span class="o">=</span> <span class="n">compute_brain_body_posterior_for_simulation</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">jdc_7_3</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">11</span> <span class="n">posterior_7_4</span><span class="p">,</span> <span class="n">trace_7_4</span> <span class="o">=</span> <span class="n">compute_brain_body_posterior_for_simulation</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">jdc_7_4</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">12</span> <span class="n">posterior_7_5</span><span class="p">,</span> <span class="n">trace_7_5</span> <span class="o">=</span> <span class="n">compute_brain_body_posterior_for_simulation</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">jdc_7_5</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span> 

<span class="nn">/tmp/ipykernel_2002/2077961507.py</span> in <span class="ni">compute_brain_body_posterior_for_simulation</span><span class="nt">(beta_degree, jdc)</span>
<span class="g g-Whitespace">     </span><span class="mi">30</span>             <span class="n">burnin</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">31</span>             <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
<span class="ne">---&gt; </span><span class="mi">32</span>             <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">33</span> 
<span class="g g-Whitespace">     </span><span class="mi">34</span>     <span class="k">return</span> <span class="n">posterior</span><span class="p">,</span> <span class="n">trace</span>

<span class="nn">~/work/rethinking-tensorflow-probability/rethinking-tensorflow-probability/rethinking/mcmc/_helpers.py</span> in <span class="ni">sample_posterior</span><span class="nt">(jdc, observed_data, params, init_state, bijectors, step_size, num_chains, num_samples, burnin)</span>
<span class="g g-Whitespace">    </span><span class="mi">108</span>         <span class="n">target_log_prob_fn</span><span class="o">=</span><span class="n">target_log_prob_fn</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">109</span>         <span class="n">num_samples</span><span class="o">=</span><span class="n">num_samples</span><span class="p">,</span>
<span class="ne">--&gt; </span><span class="mi">110</span>         <span class="n">burnin</span><span class="o">=</span><span class="n">burnin</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">111</span>     <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">112</span> 

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/util/traceback_utils.py</span> in <span class="ni">error_handler</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">148</span>     <span class="n">filtered_tb</span> <span class="o">=</span> <span class="kc">None</span>
<span class="g g-Whitespace">    </span><span class="mi">149</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">150</span>       <span class="k">return</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">151</span>     <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">152</span>       <span class="n">filtered_tb</span> <span class="o">=</span> <span class="n">_process_traceback_frames</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">)</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/eager/def_function.py</span> in <span class="ni">__call__</span><span class="nt">(self, *args, **kwds)</span>
<span class="g g-Whitespace">    </span><span class="mi">908</span> 
<span class="g g-Whitespace">    </span><span class="mi">909</span>       <span class="k">with</span> <span class="n">OptionalXlaContext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jit_compile</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">910</span>         <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">911</span> 
<span class="g g-Whitespace">    </span><span class="mi">912</span>       <span class="n">new_tracing_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experimental_get_tracing_count</span><span class="p">()</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/eager/def_function.py</span> in <span class="ni">_call</span><span class="nt">(self, *args, **kwds)</span>
<span class="g g-Whitespace">    </span><span class="mi">947</span>       <span class="c1"># In this case we have not created variables on the first call. So we can</span>
<span class="g g-Whitespace">    </span><span class="mi">948</span>       <span class="c1"># run the first trace but we should fail if variables are created.</span>
<span class="ne">--&gt; </span><span class="mi">949</span>       <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stateful_fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">950</span>       <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_created_variables</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ALLOW_DYNAMIC_VARIABLE_CREATION</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">951</span>         <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Creating variables on a non-first call to a function&quot;</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/eager/function.py</span> in <span class="ni">__call__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">3127</span>     <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">3128</span>       <span class="p">(</span><span class="n">graph_function</span><span class="p">,</span>
<span class="ne">-&gt; </span><span class="mi">3129</span>        <span class="n">filtered_flat_args</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maybe_define_function</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">3130</span>     <span class="k">return</span> <span class="n">graph_function</span><span class="o">.</span><span class="n">_call_flat</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">3131</span>         <span class="n">filtered_flat_args</span><span class="p">,</span> <span class="n">captured_inputs</span><span class="o">=</span><span class="n">graph_function</span><span class="o">.</span><span class="n">captured_inputs</span><span class="p">)</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/eager/function.py</span> in <span class="ni">_maybe_define_function</span><span class="nt">(self, args, kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">3555</span> 
<span class="g g-Whitespace">   </span><span class="mi">3556</span>           <span class="bp">self</span><span class="o">.</span><span class="n">_function_cache</span><span class="o">.</span><span class="n">missed</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">call_context_key</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">3557</span>           <span class="n">graph_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_graph_function</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">3558</span>           <span class="bp">self</span><span class="o">.</span><span class="n">_function_cache</span><span class="o">.</span><span class="n">primary</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">graph_function</span>
<span class="g g-Whitespace">   </span><span class="mi">3559</span> 

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/eager/function.py</span> in <span class="ni">_create_graph_function</span><span class="nt">(self, args, kwargs, override_flat_arg_shapes)</span>
<span class="g g-Whitespace">   </span><span class="mi">3400</span>             <span class="n">arg_names</span><span class="o">=</span><span class="n">arg_names</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">3401</span>             <span class="n">override_flat_arg_shapes</span><span class="o">=</span><span class="n">override_flat_arg_shapes</span><span class="p">,</span>
<span class="ne">-&gt; </span><span class="mi">3402</span>             <span class="n">capture_by_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_capture_by_value</span><span class="p">),</span>
<span class="g g-Whitespace">   </span><span class="mi">3403</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_function_attributes</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">3404</span>         <span class="n">function_spec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spec</span><span class="p">,</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/framework/func_graph.py</span> in <span class="ni">func_graph_from_py_func</span><span class="nt">(name, python_func, args, kwargs, signature, func_graph, autograph, autograph_options, add_control_dependencies, arg_names, op_return_value, collections, capture_by_value, override_flat_arg_shapes, acd_record_initial_resource_uses)</span>
<span class="g g-Whitespace">   </span><span class="mi">1141</span>         <span class="n">_</span><span class="p">,</span> <span class="n">original_func</span> <span class="o">=</span> <span class="n">tf_decorator</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">python_func</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1142</span> 
<span class="ne">-&gt; </span><span class="mi">1143</span>       <span class="n">func_outputs</span> <span class="o">=</span> <span class="n">python_func</span><span class="p">(</span><span class="o">*</span><span class="n">func_args</span><span class="p">,</span> <span class="o">**</span><span class="n">func_kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1144</span> 
<span class="g g-Whitespace">   </span><span class="mi">1145</span>       <span class="c1"># invariant: `func_outputs` contains only Tensors, CompositeTensors,</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/eager/def_function.py</span> in <span class="ni">wrapped_fn</span><span class="nt">(*args, **kwds)</span>
<span class="g g-Whitespace">    </span><span class="mi">670</span>         <span class="c1"># the function a weak reference to itself to avoid a reference cycle.</span>
<span class="g g-Whitespace">    </span><span class="mi">671</span>         <span class="k">with</span> <span class="n">OptionalXlaContext</span><span class="p">(</span><span class="n">compile_with_xla</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">672</span>           <span class="n">out</span> <span class="o">=</span> <span class="n">weak_wrapped_fn</span><span class="p">()</span><span class="o">.</span><span class="n">__wrapped__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">673</span>         <span class="k">return</span> <span class="n">out</span>
<span class="g g-Whitespace">    </span><span class="mi">674</span> 

<span class="nn">~/work/rethinking-tensorflow-probability/rethinking-tensorflow-probability/rethinking/mcmc/_helpers.py</span> in <span class="ni">run_hmc_chain</span><span class="nt">(init_state, bijectors, step_size, target_log_prob_fn, num_leapfrog_steps, num_samples, burnin)</span>
<span class="g g-Whitespace">     </span><span class="mi">76</span>         <span class="n">current_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">77</span>         <span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span>
<span class="ne">---&gt; </span><span class="mi">78</span>         <span class="n">trace_fn</span><span class="o">=</span><span class="n">_trace_fn_transitioned</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">79</span>     <span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">80</span> 

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow_probability/python/mcmc/sample.py</span> in <span class="ni">sample_chain</span><span class="nt">(num_results, current_state, previous_kernel_results, kernel, num_burnin_steps, num_steps_between_results, trace_fn, return_final_kernel_results, parallel_iterations, seed, name)</span>
<span class="g g-Whitespace">    </span><span class="mi">370</span>             <span class="n">seed_state_and_results</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">trace_fn</span><span class="p">(</span><span class="o">*</span><span class="n">seed_state_and_results</span><span class="p">[</span><span class="mi">1</span><span class="p">:])),</span>
<span class="g g-Whitespace">    </span><span class="mi">371</span>         <span class="c1"># pylint: enable=g-long-lambda</span>
<span class="ne">--&gt; </span><span class="mi">372</span>         <span class="n">parallel_iterations</span><span class="o">=</span><span class="n">parallel_iterations</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">373</span> 
<span class="g g-Whitespace">    </span><span class="mi">374</span>     <span class="k">if</span> <span class="n">return_final_kernel_results</span><span class="p">:</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow_probability/python/internal/loop_util.py</span> in <span class="ni">trace_scan</span><span class="nt">(loop_fn, initial_state, elems, trace_fn, trace_criterion_fn, static_trace_allocation_size, condition_fn, parallel_iterations, name)</span>
<span class="g g-Whitespace">    </span><span class="mi">221</span>         <span class="n">body</span><span class="o">=</span><span class="n">_body</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">222</span>         <span class="n">loop_vars</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">initial_state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">trace_arrays</span><span class="p">),</span>
<span class="ne">--&gt; </span><span class="mi">223</span>         <span class="n">parallel_iterations</span><span class="o">=</span><span class="n">parallel_iterations</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">224</span> 
<span class="g g-Whitespace">    </span><span class="mi">225</span>     <span class="c1"># unflatten</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/util/deprecation.py</span> in <span class="ni">new_func</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">618</span>                   <span class="n">func</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="n">arg_name</span><span class="p">,</span> <span class="n">arg_value</span><span class="p">,</span> <span class="s1">&#39;in a future version&#39;</span>
<span class="g g-Whitespace">    </span><span class="mi">619</span>                   <span class="k">if</span> <span class="n">date</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;after </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">date</span><span class="p">),</span> <span class="n">instructions</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">620</span>       <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">621</span> 
<span class="g g-Whitespace">    </span><span class="mi">622</span>     <span class="n">doc</span> <span class="o">=</span> <span class="n">_add_deprecated_arg_value_notice_to_docstring</span><span class="p">(</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/ops/control_flow_ops.py</span> in <span class="ni">while_loop_v2</span><span class="nt">(cond, body, loop_vars, shape_invariants, parallel_iterations, back_prop, swap_memory, maximum_iterations, name)</span>
<span class="g g-Whitespace">   </span><span class="mi">2556</span>       <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2557</span>       <span class="n">maximum_iterations</span><span class="o">=</span><span class="n">maximum_iterations</span><span class="p">,</span>
<span class="ne">-&gt; </span><span class="mi">2558</span>       <span class="n">return_same_structure</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2559</span> 
<span class="g g-Whitespace">   </span><span class="mi">2560</span> 

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/ops/control_flow_ops.py</span> in <span class="ni">while_loop</span><span class="nt">(cond, body, loop_vars, shape_invariants, parallel_iterations, back_prop, swap_memory, name, maximum_iterations, return_same_structure)</span>
<span class="g g-Whitespace">   </span><span class="mi">2753</span>         <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2754</span>         <span class="n">return_same_structure</span><span class="o">=</span><span class="n">return_same_structure</span><span class="p">,</span>
<span class="ne">-&gt; </span><span class="mi">2755</span>         <span class="n">back_prop</span><span class="o">=</span><span class="n">back_prop</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2756</span> 
<span class="g g-Whitespace">   </span><span class="mi">2757</span>   <span class="k">with</span> <span class="n">ops</span><span class="o">.</span><span class="n">name_scope</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;while&quot;</span><span class="p">,</span> <span class="n">loop_vars</span><span class="p">):</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/ops/while_v2.py</span> in <span class="ni">while_loop</span><span class="nt">(cond, body, loop_vars, shape_invariants, parallel_iterations, maximum_iterations, name, return_same_structure, back_prop)</span>
<span class="g g-Whitespace">    </span><span class="mi">221</span>             <span class="n">body_name</span><span class="p">,</span> <span class="n">collections</span><span class="o">=</span><span class="n">ops</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span><span class="o">.</span><span class="n">_collections</span><span class="p">),</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">222</span>         <span class="n">add_control_dependencies</span><span class="o">=</span><span class="n">add_control_dependencies</span><span class="p">,</span>
<span class="ne">--&gt; </span><span class="mi">223</span>         <span class="n">acd_record_initial_resource_uses</span><span class="o">=</span><span class="n">stateful_parallelism</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">224</span>     <span class="c1"># Add external captures of body to the list of loop vars.</span>
<span class="g g-Whitespace">    </span><span class="mi">225</span>     <span class="c1"># Note that external tensors will be treated as loop invariants, i.e.,</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/framework/func_graph.py</span> in <span class="ni">func_graph_from_py_func</span><span class="nt">(name, python_func, args, kwargs, signature, func_graph, autograph, autograph_options, add_control_dependencies, arg_names, op_return_value, collections, capture_by_value, override_flat_arg_shapes, acd_record_initial_resource_uses)</span>
<span class="g g-Whitespace">   </span><span class="mi">1141</span>         <span class="n">_</span><span class="p">,</span> <span class="n">original_func</span> <span class="o">=</span> <span class="n">tf_decorator</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">python_func</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1142</span> 
<span class="ne">-&gt; </span><span class="mi">1143</span>       <span class="n">func_outputs</span> <span class="o">=</span> <span class="n">python_func</span><span class="p">(</span><span class="o">*</span><span class="n">func_args</span><span class="p">,</span> <span class="o">**</span><span class="n">func_kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1144</span> 
<span class="g g-Whitespace">   </span><span class="mi">1145</span>       <span class="c1"># invariant: `func_outputs` contains only Tensors, CompositeTensors,</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/ops/while_v2.py</span> in <span class="ni">wrapped_body</span><span class="nt">(loop_counter, maximum_iterations_arg, *args)</span>
<span class="g g-Whitespace">    </span><span class="mi">198</span>       <span class="c1"># `orig_loop_vars` and `args`, converts flows in `args` to TensorArrays</span>
<span class="g g-Whitespace">    </span><span class="mi">199</span>       <span class="c1"># and packs it into the structure of `orig_loop_vars`.</span>
<span class="ne">--&gt; </span><span class="mi">200</span>       <span class="n">outputs</span> <span class="o">=</span> <span class="n">body</span><span class="p">(</span><span class="o">*</span><span class="n">_pack_sequence_as</span><span class="p">(</span><span class="n">orig_loop_vars</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">201</span>       <span class="k">if</span> <span class="ow">not</span> <span class="n">nest</span><span class="o">.</span><span class="n">is_sequence_or_composite</span><span class="p">(</span><span class="n">outputs</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">202</span>         <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">outputs</span><span class="p">]</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow_probability/python/internal/loop_util.py</span> in <span class="ni">_body</span><span class="nt">(i, state, num_steps_traced, trace_arrays)</span>
<span class="g g-Whitespace">    </span><span class="mi">202</span>     <span class="k">def</span> <span class="nf">_body</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">num_steps_traced</span><span class="p">,</span> <span class="n">trace_arrays</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">203</span>       <span class="n">elem</span> <span class="o">=</span> <span class="n">elems_array</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">204</span>       <span class="n">state</span> <span class="o">=</span> <span class="n">loop_fn</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">elem</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">205</span> 
<span class="g g-Whitespace">    </span><span class="mi">206</span>       <span class="n">trace_arrays</span><span class="p">,</span> <span class="n">num_steps_traced</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow_probability/python/mcmc/sample.py</span> in <span class="ni">_trace_scan_fn</span><span class="nt">(seed_state_and_results, num_steps)</span>
<span class="g g-Whitespace">    </span><span class="mi">354</span>           <span class="n">body_fn</span><span class="o">=</span><span class="n">_seeded_one_step</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">355</span>           <span class="n">initial_loop_vars</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">seed_state_and_results</span><span class="p">),</span>
<span class="ne">--&gt; </span><span class="mi">356</span>           <span class="n">parallel_iterations</span><span class="o">=</span><span class="n">parallel_iterations</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">357</span>       <span class="k">return</span> <span class="n">seed</span><span class="p">,</span> <span class="n">next_state</span><span class="p">,</span> <span class="n">current_kernel_results</span>
<span class="g g-Whitespace">    </span><span class="mi">358</span> 

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow_probability/python/internal/loop_util.py</span> in <span class="ni">smart_for_loop</span><span class="nt">(loop_num_iter, body_fn, initial_loop_vars, parallel_iterations, unroll_threshold, name)</span>
<span class="g g-Whitespace">     </span><span class="mi">92</span>           <span class="n">body</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">body_fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)),</span>
<span class="g g-Whitespace">     </span><span class="mi">93</span>           <span class="n">loop_vars</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span> <span class="o">+</span> <span class="n">initial_loop_vars</span><span class="p">,</span>
<span class="ne">---&gt; </span><span class="mi">94</span>           <span class="n">parallel_iterations</span><span class="o">=</span><span class="n">parallel_iterations</span>
<span class="g g-Whitespace">     </span><span class="mi">95</span>       <span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
<span class="g g-Whitespace">     </span><span class="mi">96</span>     <span class="n">result</span> <span class="o">=</span> <span class="n">initial_loop_vars</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/util/deprecation.py</span> in <span class="ni">new_func</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">618</span>                   <span class="n">func</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="n">arg_name</span><span class="p">,</span> <span class="n">arg_value</span><span class="p">,</span> <span class="s1">&#39;in a future version&#39;</span>
<span class="g g-Whitespace">    </span><span class="mi">619</span>                   <span class="k">if</span> <span class="n">date</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;after </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">date</span><span class="p">),</span> <span class="n">instructions</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">620</span>       <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">621</span> 
<span class="g g-Whitespace">    </span><span class="mi">622</span>     <span class="n">doc</span> <span class="o">=</span> <span class="n">_add_deprecated_arg_value_notice_to_docstring</span><span class="p">(</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/ops/control_flow_ops.py</span> in <span class="ni">while_loop_v2</span><span class="nt">(cond, body, loop_vars, shape_invariants, parallel_iterations, back_prop, swap_memory, maximum_iterations, name)</span>
<span class="g g-Whitespace">   </span><span class="mi">2556</span>       <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2557</span>       <span class="n">maximum_iterations</span><span class="o">=</span><span class="n">maximum_iterations</span><span class="p">,</span>
<span class="ne">-&gt; </span><span class="mi">2558</span>       <span class="n">return_same_structure</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2559</span> 
<span class="g g-Whitespace">   </span><span class="mi">2560</span> 

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/ops/control_flow_ops.py</span> in <span class="ni">while_loop</span><span class="nt">(cond, body, loop_vars, shape_invariants, parallel_iterations, back_prop, swap_memory, name, maximum_iterations, return_same_structure)</span>
<span class="g g-Whitespace">   </span><span class="mi">2753</span>         <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2754</span>         <span class="n">return_same_structure</span><span class="o">=</span><span class="n">return_same_structure</span><span class="p">,</span>
<span class="ne">-&gt; </span><span class="mi">2755</span>         <span class="n">back_prop</span><span class="o">=</span><span class="n">back_prop</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2756</span> 
<span class="g g-Whitespace">   </span><span class="mi">2757</span>   <span class="k">with</span> <span class="n">ops</span><span class="o">.</span><span class="n">name_scope</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;while&quot;</span><span class="p">,</span> <span class="n">loop_vars</span><span class="p">):</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/ops/while_v2.py</span> in <span class="ni">while_loop</span><span class="nt">(cond, body, loop_vars, shape_invariants, parallel_iterations, maximum_iterations, name, return_same_structure, back_prop)</span>
<span class="g g-Whitespace">    </span><span class="mi">221</span>             <span class="n">body_name</span><span class="p">,</span> <span class="n">collections</span><span class="o">=</span><span class="n">ops</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span><span class="o">.</span><span class="n">_collections</span><span class="p">),</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">222</span>         <span class="n">add_control_dependencies</span><span class="o">=</span><span class="n">add_control_dependencies</span><span class="p">,</span>
<span class="ne">--&gt; </span><span class="mi">223</span>         <span class="n">acd_record_initial_resource_uses</span><span class="o">=</span><span class="n">stateful_parallelism</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">224</span>     <span class="c1"># Add external captures of body to the list of loop vars.</span>
<span class="g g-Whitespace">    </span><span class="mi">225</span>     <span class="c1"># Note that external tensors will be treated as loop invariants, i.e.,</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/framework/func_graph.py</span> in <span class="ni">func_graph_from_py_func</span><span class="nt">(name, python_func, args, kwargs, signature, func_graph, autograph, autograph_options, add_control_dependencies, arg_names, op_return_value, collections, capture_by_value, override_flat_arg_shapes, acd_record_initial_resource_uses)</span>
<span class="g g-Whitespace">   </span><span class="mi">1146</span>       <span class="c1"># TensorArrays and `None`s.</span>
<span class="g g-Whitespace">   </span><span class="mi">1147</span>       <span class="n">func_outputs</span> <span class="o">=</span> <span class="n">nest</span><span class="o">.</span><span class="n">map_structure</span><span class="p">(</span><span class="n">convert</span><span class="p">,</span> <span class="n">func_outputs</span><span class="p">,</span>
<span class="ne">-&gt; </span><span class="mi">1148</span>                                         <span class="n">expand_composites</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1149</span> 
<span class="g g-Whitespace">   </span><span class="mi">1150</span>       <span class="n">check_mutation</span><span class="p">(</span><span class="n">func_args_before</span><span class="p">,</span> <span class="n">func_args</span><span class="p">,</span> <span class="n">original_func</span><span class="p">)</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/util/nest.py</span> in <span class="ni">map_structure</span><span class="nt">(func, *structure, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">867</span> 
<span class="g g-Whitespace">    </span><span class="mi">868</span>   <span class="k">return</span> <span class="n">pack_sequence_as</span><span class="p">(</span>
<span class="ne">--&gt; </span><span class="mi">869</span>       <span class="n">structure</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">],</span>
<span class="g g-Whitespace">    </span><span class="mi">870</span>       <span class="n">expand_composites</span><span class="o">=</span><span class="n">expand_composites</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">871</span> 

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/util/nest.py</span> in <span class="ni">&lt;listcomp&gt;</span><span class="nt">(.0)</span>
<span class="g g-Whitespace">    </span><span class="mi">867</span> 
<span class="g g-Whitespace">    </span><span class="mi">868</span>   <span class="k">return</span> <span class="n">pack_sequence_as</span><span class="p">(</span>
<span class="ne">--&gt; </span><span class="mi">869</span>       <span class="n">structure</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">],</span>
<span class="g g-Whitespace">    </span><span class="mi">870</span>       <span class="n">expand_composites</span><span class="o">=</span><span class="n">expand_composites</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">871</span> 

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/framework/func_graph.py</span> in <span class="ni">convert</span><span class="nt">(x)</span>
<span class="g g-Whitespace">   </span><span class="mi">1104</span>               <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">python_func</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
<span class="g g-Whitespace">   </span><span class="mi">1105</span>       <span class="k">if</span> <span class="n">add_control_dependencies</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1106</span>         <span class="n">x</span> <span class="o">=</span> <span class="n">deps_ctx</span><span class="o">.</span><span class="n">mark_as_return</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1107</span>       <span class="k">return</span> <span class="n">x</span>
<span class="g g-Whitespace">   </span><span class="mi">1108</span> 

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/framework/auto_control_deps.py</span> in <span class="ni">mark_as_return</span><span class="nt">(self, tensor)</span>
<span class="g g-Whitespace">    </span><span class="mi">230</span>     <span class="c1"># of a new identity operation that the stateful operations definitely don&#39;t</span>
<span class="g g-Whitespace">    </span><span class="mi">231</span>     <span class="c1"># depend on.</span>
<span class="ne">--&gt; </span><span class="mi">232</span>     <span class="n">tensor</span> <span class="o">=</span> <span class="n">array_ops</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">233</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_returned_tensors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">234</span>     <span class="k">return</span> <span class="n">tensor</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/util/traceback_utils.py</span> in <span class="ni">error_handler</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">148</span>     <span class="n">filtered_tb</span> <span class="o">=</span> <span class="kc">None</span>
<span class="g g-Whitespace">    </span><span class="mi">149</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">150</span>       <span class="k">return</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">151</span>     <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">152</span>       <span class="n">filtered_tb</span> <span class="o">=</span> <span class="n">_process_traceback_frames</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">)</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/util/dispatch.py</span> in <span class="ni">op_dispatch_handler</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1094</span>       <span class="c1"># Fallback dispatch system (dispatch v1):</span>
<span class="g g-Whitespace">   </span><span class="mi">1095</span>       <span class="k">try</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1096</span>         <span class="k">return</span> <span class="n">dispatch_target</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1097</span>       <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1098</span>         <span class="c1"># Note: convert_to_eager_tensor currently raises a ValueError, not a</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/ops/array_ops.py</span> in <span class="ni">identity</span><span class="nt">(input, name)</span>
<span class="g g-Whitespace">    </span><span class="mi">288</span>     <span class="c1"># variables. Variables have correct handle data when graph building.</span>
<span class="g g-Whitespace">    </span><span class="mi">289</span>     <span class="nb">input</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">convert_to_tensor</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">290</span>   <span class="n">ret</span> <span class="o">=</span> <span class="n">gen_array_ops</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">291</span>   <span class="c1"># Propagate handle data for happier shape inference for resource variables.</span>
<span class="g g-Whitespace">    </span><span class="mi">292</span>   <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="s2">&quot;_handle_data&quot;</span><span class="p">):</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/ops/gen_array_ops.py</span> in <span class="ni">identity</span><span class="nt">(input, name)</span>
<span class="g g-Whitespace">   </span><span class="mi">4076</span>   <span class="c1"># Add nodes to the TensorFlow graph.</span>
<span class="g g-Whitespace">   </span><span class="mi">4077</span>   <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_op</span><span class="p">,</span> <span class="n">_outputs</span> <span class="o">=</span> <span class="n">_op_def_library</span><span class="o">.</span><span class="n">_apply_op_helper</span><span class="p">(</span>
<span class="ne">-&gt; </span><span class="mi">4078</span>         <span class="s2">&quot;Identity&quot;</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="nb">input</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">4079</span>   <span class="n">_result</span> <span class="o">=</span> <span class="n">_outputs</span><span class="p">[:]</span>
<span class="g g-Whitespace">   </span><span class="mi">4080</span>   <span class="k">if</span> <span class="n">_execute</span><span class="o">.</span><span class="n">must_record_gradient</span><span class="p">():</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/framework/op_def_library.py</span> in <span class="ni">_apply_op_helper</span><span class="nt">(op_type_name, name, **keywords)</span>
<span class="g g-Whitespace">    </span><span class="mi">744</span>       <span class="n">op</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">_create_op_internal</span><span class="p">(</span><span class="n">op_type_name</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">dtypes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">745</span>                                  <span class="n">name</span><span class="o">=</span><span class="n">scope</span><span class="p">,</span> <span class="n">input_types</span><span class="o">=</span><span class="n">input_types</span><span class="p">,</span>
<span class="ne">--&gt; </span><span class="mi">746</span>                                  <span class="n">attrs</span><span class="o">=</span><span class="n">attr_protos</span><span class="p">,</span> <span class="n">op_def</span><span class="o">=</span><span class="n">op_def</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">747</span> 
<span class="g g-Whitespace">    </span><span class="mi">748</span>     <span class="c1"># `outputs` is returned as a separate return value so that the output</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/framework/func_graph.py</span> in <span class="ni">_create_op_internal</span><span class="nt">(self, op_type, inputs, dtypes, input_types, name, attrs, op_def, compute_device)</span>
<span class="g g-Whitespace">    </span><span class="mi">689</span>     <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">FuncGraph</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_create_op_internal</span><span class="p">(</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">690</span>         <span class="n">op_type</span><span class="p">,</span> <span class="n">captured_inputs</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">,</span> <span class="n">input_types</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">op_def</span><span class="p">,</span>
<span class="ne">--&gt; </span><span class="mi">691</span>         <span class="n">compute_device</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">692</span> 
<span class="g g-Whitespace">    </span><span class="mi">693</span>   <span class="k">def</span> <span class="nf">capture</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tensor</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/framework/ops.py</span> in <span class="ni">_create_op_internal</span><span class="nt">(self, op_type, inputs, dtypes, input_types, name, attrs, op_def, compute_device)</span>
<span class="g g-Whitespace">   </span><span class="mi">3688</span>       <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">3689</span> 
<span class="ne">-&gt; </span><span class="mi">3690</span>     <span class="n">node_def</span> <span class="o">=</span> <span class="n">_NodeDef</span><span class="p">(</span><span class="n">op_type</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">3691</span> 
<span class="g g-Whitespace">   </span><span class="mi">3692</span>     <span class="n">input_ops</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">op</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">)</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/tensorflow/python/framework/ops.py</span> in <span class="ni">_NodeDef</span><span class="nt">(op_type, name, attrs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1874</span>   <span class="k">if</span> <span class="n">attrs</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1875</span>     <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">attrs</span><span class="p">):</span>
<span class="ne">-&gt; </span><span class="mi">1876</span>       <span class="n">node_def</span><span class="o">.</span><span class="n">attr</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">CopyFrom</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1877</span>   <span class="k">return</span> <span class="n">node_def</span>
<span class="g g-Whitespace">   </span><span class="mi">1878</span> 

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(</span><span class="n">trace_7_4</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/07_ulysses_compass_41_0.png" src="../_images/07_ulysses_compass_41_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mass_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">mass_std</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">d</span><span class="o">.</span><span class="n">mass_std</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">num</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_model_mean</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">jdc</span><span class="p">,</span> <span class="n">posterior</span><span class="p">,</span> <span class="n">jdc_mass_seq</span><span class="p">):</span>            
    <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;sigma&quot;</span> <span class="ow">in</span> <span class="n">posterior</span><span class="p">:</span>            
        <span class="n">scale</span> <span class="o">=</span> <span class="mf">0.001</span>  <span class="c1"># model number 6</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: R^2 = </span><span class="si">{:0.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">RX_is_bad</span><span class="p">(</span><span class="n">jdc</span><span class="p">,</span> <span class="n">posterior</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()))</span>     
    
    <span class="n">sample_alpha</span> <span class="o">=</span> <span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span>
    <span class="n">sample_beta</span> <span class="o">=</span> <span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sample_sigma</span> <span class="o">=</span> <span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sample_sigma</span> <span class="o">=</span> <span class="mf">0.001</span>  <span class="c1"># model number 6</span>
        
    <span class="c1"># jdc_mass_seq is the new joint distribution model</span>
    <span class="c1"># that uses mass_seq as the data</span>
    <span class="c1">#</span>
    <span class="c1"># Note - we are using posteriors from</span>
    <span class="c1"># the trace of jdc that we built earlier    </span>
        
    <span class="n">ds</span><span class="p">,</span> <span class="n">samples</span> <span class="o">=</span> <span class="n">jdc_mass_seq</span><span class="o">.</span><span class="n">sample_distributions</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span>
      <span class="n">sample_alpha</span><span class="p">,</span>
      <span class="n">sample_beta</span><span class="p">,</span> 
      <span class="n">sample_sigma</span><span class="p">,</span>
      <span class="kc">None</span>
    <span class="p">])</span>

    <span class="c1"># we get mu from the loc parameter of underlying</span>
    <span class="c1"># distribution which is Normal</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">loc</span>
    
    <span class="n">mu_mean</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">mu_ci</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">mu</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="mf">4.5</span><span class="p">,</span> <span class="mf">95.5</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">mass_std</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">brain_std</span><span class="p">,</span> <span class="n">facecolors</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mass_seq</span><span class="p">,</span> <span class="n">mu_mean</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;k&quot;</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">mass_seq</span><span class="p">,</span> <span class="n">mu_ci</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mu_ci</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span> 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jdc_7_1_mass_seq</span> <span class="o">=</span> <span class="n">model_7_1</span><span class="p">(</span><span class="n">mass_seq</span><span class="p">)</span>    
<span class="n">plot_model_mean</span><span class="p">(</span><span class="s2">&quot;m7.1&quot;</span><span class="p">,</span> <span class="n">jdc_7_1</span><span class="p">,</span> <span class="n">posterior_7_1</span><span class="p">,</span> <span class="n">jdc_7_1_mass_seq</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/07_ulysses_compass_44_0.png" src="../_images/07_ulysses_compass_44_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Book does not provide the code snippet for other models but has corresponding figures so I am </span>
<span class="c1"># doing that as well</span>
<span class="n">jdc_7_2_mass_seq</span> <span class="o">=</span> <span class="n">model_7_2</span><span class="p">(</span><span class="n">mass_seq</span><span class="p">)</span>
<span class="n">plot_model_mean</span><span class="p">(</span><span class="s2">&quot;m7.2&quot;</span><span class="p">,</span> <span class="n">jdc_7_2</span><span class="p">,</span> <span class="n">posterior_7_2</span><span class="p">,</span> <span class="n">jdc_7_2_mass_seq</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/07_ulysses_compass_45_0.png" src="../_images/07_ulysses_compass_45_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jdc_7_3_mass_seq</span> <span class="o">=</span> <span class="n">model_7_3</span><span class="p">(</span><span class="n">mass_seq</span><span class="p">)</span>
<span class="n">plot_model_mean</span><span class="p">(</span><span class="s2">&quot;m7.3&quot;</span><span class="p">,</span> <span class="n">jdc_7_3</span><span class="p">,</span> <span class="n">posterior_7_3</span><span class="p">,</span> <span class="n">jdc_7_3_mass_seq</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/07_ulysses_compass_46_0.png" src="../_images/07_ulysses_compass_46_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jdc_7_4_mass_seq</span> <span class="o">=</span> <span class="n">model_7_4</span><span class="p">(</span><span class="n">mass_seq</span><span class="p">)</span>
<span class="n">plot_model_mean</span><span class="p">(</span><span class="s2">&quot;m7.4&quot;</span><span class="p">,</span> <span class="n">jdc_7_4</span><span class="p">,</span> <span class="n">posterior_7_4</span><span class="p">,</span> <span class="n">jdc_7_4_mass_seq</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/07_ulysses_compass_47_0.png" src="../_images/07_ulysses_compass_47_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jdc_7_5_mass_seq</span> <span class="o">=</span> <span class="n">model_7_5</span><span class="p">(</span><span class="n">mass_seq</span><span class="p">)</span>
<span class="n">plot_model_mean</span><span class="p">(</span><span class="s2">&quot;m7.5&quot;</span><span class="p">,</span> <span class="n">jdc_7_5</span><span class="p">,</span> <span class="n">posterior_7_5</span><span class="p">,</span> <span class="n">jdc_7_5_mass_seq</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/07_ulysses_compass_48_0.png" src="../_images/07_ulysses_compass_48_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jdc_7_6_mass_seq</span> <span class="o">=</span> <span class="n">model_7_6</span><span class="p">(</span><span class="n">mass_seq</span><span class="p">)</span>
<span class="n">plot_model_mean</span><span class="p">(</span><span class="s2">&quot;m7.6&quot;</span><span class="p">,</span> <span class="n">jdc_7_6</span><span class="p">,</span> <span class="n">posterior_7_6</span><span class="p">,</span> <span class="n">jdc_7_6_mass_seq</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/07_ulysses_compass_49_0.png" src="../_images/07_ulysses_compass_49_0.png" />
</div>
</div>
</div>
</div>
</div>
<div class="section" id="too-few-parameters-hurts-too">
<h3>7.1.2 Too few parameters hurts,too<a class="headerlink" href="#too-few-parameters-hurts-too" title="Permalink to this headline">¶</a></h3>
<div class="section" id="code-7-11">
<h4>Code 7.11<a class="headerlink" href="#code-7-11" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">d_minus_i</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="entropy-and-accuracy">
<h2>7.2 Entropy and accuracy<a class="headerlink" href="#entropy-and-accuracy" title="Permalink to this headline">¶</a></h2>
<div class="section" id="firing-the-weatherperson">
<h3>7.2.1 Firing the weatherperson<a class="headerlink" href="#firing-the-weatherperson" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="information-and-uncertainity">
<h3>7.2.2 Information and uncertainity<a class="headerlink" href="#information-and-uncertainity" title="Permalink to this headline">¶</a></h3>
<div class="section" id="code-7-12">
<h4>Code 7.12<a class="headerlink" href="#code-7-12" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">])</span>
<span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.6108643020548935
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="from-entropy-to-accuracy">
<h3>7.2.3 From entropy to accuracy<a class="headerlink" href="#from-entropy-to-accuracy" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="estimating-divergence">
<h3>7.2.4 Estimating divergence<a class="headerlink" href="#estimating-divergence" title="Permalink to this headline">¶</a></h3>
<div class="section" id="code-7-13">
<h4>Code 7.13<a class="headerlink" href="#code-7-13" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_log_likelihood</span><span class="p">(</span><span class="n">jdc</span><span class="p">,</span> <span class="n">posterior</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    
    <span class="n">sample_alpha</span> <span class="o">=</span> <span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span>
    <span class="n">sample_beta</span> <span class="o">=</span> <span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sample_sigma</span> <span class="o">=</span> <span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sample_sigma</span> <span class="o">=</span> <span class="mf">0.001</span>  <span class="c1"># model number 6</span>
        
    <span class="n">ds</span><span class="p">,</span> <span class="n">samples</span> <span class="o">=</span> <span class="n">jdc</span><span class="o">.</span><span class="n">sample_distributions</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span>
      <span class="n">sample_alpha</span><span class="p">,</span> 
      <span class="n">sample_beta</span><span class="p">,</span> 
      <span class="n">sample_sigma</span><span class="p">,</span>
      <span class="kc">None</span>
    <span class="p">])</span>
    
    <span class="n">log_likelihood_total</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">brain_std</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>    
    
    <span class="c1"># we are inserting the log likelihood in the trace</span>
    <span class="c1"># as well though not required for this exercise</span>
    <span class="n">sample_stats</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">sample_stats</span>    
    <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">sample_stats</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">],</span> <span class="n">sample_stats</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;draw&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">7</span><span class="p">)]</span>
    <span class="n">sample_stats</span><span class="p">[</span><span class="s2">&quot;log_likelihood&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
        <span class="n">log_likelihood_total</span><span class="p">,</span> 
        <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span>  
        <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">,</span> <span class="s1">&#39;draw&#39;</span><span class="p">,</span> <span class="s1">&#39;log_likelihood_dim_0&#39;</span><span class="p">])</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="n">log_likelihood_total</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">log_likelihood_total</span>

<span class="k">def</span> <span class="nf">lppd_fn</span><span class="p">(</span><span class="n">jdc</span><span class="p">,</span> <span class="n">posterior</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">ll</span> <span class="o">=</span> <span class="n">compute_log_likelihood</span><span class="p">(</span><span class="n">jdc</span><span class="p">,</span> <span class="n">posterior</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
    <span class="n">ll</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_logsumexp</span><span class="p">(</span><span class="n">ll</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">ll</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ll</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>


<span class="n">lppd_fn</span><span class="p">(</span><span class="n">jdc_7_1</span><span class="p">,</span> <span class="n">posterior_7_1</span><span class="p">,</span> <span class="n">trace_7_1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(2, 4000, 7)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0.30458552,  0.3225901 ,  0.24644786,  0.32744595,  0.19878276,
        0.13797183, -0.6931643 ], dtype=float32)
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="overthinking">
<h3>Overthinking<a class="headerlink" href="#overthinking" title="Permalink to this headline">¶</a></h3>
<div class="section" id="code-7-14">
<h4>Code 7.14<a class="headerlink" href="#code-7-14" title="Permalink to this headline">¶</a></h4>
<p>This is simply an implementation of lppd_fn which I have done in 7.13 already</p>
</div>
</div>
<div class="section" id="scoring-the-right-data">
<h3>Scoring the right data<a class="headerlink" href="#scoring-the-right-data" title="Permalink to this headline">¶</a></h3>
<div class="section" id="code-7-15">
<h4>Code 7.15<a class="headerlink" href="#code-7-15" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ite</span> <span class="o">=</span> <span class="p">((</span><span class="n">jdc_7_1</span><span class="p">,</span> <span class="n">posterior_7_1</span><span class="p">,</span> <span class="n">trace_7_1</span><span class="p">),</span> 
       <span class="p">(</span><span class="n">jdc_7_2</span><span class="p">,</span> <span class="n">posterior_7_2</span><span class="p">,</span> <span class="n">trace_7_2</span><span class="p">),</span> 
       <span class="p">(</span><span class="n">jdc_7_3</span><span class="p">,</span> <span class="n">posterior_7_3</span><span class="p">,</span> <span class="n">trace_7_3</span><span class="p">),</span>
       <span class="p">(</span><span class="n">jdc_7_4</span><span class="p">,</span> <span class="n">posterior_7_4</span><span class="p">,</span> <span class="n">trace_7_4</span><span class="p">),</span>
       <span class="p">(</span><span class="n">jdc_7_5</span><span class="p">,</span> <span class="n">posterior_7_5</span><span class="p">,</span> <span class="n">trace_7_5</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lppd_fn</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">ite</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(2, 4000, 7)
(2, 4000, 7)
(2, 4000, 7)
(2, 4000, 7)
(2, 4000, 7)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0.84465986, 0.38574645, -0.09376086, -0.96567327, -3.9560695]
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="id1">
<h3>Overthinking<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<div class="section" id="code-7-16-7-18-todo">
<h4>Code 7.16 - 7.18 [TODO]<a class="headerlink" href="#code-7-16-7-18-todo" title="Permalink to this headline">¶</a></h4>
</div>
</div>
</div>
<div class="section" id="golem-taming-regularization">
<h2>7.3 Golem Taming: Regularization<a class="headerlink" href="#golem-taming-regularization" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="predicting-predictive-accuracy">
<h2>7.4 Predicting predictive accuracy<a class="headerlink" href="#predicting-predictive-accuracy" title="Permalink to this headline">¶</a></h2>
<div class="section" id="overthinking-waic-calculations">
<h3>Overthinking: WAIC calculations<a class="headerlink" href="#overthinking-waic-calculations" title="Permalink to this headline">¶</a></h3>
<div class="section" id="code-7-19">
<h4>Code 7.19<a class="headerlink" href="#code-7-19" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># There is no CSV file for cars dataset in author&#39;s repo</span>
<span class="c1"># hence I have inlined the data. In R this dataset much be bundled in</span>
<span class="c1"># and this is why his code snippets do not need the csv file</span>

<span class="n">cars_data</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&quot;&quot;,&quot;speed&quot;,&quot;dist&quot;</span>
<span class="s2">&quot;1&quot;,4,2</span>
<span class="s2">&quot;2&quot;,4,10</span>
<span class="s2">&quot;3&quot;,7,4</span>
<span class="s2">&quot;4&quot;,7,22</span>
<span class="s2">&quot;5&quot;,8,16</span>
<span class="s2">&quot;6&quot;,9,10</span>
<span class="s2">&quot;7&quot;,10,18</span>
<span class="s2">&quot;8&quot;,10,26</span>
<span class="s2">&quot;9&quot;,10,34</span>
<span class="s2">&quot;10&quot;,11,17</span>
<span class="s2">&quot;11&quot;,11,28</span>
<span class="s2">&quot;12&quot;,12,14</span>
<span class="s2">&quot;13&quot;,12,20</span>
<span class="s2">&quot;14&quot;,12,24</span>
<span class="s2">&quot;15&quot;,12,28</span>
<span class="s2">&quot;16&quot;,13,26</span>
<span class="s2">&quot;17&quot;,13,34</span>
<span class="s2">&quot;18&quot;,13,34</span>
<span class="s2">&quot;19&quot;,13,46</span>
<span class="s2">&quot;20&quot;,14,26</span>
<span class="s2">&quot;21&quot;,14,36</span>
<span class="s2">&quot;22&quot;,14,60</span>
<span class="s2">&quot;23&quot;,14,80</span>
<span class="s2">&quot;24&quot;,15,20</span>
<span class="s2">&quot;25&quot;,15,26</span>
<span class="s2">&quot;26&quot;,15,54</span>
<span class="s2">&quot;27&quot;,16,32</span>
<span class="s2">&quot;28&quot;,16,40</span>
<span class="s2">&quot;29&quot;,17,32</span>
<span class="s2">&quot;30&quot;,17,40</span>
<span class="s2">&quot;31&quot;,17,50</span>
<span class="s2">&quot;32&quot;,18,42</span>
<span class="s2">&quot;33&quot;,18,56</span>
<span class="s2">&quot;34&quot;,18,76</span>
<span class="s2">&quot;35&quot;,18,84</span>
<span class="s2">&quot;36&quot;,19,36</span>
<span class="s2">&quot;37&quot;,19,46</span>
<span class="s2">&quot;38&quot;,19,68</span>
<span class="s2">&quot;39&quot;,20,32</span>
<span class="s2">&quot;40&quot;,20,48</span>
<span class="s2">&quot;41&quot;,20,52</span>
<span class="s2">&quot;42&quot;,20,56</span>
<span class="s2">&quot;43&quot;,20,64</span>
<span class="s2">&quot;44&quot;,22,66</span>
<span class="s2">&quot;45&quot;,23,54</span>
<span class="s2">&quot;46&quot;,24,70</span>
<span class="s2">&quot;47&quot;,24,92</span>
<span class="s2">&quot;48&quot;,24,93</span>
<span class="s2">&quot;49&quot;,24,120</span>
<span class="s2">&quot;50&quot;,25,85</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">buffer</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">cars_data</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>

<span class="n">d</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>speed</th>
      <th>dist</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>4</td>
      <td>2</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>4</td>
      <td>10</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>7</td>
      <td>4</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>7</td>
      <td>22</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>8</td>
      <td>16</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Note - </span>
<span class="c1">#</span>
<span class="c1"># In first edition, the book used Uniform for sigma and in the second</span>
<span class="c1"># edition it is using Exponential; </span>
<span class="c1">#</span>
<span class="c1"># If I use exponential the chains do not converge; the traces are seriously bad.</span>
<span class="c1"># In order to make it work, I have spent time trying to find an ideal number of</span>
<span class="c1"># samples &amp; burin. The configuration that has the most impact is the initialization</span>
<span class="c1"># state. For the sigma if I use the init state of 60 then the chains converge sometimes ..</span>
<span class="c1"># I have observed that even after this setting the convergence is not systematic. After running</span>
<span class="c1"># it few times I see that it has R_hat of 2 and that skews the results</span>
<span class="c1"># </span>
<span class="c1"># Edition 1 model (i.e. using Uniform for scale) is very stable</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># I have ran the model in R (using rehinking &amp; rstan) as well and there I am able to </span>
<span class="c1"># work with the model definition as it is in Edition 2</span>

<span class="n">USE_EDITION_2_SPEC</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">def</span> <span class="nf">cars_model</span><span class="p">(</span><span class="n">speed</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">100.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;alpha&quot;</span><span class="p">)</span> <span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;beta&quot;</span><span class="p">)</span> <span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">USE_EDITION_2_SPEC</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">)</span> <span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mf">30.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">)</span> <span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>        
        
        <span class="n">mu</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">speed</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>        
        
        <span class="n">brain_std</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span>
            <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jdc_cars</span> <span class="o">=</span> <span class="n">cars_model</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">speed</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

<span class="k">if</span> <span class="n">USE_EDITION_2_SPEC</span><span class="p">:</span>

    <span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">]),</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">]),</span>
        <span class="mf">60.</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">]),</span>  <span class="c1"># &lt;--- this makes it work (somewhat, not systematic !)</span>
    <span class="p">]</span>

    <span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
        <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
        <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">(),</span>
    <span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    
    <span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">]),</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">]),</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">]),</span>
    <span class="p">]</span>
    
    <span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
        <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
        <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="p">]</span>

<span class="n">observed_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">dist</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),)</span>

<span class="c1"># here I am increasing the sampling size</span>
<span class="c1"># to see if that helps</span>
<span class="n">posterior_cars</span><span class="p">,</span> <span class="n">trace_cars</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                                <span class="n">jdc_cars</span><span class="p">,</span> 
                                <span class="n">observed_data</span><span class="o">=</span><span class="n">observed_data</span><span class="p">,</span>
                                <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">],</span>
                                <span class="n">num_samples</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
                                <span class="n">burnin</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
                                <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                                <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_cars</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha</th>
      <td>-0.637</td>
      <td>1.623</td>
      <td>-2.583</td>
      <td>2.484</td>
      <td>0.933</td>
      <td>0.737</td>
      <td>3.0</td>
      <td>11.0</td>
      <td>1.56</td>
    </tr>
    <tr>
      <th>beta</th>
      <td>2.955</td>
      <td>0.158</td>
      <td>2.709</td>
      <td>3.203</td>
      <td>0.055</td>
      <td>0.040</td>
      <td>8.0</td>
      <td>80.0</td>
      <td>1.17</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>14.524</td>
      <td>1.234</td>
      <td>12.459</td>
      <td>16.382</td>
      <td>0.063</td>
      <td>0.045</td>
      <td>392.0</td>
      <td>730.0</td>
      <td>1.01</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(</span><span class="n">trace_cars</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/07_ulysses_compass_80_0.png" src="../_images/07_ulysses_compass_80_0.png" />
</div>
</div>
</div>
<div class="section" id="code-7-20">
<h4>Code 7.20<a class="headerlink" href="#code-7-20" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_samples</span> <span class="o">=</span> <span class="mi">2000</span>

<span class="k">def</span> <span class="nf">logprob_fn</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">posterior_cars</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">s</span><span class="p">]</span> <span class="o">+</span> <span class="n">posterior_cars</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="n">d</span><span class="o">.</span><span class="n">speed</span><span class="o">.</span><span class="n">values</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">posterior_cars</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">s</span><span class="p">]</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">sigma</span>   
    
    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span>
        <span class="n">loc</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> 
        <span class="n">scale</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">dist</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

<span class="n">logprob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">logprob_fn</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_samples</span><span class="p">))))</span><span class="o">.</span><span class="n">T</span>

<span class="n">logprob</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(50, 2000)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-7-21">
<h4>Code 7.21<a class="headerlink" href="#code-7-21" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_cases</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">lppd</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_logsumexp</span><span class="p">(</span><span class="n">logprob</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-7-22">
<h4>Code 7.22<a class="headerlink" href="#code-7-22" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pWAIC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">logprob</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-7-23">
<h4>Code 7.23<a class="headerlink" href="#code-7-23" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lppd</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pWAIC</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>427.1761779785156
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-7-24">
<h4>Code 7.24<a class="headerlink" href="#code-7-24" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">waic_vec</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">lppd</span> <span class="o">-</span> <span class="n">pWAIC</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_cases</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">waic_vec</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>16.037406438255786
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="comparing-cv-psis-and-waic">
<h3>7.4.3 Comparing CV, PSIS, and WAIC<a class="headerlink" href="#comparing-cv-psis-and-waic" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="model-comparison">
<h2>7.5 Model comparison<a class="headerlink" href="#model-comparison" title="Permalink to this headline">¶</a></h2>
<div class="section" id="code-7-25">
<h3>Code 7.25<a class="headerlink" href="#code-7-25" title="Permalink to this headline">¶</a></h3>
<p>Here we need to first redefine models from the previous chapters i.e. m6_6,m6_7,m6_8 and compute the log likelihoods as well and only then we will compute the WAIC</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_SEED</span> <span class="o">=</span> <span class="mi">71</span>

<span class="c1"># Note - even after providing SeedStream and generated seeds</span>
<span class="c1"># it still does not respect it</span>
<span class="k">def</span> <span class="nf">simulate</span><span class="p">():</span>
    <span class="n">seed</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">SeedStream</span><span class="p">(</span><span class="n">_SEED</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="s2">&quot;sim_heights&quot;</span><span class="p">)</span>

    <span class="c1"># number of plants</span>
    <span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>

    <span class="c1"># simulate initial heights</span>
    <span class="n">h0</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">2.</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">())</span>

    <span class="c1"># assign treatments and simulate fungus and growth</span>
    <span class="n">treatment</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="n">repeats</span><span class="o">=</span><span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
    
    <span class="n">fungus</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(</span><span class="n">total_count</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">treatment</span> <span class="o">*</span> <span class="mf">0.4</span><span class="p">))</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">())</span>
    
    <span class="n">h1</span> <span class="o">=</span> <span class="n">h0</span> <span class="o">+</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">5.</span> <span class="o">-</span> <span class="mf">3.</span> <span class="o">*</span> <span class="n">fungus</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">())</span>

    <span class="c1"># compose a clean data frame</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;h0&quot;</span><span class="p">:</span><span class="n">h0</span><span class="p">,</span> <span class="s2">&quot;h1&quot;</span><span class="p">:</span><span class="n">h1</span><span class="p">,</span> <span class="s2">&quot;treatment&quot;</span><span class="p">:</span><span class="n">treatment</span><span class="p">,</span> <span class="s2">&quot;fungus&quot;</span><span class="p">:</span><span class="n">fungus</span><span class="p">}</span>
    
    <span class="k">return</span> <span class="n">d</span>
    
<span class="n">d_dict</span> <span class="o">=</span> <span class="n">simulate</span><span class="p">()</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">d_dict</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;stats&quot;</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>h0</th>
      <td>9.894</td>
      <td>2.143</td>
      <td>6.421</td>
      <td>12.93</td>
    </tr>
    <tr>
      <th>h1</th>
      <td>13.609</td>
      <td>2.696</td>
      <td>8.782</td>
      <td>17.34</td>
    </tr>
    <tr>
      <th>treatment</th>
      <td>0.500</td>
      <td>0.503</td>
      <td>0.000</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>fungus</th>
      <td>0.350</td>
      <td>0.479</td>
      <td>0.000</td>
      <td>1.00</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d_dict</span><span class="p">)</span>
<span class="n">tdf</span> <span class="o">=</span> <span class="n">dataframe_to_tensors</span><span class="p">(</span><span class="s1">&#39;SimulatedTreatment&#39;</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;h0&#39;</span><span class="p">,</span> <span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="s1">&#39;treatment&#39;</span><span class="p">,</span> <span class="s1">&#39;fungus&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_6_6</span><span class="p">(</span><span class="n">h0</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
      <span class="n">p</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">LogNormal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;p&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>      
      <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        
      <span class="n">mu</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">h0</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="o">*</span> <span class="n">p</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
      <span class="n">scale</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  
        
      <span class="n">h1</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;h1&quot;</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    
    
<span class="n">jdc_6_6</span> <span class="o">=</span> <span class="n">model_6_6</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">h0</span><span class="p">)</span>

<span class="n">NUM_CHAINS_FOR_6_6</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_6</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_6</span><span class="p">])</span>    
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">()</span>
<span class="p">]</span>

<span class="n">posterior_6_6</span><span class="p">,</span> <span class="n">trace_6_6</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                                <span class="n">jdc_6_6</span><span class="p">,</span> 
                                <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">h1</span><span class="p">,),</span> 
                                <span class="n">num_chains</span><span class="o">=</span><span class="n">NUM_CHAINS_FOR_6_6</span><span class="p">,</span>
                                <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                                <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">,</span>
                                <span class="n">num_samples</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> 
                                <span class="n">burnin</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                                <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">])</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_6_6</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>p</th>
      <td>1.356</td>
      <td>0.019</td>
      <td>1.327</td>
      <td>1.385</td>
      <td>0.001</td>
      <td>0.000</td>
      <td>1205.0</td>
      <td>1295.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>1.896</td>
      <td>0.135</td>
      <td>1.689</td>
      <td>2.110</td>
      <td>0.004</td>
      <td>0.003</td>
      <td>1302.0</td>
      <td>1840.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_6_7</span><span class="p">(</span><span class="n">h0</span><span class="p">,</span> <span class="n">treatment</span><span class="p">,</span> <span class="n">fungus</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
      <span class="n">a</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">LogNormal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>      
      <span class="n">bt</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;bt&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>    
      <span class="n">bf</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;bf&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>    
      <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        
      <span class="n">p</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">bt</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">treatment</span> <span class="o">+</span> <span class="n">bf</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">fungus</span>
        
      <span class="n">mu</span> <span class="o">=</span> <span class="n">h0</span> <span class="o">*</span> <span class="n">p</span>
      <span class="n">scale</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  
        
      <span class="n">h1</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;h1&quot;</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    
    
<span class="n">jdc_6_7</span> <span class="o">=</span> <span class="n">model_6_7</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">h0</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">treatment</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">fungus</span><span class="p">)</span>

<span class="n">NUM_CHAINS_FOR_6_7</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_7</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_7</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_7</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_7</span><span class="p">])</span>    
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">()</span>
<span class="p">]</span>

<span class="n">posterior_6_7</span><span class="p">,</span> <span class="n">trace_6_7</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                    <span class="n">jdc_6_7</span><span class="p">,</span> 
                    <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">h1</span><span class="p">,),</span> 
                    <span class="n">num_chains</span><span class="o">=</span><span class="n">NUM_CHAINS_FOR_6_7</span><span class="p">,</span>
                    <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                    <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">,</span>
                    <span class="n">num_samples</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> 
                    <span class="n">burnin</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;bt&#39;</span><span class="p">,</span> <span class="s1">&#39;bf&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">])</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_6_7</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <td>1.454</td>
      <td>0.029</td>
      <td>1.412</td>
      <td>1.504</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>1152.0</td>
      <td>1297.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>bt</th>
      <td>-0.011</td>
      <td>0.034</td>
      <td>-0.066</td>
      <td>0.039</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>1462.0</td>
      <td>1480.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>bf</th>
      <td>-0.275</td>
      <td>0.035</td>
      <td>-0.333</td>
      <td>-0.221</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>1318.0</td>
      <td>1361.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>1.397</td>
      <td>0.101</td>
      <td>1.248</td>
      <td>1.566</td>
      <td>0.005</td>
      <td>0.004</td>
      <td>361.0</td>
      <td>774.0</td>
      <td>1.01</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_6_8</span><span class="p">(</span><span class="n">h0</span><span class="p">,</span> <span class="n">treatment</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
      <span class="n">a</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">LogNormal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>      
      <span class="n">bt</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;bt&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>    
      <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        
      <span class="n">p</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">bt</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">treatment</span> 
        
      <span class="n">mu</span> <span class="o">=</span> <span class="n">h0</span> <span class="o">*</span> <span class="n">p</span>
      <span class="n">scale</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  
        
      <span class="n">h1</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;h1&quot;</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>    
    
<span class="n">jdc_6_8</span> <span class="o">=</span> <span class="n">model_6_8</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">h0</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">treatment</span><span class="p">)</span>

<span class="n">NUM_CHAINS_FOR_6_8</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_8</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_8</span><span class="p">]),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUM_CHAINS_FOR_6_8</span><span class="p">])</span>    
<span class="p">]</span>

<span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
    <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">()</span>
<span class="p">]</span>

<span class="n">posterior_6_8</span><span class="p">,</span> <span class="n">trace_6_8</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                    <span class="n">jdc_6_8</span><span class="p">,</span> 
                    <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">h1</span><span class="p">,),</span> 
                    <span class="n">num_chains</span><span class="o">=</span><span class="n">NUM_CHAINS_FOR_6_8</span><span class="p">,</span>
                    <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                    <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">,</span>
                    <span class="n">num_samples</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> 
                    <span class="n">burnin</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;bt&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">])</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_6_8</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <td>1.288</td>
      <td>0.025</td>
      <td>1.252</td>
      <td>1.330</td>
      <td>0.001</td>
      <td>0.000</td>
      <td>2398.0</td>
      <td>1253.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>bt</th>
      <td>0.133</td>
      <td>0.035</td>
      <td>0.074</td>
      <td>0.183</td>
      <td>0.001</td>
      <td>0.000</td>
      <td>3152.0</td>
      <td>1621.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>1.792</td>
      <td>0.133</td>
      <td>1.580</td>
      <td>1.998</td>
      <td>0.004</td>
      <td>0.003</td>
      <td>884.0</td>
      <td>1273.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute the log likelihoods</span>
<span class="k">def</span> <span class="nf">compute_log_likelihood_6_7</span><span class="p">(</span><span class="n">jdc</span><span class="p">,</span> <span class="n">posterior</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span> 
    
    <span class="n">sample_a</span>  <span class="o">=</span> <span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span>
    <span class="n">sample_bt</span> <span class="o">=</span> <span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;bt&quot;</span><span class="p">]</span>
    <span class="n">sample_bf</span> <span class="o">=</span> <span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;bf&quot;</span><span class="p">]</span>
    <span class="n">sample_sigma</span> <span class="o">=</span> <span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">]</span>

    <span class="n">ds</span><span class="p">,</span> <span class="n">samples</span> <span class="o">=</span> <span class="n">jdc</span><span class="o">.</span><span class="n">sample_distributions</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span>
      <span class="n">sample_a</span><span class="p">,</span> 
      <span class="n">sample_bt</span><span class="p">,</span>
      <span class="n">sample_bf</span><span class="p">,</span>
      <span class="n">sample_sigma</span><span class="p">,</span> 
      <span class="kc">None</span>
    <span class="p">])</span>

    <span class="n">log_likelihood_total</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">h1</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>    
    
    <span class="c1"># we are inserting the log likelihood in the trace</span>
    <span class="c1"># as well though not required for this exercise</span>
    <span class="n">sample_stats</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">sample_stats</span>    
    <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">sample_stats</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">],</span> <span class="n">sample_stats</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;draw&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">100</span><span class="p">)]</span>
    
    <span class="n">sample_stats</span><span class="p">[</span><span class="s2">&quot;log_likelihood&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
        <span class="n">log_likelihood_total</span><span class="p">,</span> 
        <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span>  
        <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">,</span> <span class="s1">&#39;draw&#39;</span><span class="p">,</span> <span class="s1">&#39;log_likelihood_dim_0&#39;</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">log_likelihood_total</span>

<span class="n">ll_6_7</span> <span class="o">=</span> <span class="n">compute_log_likelihood_6_7</span><span class="p">(</span><span class="n">jdc_6_7</span><span class="p">,</span> <span class="n">posterior_6_7</span><span class="p">,</span> <span class="n">trace_6_7</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># WAIC for model_6_7</span>
<span class="n">WAIC_m6_7</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">waic</span><span class="p">(</span><span class="n">trace_6_7</span><span class="p">,</span> <span class="n">pointwise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;deviance&quot;</span><span class="p">)</span>
<span class="n">WAIC_m6_7</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/ksachdeva/rethinkingtfp/lib/python3.7/site-packages/arviz/stats/stats.py:1460: UserWarning: For one or more samples the posterior variance of the log predictive densities exceeds 0.4. This could be indication of WAIC starting to fail. 
See http://arxiv.org/abs/1507.04544 for details
  &quot;For one or more samples the posterior variance of the log predictive &quot;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Computed from 4000 by 100 log-likelihood matrix

              Estimate       SE
deviance_waic   353.87    15.10
p_waic            3.75        -

There has been a warning during the calculation. Please check the results.
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-7-26">
<h3>Code 7.26<a class="headerlink" href="#code-7-26" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># likelihoods for rest of the 6_X models</span>
<span class="k">def</span> <span class="nf">compute_log_likelihood_6_6</span><span class="p">(</span><span class="n">jdc</span><span class="p">,</span> <span class="n">posterior</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>    
    
    <span class="n">sample_p</span>  <span class="o">=</span> <span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">]</span>
    <span class="n">sample_sigma</span> <span class="o">=</span> <span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">]</span>
    
    <span class="n">ds</span><span class="p">,</span> <span class="n">samples</span> <span class="o">=</span> <span class="n">jdc</span><span class="o">.</span><span class="n">sample_distributions</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span>
      <span class="n">sample_p</span><span class="p">,</span> 
      <span class="n">sample_sigma</span><span class="p">,</span> 
      <span class="kc">None</span>
    <span class="p">])</span>

    <span class="n">log_likelihood_total</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">h1</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>    
    
    <span class="c1"># we are inserting the log likelihood in the trace</span>
    <span class="c1"># as well though not required for this exercise</span>
    <span class="n">sample_stats</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">sample_stats</span>    
    <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">sample_stats</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">],</span> <span class="n">sample_stats</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;draw&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">100</span><span class="p">)]</span>
    
    <span class="n">sample_stats</span><span class="p">[</span><span class="s2">&quot;log_likelihood&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
        <span class="n">log_likelihood_total</span><span class="p">,</span> 
        <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span>  
        <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">,</span> <span class="s1">&#39;draw&#39;</span><span class="p">,</span> <span class="s1">&#39;log_likelihood_dim_0&#39;</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">log_likelihood_total</span>

<span class="n">ll_6_6</span> <span class="o">=</span> <span class="n">compute_log_likelihood_6_6</span><span class="p">(</span><span class="n">jdc_6_6</span><span class="p">,</span> <span class="n">posterior_6_6</span><span class="p">,</span> <span class="n">trace_6_6</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_log_likelihood_6_8</span><span class="p">(</span><span class="n">jdc</span><span class="p">,</span> <span class="n">posterior</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>    
    
    <span class="n">sample_a</span>  <span class="o">=</span> <span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span>
    <span class="n">sample_bt</span> <span class="o">=</span> <span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;bt&quot;</span><span class="p">]</span>
    <span class="n">sample_sigma</span> <span class="o">=</span> <span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">]</span>

    <span class="n">ds</span><span class="p">,</span> <span class="n">samples</span> <span class="o">=</span> <span class="n">jdc</span><span class="o">.</span><span class="n">sample_distributions</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span>
      <span class="n">sample_a</span><span class="p">,</span> 
      <span class="n">sample_bt</span><span class="p">,</span> 
      <span class="n">sample_sigma</span><span class="p">,</span> 
      <span class="kc">None</span>
    <span class="p">])</span>

    <span class="n">log_likelihood_total</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">h1</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>    
    
    <span class="c1"># we are inserting the log likelihood in the trace</span>
    <span class="c1"># as well though not required for this exercise</span>
    <span class="n">sample_stats</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">sample_stats</span>    
    <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">sample_stats</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">],</span> <span class="n">sample_stats</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;draw&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">100</span><span class="p">)]</span>
    
    <span class="n">sample_stats</span><span class="p">[</span><span class="s2">&quot;log_likelihood&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
        <span class="n">log_likelihood_total</span><span class="p">,</span> 
        <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span>  
        <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">,</span> <span class="s1">&#39;draw&#39;</span><span class="p">,</span> <span class="s1">&#39;log_likelihood_dim_0&#39;</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">log_likelihood_total</span>

<span class="n">ll_6_8</span> <span class="o">=</span> <span class="n">compute_log_likelihood_6_8</span><span class="p">(</span><span class="n">jdc_6_8</span><span class="p">,</span> <span class="n">posterior_6_8</span><span class="p">,</span> <span class="n">trace_6_8</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">compare_df</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">compare</span><span class="p">({</span><span class="s2">&quot;m6.6&quot;</span><span class="p">:</span> <span class="n">trace_6_6</span><span class="p">,</span> <span class="s2">&quot;m6.7&quot;</span><span class="p">:</span> <span class="n">trace_6_7</span><span class="p">,</span> <span class="s2">&quot;m6.8&quot;</span><span class="p">:</span> <span class="n">trace_6_8</span><span class="p">},</span> <span class="n">ic</span><span class="o">=</span><span class="s1">&#39;waic&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;deviance&quot;</span><span class="p">)</span>

<span class="n">compare_df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/ksachdeva/rethinkingtfp/lib/python3.7/site-packages/arviz/stats/stats.py:1460: UserWarning: For one or more samples the posterior variance of the log predictive densities exceeds 0.4. This could be indication of WAIC starting to fail. 
See http://arxiv.org/abs/1507.04544 for details
  &quot;For one or more samples the posterior variance of the log predictive &quot;
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>rank</th>
      <th>waic</th>
      <th>p_waic</th>
      <th>d_waic</th>
      <th>weight</th>
      <th>se</th>
      <th>dse</th>
      <th>warning</th>
      <th>waic_scale</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>m6.7</th>
      <td>0</td>
      <td>353.872482</td>
      <td>3.753222</td>
      <td>0.000000</td>
      <td>9.822035e-01</td>
      <td>15.096424</td>
      <td>0.000000</td>
      <td>True</td>
      <td>deviance</td>
    </tr>
    <tr>
      <th>m6.8</th>
      <td>1</td>
      <td>403.364160</td>
      <td>2.667236</td>
      <td>49.491678</td>
      <td>1.911701e-13</td>
      <td>12.156915</td>
      <td>11.341383</td>
      <td>False</td>
      <td>deviance</td>
    </tr>
    <tr>
      <th>m6.6</th>
      <td>2</td>
      <td>414.315512</td>
      <td>1.628448</td>
      <td>60.443030</td>
      <td>1.779648e-02</td>
      <td>11.630173</td>
      <td>13.103273</td>
      <td>False</td>
      <td>deviance</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="code-7-27">
<h3>Code 7.27<a class="headerlink" href="#code-7-27" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">WAIC_m6_7</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">waic</span><span class="p">(</span><span class="n">trace_6_7</span><span class="p">,</span> <span class="n">pointwise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;deviance&quot;</span><span class="p">)</span>
<span class="n">WAIC_m6_8</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">waic</span><span class="p">(</span><span class="n">trace_6_8</span><span class="p">,</span> <span class="n">pointwise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;deviance&quot;</span><span class="p">)</span>

<span class="c1"># pointwise values are stored in the waic_i attribute.</span>
<span class="n">diff_m_6_7_m_6_8</span> <span class="o">=</span> <span class="n">WAIC_m6_7</span><span class="o">.</span><span class="n">waic_i</span> <span class="o">-</span> <span class="n">WAIC_m6_8</span><span class="o">.</span><span class="n">waic_i</span>

<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">diff_m_6_7_m_6_8</span><span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">diff_m_6_7_m_6_8</span><span class="p">))</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/ksachdeva/rethinkingtfp/lib/python3.7/site-packages/arviz/stats/stats.py:1460: UserWarning: For one or more samples the posterior variance of the log predictive densities exceeds 0.4. This could be indication of WAIC starting to fail. 
See http://arxiv.org/abs/1507.04544 for details
  &quot;For one or more samples the posterior variance of the log predictive &quot;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array(11.34138333)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-7-28">
<h3>Code 7.28<a class="headerlink" href="#code-7-28" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mf">40.0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">10.4</span> <span class="o">*</span> <span class="mf">2.6</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([12.96, 67.04])
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-7-29">
<h3>Code 7.29<a class="headerlink" href="#code-7-29" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_compare</span><span class="p">(</span><span class="n">compare_df</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/07_ulysses_compass_110_0.png" src="../_images/07_ulysses_compass_110_0.png" />
</div>
</div>
</div>
<div class="section" id="code-7-30">
<h3>Code 7.30<a class="headerlink" href="#code-7-30" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">WAIC_m6_6</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">waic</span><span class="p">(</span><span class="n">trace_6_6</span><span class="p">,</span> <span class="n">pointwise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;deviance&quot;</span><span class="p">)</span>

<span class="n">diff_m6_6_m6_8</span> <span class="o">=</span> <span class="n">WAIC_m6_6</span><span class="o">.</span><span class="n">waic_i</span> <span class="o">-</span> <span class="n">WAIC_m6_8</span><span class="o">.</span><span class="n">waic_i</span>

<span class="n">n</span> <span class="o">=</span> <span class="n">WAIC_m6_6</span><span class="o">.</span><span class="n">n_data_points</span>

<span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">diff_m6_6_m6_8</span><span class="p">))</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array(7.23930706)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-7-31">
<h3>Code 7.31<a class="headerlink" href="#code-7-31" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dSE</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">waic1</span><span class="p">,</span> <span class="n">waic2</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
    <span class="n">n</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">waic1</span><span class="o">.</span><span class="n">waic_i</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">waic2</span><span class="o">.</span><span class="n">waic_i</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;m6.6&quot;</span><span class="p">:</span> <span class="n">WAIC_m6_6</span><span class="p">,</span> <span class="s2">&quot;m6.7&quot;</span><span class="p">:</span> <span class="n">WAIC_m6_7</span><span class="p">,</span> <span class="s2">&quot;m6.8&quot;</span><span class="p">:</span> <span class="n">WAIC_m6_8</span><span class="p">}</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">{</span><span class="n">row</span><span class="p">:</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="n">dSE</span><span class="p">(</span><span class="n">row_val</span><span class="p">,</span> <span class="n">col_val</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">col_val</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
     <span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">row_val</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>m6.6</th>
      <th>m6.7</th>
      <th>m6.8</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>m6.6</th>
      <td>0.000000</td>
      <td>13.103273</td>
      <td>7.239307</td>
    </tr>
    <tr>
      <th>m6.7</th>
      <td>13.103273</td>
      <td>0.000000</td>
      <td>11.341383</td>
    </tr>
    <tr>
      <th>m6.8</th>
      <td>7.239307</td>
      <td>11.341383</td>
      <td>0.000000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="outliers-and-other-illusions">
<h3>7.5.2 Outliers and other illusions<a class="headerlink" href="#outliers-and-other-illusions" title="Permalink to this headline">¶</a></h3>
<div class="section" id="code-7-32">
<h4>Code 7.32<a class="headerlink" href="#code-7-32" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">RethinkingDataset</span><span class="o">.</span><span class="n">WaffleDivorce</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">()</span>
<span class="n">d</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">MedianAgeMarriage</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
<span class="n">d</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">Divorce</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
<span class="n">d</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">Marriage</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tdf</span> <span class="o">=</span> <span class="n">dataframe_to_tensors</span><span class="p">(</span><span class="s1">&#39;Waffle&#39;</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_5_1</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;alpha&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">betaA</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;betaA&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        
        <span class="n">mu</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">betaA</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">A</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        
        <span class="n">D</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">model_5_2</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;alpha&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">betaM</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;betaM&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        
        <span class="n">mu</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">betaM</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">M</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        
        <span class="n">D</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
    
<span class="k">def</span> <span class="nf">model_5_3</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">M</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;alpha&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">betaA</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;betaA&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">betaM</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;betaM&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        
        <span class="n">mu</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">betaA</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">A</span> <span class="o">+</span>  <span class="n">betaM</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">M</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        
        <span class="n">D</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="n">jdc_5_1</span> <span class="o">=</span> <span class="n">model_5_1</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">A</span><span class="p">)</span>
<span class="n">jdc_5_2</span> <span class="o">=</span> <span class="n">model_5_2</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
<span class="n">jdc_5_3</span> <span class="o">=</span> <span class="n">model_5_3</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">compute_posterior_5_1_and_2</span><span class="p">(</span><span class="n">jdc</span><span class="p">):</span>
    <span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">]),</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">]),</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">]),</span>
    <span class="p">]</span>

    <span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
        <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
        <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">(),</span>
    <span class="p">]</span>

    <span class="n">observed_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">D</span><span class="p">,)</span>

    <span class="c1"># here I am increasing the sampling size</span>
    <span class="c1"># to see if that helps</span>
    <span class="n">posterior</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                        <span class="n">jdc</span><span class="p">,</span> 
                        <span class="n">observed_data</span><span class="o">=</span><span class="n">observed_data</span><span class="p">,</span>
                        <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">],</span>
                        <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                        <span class="n">burnin</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                        <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                        <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">posterior</span><span class="p">,</span> <span class="n">trace</span>

<span class="k">def</span> <span class="nf">compute_posterior_5_3</span><span class="p">():</span>
    <span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">]),</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">]),</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">]),</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">]),</span>
    <span class="p">]</span>

    <span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
        <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
        <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
        <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">(),</span>
    <span class="p">]</span>

    <span class="n">observed_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">D</span><span class="p">,)</span>

    <span class="c1"># here I am increasing the sampling size</span>
    <span class="c1"># to see if that helps</span>
    <span class="n">posterior</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                        <span class="n">jdc_5_3</span><span class="p">,</span> 
                        <span class="n">observed_data</span><span class="o">=</span><span class="n">observed_data</span><span class="p">,</span>
                        <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;betaA&#39;</span><span class="p">,</span> <span class="s1">&#39;betaM&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">],</span>
                        <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                        <span class="n">burnin</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                        <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                        <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">posterior</span><span class="p">,</span> <span class="n">trace</span>
        
    
<span class="n">posterior_5_1</span><span class="p">,</span> <span class="n">trace_5_1</span> <span class="o">=</span> <span class="n">compute_posterior_5_1_and_2</span><span class="p">(</span><span class="n">jdc_5_1</span><span class="p">)</span>
<span class="n">posterior_5_2</span><span class="p">,</span> <span class="n">trace_5_2</span> <span class="o">=</span> <span class="n">compute_posterior_5_1_and_2</span><span class="p">(</span><span class="n">jdc_5_2</span><span class="p">)</span>
<span class="n">posterior_5_3</span><span class="p">,</span> <span class="n">trace_5_3</span> <span class="o">=</span> <span class="n">compute_posterior_5_3</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-7-33">
<h4>Code 7.33<a class="headerlink" href="#code-7-33" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_log_likelihood_m5_1_2</span><span class="p">(</span><span class="n">jdc</span><span class="p">,</span> <span class="n">posterior</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
    <span class="n">sample_alpha</span> <span class="o">=</span> <span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span>
    <span class="n">sample_beta</span>  <span class="o">=</span> <span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span>
    <span class="n">sample_sigma</span> <span class="o">=</span> <span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">]</span>

    <span class="n">ds</span><span class="p">,</span> <span class="n">samples</span> <span class="o">=</span> <span class="n">jdc</span><span class="o">.</span><span class="n">sample_distributions</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span>
      <span class="n">sample_alpha</span><span class="p">,</span>
      <span class="n">sample_beta</span><span class="p">,</span>
      <span class="n">sample_sigma</span><span class="p">,</span>
      <span class="kc">None</span>
    <span class="p">])</span>

    <span class="n">log_likelihood_total</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">D</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>    
    
    <span class="c1"># we are inserting the log likelihood in the trace</span>
    <span class="c1"># as well though not required for this exercise</span>
    <span class="n">sample_stats</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">sample_stats</span>    
    <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">sample_stats</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">],</span> <span class="n">sample_stats</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;draw&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">50</span><span class="p">)]</span>
    <span class="n">sample_stats</span><span class="p">[</span><span class="s2">&quot;log_likelihood&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
        <span class="n">log_likelihood_total</span><span class="p">,</span> 
        <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span>  
        <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">,</span> <span class="s1">&#39;draw&#39;</span><span class="p">,</span> <span class="s1">&#39;log_likelihood_dim_0&#39;</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">log_likelihood_total</span>

<span class="k">def</span> <span class="nf">compute_log_likelihood_m5_3</span><span class="p">(</span><span class="n">jdc</span><span class="p">,</span> <span class="n">posterior</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
    <span class="n">sample_alpha</span> <span class="o">=</span> <span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span>
    <span class="n">sample_betaA</span> <span class="o">=</span> <span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;betaA&quot;</span><span class="p">]</span>
    <span class="n">sample_betaM</span> <span class="o">=</span> <span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;betaM&quot;</span><span class="p">]</span>
    <span class="n">sample_sigma</span> <span class="o">=</span> <span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">]</span>

    <span class="n">ds</span><span class="p">,</span> <span class="n">samples</span> <span class="o">=</span> <span class="n">jdc</span><span class="o">.</span><span class="n">sample_distributions</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span>
      <span class="n">sample_alpha</span><span class="p">,</span>
      <span class="n">sample_betaA</span><span class="p">,</span>
      <span class="n">sample_betaM</span><span class="p">,</span>
      <span class="n">sample_sigma</span><span class="p">,</span>
      <span class="kc">None</span>
    <span class="p">])</span>

    <span class="n">log_likelihood_total</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">D</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>    
    
    <span class="c1"># we are inserting the log likelihood in the trace</span>
    <span class="c1"># as well though not required for this exercise</span>
    <span class="n">sample_stats</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">sample_stats</span>    
    <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">sample_stats</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">],</span> <span class="n">sample_stats</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;draw&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">50</span><span class="p">)]</span>
    <span class="n">sample_stats</span><span class="p">[</span><span class="s2">&quot;log_likelihood&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
        <span class="n">log_likelihood_total</span><span class="p">,</span> 
        <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span>  
        <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">,</span> <span class="s1">&#39;draw&#39;</span><span class="p">,</span> <span class="s1">&#39;log_likelihood_dim_0&#39;</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">log_likelihood_total</span>

    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ll_5_1</span> <span class="o">=</span> <span class="n">compute_log_likelihood_m5_1_2</span><span class="p">(</span><span class="n">jdc_5_1</span><span class="p">,</span> <span class="n">posterior_5_1</span><span class="p">,</span> <span class="n">trace_5_1</span><span class="p">)</span>
<span class="n">ll_5_2</span> <span class="o">=</span> <span class="n">compute_log_likelihood_m5_1_2</span><span class="p">(</span><span class="n">jdc_5_2</span><span class="p">,</span> <span class="n">posterior_5_2</span><span class="p">,</span> <span class="n">trace_5_2</span><span class="p">)</span>
<span class="n">ll_5_3</span> <span class="o">=</span> <span class="n">compute_log_likelihood_m5_3</span><span class="p">(</span><span class="n">jdc_5_3</span><span class="p">,</span> <span class="n">posterior_5_3</span><span class="p">,</span> <span class="n">trace_5_3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">compare</span><span class="p">({</span><span class="s2">&quot;m5.1&quot;</span><span class="p">:</span> <span class="n">trace_5_1</span><span class="p">,</span> <span class="s2">&quot;m5.2&quot;</span><span class="p">:</span> <span class="n">trace_5_2</span><span class="p">,</span> <span class="s1">&#39;m5.3&#39;</span> <span class="p">:</span> <span class="n">trace_5_3</span><span class="p">},</span> <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;deviance&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/ksachdeva/rethinkingtfp/lib/python3.7/site-packages/arviz/stats/stats.py:695: UserWarning: Estimated shape parameter of Pareto distribution is greater than 0.7 for one or more samples. You should consider using a more robust model, this is because importance sampling is less likely to work well if the marginal posterior and LOO posterior are very different. This is more likely to happen with a non-robust model and highly influential observations.
  &quot;Estimated shape parameter of Pareto distribution is greater than 0.7 for &quot;
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>rank</th>
      <th>loo</th>
      <th>p_loo</th>
      <th>d_loo</th>
      <th>weight</th>
      <th>se</th>
      <th>dse</th>
      <th>warning</th>
      <th>loo_scale</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>m5.1</th>
      <td>0</td>
      <td>125.760884</td>
      <td>3.631360</td>
      <td>0.000000</td>
      <td>0.902731</td>
      <td>12.791071</td>
      <td>0.000000</td>
      <td>False</td>
      <td>deviance</td>
    </tr>
    <tr>
      <th>m5.3</th>
      <td>1</td>
      <td>127.328893</td>
      <td>4.619902</td>
      <td>1.568008</td>
      <td>0.000000</td>
      <td>12.848073</td>
      <td>0.596191</td>
      <td>True</td>
      <td>deviance</td>
    </tr>
    <tr>
      <th>m5.2</th>
      <td>2</td>
      <td>140.151201</td>
      <td>3.127365</td>
      <td>14.390317</td>
      <td>0.097269</td>
      <td>9.592710</td>
      <td>9.256663</td>
      <td>False</td>
      <td>deviance</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="code-7-34">
<h4>Code 7.34<a class="headerlink" href="#code-7-34" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">PSIS_m5_3</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">loo</span><span class="p">(</span><span class="n">trace_5_3</span><span class="p">,</span> <span class="n">pointwise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;deviance&quot;</span><span class="p">)</span>
<span class="n">WAIC_m5_3</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">waic</span><span class="p">(</span><span class="n">trace_5_3</span><span class="p">,</span> <span class="n">pointwise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;deviance&quot;</span><span class="p">)</span>

<span class="n">penalty</span> <span class="o">=</span> <span class="n">trace_5_3</span><span class="o">.</span><span class="n">sample_stats</span><span class="o">.</span><span class="n">log_likelihood</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
    <span class="n">sample</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;chain&quot;</span><span class="p">,</span> <span class="s2">&quot;draw&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;sample&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">PSIS_m5_3</span><span class="o">.</span><span class="n">pareto_k</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">penalty</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;PSIS Pareto k&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;WAIC penalty&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/ksachdeva/rethinkingtfp/lib/python3.7/site-packages/arviz/stats/stats.py:695: UserWarning: Estimated shape parameter of Pareto distribution is greater than 0.7 for one or more samples. You should consider using a more robust model, this is because importance sampling is less likely to work well if the marginal posterior and LOO posterior are very different. This is more likely to happen with a non-robust model and highly influential observations.
  &quot;Estimated shape parameter of Pareto distribution is greater than 0.7 for &quot;
/Users/ksachdeva/rethinkingtfp/lib/python3.7/site-packages/arviz/stats/stats.py:1460: UserWarning: For one or more samples the posterior variance of the log predictive densities exceeds 0.4. This could be indication of WAIC starting to fail. 
See http://arxiv.org/abs/1507.04544 for details
  &quot;For one or more samples the posterior variance of the log predictive &quot;
</pre></div>
</div>
<img alt="../_images/07_ulysses_compass_125_1.png" src="../_images/07_ulysses_compass_125_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># reproduce figure 7.11</span>

<span class="n">v</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="n">g</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">StudentT</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">lax</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">])</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">prob</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">prob</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>

<span class="n">lax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="o">-</span><span class="n">g</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">)</span>
<span class="n">lax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="o">-</span><span class="n">t</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/07_ulysses_compass_126_0.png" src="../_images/07_ulysses_compass_126_0.png" />
</div>
</div>
</div>
<div class="section" id="code-7-35">
<h4>Code 7.35<a class="headerlink" href="#code-7-35" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_5_3t</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">M</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;alpha&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">betaA</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;betaA&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">betaM</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;betaM&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        
        <span class="n">mu</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">betaA</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">A</span> <span class="o">+</span>  <span class="n">betaM</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">M</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        
        <span class="n">D</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">StudentT</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="mf">2.</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="n">jdc_5_3t</span> <span class="o">=</span> <span class="n">model_5_3t</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">compute_posterior_5_3t</span><span class="p">():</span>
    <span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">]),</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">]),</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">]),</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">NUMBER_OF_CHAINS</span><span class="p">]),</span>
    <span class="p">]</span>

    <span class="n">bijectors</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
        <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
        <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span>
        <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">(),</span>
    <span class="p">]</span>

    <span class="n">observed_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">D</span><span class="p">,)</span>

    <span class="c1"># here I am increasing the sampling size</span>
    <span class="c1"># to see if that helps</span>
    <span class="n">posterior</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                        <span class="n">jdc_5_3t</span><span class="p">,</span> 
                        <span class="n">observed_data</span><span class="o">=</span><span class="n">observed_data</span><span class="p">,</span>
                        <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;betaA&#39;</span><span class="p">,</span> <span class="s1">&#39;betaM&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">],</span>
                        <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                        <span class="n">burnin</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                        <span class="n">init_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
                        <span class="n">bijectors</span><span class="o">=</span><span class="n">bijectors</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">posterior</span><span class="p">,</span> <span class="n">trace</span>

<span class="n">posterior_5_3t</span><span class="p">,</span> <span class="n">trace_5_3t</span> <span class="o">=</span> <span class="n">compute_posterior_5_3t</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">compute_log_likelihood_m5_3t</span><span class="p">(</span><span class="n">jdc</span><span class="p">,</span> <span class="n">posterior</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
    <span class="n">sample_alpha</span> <span class="o">=</span> <span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span>
    <span class="n">sample_betaA</span> <span class="o">=</span> <span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;betaA&quot;</span><span class="p">]</span>
    <span class="n">sample_betaM</span> <span class="o">=</span> <span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;betaM&quot;</span><span class="p">]</span>
    <span class="n">sample_sigma</span> <span class="o">=</span> <span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">]</span>

    <span class="n">ds</span><span class="p">,</span> <span class="n">samples</span> <span class="o">=</span> <span class="n">jdc</span><span class="o">.</span><span class="n">sample_distributions</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span>
      <span class="n">sample_alpha</span><span class="p">,</span>
      <span class="n">sample_betaA</span><span class="p">,</span>
      <span class="n">sample_betaM</span><span class="p">,</span>
      <span class="n">sample_sigma</span><span class="p">,</span>
      <span class="kc">None</span>
    <span class="p">])</span>

    <span class="n">log_likelihood_total</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">D</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>    
    
    <span class="c1"># we are inserting the log likelihood in the trace</span>
    <span class="c1"># as well though not required for this exercise</span>
    <span class="n">sample_stats</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">sample_stats</span>    
    <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">sample_stats</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">],</span> <span class="n">sample_stats</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;draw&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">50</span><span class="p">)]</span>
    <span class="n">sample_stats</span><span class="p">[</span><span class="s2">&quot;log_likelihood&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
        <span class="n">log_likelihood_total</span><span class="p">,</span> 
        <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span>  
        <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">,</span> <span class="s1">&#39;draw&#39;</span><span class="p">,</span> <span class="s1">&#39;log_likelihood_dim_0&#39;</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">log_likelihood_total</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:@custom_gradient grad_fn has &#39;variables&#39; in signature, but no ResourceVariables were used on the forward pass.
WARNING:tensorflow:@custom_gradient grad_fn has &#39;variables&#39; in signature, but no ResourceVariables were used on the forward pass.
WARNING:tensorflow:@custom_gradient grad_fn has &#39;variables&#39; in signature, but no ResourceVariables were used on the forward pass.
WARNING:tensorflow:@custom_gradient grad_fn has &#39;variables&#39; in signature, but no ResourceVariables were used on the forward pass.
WARNING:tensorflow:@custom_gradient grad_fn has &#39;variables&#39; in signature, but no ResourceVariables were used on the forward pass.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ll</span> <span class="o">=</span> <span class="n">compute_log_likelihood_m5_3t</span><span class="p">(</span><span class="n">jdc_5_3t</span><span class="p">,</span> <span class="n">posterior_5_3t</span><span class="p">,</span> <span class="n">trace_5_3t</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">loo</span><span class="p">(</span><span class="n">trace_5_3</span><span class="p">,</span> <span class="n">pointwise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;deviance&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/ksachdeva/rethinkingtfp/lib/python3.7/site-packages/arviz/stats/stats.py:695: UserWarning: Estimated shape parameter of Pareto distribution is greater than 0.7 for one or more samples. You should consider using a more robust model, this is because importance sampling is less likely to work well if the marginal posterior and LOO posterior are very different. This is more likely to happen with a non-robust model and highly influential observations.
  &quot;Estimated shape parameter of Pareto distribution is greater than 0.7 for &quot;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Computed from 2000 by 50 log-likelihood matrix

             Estimate       SE
deviance_loo   127.33    12.85
p_loo            4.62        -

There has been a warning during the calculation. Please check the results.
------

Pareto k diagnostic values:
                         Count   Pct.
(-Inf, 0.5]   (good)       49   98.0%
 (0.5, 0.7]   (ok)          0    0.0%
   (0.7, 1]   (bad)         1    2.0%
   (1, Inf)   (very bad)    0    0.0%
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">compare</span><span class="p">({</span><span class="s1">&#39;m5.3&#39;</span> <span class="p">:</span> <span class="n">trace_5_3</span><span class="p">,</span> <span class="s1">&#39;m5.3t&#39;</span> <span class="p">:</span> <span class="n">trace_5_3t</span><span class="p">},</span> <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;deviance&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/ksachdeva/rethinkingtfp/lib/python3.7/site-packages/arviz/stats/stats.py:695: UserWarning: Estimated shape parameter of Pareto distribution is greater than 0.7 for one or more samples. You should consider using a more robust model, this is because importance sampling is less likely to work well if the marginal posterior and LOO posterior are very different. This is more likely to happen with a non-robust model and highly influential observations.
  &quot;Estimated shape parameter of Pareto distribution is greater than 0.7 for &quot;
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>rank</th>
      <th>loo</th>
      <th>p_loo</th>
      <th>d_loo</th>
      <th>weight</th>
      <th>se</th>
      <th>dse</th>
      <th>warning</th>
      <th>loo_scale</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>m5.3</th>
      <td>0</td>
      <td>127.328893</td>
      <td>4.619902</td>
      <td>0.000000</td>
      <td>0.857934</td>
      <td>12.848073</td>
      <td>0.000000</td>
      <td>True</td>
      <td>deviance</td>
    </tr>
    <tr>
      <th>m5.3t</th>
      <td>1</td>
      <td>133.156694</td>
      <td>6.335960</td>
      <td>5.827802</td>
      <td>0.142066</td>
      <td>11.445221</td>
      <td>5.927661</td>
      <td>False</td>
      <td>deviance</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_5_3</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha</th>
      <td>-0.001</td>
      <td>0.106</td>
      <td>-0.186</td>
      <td>0.148</td>
      <td>0.010</td>
      <td>0.007</td>
      <td>120.0</td>
      <td>270.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>betaA</th>
      <td>-0.601</td>
      <td>0.152</td>
      <td>-0.873</td>
      <td>-0.379</td>
      <td>0.007</td>
      <td>0.005</td>
      <td>493.0</td>
      <td>297.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>betaM</th>
      <td>-0.050</td>
      <td>0.154</td>
      <td>-0.274</td>
      <td>0.224</td>
      <td>0.009</td>
      <td>0.008</td>
      <td>313.0</td>
      <td>239.0</td>
      <td>1.02</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>0.821</td>
      <td>0.079</td>
      <td>0.693</td>
      <td>0.938</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>538.0</td>
      <td>865.0</td>
      <td>1.00</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_5_3t</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha</th>
      <td>0.018</td>
      <td>0.098</td>
      <td>-0.146</td>
      <td>0.159</td>
      <td>0.007</td>
      <td>0.005</td>
      <td>195.0</td>
      <td>317.0</td>
      <td>1.02</td>
    </tr>
    <tr>
      <th>betaA</th>
      <td>-0.693</td>
      <td>0.151</td>
      <td>-0.900</td>
      <td>-0.435</td>
      <td>0.006</td>
      <td>0.005</td>
      <td>743.0</td>
      <td>384.0</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>betaM</th>
      <td>0.049</td>
      <td>0.201</td>
      <td>-0.283</td>
      <td>0.360</td>
      <td>0.006</td>
      <td>0.008</td>
      <td>1179.0</td>
      <td>253.0</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>0.580</td>
      <td>0.091</td>
      <td>0.439</td>
      <td>0.720</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>1242.0</td>
      <td>187.0</td>
      <td>1.01</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="06_the_haunted_dag_and_the_causal_terror.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">6. The Haunted DAG and The Causal Terror</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="08_conditional_manatees.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">8. Conditional Manatees</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Richard McElreath<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>