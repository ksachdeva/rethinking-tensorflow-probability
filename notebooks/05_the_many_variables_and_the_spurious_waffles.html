
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>5. The Many Variables &amp; The Spurious Waffles &#8212; Statistical Rethinking (2nd Edition)</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="canonical" href="https://ksachdeva.github.io/rethinking-tensorflow-probability/notebooks/05_the_many_variables_and_the_spurious_waffles.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="6. The Haunted DAG and The Causal Terror" href="06_the_haunted_dag_and_the_causal_terror.html" />
    <link rel="prev" title="4. Geocentric Models" href="04_geocentric_models.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Statistical Rethinking (2nd Edition)</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../README.html">
   Statistical Rethinking (2nd Edition) with Tensorflow Probability
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="00_preface.html">
   Preface
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="01_the_golem_of_prague.html">
   1. The Gloem of Prague
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02_small_worlds_and_large_worlds.html">
   2. Small Worlds and Large Worlds
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03_sampling_the_imaginary.html">
   3. Sampling the Imaginary
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="04_geocentric_models.html">
   4. Geocentric Models
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   5. The Many Variables &amp; The Spurious Waffles
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="06_the_haunted_dag_and_the_causal_terror.html">
   6. The Haunted DAG and The Causal Terror
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="07_ulysses_compass.html">
   7. Ulysses’ Compass
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="08_conditional_manatees.html">
   8. Conditional Manatees
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="09_markov_chain_monte_carlo.html">
   9. Markov Chain Monte Carlo
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="10_big_entropy_and_the_generalized_linear_model.html">
   10. Big Entropy and The Generalized Linear Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="11_god_spiked_the_integers.html">
   11. God Spiked the Integers
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="12_monsters_and_mixtures.html">
   12. Monsters and Mixtures
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="13_models_with_memory.html">
   13. Models with Memory
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="14_adventures_in_covariance.html">
   14. Adventures in Covariance
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="15_missing_data_and_other_opportunities.html">
   15. Missing Data and Other Opportunities
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="16_generalized_linear_madness.html">
   16. Generalized Linear Madness
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="17_horoscopes.html">
   17. Horoscopes
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/notebooks/05_the_many_variables_and_the_spurious_waffles.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/ksachdeva/rethinking-tensorflow-probability"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/ksachdeva/rethinking-tensorflow-probability/issues/new?title=Issue%20on%20page%20%2Fnotebooks/05_the_many_variables_and_the_spurious_waffles.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/ksachdeva/rethinking-tensorflow-probability/master?urlpath=tree/notebooks/05_the_many_variables_and_the_spurious_waffles.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#spurious-association">
   5.1 Spurious association
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-1">
     Code 5.1
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-2">
     Code 5.2
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-3">
     Code 5.3
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-4">
     Code 5.4
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-5">
     Code 5.5
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-6">
     Code 5.6
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-7">
     Code 5.7
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-8">
     Code 5.8
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-9">
     Code 5.9
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-10">
     Code 5.10
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-11">
     Code 5.11
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-12-todo">
     Code 5.12 (TODO)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-13">
     Code 5.13
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-14">
     Code 5.14
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-15">
     Code 5.15
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-16">
     Code 5.16
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-17">
     Code 5.17
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-18">
     Code 5.18
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-19">
     Code 5.19
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-20">
     Code 5.20
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-21">
     Code 5.21
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-22">
     Code 5.22
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-23">
     Code 5.23
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-24-5-25-and-5-26">
     Code 5.24, 5.25 and 5.26
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-27">
     Code 5.27
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#masked-relationship">
   5.2 Masked relationship
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-28">
     Code 5.28
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-29">
     Code 5.29
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-30">
     Code 5.30
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-31">
     Code 5.31
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-32">
     Code 5.32
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-33">
     Code 5.33
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-34">
     Code 5.34
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-35">
     Code 5.35
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-36">
     Code 5.36
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-37">
     Code 5.37
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-38">
     Code 5.38
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-39">
     Code 5.39
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-40">
     Code 5.40
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-41">
     Code 5.41
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-42">
     Code 5.42
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-43">
     Code 5.43
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-44">
     Code 5.44
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#categorical-variables">
   5.3 Categorical variables
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-45">
     Code 5.45
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-46">
     Code 5.46
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-47">
     Code 5.47
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-48">
     Code 5.48
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-49">
     Code 5.49
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-50">
     Code 5.50
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-51">
     Code 5.51
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-52">
     Code 5.52
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-53">
     Code 5.53
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>5. The Many Variables & The Spurious Waffles</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#spurious-association">
   5.1 Spurious association
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-1">
     Code 5.1
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-2">
     Code 5.2
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-3">
     Code 5.3
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-4">
     Code 5.4
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-5">
     Code 5.5
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-6">
     Code 5.6
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-7">
     Code 5.7
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-8">
     Code 5.8
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-9">
     Code 5.9
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-10">
     Code 5.10
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-11">
     Code 5.11
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-12-todo">
     Code 5.12 (TODO)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-13">
     Code 5.13
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-14">
     Code 5.14
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-15">
     Code 5.15
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-16">
     Code 5.16
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-17">
     Code 5.17
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-18">
     Code 5.18
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-19">
     Code 5.19
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-20">
     Code 5.20
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-21">
     Code 5.21
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-22">
     Code 5.22
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-23">
     Code 5.23
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-24-5-25-and-5-26">
     Code 5.24, 5.25 and 5.26
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-27">
     Code 5.27
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#masked-relationship">
   5.2 Masked relationship
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-28">
     Code 5.28
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-29">
     Code 5.29
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-30">
     Code 5.30
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-31">
     Code 5.31
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-32">
     Code 5.32
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-33">
     Code 5.33
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-34">
     Code 5.34
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-35">
     Code 5.35
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-36">
     Code 5.36
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-37">
     Code 5.37
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-38">
     Code 5.38
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-39">
     Code 5.39
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-40">
     Code 5.40
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-41">
     Code 5.41
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-42">
     Code 5.42
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-43">
     Code 5.43
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-44">
     Code 5.44
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#categorical-variables">
   5.3 Categorical variables
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-45">
     Code 5.45
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-46">
     Code 5.46
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-47">
     Code 5.47
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-48">
     Code 5.48
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-49">
     Code 5.49
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-50">
     Code 5.50
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-51">
     Code 5.51
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-52">
     Code 5.52
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-5-53">
     Code 5.53
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <p><a class="reference external" href="https://colab.research.google.com/github/ksachdeva/rethinking-tensorflow-probability/blob/master/notebooks/05_the_many_variables_and_the_spurious_waffles.ipynb"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg" /></a></p>
<div class="tex2jax_ignore mathjax_ignore section" id="the-many-variables-the-spurious-waffles">
<h1>5. The Many Variables &amp; The Spurious Waffles<a class="headerlink" href="#the-many-variables-the-spurious-waffles" title="Permalink to this headline">¶</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Install packages that are not installed in colab</span>
<span class="k">try</span><span class="p">:</span>
  <span class="kn">import</span> <span class="nn">google.colab</span>
  <span class="o">!</span>pip install --upgrade daft
  <span class="o">!</span>pip install causalgraphicalmodels
  <span class="o">!</span>pip install watermark
  <span class="o">!</span>pip install git+https://github.com/ksachdeva/rethinking-tensorflow-probability.git
<span class="k">except</span><span class="p">:</span>
  <span class="k">pass</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> watermark
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Core</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">arviz</span> <span class="k">as</span> <span class="nn">az</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">tensorflow_probability</span> <span class="k">as</span> <span class="nn">tfp</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">stats</span>

<span class="c1"># visualization </span>
<span class="kn">import</span> <span class="nn">daft</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">causalgraphicalmodels</span> <span class="kn">import</span> <span class="n">CausalGraphicalModel</span>

<span class="kn">from</span> <span class="nn">rethinking.data</span> <span class="kn">import</span> <span class="n">RethinkingDataset</span>
<span class="kn">from</span> <span class="nn">rethinking.data</span> <span class="kn">import</span> <span class="n">dataframe_to_tensors</span>
<span class="kn">from</span> <span class="nn">rethinking.mcmc</span> <span class="kn">import</span> <span class="n">sample_posterior</span>


<span class="c1"># aliases</span>
<span class="n">tfd</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">distributions</span>
<span class="n">tfb</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">bijectors</span>
<span class="n">Root</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="o">.</span><span class="n">Root</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-01-18 03:40:34.293312: W tensorflow/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library &#39;libcudart.so.11.0&#39;; dlerror: libcudart.so.11.0: cannot open shared object file: No such file or directory
2022-01-18 03:40:34.293351: I tensorflow/stream_executor/cuda/cudart_stub.cc:29] Ignore above cudart dlerror if you do not have a GPU set up on your machine.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">watermark</span> -p numpy,tensorflow,tensorflow_probability,arviz,scipy,pandas,daft,causalgraphicalmodels,rethinking
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>numpy                 : 1.21.5
tensorflow            : 2.7.0
tensorflow_probability: 0.15.0
arviz                 : 0.11.4
scipy                 : 1.7.3
pandas                : 1.3.5
daft                  : 0.1.2
causalgraphicalmodels : 0.0.4
rethinking            : 0.1.0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># config of various plotting libraries</span>
<span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;retina&#39;
</pre></div>
</div>
</div>
</div>
<div class="section" id="spurious-association">
<h2>5.1 Spurious association<a class="headerlink" href="#spurious-association" title="Permalink to this headline">¶</a></h2>
<div class="section" id="code-5-1">
<h3>Code 5.1<a class="headerlink" href="#code-5-1" title="Permalink to this headline">¶</a></h3>
<p>The chapter is going to use 2 predictor variables - Marriage Rate &amp; Median Age at Marriage to predict the divorce rate. Here we start with the first predictor variable - Median Age at Marriage</p>
<p>Loading the dataset and standardizing the variables of interest (i.e. median age at marriage and divorce rate)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">RethinkingDataset</span><span class="o">.</span><span class="n">WaffleDivorce</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">()</span>

<span class="c1"># standardize variables</span>
<span class="n">d</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">MedianAgeMarriage</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
<span class="n">d</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">Divorce</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-5-2">
<h3>Code 5.2<a class="headerlink" href="#code-5-2" title="Permalink to this headline">¶</a></h3>
<p>Here is the description of the linear regression model that use Median Age as the predictor variable.</p>
<p><span class="math notranslate nohighlight">\(D_i \sim Normal(\mu_i,\sigma)\)</span></p>
<p><span class="math notranslate nohighlight">\(\mu_i = \alpha + \beta_AA_i\)</span></p>
<p><span class="math notranslate nohighlight">\(\alpha \sim Normal(0,0.2)\)</span></p>
<p><span class="math notranslate nohighlight">\(\beta_A \sim Normal(0,0.5)\)</span></p>
<p><span class="math notranslate nohighlight">\(\sigma \sim Exponential(1)\)</span></p>
<p>We have standardized both D and A this means that the intercept (<span class="math notranslate nohighlight">\(\alpha\)</span>) should be close to zero.</p>
<p>A slope (<span class="math notranslate nohighlight">\(\beta_A\)</span>) of 1 would then imply that a change in one standard deviation in marriage rate is associated with change of one standard deviation in divorce.</p>
<p>Below we compute the standard deviation in median age</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span><span class="o">.</span><span class="n">MedianAgeMarriage</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.2436303013880823
</pre></div>
</div>
</div>
</div>
<p>This means that when <span class="math notranslate nohighlight">\(\beta_A\)</span> is 1 then we expect a change of 1.2 years in median age at marriage is associated with 1 full standard deviation of the divorce rate.</p>
</div>
<div class="section" id="code-5-3">
<h3>Code 5.3<a class="headerlink" href="#code-5-3" title="Permalink to this headline">¶</a></h3>
<p>Define the model and compute the posterior</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tdf</span> <span class="o">=</span> <span class="n">dataframe_to_tensors</span><span class="p">(</span><span class="s1">&#39;WaffleDivorce&#39;</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">model_5_1</span><span class="p">(</span><span class="n">median_age_data</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
      <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;alpha&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">betaA</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;betaA&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    
      <span class="n">mu</span> <span class="o">=</span>  <span class="n">alpha</span> <span class="o">+</span> <span class="n">betaA</span> <span class="o">*</span> <span class="n">median_age_data</span>
        
      <span class="n">divorce</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;divorce&quot;</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    
    
<span class="n">jdc_5_1</span> <span class="o">=</span> <span class="n">model_5_1</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">A</span><span class="p">)</span>

<span class="n">posterior_5_1</span><span class="p">,</span> <span class="n">trace_5_1</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                                <span class="n">jdc_5_1</span><span class="p">,</span> 
                                <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">D</span><span class="p">,</span> <span class="p">),</span> 
                                <span class="n">bijectors</span><span class="o">=</span><span class="p">[</span><span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span> <span class="n">tfb</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span> <span class="n">tfb</span><span class="o">.</span><span class="n">Exp</span><span class="p">()],</span>
                                <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;betaA&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-01-18 03:40:36.605949: W tensorflow/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library &#39;libcuda.so.1&#39;; dlerror: libcuda.so.1: cannot open shared object file: No such file or directory
2022-01-18 03:40:36.605981: W tensorflow/stream_executor/cuda/cuda_driver.cc:269] failed call to cuInit: UNKNOWN ERROR (303)
2022-01-18 03:40:36.606002: I tensorflow/stream_executor/cuda/cuda_diagnostics.cc:156] kernel driver does not appear to be running on this host (fv-az173-245): /proc/driver/nvidia/version does not exist
2022-01-18 03:40:36.606312: I tensorflow/core/platform/cpu_feature_guard.cc:151] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  AVX2 AVX512F FMA
To enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-5-4">
<h3>Code 5.4<a class="headerlink" href="#code-5-4" title="Permalink to this headline">¶</a></h3>
<p>Before we do posterior analysis let’s check our priors</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Below we are using the value of A (median age) </span>
<span class="n">A</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">jdc_5_1_prior</span> <span class="o">=</span> <span class="n">model_5_1</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
<span class="n">prior_pred_samples</span> <span class="o">=</span> <span class="n">jdc_5_1_prior</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prior_alpha</span> <span class="o">=</span> <span class="n">prior_pred_samples</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">prior_beta</span>  <span class="o">=</span> <span class="n">prior_pred_samples</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">prior_sigma</span> <span class="o">=</span> <span class="n">prior_pred_samples</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<span class="n">ds</span><span class="p">,</span> <span class="n">samples</span> <span class="o">=</span> <span class="n">jdc_5_1_prior</span><span class="o">.</span><span class="n">sample_distributions</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span>
    <span class="n">prior_alpha</span><span class="p">,</span>
    <span class="n">prior_beta</span><span class="p">,</span>
    <span class="n">prior_sigma</span><span class="p">,</span>
    <span class="kc">None</span>
<span class="p">])</span>

<span class="n">mu</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">loc</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">mu</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Median age marriage (std)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Divorce rate (std)&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/05_the_many_variables_and_the_spurious_waffles_17_0.png" src="../_images/05_the_many_variables_and_the_spurious_waffles_17_0.png" />
</div>
</div>
</div>
<div class="section" id="code-5-5">
<h3>Code 5.5<a class="headerlink" href="#code-5-5" title="Permalink to this headline">¶</a></h3>
<p>Now for the posterior predictions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sample_alpha</span> <span class="o">=</span> <span class="n">posterior_5_1</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sample_betaA</span> <span class="o">=</span> <span class="n">posterior_5_1</span><span class="p">[</span><span class="s2">&quot;betaA&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sample_sigma</span> <span class="o">=</span> <span class="n">posterior_5_1</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="n">A_seq</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="o">=-</span><span class="mf">3.</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mf">3.2</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">A_seq</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">A_seq</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="c1"># we are creating a new model for the test values</span>
<span class="n">jdc_5_1_test</span> <span class="o">=</span> <span class="n">model_5_1</span><span class="p">(</span><span class="n">A_seq</span><span class="p">)</span>

<span class="c1"># we will sample it using the trace_5_1</span>
<span class="n">ds</span><span class="p">,</span> <span class="n">samples</span> <span class="o">=</span> <span class="n">jdc_5_1_test</span><span class="o">.</span><span class="n">sample_distributions</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span>
    <span class="n">sample_alpha</span><span class="p">,</span>
    <span class="n">sample_betaA</span><span class="p">,</span>
    <span class="n">sample_sigma</span><span class="p">,</span>
    <span class="kc">None</span>
<span class="p">])</span>

<span class="n">mu_pred</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">loc</span>

<span class="n">mu_mean</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">mu_pred</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">mu_PI</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">mu_pred</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="p">(</span><span class="mf">5.5</span><span class="p">,</span> <span class="mf">94.5</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot it all</span>
<span class="n">az</span><span class="o">.</span><span class="n">plot_pair</span><span class="p">(</span><span class="n">d</span><span class="p">[[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;list&quot;</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">A_seq</span><span class="p">,</span> <span class="n">mu_PI</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mu_PI</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">A_seq</span><span class="p">,</span> <span class="n">mu_mean</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/05_the_many_variables_and_the_spurious_waffles_20_0.png" src="../_images/05_the_many_variables_and_the_spurious_waffles_20_0.png" />
</div>
</div>
<p>Above plot is showing that the influence of age at marriage is strongly negative with divorce rate</p>
</div>
<div class="section" id="code-5-6">
<h3>Code 5.6<a class="headerlink" href="#code-5-6" title="Permalink to this headline">¶</a></h3>
<p>We can now model a simple regression for the Mariage rate as well.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">Marriage</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>

<span class="n">tdf</span> <span class="o">=</span> <span class="n">dataframe_to_tensors</span><span class="p">(</span><span class="s1">&#39;WaffleDivorce&#39;</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">model_5_2</span><span class="p">(</span><span class="n">marriage_rate_data</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
      <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;alpha&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">betaM</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;betaM&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    
      <span class="n">mu</span> <span class="o">=</span>  <span class="n">alpha</span> <span class="o">+</span> <span class="n">betaM</span> <span class="o">*</span> <span class="n">marriage_rate_data</span>
        
      <span class="n">divorce</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;divorce&quot;</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    
    
<span class="n">jdc_5_2</span> <span class="o">=</span> <span class="n">model_5_2</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>

<span class="n">posterior_5_2</span><span class="p">,</span> <span class="n">trace_5_2</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                <span class="n">jdc_5_2</span><span class="p">,</span> 
                <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">D</span><span class="p">,),</span> 
                <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;betaM&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sample_alpha</span> <span class="o">=</span> <span class="n">posterior_5_2</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sample_betaM</span> <span class="o">=</span> <span class="n">posterior_5_2</span><span class="p">[</span><span class="s2">&quot;betaM&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sample_sigma</span> <span class="o">=</span> <span class="n">posterior_5_2</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="n">M_seq</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="o">=-</span><span class="mf">3.</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mf">3.2</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">M_seq</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">M_seq</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="c1"># we are creating a new model for the test values</span>
<span class="n">jdc_5_2_test</span> <span class="o">=</span> <span class="n">model_5_2</span><span class="p">(</span><span class="n">M_seq</span><span class="p">)</span>

<span class="c1"># we will sample it using the trace_5_1</span>
<span class="n">ds</span><span class="p">,</span> <span class="n">samples</span> <span class="o">=</span> <span class="n">jdc_5_2_test</span><span class="o">.</span><span class="n">sample_distributions</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span>
    <span class="n">sample_alpha</span><span class="p">,</span> 
    <span class="n">sample_betaM</span><span class="p">,</span> 
    <span class="n">sample_sigma</span><span class="p">,</span> 
    <span class="kc">None</span>
<span class="p">])</span>

<span class="n">mu_pred</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">loc</span>

<span class="n">mu_mean</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">mu_pred</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">mu_PI</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">mu_pred</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="p">(</span><span class="mf">5.5</span><span class="p">,</span> <span class="mf">94.5</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># plot it all</span>
<span class="n">az</span><span class="o">.</span><span class="n">plot_pair</span><span class="p">(</span><span class="n">d</span><span class="p">[[</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;list&quot;</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">M_seq</span><span class="p">,</span> <span class="n">mu_PI</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mu_PI</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">M_seq</span><span class="p">,</span> <span class="n">mu_mean</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/05_the_many_variables_and_the_spurious_waffles_24_0.png" src="../_images/05_the_many_variables_and_the_spurious_waffles_24_0.png" />
</div>
</div>
<p>Above plot is showing that the influence of marriage rate is strongly positive with divorce rate</p>
</div>
<div class="section" id="code-5-7">
<h3>Code 5.7<a class="headerlink" href="#code-5-7" title="Permalink to this headline">¶</a></h3>
<p>Author suggests that merely comparing parameter means between bivariate regressions is no way to decide which predictor is better. They may be independent, or related or could eliminate other.</p>
<p>How do we understand all this ?</p>
<p>He explains that here we may want to think <strong>causally</strong>.</p>
<p>Few interesting assumptions (or rather deductions) -</p>
<p>a) Age has a direct impact on Divorce rate as people may grow incompatible with the parter</p>
<p>b) Marriage Rate has a direct impact on Divorce rate for obvious reason (more marriages =&gt; more divorce)</p>
<p>c) Finally, Age has an impact on Marriage Rate because there are more young people</p>
<p>Another way to represent above is :</p>
<p>A -&gt; D</p>
<p>M -&gt; D</p>
<p>A -&gt; M</p>
<p>and yet another way is to use <strong>DAG</strong> (Directed Acyclic Graphs)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dag5_1</span> <span class="o">=</span> <span class="n">CausalGraphicalModel</span><span class="p">(</span>
    <span class="n">nodes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">],</span>
    <span class="n">edges</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">),</span>
           <span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">),</span>
           <span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">)])</span>
<span class="n">pgm</span> <span class="o">=</span> <span class="n">daft</span><span class="o">.</span><span class="n">PGM</span><span class="p">()</span>
<span class="n">coordinates</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;D&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)}</span>
<span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">dag5_1</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
    <span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">coordinates</span><span class="p">[</span><span class="n">node</span><span class="p">])</span>
<span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">dag5_1</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
    <span class="n">pgm</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="o">*</span><span class="n">edge</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/05_the_many_variables_and_the_spurious_waffles_27_0.png" src="../_images/05_the_many_variables_and_the_spurious_waffles_27_0.png" />
</div>
</div>
<p>Above DAG clearly shows that A impacts D directly and indirectly (i.e. via M)</p>
<p>The author used “total influence”. What is meant by <em>total</em> is that we need to account for every path from <strong>A</strong> to <strong>D</strong>.</p>
<p><strong>MEDIATION</strong> - Let’s say that <strong>A</strong> did not directly influenced <strong>D</strong>; rather it did it via <strong>M</strong>. This type of relationship is called <em>Mediation</em></p>
<p>Author raises many interesting questions here. He asks if there is indeed a direct effect of marriage rate or rather is age at marriage just driving both, creating a <strong>spurious</strong> coorelation between marriage rate and divorce rate</p>
</div>
<div class="section" id="code-5-8">
<h3>Code 5.8<a class="headerlink" href="#code-5-8" title="Permalink to this headline">¶</a></h3>
<p>Checking conditional indpendencies</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Note - There is no explicity code section for drawing the second DAG</span>
<span class="c1"># but the figure appears in the book and hence drawing it as well</span>
<span class="n">dag5_2</span> <span class="o">=</span> <span class="n">CausalGraphicalModel</span><span class="p">(</span>
    <span class="n">nodes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">],</span>
    <span class="n">edges</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">),</span>
           <span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">)])</span>
<span class="n">pgm</span> <span class="o">=</span> <span class="n">daft</span><span class="o">.</span><span class="n">PGM</span><span class="p">()</span>
<span class="n">coordinates</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;D&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)}</span>
<span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">dag5_2</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
    <span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">coordinates</span><span class="p">[</span><span class="n">node</span><span class="p">])</span>
<span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">dag5_2</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
    <span class="n">pgm</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="o">*</span><span class="n">edge</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/05_the_many_variables_and_the_spurious_waffles_30_0.png" src="../_images/05_the_many_variables_and_the_spurious_waffles_30_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DMA_dag2</span> <span class="o">=</span> <span class="n">CausalGraphicalModel</span><span class="p">(</span>
    <span class="n">nodes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">],</span>
    <span class="n">edges</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">),</span>
           <span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">)])</span>
<span class="n">all_independencies</span> <span class="o">=</span> <span class="n">DMA_dag2</span><span class="o">.</span><span class="n">get_all_independence_relationships</span><span class="p">()</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">all_independencies</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
           <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_independencies</span> <span class="k">if</span> <span class="n">t</span> <span class="o">!=</span> <span class="n">s</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;M&#39;, &#39;D&#39;, {&#39;A&#39;})
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-5-9">
<h3>Code 5.9<a class="headerlink" href="#code-5-9" title="Permalink to this headline">¶</a></h3>
<p>Checking conditional indpenedencies in the DAG1</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DMA_dag1</span> <span class="o">=</span> <span class="n">CausalGraphicalModel</span><span class="p">(</span>
    <span class="n">nodes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">],</span>
    <span class="n">edges</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">),</span>
           <span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">),</span>
           <span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">)])</span>
<span class="n">all_independencies</span> <span class="o">=</span> <span class="n">DMA_dag1</span><span class="o">.</span><span class="n">get_all_independence_relationships</span><span class="p">()</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">all_independencies</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
           <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_independencies</span> <span class="k">if</span> <span class="n">t</span> <span class="o">!=</span> <span class="n">s</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Executing above cell should not display anything as in the DAG1 (where all nodes are connected to each other) there are no conditional indpedencies.</p>
</div>
<div class="section" id="code-5-10">
<h3>Code 5.10<a class="headerlink" href="#code-5-10" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_5_3</span><span class="p">(</span><span class="n">median_age_data</span><span class="p">,</span> <span class="n">marriage_rate_data</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
      <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;alpha&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">betaA</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;betaA&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">betaM</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;betaM&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>          
      <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    
      <span class="n">mu</span> <span class="o">=</span>  <span class="n">alpha</span> <span class="o">+</span> <span class="n">betaA</span> <span class="o">*</span> <span class="n">median_age_data</span> <span class="o">+</span> <span class="n">betaM</span> <span class="o">*</span> <span class="n">marriage_rate_data</span>
        
      <span class="n">divorce</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;divorce&quot;</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    
    
<span class="n">jdc_5_3</span> <span class="o">=</span> <span class="n">model_5_3</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>

<span class="n">posterior_5_3</span><span class="p">,</span> <span class="n">trace_5_3</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                                <span class="n">jdc_5_3</span><span class="p">,</span> 
                                <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">D</span><span class="p">,),</span> 
                                <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;betaA&#39;</span><span class="p">,</span> <span class="s1">&#39;betaM&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_5_3</span><span class="p">,</span> <span class="n">round_to</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;stats&#39;</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha[0]</th>
      <td>0.00</td>
      <td>0.10</td>
      <td>-0.15</td>
      <td>0.17</td>
    </tr>
    <tr>
      <th>betaA[0]</th>
      <td>-0.60</td>
      <td>0.16</td>
      <td>-0.84</td>
      <td>-0.33</td>
    </tr>
    <tr>
      <th>betaM[0]</th>
      <td>-0.05</td>
      <td>0.17</td>
      <td>-0.31</td>
      <td>0.22</td>
    </tr>
    <tr>
      <th>sigma[0]</th>
      <td>0.83</td>
      <td>0.09</td>
      <td>0.69</td>
      <td>0.98</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Let’s try to understand the above table generated by arviz.</p>
<p>In the model above, we had include both the predictors i.e. M &amp; A. The weights of M i.e. betaM is approaching zero where as betaA is more or less unchanged.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(</span><span class="n">trace_5_3</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/05_the_many_variables_and_the_spurious_waffles_39_0.png" src="../_images/05_the_many_variables_and_the_spurious_waffles_39_0.png" />
</div>
</div>
</div>
<div class="section" id="code-5-11">
<h3>Code 5.11<a class="headerlink" href="#code-5-11" title="Permalink to this headline">¶</a></h3>
<p>Here we will take the help of forest plot to compare the posteriors of various models that we have built so far</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coeftab</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;m5.1&quot;</span><span class="p">:</span> <span class="n">trace_5_1</span><span class="p">,</span>
           <span class="s2">&quot;m5.2&quot;</span><span class="p">:</span> <span class="n">trace_5_2</span><span class="p">,</span>
           <span class="s2">&quot;m5.3&quot;</span><span class="p">:</span> <span class="n">trace_5_3</span><span class="p">}</span>

<span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">coeftab</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">model_names</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">coeftab</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span><span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
               <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;betaA&quot;</span><span class="p">,</span> <span class="s2">&quot;betaM&quot;</span><span class="p">],</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/05_the_many_variables_and_the_spurious_waffles_41_0.png" src="../_images/05_the_many_variables_and_the_spurious_waffles_41_0.png" />
</div>
</div>
<p>Let’s learn how to read above plot</p>
<p>m5.1 is our first model where we had used betaA. If we compare it to m5.3 it is more or less at the same place.</p>
<p>whereas,</p>
<p>m5.2 is our second model where we had used betaM. If we compare it to m5.3, it is now closer to zero.</p>
<p>This is another way to read/plot what we saw in the arviz summary in Code 5.10</p>
<p>From all this, we can say that - once we know median age at marriage for a State, there is little or no additional predictive power in also knowing the rate of marriage in that state</p>
</div>
<div class="section" id="code-5-12-todo">
<h3>Code 5.12 (TODO)<a class="headerlink" href="#code-5-12-todo" title="Permalink to this headline">¶</a></h3>
<p>Possibly revisit this to do what professor has asked to do instead of just translating the code in the cell</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># number of simulated States</span>
<span class="n">age</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">((</span><span class="n">N</span><span class="p">,))</span>  <span class="c1"># sim A</span>
<span class="n">mar</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">age</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>  <span class="c1"># sim A -&gt; M</span>
<span class="n">div</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">age</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>  <span class="c1"># sim A -&gt; D</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-5-13">
<h3>Code 5.13<a class="headerlink" href="#code-5-13" title="Permalink to this headline">¶</a></h3>
<p>Following few cells are all about how to plot multivariate posteriors.</p>
<p>Previously we had only 1 predictor variable and hence a single scatterplot can convey a lot of information. Addition of regression lines and intervals also helped in estimating the size and uncertainity.</p>
<p>However, in the case multivariate regression we would have use other types of plots.</p>
<p>Author mentions that we need to also know how to select the proper type of plot for a given problem.</p>
<p>He explains 3 types of plots -</p>
<ul class="simple">
<li><p>Predictor residual plots</p></li>
<li><p>Posterior prediction plots</p></li>
<li><p>Counterfactual plots</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># we are first redefining our first model. It is exactly the same as m5_1</span>

<span class="k">def</span> <span class="nf">model_5_4</span><span class="p">(</span><span class="n">median_age_data</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
      <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;alpha&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">betaA</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;betaA&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    
      <span class="n">mu</span> <span class="o">=</span>  <span class="n">alpha</span> <span class="o">+</span> <span class="n">betaA</span> <span class="o">*</span> <span class="n">median_age_data</span>
        
      <span class="n">M</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;M&quot;</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    
    
<span class="n">jdc_5_4</span> <span class="o">=</span> <span class="n">model_5_4</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">A</span><span class="p">)</span>

<span class="n">posterior_5_4</span><span class="p">,</span> <span class="n">trace_5_4</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                                <span class="n">jdc_5_4</span><span class="p">,</span> 
                                <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">D</span><span class="p">,),</span> 
                                <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;betaA&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(</span><span class="n">trace_5_4</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/arviz/stats/density_utils.py:481: UserWarning: Your data appears to have a single value or no finite values
  warnings.warn(&quot;Your data appears to have a single value or no finite values&quot;)
/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/arviz/stats/density_utils.py:481: UserWarning: Your data appears to have a single value or no finite values
  warnings.warn(&quot;Your data appears to have a single value or no finite values&quot;)
/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/arviz/stats/density_utils.py:481: UserWarning: Your data appears to have a single value or no finite values
  warnings.warn(&quot;Your data appears to have a single value or no finite values&quot;)
</pre></div>
</div>
<img alt="../_images/05_the_many_variables_and_the_spurious_waffles_48_1.png" src="../_images/05_the_many_variables_and_the_spurious_waffles_48_1.png" />
</div>
</div>
</div>
<div class="section" id="code-5-14">
<h3>Code 5.14<a class="headerlink" href="#code-5-14" title="Permalink to this headline">¶</a></h3>
<p>First is <strong>Predictor residual plot</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sample_alpha</span> <span class="o">=</span> <span class="n">posterior_5_4</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sample_betaA</span> <span class="o">=</span> <span class="n">posterior_5_4</span><span class="p">[</span><span class="s2">&quot;betaA&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sample_sigma</span> <span class="o">=</span> <span class="n">posterior_5_4</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="n">ds</span><span class="p">,</span> <span class="n">samples</span> <span class="o">=</span> <span class="n">jdc_5_4</span><span class="o">.</span><span class="n">sample_distributions</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span>
    <span class="n">sample_alpha</span><span class="p">,</span>
    <span class="n">sample_betaA</span><span class="p">,</span>
    <span class="n">sample_sigma</span><span class="p">,</span>
    <span class="kc">None</span>
<span class="p">])</span>

<span class="n">mu_pred</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">loc</span>

<span class="n">mu_mean</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">mu_pred</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">mu_resid</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">M</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">mu_mean</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-5-15">
<h3>Code 5.15<a class="headerlink" href="#code-5-15" title="Permalink to this headline">¶</a></h3>
<p>Second is <strong>Posterior prediction plots</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sample_alpha</span> <span class="o">=</span> <span class="n">posterior_5_3</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sample_betaA</span> <span class="o">=</span> <span class="n">posterior_5_3</span><span class="p">[</span><span class="s2">&quot;betaA&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sample_betaM</span> <span class="o">=</span> <span class="n">posterior_5_3</span><span class="p">[</span><span class="s2">&quot;betaM&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sample_sigma</span> <span class="o">=</span> <span class="n">posterior_5_3</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="n">ds</span><span class="p">,</span> <span class="n">samples</span> <span class="o">=</span> <span class="n">jdc_5_3</span><span class="o">.</span><span class="n">sample_distributions</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span>
    <span class="n">sample_alpha</span><span class="p">,</span>
    <span class="n">sample_betaA</span><span class="p">,</span>
    <span class="n">sample_betaM</span><span class="p">,</span>
    <span class="n">sample_sigma</span><span class="p">,</span> 
    <span class="kc">None</span>
<span class="p">])</span>

<span class="n">mu_pred</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">loc</span>

<span class="n">mu_mean</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">mu_pred</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">mu_PI</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">mu_pred</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="p">(</span><span class="mf">5.5</span><span class="p">,</span> <span class="mf">94.5</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

<span class="c1"># get the simulated D</span>
<span class="n">D_sim</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">D_PI</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">D_sim</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="p">(</span><span class="mf">5.5</span><span class="p">,</span> <span class="mf">94.5</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>    

<span class="n">D_sim</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>TensorShape([500, 50])
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-5-16">
<h3>Code 5.16<a class="headerlink" href="#code-5-16" title="Permalink to this headline">¶</a></h3>
<p>Plot predictions against the observed</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">mu_PI</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> <span class="nb">float</span><span class="p">(</span><span class="n">mu_PI</span><span class="o">.</span><span class="n">max</span><span class="p">())),</span>
                 <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Observed divorce&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Predicted divorce&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">D</span><span class="p">,</span> <span class="n">mu_mean</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">mu_PI</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">mu_PI</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">101</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">mu_PI</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="s2">&quot;b&quot;</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/05_the_many_variables_and_the_spurious_waffles_54_0.png" src="../_images/05_the_many_variables_and_the_spurious_waffles_54_0.png" />
</div>
</div>
<p>The diagonal line shows <strong>perfect predictions</strong>.</p>
</div>
<div class="section" id="code-5-17">
<h3>Code 5.17<a class="headerlink" href="#code-5-17" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">Loc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">,</span> <span class="s2">&quot;UT&quot;</span><span class="p">,</span> <span class="s2">&quot;RI&quot;</span><span class="p">,</span> <span class="s2">&quot;ME&quot;</span><span class="p">]:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">Loc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mu_mean</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">),</span>
                    <span class="n">textcoords</span><span class="o">=</span><span class="s2">&quot;offset pixels&quot;</span><span class="p">)</span>
<span class="n">fig</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/05_the_many_variables_and_the_spurious_waffles_57_0.png" src="../_images/05_the_many_variables_and_the_spurious_waffles_57_0.png" />
</div>
</div>
<p>Remember that the above graph is draw using m5_3 that had taken both predictor variables in account.</p>
<p>According to book, above figure shows -
“Model under-predicts for States with very high divorce rate while it over-predicts for states with very low divorce rates.”</p>
<p><strong>I am not able to interpret that :(</strong></p>
<p>Some states, the ones which are labelled i.e. Idaho (ID), Utah (UT) have lower divorce rates because of religious regions.</p>
</div>
<div class="section" id="code-5-18">
<h3>Code 5.18<a class="headerlink" href="#code-5-18" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># number of cases</span>
<span class="c1"># x_real as Gaussian with mean 0 and stddev 1</span>
<span class="n">x_real</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">((</span><span class="n">N</span><span class="p">,))</span>
<span class="c1"># x_spur as Gaussian with mean=x_real</span>
<span class="n">x_spur</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">x_real</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
<span class="c1"># y as Gaussian with mean=x_real</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">x_real</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
<span class="c1"># bind all together in data frame</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span> <span class="s2">&quot;x_real&quot;</span><span class="p">:</span> <span class="n">x_real</span><span class="p">,</span> <span class="s2">&quot;x_spur&quot;</span><span class="p">:</span> <span class="n">x_spur</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>y</th>
      <th>x_real</th>
      <th>x_spur</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-0.553216</td>
      <td>0.279166</td>
      <td>0.584016</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-1.107027</td>
      <td>-0.876403</td>
      <td>-0.552197</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-1.186114</td>
      <td>0.203002</td>
      <td>0.260309</td>
    </tr>
    <tr>
      <th>3</th>
      <td>-1.472900</td>
      <td>-1.002320</td>
      <td>-2.154058</td>
    </tr>
    <tr>
      <th>4</th>
      <td>-0.552986</td>
      <td>0.375269</td>
      <td>0.716796</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>95</th>
      <td>-1.719238</td>
      <td>0.534809</td>
      <td>0.813719</td>
    </tr>
    <tr>
      <th>96</th>
      <td>-1.469997</td>
      <td>-0.129842</td>
      <td>1.697508</td>
    </tr>
    <tr>
      <th>97</th>
      <td>1.246525</td>
      <td>0.090118</td>
      <td>1.388067</td>
    </tr>
    <tr>
      <th>98</th>
      <td>-3.722050</td>
      <td>-1.757211</td>
      <td>-4.754894</td>
    </tr>
    <tr>
      <th>99</th>
      <td>-0.339856</td>
      <td>0.420179</td>
      <td>-0.940463</td>
    </tr>
  </tbody>
</table>
<p>100 rows × 3 columns</p>
</div></div></div>
</div>
</div>
<div class="section" id="code-5-19">
<h3>Code 5.19<a class="headerlink" href="#code-5-19" title="Permalink to this headline">¶</a></h3>
<p>Third type of plot is called <strong>Counterfactual Plots</strong></p>
<p>The simplest use of counterfactual plot is to see how the prediction changes as we change <strong>only one</strong> predictor at a time.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Reloading the dataset</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">RethinkingDataset</span><span class="o">.</span><span class="n">WaffleDivorce</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">()</span>

<span class="c1"># standardize variables</span>
<span class="n">d</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">MedianAgeMarriage</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
<span class="n">d</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">Divorce</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
<span class="n">d</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">Marriage</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>

<span class="n">tdf</span> <span class="o">=</span> <span class="n">dataframe_to_tensors</span><span class="p">(</span><span class="s1">&#39;WaffleDivorce&#39;</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_5_3_A</span><span class="p">(</span><span class="n">median_age_data</span><span class="p">,</span> <span class="n">marriage_rate_data</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
      <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;alpha&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">betaA</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;betaA&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">betaM</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;betaM&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>          
      <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    
      <span class="n">mu</span> <span class="o">=</span>  <span class="n">alpha</span> <span class="o">+</span> <span class="n">betaA</span> <span class="o">*</span> <span class="n">median_age_data</span> <span class="o">+</span> <span class="n">betaM</span> <span class="o">*</span> <span class="n">marriage_rate_data</span>
        
      <span class="n">divorce</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;divorce&quot;</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    

<span class="k">def</span> <span class="nf">model_5_X_M</span><span class="p">(</span><span class="n">median_age_data</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
      <span class="n">alphaM</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;alphaM&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">betaAM</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;betaAM&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>      
      <span class="n">sigmaM</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigmaM&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    
      <span class="n">mu_M</span> <span class="o">=</span>  <span class="n">alphaM</span> <span class="o">+</span> <span class="n">betaAM</span> <span class="o">*</span> <span class="n">median_age_data</span> 
        
      <span class="n">M</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu_M</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigmaM</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;M&quot;</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    

<span class="c1">## First model</span>
<span class="n">jdc_5_3_A</span> <span class="o">=</span> <span class="n">model_5_3_A</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
<span class="n">posterior_5_3_A</span><span class="p">,</span> <span class="n">trace_5_3_A</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                        <span class="n">jdc_5_3_A</span><span class="p">,</span> 
                        <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">D</span><span class="p">,),</span> 
                        <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;betaA&#39;</span><span class="p">,</span> <span class="s1">&#39;betaM&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">])</span>

<span class="c1">## Second model</span>
<span class="n">jdc_5_X_M</span> <span class="o">=</span> <span class="n">model_5_X_M</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">A</span><span class="p">)</span>
<span class="n">posterior_5_X_M</span><span class="p">,</span> <span class="n">trace_5_X_M</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                        <span class="n">jdc_5_X_M</span><span class="p">,</span> 
                        <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">M</span><span class="p">,),</span> 
                        <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;betaA&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:5 out of the last 5 calls to &lt;function run_hmc_chain at 0x7f203485cdd0&gt; triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has experimental_relax_shapes=True option that relaxes argument shapes that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:6 out of the last 6 calls to &lt;function run_hmc_chain at 0x7f203485cdd0&gt; triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has experimental_relax_shapes=True option that relaxes argument shapes that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(</span><span class="n">trace_5_X_M</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/05_the_many_variables_and_the_spurious_waffles_65_0.png" src="../_images/05_the_many_variables_and_the_spurious_waffles_65_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(</span><span class="n">trace_5_3_A</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/05_the_many_variables_and_the_spurious_waffles_66_0.png" src="../_images/05_the_many_variables_and_the_spurious_waffles_66_0.png" />
</div>
</div>
</div>
<div class="section" id="code-5-20">
<h3>Code 5.20<a class="headerlink" href="#code-5-20" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">A_seq</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">A_seq</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">A_seq</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-5-21">
<h3>Code 5.21<a class="headerlink" href="#code-5-21" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sample5X_alpha</span> <span class="o">=</span> <span class="n">posterior_5_X_M</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sample5X_betaA</span> <span class="o">=</span> <span class="n">posterior_5_X_M</span><span class="p">[</span><span class="s2">&quot;betaA&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sample5X_sigma</span> <span class="o">=</span> <span class="n">posterior_5_X_M</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># simulate M using A_seq</span>
<span class="n">jdc_5_X_M_test</span> <span class="o">=</span> <span class="n">model_5_X_M</span><span class="p">(</span><span class="n">A_seq</span><span class="p">)</span>

<span class="n">samples</span> <span class="o">=</span> <span class="n">jdc_5_X_M_test</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span>
    <span class="n">sample5X_alpha</span><span class="p">,</span> 
    <span class="n">sample5X_betaA</span><span class="p">,</span> 
    <span class="n">sample5X_sigma</span><span class="p">,</span> 
    <span class="kc">None</span>
<span class="p">])</span>

<span class="n">M_sim</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="n">M_sim</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>TensorShape([500, 30])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># time to simulate D using M</span>
<span class="n">sample53A_alpha</span>  <span class="o">=</span> <span class="n">posterior_5_3_A</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sample53A_betaA</span>  <span class="o">=</span> <span class="n">posterior_5_3_A</span><span class="p">[</span><span class="s2">&quot;betaA&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sample53A_betaM</span>  <span class="o">=</span> <span class="n">posterior_5_3_A</span><span class="p">[</span><span class="s2">&quot;betaM&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sample53A_sigma</span>  <span class="o">=</span> <span class="n">posterior_5_3_A</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="n">jdc_5_3_A_test</span> <span class="o">=</span> <span class="n">model_5_3_A</span><span class="p">(</span><span class="n">A_seq</span><span class="p">,</span> <span class="n">M_sim</span><span class="p">)</span>

<span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">D_sim</span> <span class="o">=</span> <span class="n">jdc_5_3_A_test</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span>
    <span class="n">sample53A_alpha</span><span class="p">,</span>
    <span class="n">sample53A_betaA</span><span class="p">,</span>
    <span class="n">sample53A_betaM</span><span class="p">,</span>
    <span class="n">sample53A_sigma</span><span class="p">,</span>
    <span class="kc">None</span>
<span class="p">])</span>

<span class="n">D_sim</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>TensorShape([500, 30])
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-5-22">
<h3>Code 5.22<a class="headerlink" href="#code-5-22" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># display counterfactual predictions</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">A_seq</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">D_sim</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;manipulated A&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;counterfactual D&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">A_seq</span><span class="p">,</span> <span class="o">*</span><span class="n">tfp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">D_sim</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="p">(</span><span class="mf">5.5</span><span class="p">,</span> <span class="mf">94.5</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                 <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Total counterfactual effect of A on D&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/05_the_many_variables_and_the_spurious_waffles_73_0.png" src="../_images/05_the_many_variables_and_the_spurious_waffles_73_0.png" />
</div>
</div>
</div>
<div class="section" id="code-5-23">
<h3>Code 5.23<a class="headerlink" href="#code-5-23" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">M_seq</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">M_seq</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">M_seq</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">compute_D_from_posterior_using_M</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">sample53A_alpha</span> <span class="o">+</span> <span class="n">sample53A_betaM</span> <span class="o">*</span> <span class="n">m</span>
    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sample53A_sigma</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>        

<span class="n">D_sim</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">vectorized_map</span><span class="p">(</span><span class="n">compute_D_from_posterior_using_M</span><span class="p">,</span> <span class="n">M_seq</span><span class="p">)))</span>
<span class="n">D_sim</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:Note that RandomStandardNormal inside pfor op may not give same output as inside a sequential loop.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>TensorShape([500, 30])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># display counterfactual predictions</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">M_seq</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">D_sim</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;manipulated M&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;counterfactual D&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">M_seq</span><span class="p">,</span> <span class="o">*</span><span class="n">tfp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">D_sim</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="p">(</span><span class="mf">5.5</span><span class="p">,</span> <span class="mf">94.5</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                 <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Total counterfactual effect of M on D&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/05_the_many_variables_and_the_spurious_waffles_76_0.png" src="../_images/05_the_many_variables_and_the_spurious_waffles_76_0.png" />
</div>
</div>
</div>
<div class="section" id="code-5-24-5-25-and-5-26">
<h3>Code 5.24, 5.25 and 5.26<a class="headerlink" href="#code-5-24-5-25-and-5-26" title="Permalink to this headline">¶</a></h3>
<p>Here the author explains how to do above manually in the overthinking box.</p>
<p>Due to the lack of Predictive support in tensorflow prob I had to do it anyways. So refer to above cells.</p>
</div>
<div class="section" id="code-5-27">
<h3>Code 5.27<a class="headerlink" href="#code-5-27" title="Permalink to this headline">¶</a></h3>
<p>Previous example used multiple predictors to show case spurious association but sometimes you do need multiple predictor variables as they do have influence on the outcome.</p>
<p>It is possible that one predictor variable is +ively related to outcome whereas the other one is -ively correlated.</p>
<p>We are going to use a new dataset called Milk.</p>
<p>Question that we want to answer is - <strong>To what extent energy content of milk, measured in KCal, is related to the percent of the brain mass that is neocortex</strong>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">RethinkingDataset</span><span class="o">.</span><span class="n">Milk</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">()</span>
<span class="n">d</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
<span class="n">d</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 29 entries, 0 to 28
Data columns (total 8 columns):
 #   Column          Non-Null Count  Dtype  
---  ------          --------------  -----  
 0   clade           29 non-null     object 
 1   species         29 non-null     object 
 2   kcal.per.g      29 non-null     float64
 3   perc.fat        29 non-null     float64
 4   perc.protein    29 non-null     float64
 5   perc.lactose    29 non-null     float64
 6   mass            29 non-null     float64
 7   neocortex.perc  17 non-null     float64
dtypes: float64(6), object(2)
memory usage: 1.9+ KB
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>clade</th>
      <th>species</th>
      <th>kcal.per.g</th>
      <th>perc.fat</th>
      <th>perc.protein</th>
      <th>perc.lactose</th>
      <th>mass</th>
      <th>neocortex.perc</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Strepsirrhine</td>
      <td>Eulemur fulvus</td>
      <td>0.49</td>
      <td>16.60</td>
      <td>15.42</td>
      <td>67.98</td>
      <td>1.95</td>
      <td>55.16</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Strepsirrhine</td>
      <td>E macaco</td>
      <td>0.51</td>
      <td>19.27</td>
      <td>16.91</td>
      <td>63.82</td>
      <td>2.09</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Strepsirrhine</td>
      <td>E mongoz</td>
      <td>0.46</td>
      <td>14.11</td>
      <td>16.85</td>
      <td>69.04</td>
      <td>2.51</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Strepsirrhine</td>
      <td>E rubriventer</td>
      <td>0.48</td>
      <td>14.91</td>
      <td>13.18</td>
      <td>71.91</td>
      <td>1.62</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Strepsirrhine</td>
      <td>Lemur catta</td>
      <td>0.60</td>
      <td>27.28</td>
      <td>19.50</td>
      <td>53.22</td>
      <td>2.19</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ul class="simple">
<li><p>kcal.per.g - Kilocalories of energy per gram of milk</p></li>
<li><p>mass - Average female body mass, in KG</p></li>
<li><p>neocortex.perc - Percent of total brain mass that is neocortex mass</p></li>
</ul>
<p>Although not mentioned in the question that was asked above, we are considering the female body mass as well. This is to see the masking that hides the relationships among the variables.</p>
</div>
</div>
<div class="section" id="masked-relationship">
<h2>5.2 Masked relationship<a class="headerlink" href="#masked-relationship" title="Permalink to this headline">¶</a></h2>
<div class="section" id="code-5-28">
<h3>Code 5.28<a class="headerlink" href="#code-5-28" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;kcal.per.g&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
<span class="n">d</span><span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;neocortex.perc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
<span class="n">d</span><span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">mass</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>

<span class="n">tdf</span> <span class="o">=</span> <span class="n">dataframe_to_tensors</span><span class="p">(</span><span class="s1">&#39;Milk&#39;</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-5-29">
<h3>Code 5.29<a class="headerlink" href="#code-5-29" title="Permalink to this headline">¶</a></h3>
<p>A Simple Bivariate model between KCal and NeoCortex percent</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># N =&gt; Standardized Neocortex percent</span>

<span class="k">def</span> <span class="nf">model_5_5</span><span class="p">(</span><span class="n">neocortex_percent_std</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
      <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;alpha&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">betaN</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;betaN&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>      
      <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    
      <span class="n">mu</span> <span class="o">=</span>  <span class="n">alpha</span> <span class="o">+</span> <span class="n">betaN</span> <span class="o">*</span> <span class="n">neocortex_percent_std</span>
        
      <span class="n">K</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;K&quot;</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    
    
<span class="n">jdc_5_5</span> <span class="o">=</span> <span class="n">model_5_5</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>

<span class="n">samples</span> <span class="o">=</span> <span class="n">jdc_5_5</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>

<span class="n">samples</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>StructTuple(
  var0=&lt;tf.Tensor: shape=(1,), dtype=float32, numpy=array([-0.2264246], dtype=float32)&gt;,
  var1=&lt;tf.Tensor: shape=(1,), dtype=float32, numpy=array([1.2514617], dtype=float32)&gt;,
  var2=&lt;tf.Tensor: shape=(1,), dtype=float32, numpy=array([2.4110255], dtype=float32)&gt;,
  var3=&lt;tf.Tensor: shape=(29,), dtype=float32, numpy=
    array([ 3.7145152 ,         nan,         nan,         nan,         nan,
           -2.2444994 , -3.7532907 , -1.783252  ,         nan,  1.6549164 ,
           -7.167117  , -5.4488096 , -1.3002713 ,         nan,         nan,
            0.43240526,         nan, -0.81642985,         nan,  3.3517313 ,
                   nan,  0.50732595,         nan,  4.248379  , -1.6201051 ,
                   nan,  0.88332224,  4.99605   , -0.94462955], dtype=float32)&gt;
)
</pre></div>
</div>
</div>
</div>
<p>If you see above displayed samples, you would see lot of NaN. Now tensorflow prob does not complain and/or throw
an exception here but it is going to cause lot of pain.</p>
<p>In other words, we must not have this situation i.e. presence of NaN</p>
</div>
<div class="section" id="code-5-30">
<h3>Code 5.30<a class="headerlink" href="#code-5-30" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;neocortex.perc&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0     55.16
1       NaN
2       NaN
3       NaN
4       NaN
5     64.54
6     64.54
7     67.64
8       NaN
9     68.85
10    58.85
11    61.69
12    60.32
13      NaN
14      NaN
15    69.97
16      NaN
17    70.41
18      NaN
19    73.40
20      NaN
21    67.53
22      NaN
23    71.26
24    72.60
25      NaN
26    70.24
27    76.30
28    75.49
Name: neocortex.perc, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>We have lot of data missing in the neorcortex.perc colums</p>
</div>
<div class="section" id="code-5-31">
<h3>Code 5.31<a class="headerlink" href="#code-5-31" title="Permalink to this headline">¶</a></h3>
<p>Drop all the cases with missing values. This is known as <strong>COMPLETE CASE ANANLYSIS</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dcc</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">d</span><span class="p">[[</span><span class="s2">&quot;K&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;any&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>

<span class="c1"># we now have only 17 rows</span>
<span class="n">dcc</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>kcal.per.g</th>
      <th>perc.fat</th>
      <th>perc.protein</th>
      <th>perc.lactose</th>
      <th>mass</th>
      <th>neocortex.perc</th>
      <th>K</th>
      <th>N</th>
      <th>M</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>17.000000</td>
      <td>17.000000</td>
      <td>17.000000</td>
      <td>17.000000</td>
      <td>17.000000</td>
      <td>17.000000</td>
      <td>17.000000</td>
      <td>1.700000e+01</td>
      <td>17.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>0.657647</td>
      <td>36.063529</td>
      <td>16.255294</td>
      <td>47.681176</td>
      <td>16.637647</td>
      <td>67.575882</td>
      <td>0.098654</td>
      <td>-2.821273e-15</td>
      <td>0.033852</td>
    </tr>
    <tr>
      <th>std</th>
      <td>0.172899</td>
      <td>14.705419</td>
      <td>5.598480</td>
      <td>13.585261</td>
      <td>23.582322</td>
      <td>5.968612</td>
      <td>1.071235</td>
      <td>1.000000e+00</td>
      <td>1.138400</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.460000</td>
      <td>3.930000</td>
      <td>7.370000</td>
      <td>27.090000</td>
      <td>0.120000</td>
      <td>55.160000</td>
      <td>-1.125913</td>
      <td>-2.080196e+00</td>
      <td>-2.097830</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>0.490000</td>
      <td>27.180000</td>
      <td>11.680000</td>
      <td>37.800000</td>
      <td>1.550000</td>
      <td>64.540000</td>
      <td>-0.940041</td>
      <td>-5.086413e-01</td>
      <td>-0.591039</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>0.620000</td>
      <td>37.780000</td>
      <td>15.800000</td>
      <td>46.880000</td>
      <td>5.250000</td>
      <td>68.850000</td>
      <td>-0.134597</td>
      <td>2.134697e-01</td>
      <td>0.127441</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>0.800000</td>
      <td>50.490000</td>
      <td>20.850000</td>
      <td>55.200000</td>
      <td>33.110000</td>
      <td>71.260000</td>
      <td>0.980633</td>
      <td>6.172487e-01</td>
      <td>1.212020</td>
    </tr>
    <tr>
      <th>max</th>
      <td>0.970000</td>
      <td>55.510000</td>
      <td>25.300000</td>
      <td>70.770000</td>
      <td>79.430000</td>
      <td>76.300000</td>
      <td>2.033906</td>
      <td>1.461666e+00</td>
      <td>1.727359</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tdcc</span> <span class="o">=</span> <span class="n">dataframe_to_tensors</span><span class="p">(</span><span class="s1">&#39;Milk&#39;</span><span class="p">,</span> <span class="n">dcc</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-5-32">
<h3>Code 5.32<a class="headerlink" href="#code-5-32" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jdc_5_5_draft</span> <span class="o">=</span> <span class="n">model_5_5</span><span class="p">(</span><span class="n">tdcc</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>

<span class="n">samples</span> <span class="o">=</span> <span class="n">jdc_5_5_draft</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>

<span class="n">samples</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>StructTuple(
  var0=&lt;tf.Tensor: shape=(1,), dtype=float32, numpy=array([-0.5990976], dtype=float32)&gt;,
  var1=&lt;tf.Tensor: shape=(1,), dtype=float32, numpy=array([-0.75976264], dtype=float32)&gt;,
  var2=&lt;tf.Tensor: shape=(1,), dtype=float32, numpy=array([0.12881611], dtype=float32)&gt;,
  var3=&lt;tf.Tensor: shape=(17,), dtype=float32, numpy=
    array([ 1.2075393 , -0.31177106, -0.22172406, -0.60209316, -0.6507419 ,
            0.29391328, -0.14125672,  0.16977042, -0.71745133, -1.0280712 ,
           -1.200116  , -0.4808861 , -1.0974077 , -1.1023976 , -0.9336493 ,
           -1.7022667 , -1.5758266 ], dtype=float32)&gt;
)
</pre></div>
</div>
</div>
</div>
<p>You should not see an NaN in the samples</p>
</div>
<div class="section" id="code-5-33">
<h3>Code 5.33<a class="headerlink" href="#code-5-33" title="Permalink to this headline">¶</a></h3>
<p>Investigate if we have proper priors by plotting 50 prior regression lines</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xseq</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span><span class="mf">2.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="n">sample_alpha</span><span class="p">,</span> <span class="n">sample_betaN</span><span class="p">,</span> <span class="n">sample_sigma</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">model_5_5</span><span class="p">(</span><span class="n">xseq</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>

<span class="c1"># we simply compute for the two possible values</span>
<span class="n">mu_pred_0</span> <span class="o">=</span> <span class="n">sample_alpha</span> <span class="o">+</span> <span class="n">sample_betaN</span> <span class="o">*</span> <span class="o">-</span><span class="mf">2.0</span>
<span class="n">mu_pred_1</span> <span class="o">=</span> <span class="n">sample_alpha</span> <span class="o">+</span> <span class="n">sample_betaN</span> <span class="o">*</span> <span class="mf">2.0</span>

<span class="n">mu_pred</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">mu_pred_0</span><span class="p">,</span> <span class="n">mu_pred_1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="n">xseq</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">ylim</span><span class="o">=</span><span class="n">xseq</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xseq</span><span class="p">,</span> <span class="n">mu_pred</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/05_the_many_variables_and_the_spurious_waffles_97_0.png" src="../_images/05_the_many_variables_and_the_spurious_waffles_97_0.png" />
</div>
</div>
<p>Above does not look good. We should have better priors for <span class="math notranslate nohighlight">\(\alpha\)</span> so that it sticks closer to zero</p>
</div>
<div class="section" id="code-5-34">
<h3>Code 5.34<a class="headerlink" href="#code-5-34" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_5_5</span><span class="p">(</span><span class="n">neocortex_percent_std</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
      <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;alpha&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">betaN</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;betaN&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>      
      <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    
      <span class="n">mu</span> <span class="o">=</span>  <span class="n">alpha</span> <span class="o">+</span> <span class="n">betaN</span> <span class="o">*</span> <span class="n">neocortex_percent_std</span>
        
      <span class="n">K</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;K&quot;</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    
    
<span class="n">jdc_5_5</span> <span class="o">=</span> <span class="n">model_5_5</span><span class="p">(</span><span class="n">tdcc</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>

<span class="n">posterior_5_5</span><span class="p">,</span> <span class="n">trace_5_5</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                                <span class="n">jdc_5_5</span><span class="p">,</span> 
                                <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">tdcc</span><span class="o">.</span><span class="n">K</span><span class="p">,),</span>
                                <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;betaN&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-5-35">
<h3>Code 5.35<a class="headerlink" href="#code-5-35" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_5_5</span><span class="p">,</span> <span class="n">round_to</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;stats&#39;</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha[0]</th>
      <td>0.03</td>
      <td>0.16</td>
      <td>-0.24</td>
      <td>0.27</td>
    </tr>
    <tr>
      <th>betaN[0]</th>
      <td>0.13</td>
      <td>0.23</td>
      <td>-0.22</td>
      <td>0.50</td>
    </tr>
    <tr>
      <th>sigma[0]</th>
      <td>1.11</td>
      <td>0.21</td>
      <td>0.82</td>
      <td>1.42</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="code-5-36">
<h3>Code 5.36<a class="headerlink" href="#code-5-36" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xseq</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">dcc</span><span class="o">.</span><span class="n">N</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mf">0.15</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">dcc</span><span class="o">.</span><span class="n">N</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.15</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">xseq</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">xseq</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="n">sample_alpha</span> <span class="o">=</span>  <span class="n">posterior_5_5</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sample_betaN</span> <span class="o">=</span>  <span class="n">posterior_5_5</span><span class="p">[</span><span class="s2">&quot;betaN&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sample_sigma</span> <span class="o">=</span>  <span class="n">posterior_5_5</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> 

<span class="n">jdc_5_5_test</span> <span class="o">=</span> <span class="n">model_5_5</span><span class="p">(</span><span class="n">xseq</span><span class="p">)</span>

<span class="n">ds</span><span class="p">,</span> <span class="n">samples</span> <span class="o">=</span> <span class="n">jdc_5_5_test</span><span class="o">.</span><span class="n">sample_distributions</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span>
    <span class="n">sample_alpha</span><span class="p">,</span> 
    <span class="n">sample_betaN</span><span class="p">,</span> 
    <span class="n">sample_sigma</span><span class="p">,</span> 
    <span class="kc">None</span>
<span class="p">])</span>

<span class="n">mu_pred</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">loc</span>

<span class="c1"># summarize samples across cases</span>
<span class="n">mu_mean</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">mu_pred</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">mu_PI</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">mu_pred</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="p">(</span><span class="mf">5.5</span><span class="p">,</span> <span class="mf">94.5</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">az</span><span class="o">.</span><span class="n">plot_pair</span><span class="p">(</span><span class="n">dcc</span><span class="p">[[</span><span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;K&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;list&quot;</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xseq</span><span class="p">,</span> <span class="n">mu_mean</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">xseq</span><span class="p">,</span> <span class="n">mu_PI</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mu_PI</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/05_the_many_variables_and_the_spurious_waffles_104_0.png" src="../_images/05_the_many_variables_and_the_spurious_waffles_104_0.png" />
</div>
</div>
<p>Above plot displays weak association when using simple bivariate regression</p>
</div>
<div class="section" id="code-5-37">
<h3>Code 5.37<a class="headerlink" href="#code-5-37" title="Permalink to this headline">¶</a></h3>
<p>We now consider another predictor variable; the adult female body mass</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_5_6</span><span class="p">(</span><span class="n">female_body_mass</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
      <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;alpha&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">betaM</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;betaM&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>      
      <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    
      <span class="n">mu</span> <span class="o">=</span>  <span class="n">alpha</span> <span class="o">+</span> <span class="n">betaM</span> <span class="o">*</span> <span class="n">female_body_mass</span>
        
      <span class="n">K</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;K&quot;</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    
    
<span class="n">jdc_5_6</span> <span class="o">=</span> <span class="n">model_5_6</span><span class="p">(</span><span class="n">tdcc</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>

<span class="n">posterior_5_6</span><span class="p">,</span> <span class="n">trace_5_6</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                            <span class="n">jdc_5_6</span><span class="p">,</span> 
                            <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">tdcc</span><span class="o">.</span><span class="n">K</span><span class="p">,),</span>
                            <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;betaM&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">])</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_5_6</span><span class="p">,</span> <span class="n">round_to</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;stats&#39;</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha[0]</th>
      <td>0.05</td>
      <td>0.09</td>
      <td>-0.09</td>
      <td>0.12</td>
    </tr>
    <tr>
      <th>betaM[0]</th>
      <td>-0.01</td>
      <td>0.21</td>
      <td>-0.27</td>
      <td>0.19</td>
    </tr>
    <tr>
      <th>sigma[0]</th>
      <td>0.68</td>
      <td>0.62</td>
      <td>0.06</td>
      <td>1.35</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Log-mass is negatively correlated with KCal. The influence is stronger than that of neocortex percent but it is in the opposite direction.</p>
</div>
<div class="section" id="code-5-38">
<h3>Code 5.38<a class="headerlink" href="#code-5-38" title="Permalink to this headline">¶</a></h3>
<p>Now let’s see what happens when we add both the predictor variables to the model</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_5_7</span><span class="p">(</span><span class="n">neocortex_percent_std</span><span class="p">,</span> <span class="n">female_body_mass</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>
      <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;alpha&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">betaN</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;betaN&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>      
      <span class="n">betaM</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;betaM&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>      
      <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    
      <span class="n">mu</span> <span class="o">=</span>  <span class="n">alpha</span> <span class="o">+</span> <span class="n">betaN</span> <span class="o">*</span> <span class="n">neocortex_percent_std</span> <span class="o">+</span> <span class="n">betaM</span> <span class="o">*</span> <span class="n">female_body_mass</span>
        
      <span class="n">K</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;K&quot;</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    
    
<span class="n">jdc_5_7</span> <span class="o">=</span> <span class="n">model_5_7</span><span class="p">(</span><span class="n">tdcc</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">tdcc</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>

<span class="n">posterior_5_7</span><span class="p">,</span> <span class="n">trace_5_7</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span><span class="n">jdc_5_7</span><span class="p">,</span> 
                              <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">tdcc</span><span class="o">.</span><span class="n">K</span><span class="p">,),</span> 
                              <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;betaN&#39;</span><span class="p">,</span> <span class="s1">&#39;betaM&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">])</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">trace_5_7</span><span class="p">,</span> <span class="n">round_to</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;stats&#39;</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha[0]</th>
      <td>0.06</td>
      <td>0.14</td>
      <td>-0.17</td>
      <td>0.28</td>
    </tr>
    <tr>
      <th>betaN[0]</th>
      <td>0.59</td>
      <td>0.27</td>
      <td>0.14</td>
      <td>0.97</td>
    </tr>
    <tr>
      <th>betaM[0]</th>
      <td>-0.63</td>
      <td>0.24</td>
      <td>-1.04</td>
      <td>-0.27</td>
    </tr>
    <tr>
      <th>sigma[0]</th>
      <td>0.86</td>
      <td>0.17</td>
      <td>0.60</td>
      <td>1.08</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>By including both predictor variables in the regression, the posterior assocition of both with the outcome has increased.</p>
</div>
<div class="section" id="code-5-39">
<h3>Code 5.39<a class="headerlink" href="#code-5-39" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coeftab</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;m5.5&quot;</span><span class="p">:</span> <span class="n">trace_5_5</span><span class="p">,</span>
           <span class="s2">&quot;m5.6&quot;</span><span class="p">:</span> <span class="n">trace_5_6</span><span class="p">,</span>
           <span class="s2">&quot;m5.7&quot;</span><span class="p">:</span> <span class="n">trace_5_7</span><span class="p">}</span>

<span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">coeftab</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">model_names</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">coeftab</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span><span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
               <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;betaM&quot;</span><span class="p">,</span> <span class="s2">&quot;betaN&quot;</span><span class="p">],</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/05_the_many_variables_and_the_spurious_waffles_113_0.png" src="../_images/05_the_many_variables_and_the_spurious_waffles_113_0.png" />
</div>
</div>
</div>
<div class="section" id="code-5-40">
<h3>Code 5.40<a class="headerlink" href="#code-5-40" title="Permalink to this headline">¶</a></h3>
<p>Counterfactual plot when setting N to zero and using M as the predictor variable</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xseq</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">dcc</span><span class="o">.</span><span class="n">M</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mf">0.15</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">dcc</span><span class="o">.</span><span class="n">M</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.15</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">xseq</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">xseq</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="n">sample_alpha</span> <span class="o">=</span>  <span class="n">posterior_5_7</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sample_betaN</span> <span class="o">=</span>  <span class="n">posterior_5_7</span><span class="p">[</span><span class="s2">&quot;betaN&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sample_betaM</span> <span class="o">=</span>  <span class="n">posterior_5_7</span><span class="p">[</span><span class="s2">&quot;betaN&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sample_sigma</span> <span class="o">=</span>  <span class="n">posterior_5_7</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> 

<span class="n">mu_pred</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">vectorized_map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">sample_alpha</span> <span class="o">+</span> <span class="n">sample_betaN</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> <span class="n">xseq</span><span class="p">)))</span>

<span class="c1"># summarize samples across cases</span>
<span class="n">mu_mean</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">mu_pred</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">mu_PI</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">mu_pred</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="p">(</span><span class="mf">5.5</span><span class="p">,</span> <span class="mf">94.5</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="n">dcc</span><span class="o">.</span><span class="n">M</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">dcc</span><span class="o">.</span><span class="n">M</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="n">dcc</span><span class="o">.</span><span class="n">K</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">dcc</span><span class="o">.</span><span class="n">K</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xseq</span><span class="p">,</span> <span class="n">mu_mean</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">xseq</span><span class="p">,</span> <span class="n">mu_PI</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mu_PI</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/05_the_many_variables_and_the_spurious_waffles_115_0.png" src="../_images/05_the_many_variables_and_the_spurious_waffles_115_0.png" />
</div>
</div>
</div>
<div class="section" id="code-5-41">
<h3>Code 5.41<a class="headerlink" href="#code-5-41" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># M -&gt; K &lt;- N</span>
<span class="c1"># M -&gt; N</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">((</span><span class="n">n</span><span class="p">,))</span>
<span class="n">N</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">M</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
<span class="n">K</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">N</span> <span class="o">-</span> <span class="n">M</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>

<span class="n">d_sim</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;K&quot;</span><span class="p">:</span> <span class="n">K</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="n">N</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="n">M</span><span class="p">})</span>

<span class="n">d_sim</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>K</th>
      <th>N</th>
      <th>M</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-0.030641</td>
      <td>-1.899146</td>
      <td>-1.312325</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-0.657766</td>
      <td>0.152671</td>
      <td>0.581702</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-0.113301</td>
      <td>0.130901</td>
      <td>-0.172823</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.327264</td>
      <td>-1.121136</td>
      <td>-0.038090</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1.066025</td>
      <td>-2.107418</td>
      <td>-2.243279</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>95</th>
      <td>0.139137</td>
      <td>-0.560141</td>
      <td>0.516984</td>
    </tr>
    <tr>
      <th>96</th>
      <td>2.072082</td>
      <td>2.646486</td>
      <td>2.069870</td>
    </tr>
    <tr>
      <th>97</th>
      <td>-0.296898</td>
      <td>-0.492251</td>
      <td>-0.163098</td>
    </tr>
    <tr>
      <th>98</th>
      <td>1.615121</td>
      <td>-0.341658</td>
      <td>-1.205267</td>
    </tr>
    <tr>
      <th>99</th>
      <td>-2.817693</td>
      <td>-0.779795</td>
      <td>-0.025967</td>
    </tr>
  </tbody>
</table>
<p>100 rows × 3 columns</p>
</div></div></div>
</div>
</div>
<div class="section" id="code-5-42">
<h3>Code 5.42<a class="headerlink" href="#code-5-42" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># M -&gt; K &lt;- N</span>
<span class="c1"># N -&gt; M</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">N</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">((</span><span class="n">n</span><span class="p">,))</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
<span class="n">K</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">N</span> <span class="o">-</span> <span class="n">M</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>

<span class="n">d_sim2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;K&quot;</span><span class="p">:</span> <span class="n">K</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="n">N</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="n">M</span><span class="p">})</span>

<span class="c1"># M -&gt; K &lt;- N</span>
<span class="c1"># M &lt;- U -&gt; N</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">N</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">((</span><span class="n">n</span><span class="p">,))</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">M</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
<span class="n">K</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">N</span> <span class="o">-</span> <span class="n">M</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>

<span class="n">d_sim3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;K&quot;</span><span class="p">:</span> <span class="n">K</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="n">N</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="n">M</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-5-43">
<h3>Code 5.43<a class="headerlink" href="#code-5-43" title="Permalink to this headline">¶</a></h3>
<p>The book uses <code class="docutils literal notranslate"><span class="pre">dagitty</span></code> an R package that can draw the DAG as well generate the equivalentDAGs given a DAG as input</p>
<p>At this point I do not have the corresponding function in python so I am manually specifying the equivalent DAGs (after seeing the result in RStudio as the book does not display the equivalentDAGs either)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coordinates</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="s2">&quot;K&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)}</span>
<span class="n">node_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="s2">&quot;K&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">]</span>

<span class="n">equivalent_dags</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[(</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="s2">&quot;K&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;K&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">)],</span>
    <span class="p">[(</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="s2">&quot;K&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;K&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">)],</span>
    <span class="p">[(</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="s2">&quot;K&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;K&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">)],</span>
    <span class="p">[(</span><span class="s2">&quot;K&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;K&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">)],</span>
    <span class="p">[(</span><span class="s2">&quot;K&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;K&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">)],</span>
    <span class="p">[(</span><span class="s2">&quot;K&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;K&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">)]</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">equivalent_dags</span><span class="p">:</span>
    <span class="n">dag</span> <span class="o">=</span> <span class="n">CausalGraphicalModel</span><span class="p">(</span><span class="n">nodes</span><span class="o">=</span><span class="n">node_names</span><span class="p">,</span> <span class="n">edges</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>    
    <span class="n">pgm</span> <span class="o">=</span> <span class="n">daft</span><span class="o">.</span><span class="n">PGM</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">dag</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
        <span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">coordinates</span><span class="p">[</span><span class="n">node</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">dag</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
        <span class="n">pgm</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="o">*</span><span class="n">edge</span><span class="p">)</span>
        
    <span class="n">pgm</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/05_the_many_variables_and_the_spurious_waffles_121_0.png" src="../_images/05_the_many_variables_and_the_spurious_waffles_121_0.png" />
<img alt="../_images/05_the_many_variables_and_the_spurious_waffles_121_1.png" src="../_images/05_the_many_variables_and_the_spurious_waffles_121_1.png" />
<img alt="../_images/05_the_many_variables_and_the_spurious_waffles_121_2.png" src="../_images/05_the_many_variables_and_the_spurious_waffles_121_2.png" />
<img alt="../_images/05_the_many_variables_and_the_spurious_waffles_121_3.png" src="../_images/05_the_many_variables_and_the_spurious_waffles_121_3.png" />
<img alt="../_images/05_the_many_variables_and_the_spurious_waffles_121_4.png" src="../_images/05_the_many_variables_and_the_spurious_waffles_121_4.png" />
<img alt="../_images/05_the_many_variables_and_the_spurious_waffles_121_5.png" src="../_images/05_the_many_variables_and_the_spurious_waffles_121_5.png" />
</div>
</div>
</div>
<div class="section" id="code-5-44">
<h3>Code 5.44<a class="headerlink" href="#code-5-44" title="Permalink to this headline">¶</a></h3>
<p>This section discusses Categorical Variables i.e. Discrete &amp; Unordered variables.</p>
<p>We will again use HOWELL dataset here. In previous chapter, we had taken into consider <em>sex</em> variable and here we will model it as a categorical variable.</p>
<p>To start with let’s load the dataset</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">RethinkingDataset</span><span class="o">.</span><span class="n">Howell1</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">()</span>
<span class="n">d</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
<span class="n">d</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 544 entries, 0 to 543
Data columns (total 4 columns):
 #   Column  Non-Null Count  Dtype  
---  ------  --------------  -----  
 0   height  544 non-null    float64
 1   weight  544 non-null    float64
 2   age     544 non-null    float64
 3   male    544 non-null    int64  
dtypes: float64(3), int64(1)
memory usage: 17.1 KB
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>height</th>
      <th>weight</th>
      <th>age</th>
      <th>male</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>151.765</td>
      <td>47.825606</td>
      <td>63.0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>139.700</td>
      <td>36.485807</td>
      <td>63.0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>136.525</td>
      <td>31.864838</td>
      <td>65.0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>156.845</td>
      <td>53.041914</td>
      <td>41.0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>145.415</td>
      <td>41.276872</td>
      <td>51.0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
</div>
<div class="section" id="categorical-variables">
<h2>5.3 Categorical variables<a class="headerlink" href="#categorical-variables" title="Permalink to this headline">¶</a></h2>
<div class="section" id="code-5-45">
<h3>Code 5.45<a class="headerlink" href="#code-5-45" title="Permalink to this headline">¶</a></h3>
<p>Here we are considering following model</p>
<p><span class="math notranslate nohighlight">\(h_i \sim Normal(\mu_i,\sigma)\)</span></p>
<p><span class="math notranslate nohighlight">\(\mu_i = \alpha + \beta_mm_i\)</span></p>
<p><span class="math notranslate nohighlight">\(\alpha \sim Normal(178,20)\)</span></p>
<p><span class="math notranslate nohighlight">\(\beta_m \sim Normal(0,10)\)</span></p>
<p><span class="math notranslate nohighlight">\(\sigma \sim Exponential(1)\)</span></p>
<p><em>m</em> here is a categorical value and is 1 when we are dealing with males. This means that <span class="math notranslate nohighlight">\(\alpha\)</span> is used
to predict both female and male heights.</p>
<p>But if we have a male then the height gets an extra <span class="math notranslate nohighlight">\(\beta_m\)</span>. This also means that <span class="math notranslate nohighlight">\(\alpha\)</span> does not represent the average of all samples but rather the average of female height.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mu_female</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">178.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">20.</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="mf">1e4</span><span class="p">),))</span>

<span class="n">diff</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">10.</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="mf">1e4</span><span class="p">),))</span>

<span class="n">mu_male</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">178.0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">20.</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="mf">1e4</span><span class="p">),))</span> <span class="o">+</span> <span class="n">diff</span>

<span class="n">sample_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;mu_female&#39;</span> <span class="p">:</span> <span class="n">mu_female</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
    <span class="s1">&#39;mu_male&#39;</span> <span class="p">:</span> <span class="n">mu_male</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="p">}</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">az</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">sample_dict</span><span class="p">),</span> <span class="n">round_to</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;stats&#39;</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>mu_female</th>
      <td>177.72</td>
      <td>19.82</td>
      <td>144.81</td>
      <td>208.05</td>
    </tr>
    <tr>
      <th>mu_male</th>
      <td>178.02</td>
      <td>22.50</td>
      <td>144.43</td>
      <td>215.91</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The prior for male is wider (see std column). This is because it uses both the parameters.</p>
<p>Author explains that this makes assigning sensible priors harder. As show above, one of the category would have more uncertainity in the prediction as two priors are involved.</p>
</div>
<div class="section" id="code-5-46">
<h3>Code 5.46<a class="headerlink" href="#code-5-46" title="Permalink to this headline">¶</a></h3>
<p>Another approach is to use <strong>INDEX VARIABLE</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;sex&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">male</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">sex</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0      1
1      0
2      0
3      1
4      0
      ..
539    1
540    1
541    0
542    1
543    1
Name: sex, Length: 544, dtype: int64
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-5-47">
<h3>Code 5.47<a class="headerlink" href="#code-5-47" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tdf</span> <span class="o">=</span> <span class="n">dataframe_to_tensors</span><span class="p">(</span><span class="s1">&#39;Howell1&#39;</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;height&#39;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>     
    <span class="s1">&#39;sex&#39;</span>    <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span>
<span class="p">})</span>


<span class="k">def</span> <span class="nf">model_5_8</span><span class="p">(</span><span class="n">sex</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>      
      <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">178.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">20.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;alpha&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,)))</span>                
      <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mf">50.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

      <span class="c1"># took long time to figure this out</span>
      <span class="n">mu</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">alpha</span><span class="p">),</span> <span class="n">sex</span><span class="p">))</span>      
    
      <span class="n">height</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;height&quot;</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    
    
<span class="n">jdc_5_8</span> <span class="o">=</span> <span class="n">model_5_8</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">sex</span><span class="p">)</span>

<span class="n">posterior_5_8</span><span class="p">,</span> <span class="n">trace_5_8</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                                <span class="n">jdc_5_8</span><span class="p">,</span>
                                <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">height</span><span class="p">,),</span>
                                <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">])</span>

<span class="c1"># now here is the special thing we have to do here</span>
<span class="c1"># alpha is actually a vector so for az_trace to display</span>
<span class="c1"># it properly I would have to extract it properly</span>
<span class="n">female_alpha</span><span class="p">,</span> <span class="n">male_alpha</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">posterior_5_8</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># reformatted </span>
<span class="n">posterior_5_8_new</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;female_alpha&quot;</span> <span class="p">:</span> <span class="n">female_alpha</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
    <span class="s2">&quot;male_alpha&quot;</span> <span class="p">:</span> <span class="n">male_alpha</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
    <span class="s2">&quot;sigma&quot;</span> <span class="p">:</span> <span class="n">posterior_5_8</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">az</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">posterior_5_8_new</span><span class="p">),</span> <span class="n">round_to</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;stats&#39;</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/arviz/data/base.py:221: UserWarning: More chains (500) than draws (1). Passed array should have shape (chains, draws, *shape)
  UserWarning,
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>female_alpha</th>
      <td>134.94</td>
      <td>1.57</td>
      <td>132.29</td>
      <td>137.20</td>
    </tr>
    <tr>
      <th>male_alpha</th>
      <td>142.26</td>
      <td>1.74</td>
      <td>139.76</td>
      <td>145.18</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>27.51</td>
      <td>0.87</td>
      <td>26.09</td>
      <td>28.72</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="code-5-48">
<h3>Code 5.48<a class="headerlink" href="#code-5-48" title="Permalink to this headline">¶</a></h3>
<p>What is the expected difference between females and males ?</p>
<p>We can use the samples from the posterior to compute this.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_5_8_new</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>    
    <span class="s2">&quot;diff_fm&quot;</span> <span class="p">:</span> <span class="n">female_alpha</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="o">-</span> <span class="n">male_alpha</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="p">})</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">az</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">posterior_5_8_new</span><span class="p">),</span> <span class="n">round_to</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;stats&#39;</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/arviz/data/base.py:221: UserWarning: More chains (500) than draws (1). Passed array should have shape (chains, draws, *shape)
  UserWarning,
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>female_alpha</th>
      <td>134.94</td>
      <td>1.57</td>
      <td>132.29</td>
      <td>137.20</td>
    </tr>
    <tr>
      <th>male_alpha</th>
      <td>142.26</td>
      <td>1.74</td>
      <td>139.76</td>
      <td>145.18</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>27.51</td>
      <td>0.87</td>
      <td>26.09</td>
      <td>28.72</td>
    </tr>
    <tr>
      <th>diff_fm</th>
      <td>-7.32</td>
      <td>2.41</td>
      <td>-11.00</td>
      <td>-3.35</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Note that the above computation (i.e. diff) appeared in the arviz summary. This kind of calculation is called a <strong>CONTRAST</strong>.</p>
</div>
<div class="section" id="code-5-49">
<h3>Code 5.49<a class="headerlink" href="#code-5-49" title="Permalink to this headline">¶</a></h3>
<p>We explore the mile dataset again. We are now interested in <code class="docutils literal notranslate"><span class="pre">clade</span></code> variable which encodes the broad taxonomic membership of each species</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">RethinkingDataset</span><span class="o">.</span><span class="n">Milk</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">()</span>
<span class="n">d</span><span class="o">.</span><span class="n">clade</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([&#39;Strepsirrhine&#39;, &#39;New World Monkey&#39;, &#39;Old World Monkey&#39;, &#39;Ape&#39;],
      dtype=object)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-5-50">
<h3>Code 5.50<a class="headerlink" href="#code-5-50" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;clade_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">clade</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">codes</span>

<span class="n">d</span><span class="p">[</span><span class="s2">&quot;clade_id&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0     3
1     3
2     3
3     3
4     3
5     1
6     1
7     1
8     1
9     1
10    1
11    1
12    1
13    1
14    2
15    2
16    2
17    2
18    2
19    2
20    0
21    0
22    0
23    0
24    0
25    0
26    0
27    0
28    0
Name: clade_id, dtype: int8
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span><span class="o">.</span><span class="n">clade</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0        Strepsirrhine
1        Strepsirrhine
2        Strepsirrhine
3        Strepsirrhine
4        Strepsirrhine
5     New World Monkey
6     New World Monkey
7     New World Monkey
8     New World Monkey
9     New World Monkey
10    New World Monkey
11    New World Monkey
12    New World Monkey
13    New World Monkey
14    Old World Monkey
15    Old World Monkey
16    Old World Monkey
17    Old World Monkey
18    Old World Monkey
19    Old World Monkey
20                 Ape
21                 Ape
22                 Ape
23                 Ape
24                 Ape
25                 Ape
26                 Ape
27                 Ape
28                 Ape
Name: clade, dtype: object
</pre></div>
</div>
</div>
</div>
<p>Based on above it seems that pandas is first sorting the categories by name and then assigning the number. So,</p>
<ul class="simple">
<li><p>Ape = 0</p></li>
<li><p>New World Monkey = 1</p></li>
<li><p>Old World Monkey = 2</p></li>
<li><p>Strepsirrhine    = 3</p></li>
</ul>
</div>
<div class="section" id="code-5-51">
<h3>Code 5.51<a class="headerlink" href="#code-5-51" title="Permalink to this headline">¶</a></h3>
<p>We will now model again using the index variables</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;kcal.per.g&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>

<span class="n">tdf</span> <span class="o">=</span> <span class="n">dataframe_to_tensors</span><span class="p">(</span><span class="s1">&#39;Milk&#39;</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;K&#39;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>     
    <span class="s1">&#39;clade_id&#39;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">int64</span>
<span class="p">})</span>

<span class="n">CLADE_ID_LEN</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">clade_id</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">model_5_9</span><span class="p">(</span><span class="n">clade_id</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>      
      <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;alpha&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="n">CLADE_ID_LEN</span><span class="p">,)))</span>                
      <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>        

      <span class="n">mu</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">alpha</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">clade_id</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">)))</span>      
    
      <span class="n">K</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;K&quot;</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    
    
<span class="n">jdc_5_9</span> <span class="o">=</span> <span class="n">model_5_9</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">clade_id</span><span class="p">)</span>

<span class="n">posterior_5_9</span><span class="p">,</span> <span class="n">trace_5_9</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                                <span class="n">jdc_5_9</span><span class="p">,</span>
                                <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">K</span><span class="p">,),</span>
                                <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">])</span>

<span class="c1"># now here is the special thing we have to do here</span>
<span class="c1"># alpha is actually a vector so for az_trace to display</span>
<span class="c1"># it properly I would have to extract it properly</span>
<span class="n">ape_alpha</span><span class="p">,</span> <span class="n">nwm_alpha</span><span class="p">,</span> <span class="n">owm_alpha</span><span class="p">,</span> <span class="n">strep_alpha</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">posterior_5_9</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># reformatted </span>
<span class="n">updated_posterior_5_9</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;ape_alpha&quot;</span> <span class="p">:</span> <span class="n">ape_alpha</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
    <span class="s2">&quot;nwm_alpha&quot;</span> <span class="p">:</span> <span class="n">nwm_alpha</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
    <span class="s2">&quot;owm_alpha&quot;</span> <span class="p">:</span> <span class="n">owm_alpha</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
    <span class="s2">&quot;strep_alpha&quot;</span> <span class="p">:</span> <span class="n">strep_alpha</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
    <span class="s2">&quot;sigma&quot;</span> <span class="p">:</span> <span class="n">posterior_5_9</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">az</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">updated_posterior_5_9</span><span class="p">),</span> <span class="n">round_to</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;stats&#39;</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/arviz/data/base.py:221: UserWarning: More chains (500) than draws (1). Passed array should have shape (chains, draws, *shape)
  UserWarning,
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>ape_alpha</th>
      <td>-0.52</td>
      <td>0.18</td>
      <td>-0.81</td>
      <td>-0.25</td>
    </tr>
    <tr>
      <th>nwm_alpha</th>
      <td>0.49</td>
      <td>0.23</td>
      <td>0.08</td>
      <td>0.81</td>
    </tr>
    <tr>
      <th>owm_alpha</th>
      <td>0.46</td>
      <td>0.25</td>
      <td>0.11</td>
      <td>0.87</td>
    </tr>
    <tr>
      <th>strep_alpha</th>
      <td>-0.46</td>
      <td>0.22</td>
      <td>-0.74</td>
      <td>-0.07</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>0.81</td>
      <td>0.11</td>
      <td>0.65</td>
      <td>0.98</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;a[&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;]:&quot;</span> <span class="o">+</span> <span class="n">s</span>
          <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">clade</span><span class="o">.</span><span class="n">unique</span><span class="p">()))]</span>
<span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">({</span><span class="s2">&quot;a&quot;</span> <span class="p">:</span> <span class="n">trace_5_9</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]},</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">yticklabels</span><span class="o">=</span><span class="n">labels</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;expected kcal (std)&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/05_the_many_variables_and_the_spurious_waffles_143_0.png" src="../_images/05_the_many_variables_and_the_spurious_waffles_143_0.png" />
</div>
</div>
</div>
<div class="section" id="code-5-52">
<h3>Code 5.52<a class="headerlink" href="#code-5-52" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">63</span><span class="p">)</span>
<span class="n">d</span><span class="p">[</span><span class="s2">&quot;house&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="mi">8</span><span class="p">),</span> <span class="n">d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span><span class="o">.</span><span class="n">house</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0     2
1     3
2     1
3     3
4     0
5     0
6     0
7     2
8     0
9     0
10    1
11    3
12    1
13    1
14    3
15    1
16    2
17    0
18    3
19    2
20    3
21    0
22    3
23    1
24    3
25    2
26    0
27    2
28    2
Name: house, dtype: int64
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="code-5-53">
<h3>Code 5.53<a class="headerlink" href="#code-5-53" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tdf</span> <span class="o">=</span> <span class="n">dataframe_to_tensors</span><span class="p">(</span><span class="s1">&#39;Milk&#39;</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;K&#39;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>     
    <span class="s1">&#39;clade_id&#39;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span>
    <span class="s1">&#39;house&#39;</span> <span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span>
<span class="p">})</span>

<span class="n">CLADE_ID_LEN</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">clade_id</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
<span class="n">HOUSE_ID_LEN</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">house</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">model_5_10</span><span class="p">(</span><span class="n">clade_id</span><span class="p">,</span> <span class="n">house_id</span><span class="p">):</span>    
    <span class="k">def</span> <span class="nf">_generator</span><span class="p">():</span>      
      <span class="n">alpha</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;alpha&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="n">CLADE_ID_LEN</span><span class="p">,)))</span>                
      <span class="n">house</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;house&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="n">HOUSE_ID_LEN</span><span class="p">,)))</span>                
      <span class="n">sigma</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">Root</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sigma&quot;</span><span class="p">),</span> <span class="n">sample_shape</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>        

      <span class="n">mu</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">alpha</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">clade_id</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">)))</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">house</span><span class="p">),</span> <span class="n">house_id</span><span class="p">))</span>
    
      <span class="n">K</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tfd</span><span class="o">.</span><span class="n">Independent</span><span class="p">(</span><span class="n">tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;K&quot;</span><span class="p">),</span> <span class="n">reinterpreted_batch_ndims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tfd</span><span class="o">.</span><span class="n">JointDistributionCoroutine</span><span class="p">(</span><span class="n">_generator</span><span class="p">,</span> <span class="n">validate_args</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    
    
<span class="n">jdc_5_10</span> <span class="o">=</span> <span class="n">model_5_10</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">clade_id</span><span class="p">,</span> <span class="n">tdf</span><span class="o">.</span><span class="n">house</span><span class="p">)</span>

<span class="n">posterior_5_10</span><span class="p">,</span> <span class="n">trace_5_10</span> <span class="o">=</span> <span class="n">sample_posterior</span><span class="p">(</span>
                                <span class="n">jdc_5_10</span><span class="p">,</span>
                                <span class="n">observed_data</span><span class="o">=</span><span class="p">(</span><span class="n">tdf</span><span class="o">.</span><span class="n">K</span><span class="p">,),</span>
                                <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;house&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">])</span>

<span class="c1"># now here is the special thing we have to do here</span>
<span class="c1"># alpha is actually a vector so for az_trace to display</span>
<span class="c1"># it properly I would have to extract it properly</span>
<span class="n">ape_alpha</span><span class="p">,</span> <span class="n">nwm_alpha</span><span class="p">,</span> <span class="n">owm_alpha</span><span class="p">,</span> <span class="n">strep_alpha</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">posterior_5_10</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">house_0</span><span class="p">,</span> <span class="n">house_1</span><span class="p">,</span> <span class="n">house_2</span><span class="p">,</span> <span class="n">house_3</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">posterior_5_10</span><span class="p">[</span><span class="s2">&quot;house&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># reformatted </span>
<span class="n">updated_posterior_5_10</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;ape_alpha&quot;</span> <span class="p">:</span> <span class="n">ape_alpha</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
    <span class="s2">&quot;nwm_alpha&quot;</span> <span class="p">:</span> <span class="n">nwm_alpha</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
    <span class="s2">&quot;owm_alpha&quot;</span> <span class="p">:</span> <span class="n">owm_alpha</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
    <span class="s2">&quot;strep_alpha&quot;</span> <span class="p">:</span> <span class="n">strep_alpha</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
    <span class="s2">&quot;house_0&quot;</span> <span class="p">:</span> <span class="n">house_0</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
    <span class="s2">&quot;house_1&quot;</span> <span class="p">:</span> <span class="n">house_1</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
    <span class="s2">&quot;house_2&quot;</span> <span class="p">:</span> <span class="n">house_2</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
    <span class="s2">&quot;house_3&quot;</span> <span class="p">:</span> <span class="n">house_3</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>    
    <span class="s2">&quot;sigma&quot;</span> <span class="p">:</span> <span class="n">posterior_5_10</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">az</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">updated_posterior_5_10</span><span class="p">),</span> <span class="n">round_to</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;stats&#39;</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/arviz/data/base.py:221: UserWarning: More chains (500) than draws (1). Passed array should have shape (chains, draws, *shape)
  UserWarning,
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>ape_alpha</th>
      <td>-0.34</td>
      <td>0.27</td>
      <td>-0.73</td>
      <td>0.09</td>
    </tr>
    <tr>
      <th>nwm_alpha</th>
      <td>0.38</td>
      <td>0.25</td>
      <td>0.08</td>
      <td>0.84</td>
    </tr>
    <tr>
      <th>owm_alpha</th>
      <td>0.70</td>
      <td>0.21</td>
      <td>0.34</td>
      <td>0.98</td>
    </tr>
    <tr>
      <th>strep_alpha</th>
      <td>-0.53</td>
      <td>0.26</td>
      <td>-0.95</td>
      <td>-0.10</td>
    </tr>
    <tr>
      <th>house_0</th>
      <td>0.14</td>
      <td>0.18</td>
      <td>-0.16</td>
      <td>0.40</td>
    </tr>
    <tr>
      <th>house_1</th>
      <td>-0.00</td>
      <td>0.31</td>
      <td>-0.55</td>
      <td>0.47</td>
    </tr>
    <tr>
      <th>house_2</th>
      <td>0.14</td>
      <td>0.19</td>
      <td>-0.16</td>
      <td>0.42</td>
    </tr>
    <tr>
      <th>house_3</th>
      <td>-0.37</td>
      <td>0.27</td>
      <td>-0.75</td>
      <td>0.11</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>0.78</td>
      <td>0.12</td>
      <td>0.59</td>
      <td>0.94</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="04_geocentric_models.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">4. Geocentric Models</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="06_the_haunted_dag_and_the_causal_terror.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">6. The Haunted DAG and The Causal Terror</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Richard McElreath<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>